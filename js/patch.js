(()=>{var ct={};(()=>{ct.d=(t,e)=>{for(var i in e){if(ct.o(e,i)&&!ct.o(t,i)){Object.defineProperty(t,i,{enumerable:true,get:e[i]})}}}})();(()=>{ct.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();(()=>{ct.r=t=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(t,"__esModule",{value:true})}})();var ft={};(()=>{"use strict";ct.r(ft);ct.d(ft,{Anim:()=>u,AnimKey:()=>h,CONSTANTS:()=>c,EMBED:()=>U,Link:()=>M,LoadingStatus:()=>R,Op:()=>y,Patch:()=>L,PatchVariable:()=>it,Port:()=>P,Profiler:()=>at,RenderLoop:()=>ht,Timer:()=>O,default:()=>ut,now:()=>N,utils:()=>t});var t={};ct.r(t);ct.d(t,{ajax:()=>I,basename:()=>x,cacheBust:()=>A,clamp:()=>b,cleanJson:()=>g,copyArray:()=>S,escapeHTML:()=>et,filename:()=>q,float32Concat:()=>W,generateUUID:()=>o,getShortOpName:()=>i,isNumeric:()=>f,logErrorConsole:()=>Q,logStack:()=>X,map:()=>T,prefixedHash:()=>m,request:()=>K,shortId:()=>E,shuffleArray:()=>s,simpleId:()=>_,smoothStep:()=>p,smootherStep:()=>v,uniqueArray:()=>J,uuid:()=>a});class w{constructor(t,e,i,s){this.targetObj=t;this.id=e;this.eventName=i;this.cb=s}remove(){this.targetObj.off(this.id)}}class B{constructor(){this._simpleIdCounter=0}uuid(){let i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=(i+Math.random()*16)%16|0;i=Math.floor(i/16);return(t==="x"?e:e&3|8).toString(16)})}isNumeric(t){return!isNaN(parseFloat(t))&&isFinite(t)}simpleId(){this._simpleIdCounter++;return this._simpleIdCounter}pathLookup(t,e){const i=e.split(".");if(i.length==1){return t[i[0]]}return this.pathLookup(t[i[0]],i.slice(1).join("."))}}const n=new B;class l{constructor(t,e){this.initiator=t;this._options=e;if(!this.initiator){console.error("no log initator given");CABLES.logStack()}}stack(t){console.info("["+this.initiator+"] ",t);console.log((new Error).stack)}groupCollapsed(t){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments);console.groupCollapsed("["+this.initiator+"] "+t)}table(t){console.table(t)}groupEnd(){console.groupEnd()}error(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:2},...arguments)||!CABLES.UI){console.error("["+this.initiator+"]",...arguments)}if(this._options&&this._options.onError){this._options.onError(this.initiator,...arguments)}}errorGui(){if(CABLES.UI)CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:2},...arguments)}warn(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:1},...arguments))console.warn("["+this.initiator+"]",...arguments)}verbose(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments)}info(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.info("["+this.initiator+"]",...arguments)}log(){if(CABLES.UI&&CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)||!CABLES.logSilent)console.log("["+this.initiator+"]",...arguments)}logGui(){if(CABLES.UI)CABLES.UI.logFilter.filterLog({initiator:this.initiator,level:0},...arguments)}userInteraction(t){}}class e{#eventLog=new l("eventtarget");#listeners={};#logEvents=false;#logName="";#eventCallbacks={};#countErrorUnknowns=0;eventsPaused=false;constructor(){}on(t,e,i=""){const s=(i||"")+n.simpleId();const r=new w(this,s,t,e);if(!this.#eventCallbacks[t])this.#eventCallbacks[t]=[r];else this.#eventCallbacks[t].push(r);this.#listeners[r.id]=r;return r}removeAllEventListeners(){for(const t in this.#listeners){this.off(this.#listeners[t])}}addEventListener(t,e,i=""){return this.on(t,e,i)}hasEventListener(t,e=null){if(t&&!e){if(typeof t=="string")return!!this.#listeners[t];else return!!this.#listeners[t.id]}else{this.#eventLog.warn("old eventtarget function haseventlistener!");if(t&&e){if(this.#eventCallbacks[t]){const i=this.#eventCallbacks[t].indexOf(e);return i!==-1}}}}hasListenerForEventName(t){return this.#eventCallbacks[t]&&this.#eventCallbacks[t].length>0}removeEventListener(t){return this.off(t)}off(t){if(t===null||t===undefined){this.#eventLog.warn("removeEventListener id null",t);return}let i=t;if(t.eventName)i=t.id;if(typeof i!="string"){console.log("old function signature: removeEventListener! use listener id");return}const s=this.#listeners[i];if(!s){if(this.#countErrorUnknowns==20)this.#eventLog.warn("stopped reporting unknown events");if(this.#countErrorUnknowns<20)this.#eventLog.warn("could not find event...",i,s);this.#countErrorUnknowns++;return}let r=0;let n=true;while(n){n=false;let e=-1;for(let t=0;t<this.#eventCallbacks[s.eventName].length;t++){if(this.#eventCallbacks[s.eventName][t].id.indexOf(i)===0){n=true;e=t}}if(e!==-1){this.#eventCallbacks[s.eventName].splice(e,1);delete this.#listeners[i];r++}}if(r==0)console.log("no events removed",s.eventName,i);return}logEvents(t,e){this.#logEvents=t;this.#logName=e}emitEvent(e,i=null,s=null,r=null,n=null,a=null,o=null,h=null,l=null){if(this.eventsPaused)return;if(this.#logEvents)this.#eventLog.log("[event] ",this.#logName,e,this.#eventCallbacks);if(this.#eventCallbacks[e]){for(let t=0;t<this.#eventCallbacks[e].length;t++){if(this.#eventCallbacks[e][t]){this.#eventCallbacks[e][t].cb(i,s,r,n,a,o,h,l)}}}else{if(this.#logEvents)this.#eventLog.log("[event] has no event callback",e,this.#eventCallbacks)}}}class h{anim=null;id=CABLES.simpleId();time=0;value=0;onChange=null;_easing=0;bezCp1=null;bezCp2=null;bezAn=null;cb=null;cbTriggered=false;temp={};uiAttribs={};clip=null;clipId=null;constructor(t,e){this.anim=t.anim||e||null;this.setEasing(u.EASING_LINEAR);this.set(t)}setClip(t,e){this.clipId=t;this.clip=e;if(this.anim)this.anim.emitEvent(u.EVENT_CHANGE)}emitChange(){if(this.anim.batchMode)return;if(!this.anim)return;this.bezAn=null;if(this.onChange!==null)this.onChange();this.anim.forceChangeCallbackSoon();for(let t=0;t<this.anim.keys.length;t++)this.anim.keys[t].bezAn=null}delete(){if(this.anim)this.anim.remove(this);else console.log("animkey without anim...")}setUiAttribs(e){for(const t in e){this.uiAttribs[t]=e[t];if(e[t]===null)delete this.uiAttribs[t]}if(this.anim)this.anim.emitEvent(u.EVENT_CHANGE)}setEasing(t){if(this.anim.uiAttribs.readOnly)return;if(this.anim.uiAttribs.muted)return;let e=false;if(this._easing!=t)e=true;this._easing=t;if(this._easing!=u.EASING_CLIP){this.clipId="";this.clip=null}if(this._easing==u.EASING_LINEAR)this.ease=this.easeLinear;else if(this._easing==u.EASING_ABSOLUTE)this.ease=this.easeAbsolute;else if(this._easing==u.EASING_SMOOTHSTEP)this.ease=h.easeSmoothStep;else if(this._easing==u.EASING_SMOOTHERSTEP)this.ease=h.easeSmootherStep;else if(this._easing==u.EASING_CUBIC_IN)this.ease=h.easeCubicIn;else if(this._easing==u.EASING_CUBIC_OUT)this.ease=h.easeCubicOut;else if(this._easing==u.EASING_CUBIC_INOUT)this.ease=h.easeCubicInOut;else if(this._easing==u.EASING_EXPO_IN)this.ease=h.easeExpoIn;else if(this._easing==u.EASING_EXPO_OUT)this.ease=h.easeExpoOut;else if(this._easing==u.EASING_EXPO_INOUT)this.ease=h.easeExpoInOut;else if(this._easing==u.EASING_SIN_IN)this.ease=h.easeSinIn;else if(this._easing==u.EASING_SIN_OUT)this.ease=h.easeSinOut;else if(this._easing==u.EASING_SIN_INOUT)this.ease=h.easeSinInOut;else if(this._easing==u.EASING_BACK_OUT)this.ease=h.easeOutBack;else if(this._easing==u.EASING_BACK_IN)this.ease=h.easeInBack;else if(this._easing==u.EASING_BACK_INOUT)this.ease=h.easeInOutBack;else if(this._easing==u.EASING_ELASTIC_IN)this.ease=h.easeInElastic;else if(this._easing==u.EASING_ELASTIC_OUT)this.ease=h.easeOutElastic;else if(this._easing==u.EASING_BOUNCE_IN)this.ease=h.easeInBounce;else if(this._easing==u.EASING_BOUNCE_OUT)this.ease=h.easeOutBounce;else if(this._easing==u.EASING_QUART_OUT)this.ease=h.easeOutQuart;else if(this._easing==u.EASING_QUART_IN)this.ease=h.easeInQuart;else if(this._easing==u.EASING_QUART_INOUT)this.ease=h.easeInOutQuart;else if(this._easing==u.EASING_QUINT_OUT)this.ease=h.easeOutQuint;else if(this._easing==u.EASING_QUINT_IN)this.ease=h.easeInQuint;else if(this._easing==u.EASING_QUINT_INOUT)this.ease=h.easeInOutQuint;else if(this._easing==u.EASING_CLIP)this.ease=this.easeAbsolute;else if(this._easing==u.EASING_CUBICSPLINE){if(this.ease!=this.easeCubicSpline){this.ease=this.easeCubicSpline;this.bezReset()}this.bezAn=null}else{this._easing=u.EASING_LINEAR;this.ease=this.easeLinear}if(e)this.emitChange()}bezReset(){let t=.5;const e=this.anim.getPrevKey(this.time);if(e)t=(this.time-e.time)/2;let i=.5;const s=this.anim.getNextKey(this.time);if(s)i=(s.time-this.time)/2;this.bezCp1=[-Math.min(t,i),0];this.bezCp2=[Math.min(t,i),0];this.emitChange()}trigger(){this.cb();this.cbTriggered=true}setValue(t){this.value=t;this.emitChange()}setBezCp1(t,e){this.bezCp1=[t,e];this.emitChange()}setBezCp2(t,e){this.bezCp2=[t,e];this.emitChange()}set(t){if(t){if(t.hasOwnProperty("e"))this.setEasing(t.e);if(t.cb){this.cb=t.cb;this.cbTriggered=false}if(t.hasOwnProperty("cp1")){this.bezCp1=t.cp1;this.bezCp2=t.cp2}if(t.hasOwnProperty("t"))this.time=t.t;if(t.hasOwnProperty("time"))this.time=t.time;if(t.hasOwnProperty("v"))this.value=t.v;else if(t.hasOwnProperty("value"))this.value=t.value;if(t.hasOwnProperty("uiAttribs"))this.setUiAttribs(t.uiAttribs);if(t.clipId)this.clipId=t.clipId}this.emitChange()}getSerialized(){const t={};t.t=this.time;t.v=this.value;t.e=this._easing;t.uiAttribs=this.uiAttribs;if(this.clipId)t.clipId=this.clipId;if(this._easing===u.EASING_CUBICSPLINE){t.cp1=this.bezCp1;t.cp2=this.bezCp2}return t}getEasing(){return this._easing}easeCubicSpline(t,e){if(!this.bezAn){const i=30;this.bezAn=new u;for(let t=0;t<=i+1;t++){const s=h.cubicSpline(t/i,this,e);this.bezAn.setValue(s[0],s[1])}}return this.bezAn.getValue(this.time+t*(e.time-this.time))}easeLinear(t,e){return h.linear(t,this,e)}easeAbsolute(){return this.value}}h.cubicSpline=function(t,e,i){const s=1-t;const r=s*s;const n=t*t;const a=r*s;const o=3*r*t;const h=3*s*n;const l=n*t;e.bezCp1=e.bezCp1||[-.5,0];e.bezCp2=e.bezCp2||[.5,0];i.bezCp1=i.bezCp1||[-.5,0];i.bezCp2=i.bezCp2||[.5,0];const u=Math.min(i.time,e.bezCp2[0]+e.time);const c=Math.max(e.time,i.bezCp1[0]+i.time);const f=a*e.time+o*u+h*c+l*i.time;const g=a*e.value+o*(e.bezCp2[1]+e.value)+h*(i.bezCp1[1]+i.value)+l*i.value;return[f,g]};h.linear=function(t,e,i){return e.value+(i.value-e.value)*t};const V=function(t){return t=2**(10*(t-1))};h.easeExpoIn=function(t,e){t=V(t);return h.linear(t,this,e)};const D=function(t){t=-(2**(-10*t))+1;return t};h.easeExpoOut=function(t,e){t=D(t);return h.linear(t,this,e)};const k=function(t){t*=2;if(t<1){t=.5*2**(10*(t-1))}else{t--;t=.5*(-(2**(-10*t))+2)}return t};h.easeExpoInOut=function(t,e){t=k(t);return h.linear(t,this,e)};h.easeSinIn=function(t,e){t=-1*Math.cos(t*Math.PI/2)+1;return h.linear(t,this,e)};h.easeSinOut=function(t,e){t=Math.sin(t*Math.PI/2);return h.linear(t,this,e)};h.easeSinInOut=function(t,e){t=-.5*(Math.cos(Math.PI*t)-1);return h.linear(t,this,e)};const G=function(t){t=t*t*t;return t};h.easeCubicIn=function(t,e){t=G(t);return h.linear(t,this,e)};h.easeInQuint=function(t,e){t=t*t*t*t*t;return h.linear(t,this,e)};h.easeOutQuint=function(t,e){t=(t-=1)*t*t*t*t+1;return h.linear(t,this,e)};h.easeInOutQuint=function(t,e){if((t/=.5)<1)t=.5*t*t*t*t*t;else t=.5*((t-=2)*t*t*t*t+2);return h.linear(t,this,e)};h.easeInQuart=function(t,e){t=t*t*t*t;return h.linear(t,this,e)};h.easeOutQuart=function(t,e){t=-1*((t-=1)*t*t*t-1);return h.linear(t,this,e)};h.easeInOutQuart=function(t,e){if((t/=.5)<1)t=.5*t*t*t*t;else t=-.5*((t-=2)*t*t*t-2);return h.linear(t,this,e)};h.bounce=function(t){if((t/=1)<1/2.75)t=7.5625*t*t;else if(t<2/2.75)t=7.5625*(t-=1.5/2.75)*t+.75;else if(t<2.5/2.75)t=7.5625*(t-=2.25/2.75)*t+.9375;else t=7.5625*(t-=2.625/2.75)*t+.984375;return t};h.easeInBounce=function(t,e){return h.linear(h.bounce(t),this,e)};h.easeOutBounce=function(t,e){return h.linear(h.bounce(t),this,e)};h.easeInElastic=function(t,e){let i=1.70158;let s=0;let r=1;const n=0;const a=1;const o=1;if(t===0)t=n;else if((t/=a)==1)t=n+o;else{if(!s)s=a*.3;if(r<Math.abs(o)){r=o;i=s/4}else i=s/(2*Math.PI)*Math.asin(o/r);t=-(r*2**(10*(t-=1))*Math.sin((t*a-i)*(2*Math.PI)/s))+n}return h.linear(t,this,e)};h.easeOutElastic=function(t,e){let i=1.70158;let s=0;let r=1;const n=0;const a=1;const o=1;if(t===0)t=n;else if((t/=a)==1)t=n+o;else{if(!s)s=a*.3;if(r<Math.abs(o)){r=o;i=s/4}else i=s/(2*Math.PI)*Math.asin(o/r);t=r*2**(-10*t)*Math.sin((t*a-i)*(2*Math.PI)/s)+o+n}return h.linear(t,this,e)};h.easeInBack=function(t,e){const i=1.70158;t=t*t*((i+1)*t-i);return h.linear(t,this,e)};h.easeOutBack=function(t,e){const i=1.70158;t=(t=t/1-1)*t*((i+1)*t+i)+1;return h.linear(t,this,e)};h.easeInOutBack=function(t,e){let i=1.70158;const s=1/2;if((t/=1/2)<1)t=s*(t*t*(((i*=1.525)+1)*t-i));else t=s*((t-=2)*t*(((i*=1.525)+1)*t+i)+2);return h.linear(t,this,e)};const H=function(t){t--;t=t*t*t+1;return t};h.easeCubicOut=function(t,e){t=H(t);return h.linear(t,this,e)};const z=function(t){t*=2;if(t<1)t=.5*t*t*t;else{t-=2;t=.5*(t*t*t+2)}return t};h.easeCubicInOut=function(t,e){t=z(t);return h.linear(t,this,e)};h.easeSmoothStep=function(t,e){const i=Math.max(0,Math.min(1,t));t=i*i*(3-2*i);return h.linear(t,this,e)};h.easeSmootherStep=function(t,e){const i=Math.max(0,Math.min(1,(t-0)/(1-0)));t=i*i*i*(i*(i*6-15)+10);return h.linear(t,this,e)};let j={};class u extends e{static EVENT_KEY_DELETE="keyDelete";static EVENT_CHANGE="onChange";static EVENT_UIATTRIB_CHANGE="uiattrchange";static LOOP_OFF=0;static LOOP_REPEAT=1;static LOOP_MIRROR=2;static LOOP_OFFSET=3;static EASING_LINEAR=0;static EASING_ABSOLUTE=1;static EASING_SMOOTHSTEP=2;static EASING_SMOOTHERSTEP=3;static EASING_CUBICSPLINE=4;static EASING_CUBIC_IN=5;static EASING_CUBIC_OUT=6;static EASING_CUBIC_INOUT=7;static EASING_EXPO_IN=8;static EASING_EXPO_OUT=9;static EASING_EXPO_INOUT=10;static EASING_SIN_IN=11;static EASING_SIN_OUT=12;static EASING_SIN_INOUT=13;static EASING_BACK_IN=14;static EASING_BACK_OUT=15;static EASING_BACK_INOUT=16;static EASING_ELASTIC_IN=17;static EASING_ELASTIC_OUT=18;static EASING_BOUNCE_IN=19;static EASING_BOUNCE_OUT=21;static EASING_QUART_IN=22;static EASING_QUART_OUT=23;static EASING_QUART_INOUT=24;static EASING_QUINT_IN=25;static EASING_QUINT_OUT=26;static EASING_QUINT_INOUT=27;static EASING_CLIP=28;static EASINGNAMES=["linear","absolute","smoothstep","smootherstep","Cubic In","Cubic Out","Cubic In Out","Expo In","Expo Out","Expo In Out","Sin In","Sin Out","Sin In Out","Quart In","Quart Out","Quart In Out","Quint In","Quint Out","Quint In Out","Back In","Back Out","Back In Out","Elastic In","Elastic Out","Bounce In","Bounce Out","Clip"];#tlActive=true;uiAttribs={};loop=0;onLooped=null;_timesLooped=0;#needsSort=false;_cachedIndex=0;port=null;keys=[];onChange=null;stayInTimeline=false;batchMode=false;#log=new l("Anim");constructor(t={}){super();t=t||{};this.id=a();this.name=t.name||null;this.defaultEasing=t.defaultEasing||u.EASING_LINEAR}forceChangeCallback(){if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this)}forceChangeCallbackSoon(){if(this.batchMode)return;if(!this.forcecbto)this.forcecbto=setTimeout(()=>{this.forceChangeCallback();this.forcecbto=null},50)}getLoop(){return this.loop}setLoop(t){if(t===false)t=0;if(t===true)t=1;this.loop=t;this.emitEvent(u.EVENT_CHANGE,this)}hasEnded(t){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return true;if(this.keys[this.keys.length-1].time<=t)return true;return false}hasStarted(t){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return false;if(t>=this.keys[0].time)return true;return false}isRising(t){if(this.#needsSort)this.sortKeys();if(this.hasEnded(t))return false;const e=this.getKeyIndex(t);if(this.keys[e].value<this.keys[e+1].value)return true;return false}clearBefore(t){if(this.#needsSort)this.sortKeys();const e=this.getValue(t);const i=this.getKeyIndex(t);this.setValue(t,e);if(i>1){this.keys.splice(0,i);this.#needsSort=true}}clear(t){if(this.#needsSort)this.sortKeys();let e=0;if(t)e=this.getValue(t);for(let t=0;t<this.keys.length;t++)this.emitEvent(u.EVENT_KEY_DELETE,this.keys[t]);this.keys.length=0;if(t)this.setValue(t,e);this.#needsSort=true;if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this)}checkIsSorted(){let e=true;for(let t=0;t<this.keys.length-1;t++)if(this.keys[t].time>this.keys[t+1].time){e=false;break}return e}sortKeys(){if(this.batchMode)return;if(!this.checkIsSorted()){this.keys.sort((t,e)=>{return t.time-e.time});this.#needsSort=false;this.emitEvent(u.EVENT_CHANGE)}}hasDuplicates(){const e={};let i=0;for(let t=0;t<this.keys.length;t++){e[this.keys[t].time]=1;i++}const t=Object.keys(e);if(t.length!=i){return true}return false}removeDuplicates(){if(this.hasDuplicates()){if(this.#needsSort)this.sortKeys();let e=0;while(this.hasDuplicates()){for(let t=0;t<this.keys.length-1;t++){if(this.keys[t].time==this.keys[t+1].time){const i=this.keys[t];this.keys.splice(t,1);this.emitEvent(u.EVENT_KEY_DELETE,i)}e++}}this.#needsSort=true}}getLengthLoop(){if(this.#needsSort)this.sortKeys();if(this.keys.length<2)return 0;return this.lastKey.time-this.firstKey.time}getLength(){if(this.#needsSort)this.sortKeys();if(this.keys.length===0)return 0;return this.lastKey.time}getKeyIndex(e){if(this.#needsSort)this.sortKeys();let i=0;let s=0;if(this._cachedIndex&&this.keys.length>this._cachedIndex&&e>=this.keys[this._cachedIndex].time)s=this._cachedIndex;for(let t=s;t<this.keys.length;t++){if(e>=this.keys[t].time)i=t;if(this.keys[t].time>e){if(e!=0)this._cachedIndex=i;return i}}return i}setValue(e,i,s=null){if(CABLES.UI&&CABLES.UI.showDevInfos)if(isNaN(i))CABLES.logStack();if(this.#needsSort)this.sortKeys();let r=null;if(!this.batchMode)if(this.keys.length==0||e<=this.lastKey.time)for(let t=0;t<this.keys.length;t++)if(this.keys[t].time==e){r=this.keys[t];this.keys[t].setValue(i);this.keys[t].cb=s;break}if(!r){r=new h({time:e,value:i,e:this.defaultEasing,cb:s,anim:this});this.keys.push(r)}if(!this.batchMode){if(this.onChange)this.onChange();this.emitEvent(u.EVENT_CHANGE,this);this.#needsSort=true}return r}setKeyEasing(t,e){if(this.keys[t]){this.keys[t].setEasing(e);this.emitEvent(u.EVENT_CHANGE,this)}}deserialize(e,t,i){if(e.loop)this.loop=e.loop;if(e.tlActive)this.#tlActive=e.tlActive;if(e.height)this.uiAttribs.height=e.height;if(t){while(this.keys.length)this.keys[0].delete();this.keys.length=0}for(const s in e.keys){let t=new h(e.keys[s],this);this.keys.push(t);if(i)if(e.keys[s].clipId){i[e.keys[s].clipId]=i[e.keys[s].clipId]||[];if(i)i[e.keys[s].clipId].push(t)}}this.sortKeys()}getSerialized(){const e={};e.keys=[];e.loop=this.loop;if(this.#tlActive)e.tlActive=this.tlActive;if(this.uiAttribs.height)e.height=this.uiAttribs.height;for(let t=0;t<this.keys.length;t++)e.keys.push(this.keys[t].getSerialized());return e}getKey(t){if(this.#needsSort)this.sortKeys();const e=this.getKeyIndex(t);return this.keys[e]}getNextKey(t){if(this.#needsSort)this.sortKeys();let e=this.getKeyIndex(t)+1;if(e>=this.keys.length)return null;return this.keys[e]}getPrevKey(t){if(this.#needsSort)this.sortKeys();let e=this.getKeyIndex(t)-1;if(e<0)return null;return this.keys[e]}isFinished(t){if(this.#needsSort)this.sortKeys();if(this.keys.length<=0)return true;return t>this.lastKey.time}isStarted(t){if(this.#needsSort)this.sortKeys();if(this.keys.length<=0)return false;return t>=this.firstKey.time}remove(e,i){for(let t=0;t<this.keys.length;t++){if(this.keys[t]==e){this.emitEvent(u.EVENT_KEY_DELETE,this.keys[t]);this.keys.splice(t,1);this.#needsSort=true;if(i===undefined){this.emitEvent(u.EVENT_CHANGE,this)}return}}}get lastKey(){if(this.#needsSort)this.sortKeys();return this.keys[this.keys.length-1]}get firstKey(){if(this.#needsSort)this.sortKeys();return this.keys[0]}getLoopIndex(t){if(this.#needsSort)this.sortKeys();if(this.keys.length<2)return 0;return(t-this.firstKey.time)/this.getLengthLoop()}getValue(t=0){let e=0;if(this.keys.length===0)return 0;if(this.#needsSort)this.sortKeys();if(!this.loop&&t>this.lastKey.time){if(this.lastKey.cb&&!this.lastKey.cbTriggered)this.lastKey.trigger();return this.lastKey.value}if(t<this.firstKey.time)return this.keys[0].value;if(this.loop&&this.keys.length>1&&t>this.lastKey.time){const o=this.getLoopIndex(t);if(o>this._timesLooped){this._timesLooped++;if(this.onLooped)this.onLooped()}t=(t-this.firstKey.time)%this.getLengthLoop();if(this.loop==u.LOOP_REPEAT){}else if(this.loop==u.LOOP_MIRROR){if(Math.floor(o)%2==1)t=this.getLengthLoop()-t}else if(this.loop==u.LOOP_OFFSET){e=(this.lastKey.value-this.keys[0].value)*Math.floor(o)}t+=this.firstKey.time}const i=this.getKeyIndex(t);if(i>=this.keys.length-1){if(this.lastKey.cb&&!this.lastKey.cbTriggered)this.lastKey.trigger();return this.lastKey.value}const s=i+1;const r=this.keys[i];const n=this.keys[s];if(r.cb&&!r.cbTriggered)r.trigger();if(!n)return-1;const a=(t-r.time)/(n.time-r.time);if(r.getEasing()==u.EASING_CLIP){if(!r.clip&&this.port){const h=this.port.op.patch;const l=h.getVar(r.clipId)?.getValue();if(l)r.clip=l}if(r.clip&&r.clip.getValue){return r.clip.getValue(a*r.clip.getLength())}else{this.#log.warn("no clip found")}}return r.ease(a,n)+e}addKey(t){if(t.time===undefined){this.#log.warn("key time undefined, ignoring!")}else{this.keys.push(t);if(this.onChange!==null)this.onChange();this.emitEvent(u.EVENT_CHANGE,this);this.#needsSort=true}}sortSoon(){this.#needsSort=true}easingFromString(t){if(t=="linear")return u.EASING_LINEAR;if(t=="absolute")return u.EASING_ABSOLUTE;if(t=="smoothstep")return u.EASING_SMOOTHSTEP;if(t=="smootherstep")return u.EASING_SMOOTHERSTEP;if(t=="Cubic In")return u.EASING_CUBIC_IN;if(t=="Cubic Out")return u.EASING_CUBIC_OUT;if(t=="Cubic In Out")return u.EASING_CUBIC_INOUT;if(t=="Expo In")return u.EASING_EXPO_IN;if(t=="Expo Out")return u.EASING_EXPO_OUT;if(t=="Expo In Out")return u.EASING_EXPO_INOUT;if(t=="Sin In")return u.EASING_SIN_IN;if(t=="Sin Out")return u.EASING_SIN_OUT;if(t=="Sin In Out")return u.EASING_SIN_INOUT;if(t=="Back In")return u.EASING_BACK_IN;if(t=="Back Out")return u.EASING_BACK_OUT;if(t=="Back In Out")return u.EASING_BACK_INOUT;if(t=="Elastic In")return u.EASING_ELASTIC_IN;if(t=="Elastic Out")return u.EASING_ELASTIC_OUT;if(t=="Bounce In")return u.EASING_BOUNCE_IN;if(t=="Bounce Out")return u.EASING_BOUNCE_OUT;if(t=="Quart Out")return u.EASING_QUART_OUT;if(t=="Quart In")return u.EASING_QUART_IN;if(t=="Quart In Out")return u.EASING_QUART_INOUT;if(t=="Quint Out")return u.EASING_QUINT_OUT;if(t=="Quint In")return u.EASING_QUINT_IN;if(t=="Quint In Out")return u.EASING_QUINT_INOUT;this.#log.warn("unknown anim easing?",t)}createPort(t,e,i){const s=t.inDropDown(e,u.EASINGNAMES,"linear");s.set("linear");s.defaultValue=0;s.onChange=()=>{this.defaultEasing=this.easingFromString(s.get());this.emitEvent("onChangeDefaultEasing",this);if(i)i()};return s}get tlActive(){return this.#tlActive}set tlActive(t){if(CABLES.UI){this.#tlActive=t;window.gui.emitEvent("tlActiveChanged",this);this.forceChangeCallbackSoon()}}setUiAttribs(e){for(const t in e){this.uiAttribs[t]=e[t];if(e[t]===null)delete this.uiAttribs[t]}this.emitEvent(u.EVENT_UIATTRIB_CHANGE)}hasKeyframesBetween(e,i){for(let t=0;t<this.keys.length;t++)if(this.keys[t].time>=e&&this.keys[t].time<=i)return true;return false}static initClipsFromVars(i){for(const e in i.missingClipAnims){const s=i.getVar(e);for(let t=0;t<i.missingClipAnims[e].length;t++){i.missingClipAnims[e].clip=s.getValue();delete i.missingClipAnims[e]}}}}const c={ANIM:{EASINGS:u.EASINGNAMES,EASING_LINEAR:0,EASING_ABSOLUTE:1,EASING_SMOOTHSTEP:2,EASING_SMOOTHERSTEP:3,EASING_CUBICSPLINE:4,EASING_CUBIC_IN:5,EASING_CUBIC_OUT:6,EASING_CUBIC_INOUT:7,EASING_EXPO_IN:8,EASING_EXPO_OUT:9,EASING_EXPO_INOUT:10,EASING_SIN_IN:11,EASING_SIN_OUT:12,EASING_SIN_INOUT:13,EASING_BACK_IN:14,EASING_BACK_OUT:15,EASING_BACK_INOUT:16,EASING_ELASTIC_IN:17,EASING_ELASTIC_OUT:18,EASING_BOUNCE_IN:19,EASING_BOUNCE_OUT:21,EASING_QUART_IN:22,EASING_QUART_OUT:23,EASING_QUART_INOUT:24,EASING_QUINT_IN:25,EASING_QUINT_OUT:26,EASING_QUINT_INOUT:27,EASING_CLIP:28},OP:{OP_PORT_TYPE_VALUE:0,OP_PORT_TYPE_NUMBER:0,OP_PORT_TYPE_FUNCTION:1,OP_PORT_TYPE_TRIGGER:1,OP_PORT_TYPE_OBJECT:2,OP_PORT_TYPE_TEXTURE:2,OP_PORT_TYPE_ARRAY:3,OP_PORT_TYPE_DYNAMIC:4,OP_PORT_TYPE_STRING:5,OP_VERSION_PREFIX:"_v"},PORT:{PORT_DIR_IN:0,PORT_DIR_OUT:1},PACO:{PACO_CLEAR:0,PACO_VALUECHANGE:1,PACO_OP_DELETE:2,PACO_UNLINK:3,PACO_LINK:4,PACO_LOAD:5,PACO_OP_CREATE:6,PACO_OP_ENABLE:7,PACO_OP_DISABLE:8,PACO_UIATTRIBS:9,PACO_VARIABLES:10,PACO_TRIGGERS:11,PACO_PORT_SETVARIABLE:12,PACO_PORT_SETANIMATED:13,PACO_PORT_ANIM_UPDATED:14,PACO_DESERIALIZE:15,PACO_OP_RELOAD:16}};Math.randomSeed=1;Math.setRandomSeed=function(t){Math.randomSeed=t*50728129;if(t!=0){Math.randomSeed=Math.seededRandom()*17624813;Math.randomSeed=Math.seededRandom()*9737333}};Math.seededRandom=function(t,e){if(Math.randomSeed===0)Math.randomSeed=Math.random()*999;t=t||1;e=e||0;Math.randomSeed=(Math.randomSeed*9301+49297)%233280;const i=Math.randomSeed/233280;return e+i*(t-e)};String.prototype.endl=function(){return this+"\n"};String.prototype.contains=function(t){console.warn("string.contains deprecated, use string.includes");console.log((new Error).stack);return this.includes(t)};function Y(){}Y();function W(t,e){if(!(t instanceof Float32Array))t=new Float32Array(t);if(!(e instanceof Float32Array))e=new Float32Array(e);const i=new Float32Array(t.length+e.length);i.set(t);i.set(e,t.length);return i}const i=function(t){let e=t.split(".")[t.split(".").length-1];if(e.includes(c.OP.OP_VERSION_PREFIX)){const i=e.split(c.OP.OP_VERSION_PREFIX)[1];e=e.substring(0,e.length-(c.OP.OP_VERSION_PREFIX+i).length)}return e};const s=function(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.seededRandom()*(t+1));const s=e[t];e[t]=e[i];e[i]=s}return e};const r={};const E=function(){let t=Math.random().toString(36).substr(2,9);if(r.hasOwnProperty(t))t=E();r[t]=true;return t};const a=n.uuid;const o=a;const f=n.isNumeric;function g(e){for(const t in e){if(e[t]&&typeof objValue==="object"&&e[t].constructor===Object)e[t]=g(e[t]);if(e[t]===null||e[t]===undefined)delete e[t];else if(Array.isArray(e[t])&&e[t].length==0)delete e[t]}return e}const m=function(i,t="id"){let s=0;if(i.length>0){for(let e=0;e<i.length;e++){let t=i.charCodeAt(e);s=(s<<5)-s+t;s&=s}}return t+""+s};let d=0;const _=function(){d++;return d};const p=function(t){const e=Math.max(0,Math.min(1,(t-0)/(1-0)));t=e*e*(3-2*e);return t};const v=function(t){const e=Math.max(0,Math.min(1,(t-0)/(1-0)));t=e*e*e*(e*(e*6-15)+10);return t};const b=function(t,e,i){return Math.min(Math.max(t,e),i)};const T=function(t,e,i,s,r,n=0,a=true){if(a){if(t>=i)return r;if(t<=e)return s}let o=false;const h=Math.min(e,i);const l=Math.max(e,i);if(h!=e)o=true;let u=false;const c=Math.min(s,r);const f=Math.max(s,r);if(c!=s)u=true;let g=0;let d=0;if(o)g=(l-t)*(f-c)/(l-h);else g=(t-h)*(f-c)/(l-h);if(u)d=f-g;else d=g+c;if(!n)return d;if(n==1){t=Math.max(0,Math.min(1,(d-s)/(r-s)));return s+t*t*(3-2*t)*(r-s)}if(n==2){t=Math.max(0,Math.min(1,(d-s)/(r-s)));return s+t*t*t*(t*(t*6-15)+10)*(r-s)}return d};const A=function(t=""){if(!t)return"";if(t.startsWith("data:"))return;if(t.includes("?"))t+="&";else t+="?";return t+"cache="+CABLES.uuid()};const S=function(e,i){if(!e)return null;i=i||[];i.length=e.length;for(let t=0;t<e.length;t++)i[t]=e[t];return i};const x=function(t){let e=CABLES.filename(t);const i=e.split(".");e=i[0];return e};const X=function(){console.log("logstack",(new Error).stack)};const q=function(t){let e="";if(!t)return"";if(t.startsWith("data:")&&t.includes(":")){const i=t.split(",");return i[0]}let i=(t+"").split("/");if(i.length>0){const s=i[i.length-1];let t=s.split("?");e=t[0]}return e||""};function I(t,e,i,s,r,n,a={},o={}){const h={url:t,cb:e,method:i,data:s,contenttype:r,sync:false,jsonP:n,headers:a};if(o&&o.credentials)h.credentials=o.credentials;K(h)}function K(e){if(!e.hasOwnProperty("asynch"))e.asynch=true;let i;try{i=new XMLHttpRequest}catch(t){}i.onreadystatechange=function(){if(i.readyState!=4)return;if(e.cb){if(i.status==200||i.status==0)e.cb(false,i.responseText,i);else e.cb(true,i.responseText,i)}};try{i.open(e.method?e.method.toUpperCase():"GET",e.url,!e.sync)}catch(t){if(e.cb&&t)e.cb(true,t.msg,i)}if(typeof e.headers==="object"){if(e.headers){const s=Object.keys(e.headers);for(let t=0;t<s.length;t++){const r=s[t];const n=e.headers[r];i.setRequestHeader(r,n)}}}if(e.credentials&&e.credentials!=="omit"){i.withCredentials=true}try{if(!e.post&&!e.data){i.send()}else{i.setRequestHeader("Content-type",e.contenttype?e.contenttype:"application/x-www-form-urlencoded");i.send(e.data||e.post)}}catch(t){if(e.cb)e.cb(true,t.msg,i)}}const Q=function(t){CABLES.errorConsole=CABLES.errorConsole||{log:[]};CABLES.errorConsole.log.push({initiator:t,arguments:arguments});if(!CABLES.errorConsole.ele){const e=document.createElement("div");e.id="cablesErrorConsole";e.style.width="90%";e.style.height="300px";e.style.zIndex="9999999";e.style.display="inline-block";e.style.position="absolute";e.style.padding="10px";e.style.fontFamily="monospace";e.style.color="red";e.style.backgroundColor="#200";CABLES.errorConsole.ele=e;document.body.appendChild(e)}let s="ERROR<br/>for more info, open your browsers dev tools console (Ctrl+Shift+I or Command+Alt+I)<br/>";for(let i=0;i<CABLES.errorConsole.log.length;i++){s+=CABLES.errorConsole.log[i].initiator+" ";for(let t=1;t<CABLES.errorConsole.log[i].arguments.length;t++){if(t>2)s+=", ";let e=CABLES.errorConsole.log[i].arguments[t];if(e.constructor.name.indexOf("Error")>-1||e.constructor.name.indexOf("error")>-1){let t="Uncaught ErrorEvent ";if(e.message)t+=" message: "+e.message;s+=t}else if(typeof e=="string")s+=e;else if(typeof e=="number")s+=String(e)+" "}s+="<br/>"}CABLES.errorConsole.ele.innerHTML=s};function J(i){const s={},r=[];for(let t=0,e=i.length;t<e;++t){if(!s.hasOwnProperty(i[t])){r.push(i[t]);s[i[t]]=1}}return r}const Z={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};const $=/[&<>"']/g;const tt=RegExp($.source);const et=function(t){return t&&tt.test(t)?t.replace($,function(t){return Z[t]}):t||""};class P extends e{static DIR_IN=0;static DIR_OUT=1;static TYPE_VALUE=0;static TYPE_NUMBER=0;static TYPE_FUNCTION=1;static TYPE_TRIGGER=1;static TYPE_OBJECT=2;static TYPE_TEXTURE=2;static TYPE_ARRAY=3;static TYPE_DYNAMIC=4;static TYPE_STRING=5;static EVENT_UIATTRCHANGE="onUiAttrChange";static EVENT_VALUE_CHANGE="change";static EVENT_LINK_CHANGED="onLinkChanged";static EVENT_LINK_REMOVED="onLinkRemoved";#log=new l("core_port");#oldAnimVal=-5711;animMuted=false;lastAnimTime=0;#uiActiveState=true;#valueBeforeLink=null;#animated=false;#useVariableName=null;#op=null;constructor(t,e,i,s={}){super();this.data={};this.direction=P.DIR_IN;this.id=String(CABLES.simpleId());this.#op=t;this.links=[];this.value=0;this.name=e;this.type=i||P.TYPE_VALUE;this.uiAttribs=s||{};this.anim=null;this.defaultValue=null;this.ignoreValueSerialize=false;this.onLinkChanged=null;this.crashed=false;this.onValueChanged=null;this.onTriggered=null;this.changeAlways=false;this.forceRefChange=false;this.activityCounter=0;this.apf=0;this.activityCounterStartFrame=0;this.canLink=null;this.preserveLinks=null;this.indexPort=null}get parent(){this.#log.stack("use port.op, not .parent");return this.op}get title(){return this.uiAttribs.title||this.name}get op(){return this.#op}get val(){return this.get()}set val(t){this.setValue(t)}copyLinkedUiAttrib(t,e){if(!CABLES.UI)return;if(!this.isLinked())return;const i={};i[t]=this.links[0].getOtherPort(this).getUiAttrib(t);e.setUiAttribs(i)}getValueForDisplay(){let t=this.value;if(typeof this.value==="string"||this.value instanceof String){if(t.length>1e3){t=t.substring(0,999);t+="..."}if(this.uiAttribs&&this.uiAttribs.display=="boolnum"){t+=" - ";if(!this.value)t+="false";else t+="true"}t=t.replace(/[\u00A0-\u9999<>&]/g,function(t){return"&#"+t.charCodeAt(0)+";"});if(t.length>100)t=t.substring(0,100)}else{t=String(this.value)}return t}onAnimToggle(){}_onAnimToggle(){this.onAnimToggle()}remove(){this.removeLinks();this.#op.removePort(this)}setUiAttribs(t){let e=false;if(!this.uiAttribs)this.uiAttribs={};for(const i in t){if(t[i]===undefined){delete this.uiAttribs[i];continue}if(this.uiAttribs[i]!=t[i])e=true;this.uiAttribs[i]=t[i];if(i=="group"&&this.indexPort)this.indexPort.setUiAttribs({group:t[i]})}if(t.hasOwnProperty("expose"))this.#op.patch.emitEvent("subpatchExpose",this.#op.uiAttribs.subPatch);if(e)this.emitEvent(P.EVENT_UIATTRCHANGE,t,this)}getUiAttribs(){return this.uiAttribs}getUiAttrib(t){if(!this.uiAttribs||!this.uiAttribs.hasOwnProperty(t))return null;return this.uiAttribs[t]}get(){if(CABLES.UI&&this.#animated&&this.lastAnimTime==this.#op.patch.timer.getTime()&&!CABLES.UI.keyframeAutoCreate){return this.value}if(!this.animMuted&&this.#animated&&this.lastAnimFrame!=this.#op.patch.getFrameNum()){this.lastAnimTime=this.#op.patch.timer.getTime();this.lastAnimFrame=this.#op.patch.getFrameNum();let t=this.anim.getValue(this.#op.patch.timer.getTime());if(this.value!=t){this.value=t;this.#oldAnimVal=this.value;this.forceChange()}}return this.value}set(t){this.setValue(t)}setRef(t){this.forceRefChange=true;this.setValue(t)}setValue(e){if(e===undefined)e=null;if(CABLES.UI&&CABLES.UI.showDevInfos){CABLES.UI.countSetWarns=CABLES.UI.countSetWarns||0;if(CABLES.UI.countSetWarns<20&&this.direction==c.PORT.PORT_DIR_OUT&&this.type==P.TYPE_OBJECT&&e&&!this.forceRefChange){this.#log.warn("object port ["+this.name+"] uses .set ["+this.op.objName+"]");CABLES.UI.countSetWarns++}}if(this.#op.enabled&&!this.crashed){if(e!==this.value||this.changeAlways||this.type==P.TYPE_TEXTURE||this.type==P.TYPE_ARRAY){if(CABLES.UI&&this.#animated){CABLES.UI.PREVISKEYVAL=null;if(!CABLES.UI.keyframeAutoCreate)CABLES.UI.PREVISKEYVAL=e}if(CABLES.UI&&this.#animated&&CABLES.UI.keyframeAutoCreate){let t=this.#op.patch.timer.getTime();if(CABLES.UI&&CABLES.Patch.getGui().glTimeline)CABLES.Patch.getGui().glTimeline.createKey(this.anim,t,e);else this.anim.setValue(t,e)}else{try{this.value=e;this.forceChange()}catch(t){this.crashed=true;this.setValue=function(t){};this.onTriggered=function(){};this.#log.error("exception in ",this.#op);this.#log.error(t);this.#op.patch.emitEvent("exception",t,this.#op)}if(this.#op&&this.#op.patch&&this.#op.patch.isEditorMode()&&this.type==P.TYPE_TEXTURE)CABLES.Patch.getGui().texturePreview().updateTexturePort(this)}if(this.direction==c.PORT.PORT_DIR_OUT)for(let t=0;t<this.links.length;++t)this.links[t].setValue()}}}updateAnim(){if(!this.#animated||this.animMuted)return;this.value=this.get();if(this.#oldAnimVal!=this.value||this.changeAlways){this.#oldAnimVal=this.value;this.forceChange()}this.#oldAnimVal=this.value}forceChange(){if(this.onValueChanged||this.onChange){}this._activity();this.emitEvent(P.EVENT_VALUE_CHANGE,this.value,this);if(this.onChange)this.onChange(this,this.value);else if(this.onValueChanged)this.onValueChanged(this,this.value)}getTypeString(){return P.getTypeString(this.type)}deSerializeSettings(t){if(!t)return;if(t.animated)this.setAnimated(t.animated);if(t.useVariable)this.setVariableName(t.useVariable);if(t.title)this.setUiAttribs({title:t.title});if(t.expose)this.setUiAttribs({expose:true});if(t.order)this.setUiAttribs({order:t.order});if(t.multiPortManual)this.setUiAttribs({multiPortManual:t.multiPortManual});if(t.multiPortNum)this.setUiAttribs({multiPortNum:t.multiPortNum});if(t.anim){if(!this.anim)this.anim=new u({name:"port "+this.name});this.#op.hasAnimPort=true;this.anim.port=this;this.anim.deserialize(t.anim,true,this.op.patch.clipAnims);this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.bindAnimListeners();this.anim.sortKeys()}}setInitialValue(t){if(this.op.preservedPortLinks[this.name]){for(let t=0;t<this.op.preservedPortLinks[this.name].length;t++){const e=this.op.preservedPortLinks[this.name][t];this.op.patch._addLink(e.objIn,e.objOut,e.portIn,e.portOut)}}if(this.op.preservedPortValues&&this.op.preservedPortValues.hasOwnProperty(this.name)&&this.op.preservedPortValues[this.name]!==undefined){this.set(this.op.preservedPortValues[this.name])}else if(t!==undefined)this.set(t);if(t!==undefined)this.defaultValue=t}getSerialized(){let e={name:this.getName()};if(!this.ignoreValueSerialize&&this.links.length===0){if(this.type==P.TYPE_OBJECT&&this.value&&this.value.tex){}else e.value=this.value}if(this.#useVariableName)e.useVariable=this.#useVariableName;if(this.#animated)e.animated=true;if(this.anim)e.anim=this.anim.getSerialized();if(this.uiAttribs.multiPortNum)e.multiPortNum=this.uiAttribs.multiPortNum;if(this.uiAttribs.multiPortManual)e.multiPortManual=this.uiAttribs.multiPortManual;if(this.uiAttribs.display=="file")e.display=this.uiAttribs.display;if(this.uiAttribs.expose){e.expose=true;if(this.uiAttribs.hasOwnProperty("order"))e.order=this.uiAttribs.order}if(this.uiAttribs.title)e.title=this.uiAttribs.title;if((this.preserveLinks||this.direction==c.PORT.PORT_DIR_OUT)&&this.links.length>0){e.links=[];for(const t in this.links){if(!this.links[t].ignoreInSerialize&&(this.links[t].portIn&&this.links[t].portOut))e.links.push(this.links[t].getSerialized())}}if(this.direction==P.DIR_IN&&this.links.length>0){for(const t in this.links){if(!this.links[t].portIn||!this.links[t].portOut)continue;const i=this.links[t].getOtherPort(this);if(i.op.isInBlueprint2&&this.op.isInBlueprint2){if(i.op.isInBlueprint2()&&!this.op.isInBlueprint2()){e.links=e.links||[];e.links.push(this.links[t].getSerialized())}}}}if(e.links&&e.links.length==0)delete e.links;if(this.type===P.TYPE_FUNCTION)delete e.value;if(this.type===P.TYPE_FUNCTION&&this.links.length==0)e=null;if(e&&Object.keys(e).length==1&&e.name)e=null;g(e);return e}shouldLink(t,e){return!!(t&&e)}removeLinks(){let t=0;while(this.links.length>0){t++;if(t>5e3){this.#log.warn("could not delete links... / infinite loop");this.links.length=0;break}this.links[0].remove()}}removeLink(e){for(let t=0;t<this.links.length;t++)if(this.links[t]==e)this.links.splice(t,1);if(this.direction==P.DIR_IN){if(this.type==P.TYPE_VALUE)this.setValue(this.#valueBeforeLink||0);else this.setValue(this.#valueBeforeLink||null)}if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();try{if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(P.EVENT_LINK_CHANGED);this.emitEvent(P.EVENT_LINK_REMOVED);this.#op.emitEvent(P.EVENT_LINK_CHANGED)}catch(t){this.#log.error(t)}}getName(){return this.name}getTitle(){if(this.uiAttribs.title)return this.uiAttribs.title;return this.name}addLink(t){this.#valueBeforeLink=this.value;this.links.push(t);if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();try{if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(P.EVENT_LINK_CHANGED);this.#op.emitEvent(P.EVENT_LINK_CHANGED)}catch(t){this.#log.error(t)}}getLinkTo(e){for(const t in this.links)if(this.links[t].portIn==e||this.links[t].portOut==e)return this.links[t]}removeLinkTo(e){for(const t in this.links){if(this.links[t].portIn==e||this.links[t].portOut==e){this.links[t].remove();if(CABLES.UI&&this.#op.checkLinkTimeWarnings)this.#op.checkLinkTimeWarnings();if(this.onLinkChanged)this.onLinkChanged();this.emitEvent(P.EVENT_LINK_CHANGED);this.emitEvent(P.EVENT_LINK_REMOVED);return}}}isLinkedTo(e){for(const t in this.links)if(this.links[t].portIn==e||this.links[t].portOut==e)return true;return false}_activity(){this.activityCounter++}trigger(){const e=this.links.length;this._activity();if(e===0)return;if(!this.#op.enabled)return;let i=null;try{for(let t=0;t<e;++t){if(this.links[t].portIn){i=this.links[t].portIn;i.op.patch.pushTriggerStack(i);if(!i._onTriggered){this.#log.log("no porttriggered?!",i,i._onTriggered)}else i._onTriggered();i.op.patch.popTriggerStack()}if(this.links[t])this.links[t].activity()}}catch(t){if(!i)return this.#log.error("unknown port error");i.op.enabled=false;i.op.setUiError("crash","op crashed, port exception "+i.name,3);if(this.#op.patch.isEditorMode()){if(i.op.onError)i.op.onError(t)}this.#log.error("exception in port: ",i.name,i.op.name,i.op.id);this.#log.error(t)}}call(){this.#log.warn("call deprecated - use trigger() ");this.trigger()}execute(){}setVariableName(t){this.#useVariableName=t;this.#op.patch.on("variableRename",(t,e)=>{if(t!=this.#useVariableName)return;this.#useVariableName=e})}getVariableName(){return this.#useVariableName}setVariable(t){this.setAnimated(false);const e={useVariable:false};if(this._variableIn&&this._varChangeListenerId){this._variableIn.off(this._varChangeListenerId);this._variableIn=null}if(t){this._variableIn=this.#op.patch.getVar(t);if(!this._variableIn){}else{if(this.type==P.TYPE_OBJECT){this._varChangeListenerId=this._variableIn.on("change",()=>{this.set(null);this.set(this._variableIn.getValue())})}else{this._varChangeListenerId=this._variableIn.on("change",this.set.bind(this))}this.set(this._variableIn.getValue())}this.#useVariableName=t;e.useVariable=true;e.variableName=this.#useVariableName}else{e.variableName=this.#useVariableName=null;e.useVariable=false}this.setUiAttribs(e);this.#op.patch.emitEvent("portSetVariable",this.#op,this,t)}_handleNoTriggerOpAnimUpdates(t){let e=false;if(!e){if(t)this._notriggerAnimUpdate=this.#op.patch.on("onRenderFrame",()=>{this.updateAnim()});else if(this._notriggerAnimUpdate)this._notriggerAnimUpdate=this.#op.patch.off(this._notriggerAnimUpdate)}}bindAnimListeners(){this.anim.on(u.EVENT_CHANGE,()=>{this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.#op.patch.updateAnimMaxTimeSoon()});this.anim.on(u.EVENT_KEY_DELETE,()=>{this.#op.patch.updateAnimMaxTimeSoon()})}setAnimated(t){let e=false;if(this.#animated!=t){this.#animated=t;this.#op.hasAnimPort=true;e=true}if(this.#animated&&!this.anim){this.anim=new u({name:"port "+this.name});this.bindAnimListeners()}if(this.#animated){let t=0;if(this.#op.patch.gui&&this.#op.patch.gui.glTimeline)t=this.#op.patch.timer.getTime();if(this.anim.keys.length==0)this.anim.setValue(t,this.value)}else{this.anim=null}this._handleNoTriggerOpAnimUpdates(t);this.#op.patch.emitEvent("portAnimToggle",this.#op,this,this.anim);this.setUiAttribs({isAnimated:this.#animated});if(e)this._onAnimToggle()}toggleAnim(){this.setAnimated(!this.#animated);this.setUiAttribs({isAnimated:this.#animated});this.#op.patch.emitEvent("portAnimUpdated",this.#op,this,this.anim);this.#op.patch.emitEvent("portAnimToggle",this.#op,this,this.anim)}getType(){return this.type}isLinked(){return this.links.length>0||this.#animated||this.#useVariableName!=null}isBoundToVar(){const t=this.#useVariableName!=null;this.uiAttribs.boundToVar=t;return t}isAnimated(){return this.#animated}isHidden(){return this.uiAttribs.hidePort}_onTriggered(t){this._activity();this.#op.updateAnims();if(this.#op.enabled&&this.onTriggered)this.onTriggered();if(this.#op.enabled)this.emitEvent("trigger",t)}onValueChange(t){this.onChange=t}hidePort(){}static portTypeNumberToString(t){if(t==P.TYPE_VALUE)return"value";if(t==P.TYPE_FUNCTION)return"function";if(t==P.TYPE_OBJECT)return"object";if(t==P.TYPE_ARRAY)return"array";if(t==P.TYPE_STRING)return"string";if(t==P.TYPE_DYNAMIC)return"dynamic";return"unknown"}static getTypeString(t){if(t==P.TYPE_VALUE)return"Number";if(t==P.TYPE_FUNCTION)return"Trigger";if(t==P.TYPE_OBJECT)return"Object";if(t==P.TYPE_DYNAMIC)return"Dynamic";if(t==P.TYPE_ARRAY)return"Array";if(t==P.TYPE_STRING)return"String";return"Unknown"}}class M extends e{#log=new l("link");constructor(t){super();this.id=CABLES.simpleId();this.portIn=null;this.portOut=null;this._patch=t;this.activityCounter=0;this.ignoreInSerialize=false}setValue(t){if(t===undefined)this._setValue();else this.portIn.set(t)}activity(){this.activityCounter++}_setValue(){if(!this.portOut){this.remove();return}const t=this.portOut.get();if(t==t){if(this.portIn.type!=P.TYPE_FUNCTION)this.activity();if(this.portIn.get()!==t){this.portIn.set(t)}else{if(this.portIn.changeAlways)this.portIn.set(t);if(this.portOut.forceRefChange)this.portIn.forceChange()}}}getOtherPort(t){if(t==this.portIn)return this.portOut;return this.portIn}remove(){if(this.portIn)this.portIn.removeLink(this);if(this.portOut)this.portOut.removeLink(this);if(this._patch){this._patch.emitEvent("onUnLink",this.portIn,this.portOut,this)}if(this.portIn&&(this.portIn.type==P.TYPE_OBJECT||this.portIn.type==P.TYPE_ARRAY)){this.portIn.set(null);if(this.portIn.links.length>0)this.portIn.set(this.portIn.links[0].getOtherPort(this.portIn).get())}if(this.portIn)this.portIn.op._checkLinksNeededToWork();if(this.portOut)this.portOut.op._checkLinksNeededToWork();this.portIn=null;this.portOut=null;this._patch=null}link(t,e){if(!M.canLink(t,e)){this.#log.warn("[core_link] cannot link ports!",t,e);return false}if(t.direction==P.DIR_IN){this.portIn=t;this.portOut=e}else{this.portIn=e;this.portOut=t}t.addLink(this);e.addLink(this);this.setValue();t.op._checkLinksNeededToWork();e.op._checkLinksNeededToWork()}getSerialized(){const t={};t.portIn=this.portIn.getName();t.portOut=this.portOut.getName();t.objIn=this.portIn.op.id;t.objOut=this.portOut.op.id;return t}static canLinkText(t,e){if(t.direction==e.direction){let t="(out)";if(e.direction==P.DIR_IN)t="(in)";return"can not link: same direction "+t}if(t.op==e.op)return"can not link: same op";if(t.type!=P.TYPE_DYNAMIC&&e.type!=P.TYPE_DYNAMIC){if(t.type!=e.type)return"can not link: different type"}if(CABLES.UI&&t.type==P.TYPE_OBJECT&&e.type==P.TYPE_OBJECT){if(t.uiAttribs.objType&&e.uiAttribs.objType)if(t.uiAttribs.objType!=e.uiAttribs.objType)return"incompatible objects"}if(!t)return"can not link: port 1 invalid";if(!e)return"can not link: port 2 invalid";if(t.direction==P.DIR_IN&&t.isAnimated())return"can not link: is animated";if(e.direction==P.DIR_IN&&e.isAnimated())return"can not link: is animated";if(t.isLinkedTo(e))return"ports already linked";if(t.canLink&&!t.canLink(e)||e.canLink&&!e.canLink(t))return"Incompatible";return"can link"}static canLink(t,e){if(!t)return false;if(!e)return false;if(t.direction==P.DIR_IN&&t.isAnimated())return false;if(e.direction==P.DIR_IN&&e.isAnimated())return false;if(t.isHidden()||e.isHidden())return false;if(t.isLinkedTo(e))return false;if(t.direction==e.direction)return false;if(CABLES.UI&&t.type==P.TYPE_OBJECT&&e.type==P.TYPE_OBJECT){if(t.uiAttribs.objType&&e.uiAttribs.objType){if(t.uiAttribs.objType.indexOf("sg_")==0&&e.uiAttribs.objType.indexOf("sg_")==0)return true;if(t.uiAttribs.objType!=e.uiAttribs.objType)return false}}if(t.type!=e.type&&(t.type!=P.TYPE_DYNAMIC&&e.type!=P.TYPE_DYNAMIC))return false;if(t.type==P.TYPE_DYNAMIC||e.type==P.TYPE_DYNAMIC)return true;if(t.op==e.op)return false;if(t.canLink&&!t.canLink(e))return false;if(e.canLink&&!e.canLink(t))return false;return true}}class R extends e{constructor(t){super();this._log=new l("LoadingStatus");this._loadingAssets={};this._cbFinished=[];this._assetTasks=[];this._percent=0;this._count=0;this._countFinished=0;this._order=0;this._startTime=0;this._patch=t;this._wasFinishedPrinted=false;this._loadingAssetTaskCb=false}setOnFinishedLoading(t){this._cbFinished.push(t)}getNumAssets(){return this._countFinished}getProgress(){return this._percent}checkStatus(){this._countFinished=0;this._count=0;for(const t in this._loadingAssets){this._count++;if(!this._loadingAssets[t].finished){this._countFinished++}}this._percent=(this._count-this._countFinished)/this._count;if(this._countFinished===0){for(let t=0;t<this._cbFinished.length;t++){if(this._cbFinished[t]){const e=this._cbFinished[t];setTimeout(()=>{e(this._patch);this.emitEvent("finishedAll")},100)}}if(!this._wasFinishedPrinted){this._wasFinishedPrinted=true;this.print()}this.emitEvent("finishedAll")}}getList(){let e=[];for(const t in this._loadingAssets){e.push(this._loadingAssets[t])}return e}getListJobs(){let e=[];for(const t in this._loadingAssets){if(!this._loadingAssets[t].finished)e.push(this._loadingAssets[t].name)}return e}print(){if(this._patch.config.silent)return;const e=[];for(const t in this._loadingAssets){e.push([this._loadingAssets[t].order,this._loadingAssets[t].type,this._loadingAssets[t].name,(this._loadingAssets[t].timeEnd-this._loadingAssets[t].timeStart)/1e3+"s"])}this._log.groupCollapsed("finished loading "+this._order+" assets in "+(Date.now()-this._startTime)/1e3+"s");this._log.table(e);this._log.groupEnd()}finished(t){const e=this._loadingAssets[t];if(e){if(e.finished)this._log.warn("loading job was already finished",e);if(e.op)e.op.setUiAttribs({loading:false});e.finished=true;e.timeEnd=Date.now()}this.checkStatus();this.emitEvent("finishedTask");return null}_startAssetTasks(){for(let t=0;t<this._assetTasks.length;t++)this._assetTasks[t]();this._assetTasks.length=0}addAssetLoadingTask(t){if(this._patch.isEditorMode()&&!CABLES.UI.loaded){this._assetTasks.push(t);if(!this._loadingAssetTaskCb)window.gui.addEventListener("uiloaded",this._startAssetTasks.bind(this));this._loadingAssetTaskCb=true}else{t()}this.emitEvent("addAssetTask")}existByName(e){for(let t in this._loadingAssets){if(this._loadingAssets[t].name==e&&!this._loadingAssets[t].finished)return true}}start(t,e,i){if(this._startTime==0)this._startTime=Date.now();const s=o();e=e||"unknown";if(e.length>100)e=e.substring(0,100);if(i)i.setUiAttrib({loading:true});this._loadingAssets[s]={id:s,op:i,type:t,name:e,finished:false,timeStart:Date.now(),order:this._order};this._order++;this.emitEvent("startTask");return s}}class it extends e{#name;constructor(t,e,i){super();this.#name=t;this.type=i;this.setValue(e)}addListener(t){this.on("change",t,"var")}getValue(){return this._v}get name(){return this.#name}getName(){return this.#name}setValue(t){this._v=t;this.emitEvent("change",t,this)}}const C=function(){return window.performance.now()};const N=function(){return C()};class O extends e{static EVENT_PLAY_PAUSE="playPause";static EVENT_TIME_CHANGED="timeChange";#lastTime=0;#timeOffset=0;#currentTime=0;#paused=true;#delay=0;#timeStart=0;#ts;constructor(){super();this.#timeStart=0;this.overwriteTime=-1}#internalNow(){if(this.#ts)return this.#ts;return C()}#getTime(){this.#lastTime=(this.#internalNow()-this.#timeStart)/1e3;return this.#lastTime+this.#timeOffset}setDelay(t){this.#delay=t;this.emitEvent(O.EVENT_TIME_CHANGED)}isPlaying(){return!this.#paused}update(t){if(t)this.#ts=t;if(this.#paused)return;this.#currentTime=this.#getTime();return this.#currentTime}getMillis(){return this.get()*1e3}get(){return this.getTime()}getTime(){if(this.overwriteTime>=0)return this.overwriteTime-this.#delay;return this.#currentTime-this.#delay}togglePlay(){if(this.#paused)this.play();else this.pause()}setTime(t){if(isNaN(t)||t<0)t=0;this.#timeStart=this.#internalNow();this.#timeOffset=t;this.#currentTime=t;this.emitEvent(O.EVENT_TIME_CHANGED)}setOffset(t){if(this.#currentTime+t<0){this.#timeStart=this.#internalNow();this.#timeOffset=0;this.#currentTime=0}else{this.#timeOffset+=t;this.#currentTime=this.#lastTime+this.#timeOffset}this.emitEvent(O.EVENT_TIME_CHANGED)}play(){this.#timeStart=this.#internalNow();this.#paused=false;this.emitEvent(O.EVENT_PLAY_PAUSE)}pause(){this.#timeOffset=this.#currentTime;this.#paused=true;this.emitEvent(O.EVENT_PLAY_PAUSE)}static now(){return window.performance.now()}}class L extends e{static EVENT_OP_DELETED="onOpDelete";static EVENT_OP_ADDED="onOpAdd";static EVENT_PAUSE="pause";static EVENT_RESUME="resume";static EVENT_PATCHLOADEND="patchLoadEnd";static EVENT_VARIABLES_CHANGED="variablesChanged";static EVENT_RENDER_FRAME="onRenderFrame";static EVENT_RENDERED_ONE_FRAME="renderedOneFrame";static EVENT_LINK="onLink";static EVENT_VALUESSET="loadedValueSet";static EVENT_DISPOSE="dispose";static EVENT_ANIM_MAXTIME_CHANGE="animmaxtimechange";static EVENT_INIT_CGL="INIT_CGL";#log;#renderOneFrame=false;#initialDeserialize=true;ops=[];settings={};animMaxTime=0;missingClipAnims={};profiler=null;aborted=false;_crashedOps=[];animFrameOps=[];_animReq=null;_opIdCache={};_triggerStack=[];storeObjNames=false;_volumeListeners=[];namedTriggers={};_origData=null;tempData={};frameStore={};constructor(t){super();this.renderloop=null;this.config=t||{glCanvasResizeToWindow:false,prefixAssetPath:"",prefixJsPath:"",silent:true,onError:null,onFinishedLoading:null,onFirstFrameRendered:null,onPatchLoaded:null,fpsLimit:0};this.#log=new l("core_patch",{onError:t.onError});this.timer=new O;this.freeTimer=new O;this.gui=null;CABLES.logSilent=this.silent=true;this.loading=new R(this);if(!function(){return!this}())this.#log.warn("not in strict mode: core patch");if(this.config.hasOwnProperty("silent"))this.silent=CABLES.logSilent=this.config.silent;if(!this.config.hasOwnProperty("doRequestAnimation"))this.config.doRequestAnimation=true;if(!this.config.prefixAssetPath)this.config.prefixAssetPath="";if(!this.config.prefixJsPath)this.config.prefixJsPath="";if(!this.config.masterVolume)this.config.masterVolume=1;this._variables={};this.vars={};if(t&&t.vars)this.vars=t.vars;this.cgl=null;this.cgp=null;this._subpatchOpCache={};window.dispatchEvent(new CustomEvent(L.EVENT_INIT_CGL,{detail:this}));this.loading.setOnFinishedLoading(this.config.onFinishedLoading);if(!CABLES.OPS){this.aborted=true;throw new Error("no CABLES.OPS found")}this.freeTimer.play();if(this.config.patch){this.deSerialize(this.config.patch)}else if(this.config.patchFile){I(this.config.patchFile,(t,e)=>{try{const i=JSON.parse(e);if(t){const s="";this.#log.error("err",t);this.#log.error("data",i);this.#log.error("data",i.msg);return}this.deSerialize(i)}catch(t){this.#log.error("could not load/parse patch ",t)}})}this.timer.play();console.log("made with https://cables.gl");this.cg=undefined}static getGui(){return window.gui}isPlaying(){if(this.renderloop)return!this.renderloop.paused;return false}renderOneFrame(){}isEditorMode(){return this.config.editorMode===true}pause(){this.emitEvent(L.EVENT_PAUSE);if(this.renderloop)this.renderloop.pause();this.freeTimer.pause()}resume(){this.freeTimer.play();this.emitEvent(L.EVENT_RESUME);if(this.renderloop)this.renderloop.resume()}setVolume(e){this.config.masterVolume=e;for(let t=0;t<this._volumeListeners.length;t++)this._volumeListeners[t].onMasterVolumeChanged(e)}getAssetPath(e=null){if(this.config.hasOwnProperty("assetPath")){return this.config.assetPath}else if(this.isEditorMode()){let t=e||L.getGui().project()._id;return"/assets/"+t+"/"}else if(document.location.href.indexOf("cables.gl")>0||document.location.href.indexOf("cables.local")>0){const i=document.location.pathname.split("/");let t=e||i[i.length-1];return"/assets/"+t+"/"}else{return"assets/"}}getJsPath(){if(this.config.hasOwnProperty("jsPath")){return this.config.jsPath}else{return"js/"}}getFilePath(t){if(!t)return t;t=String(t);if(t.indexOf("https:")===0||t.indexOf("http:")===0)return t;if(t.indexOf("data:")===0)return t;if(t.indexOf("file:")===0)return t;t=t.replace("//","/");if(t.startsWith(this.config.prefixAssetPath))t=t.replace(this.config.prefixAssetPath,"");return this.config.prefixAssetPath+t+(this.config.suffixAssetPath||"")}clear(){this.emitEvent("patchClearStart");this.animFrameOps.length=0;this.timer=new O;while(this.ops.length>0)this.deleteOp(this.ops[0].id);this._opIdCache={};this.emitEvent("patchClearEnd")}createOp(t,e,i=null){let s=null;let r="";try{if(!t){console.error("createop identifier false",t);console.log((new Error).stack);return}if(t.indexOf("Ops.")===-1){const n=t;if(CABLES.OPS[n]){r=CABLES.OPS[n].objName;try{s=new CABLES.OPS[n].f(this,r,e,n)}catch(t){this._crashedOps.push(r);this.#log.error("[instancing error] constructor: "+r,t);if(!this.isEditorMode()){this.#log.error("INSTANCE_ERR","Instancing Error: "+r,t)}else{s=new CABLES.Op(this,r,e);s.setUiError("instancingError","Failed to instanciate op",3);s.setEnabled(false);if(this.#initialDeserialize)L.getGui().patchView.store.opCrashed=true}}s.opId=n}else{if(i){t=i;this.#log.warn("could not find op by id: "+n)}else{throw new Error("could not find op by id: "+n,{cause:"opId:"+n})}}}if(!s){r=t;const a=t.split(".");const o=L.getOpClass(r);if(!o){this.emitEvent("criticalError",{title:"Unknown op: "+r,text:"Unknown op: "+r});this.#log.error("unknown op: "+r);throw new Error("unknown op: "+r)}else{s=new o(this,r,e)}if(s){s.opId=null;for(const t in CABLES.OPS){if(CABLES.OPS[t].objName==r)s.opId=t}}}}catch(t){this._crashedOps.push(r);this.#log.error("[instancing error] "+r,t);if(!this.isEditorMode()){this.#log.error("INSTANCE_ERR","Instancing Error: "+r,t)}else{if(this.#initialDeserialize)L.getGui().patchView.store.opCrashed=true}}if(s){s._objName=r;s.patch=this}else{this.#log.log("no op was created!?",t,e)}return s}addOp(t,e,i,s=false,r=null){const n=this.createOp(t,i,r);if(n){e=e||{};if(e.hasOwnProperty("errors"))delete e.errors;if(e.hasOwnProperty("error"))delete e.error;e.subPatch=e.subPatch||0;n.setUiAttribs(e);if(n.onCreate)n.onCreate();if(n.hasOwnProperty("onAnimFrame")&&n.onAnimFrame)this.addOnAnimFrame(n);if(n.hasOwnProperty("onMasterVolumeChanged"))this._volumeListeners.push(n);if(this._opIdCache[n.id]){this.#log.warn("opid with id "+n.id+" already exists in patch!");this.deleteOp(n.id)}this.ops.push(n);this._opIdCache[n.id]=n;if(this._subPatchCacheAdd)this._subPatchCacheAdd(e.subPatch,n);this.emitEvent(L.EVENT_OP_ADDED,n,s);if(n.init)n.init();n.emitEvent(y.EVENT_INIT,s)}else{this.#log.error("addop: op could not be created: ",t)}return n}addOnAnimFrame(e){for(let t=0;t<this.animFrameOps.length;t++)if(this.animFrameOps[t]==e){return}this.animFrameOps.push(e)}removeOnAnimFrame(e){for(let t=0;t<this.animFrameOps.length;t++){if(this.animFrameOps[t]==e){this.animFrameOps.splice(t,1);return}}}addOnAnimFrameCallback(t){this.animFrameCallbacks.push(t)}removeOnAnimCallback(e){for(let t=0;t<this.animFrameCallbacks.length;t++){if(this.animFrameCallbacks[t]==e){this.animFrameCallbacks.splice(t,1);return}}}updateAnimMaxTimeSoon(){if(this.toAnimMaxTime)clearTimeout(this.toAnimMaxTime);this.toAnimMaxTime=setTimeout(()=>{this.updateAnimMaxTime()},50)}updateAnimMaxTime(){let i=0;for(let e=0;e<this.ops.length;e++){if(this.ops[e].hasAnimPort){for(let t=0;t<this.ops[e].portsIn.length;t++){if(this.ops[e].portsIn[t].anim){if(this.ops[e].portsIn[t].anim.lastKey&&this.ops[e].portsIn[t].anim.lastKey.time>i){i=this.ops[e].portsIn[t].anim.lastKey.time}}}}}if(i!=this.animMaxTime){this.animMaxTime=i;this.emitEvent(L.EVENT_ANIM_MAXTIME_CHANGE)}}deleteOp(s,r,n){let a=false;for(let i=0;i<this.ops.length;i++){if(this.ops[i].id==s){const o=this.ops[i];let t=null;let e=null;if(o){a=true;if(r){if(o.portsIn.length>0&&o.getFirstPortIn()&&o.getFirstPortIn().isLinked()&&(o.portsOut.length>0&&o.getFirstPortOut()&&o.getFirstPortOut().isLinked())){if(o.getFirstPortIn().getType()==o.getFirstPortOut().getType()&&o.getFirstPortIn().isLinked()){t=o.getFirstPortIn()?.links[0]?.getOtherPort(o.getFirstPortIn());e=o.getFirstPortOut()?.links[0]?.getOtherPort(o.getFirstPortOut())}}}const h=this.ops[i];h.removeLinks();this.ops.splice(i,1);h.emitEvent("delete",h);this.emitEvent(L.EVENT_OP_DELETED,h,n);if(this.clearSubPatchCache)this.clearSubPatchCache(h.uiAttribs.subPatch);if(h.onDelete)h.onDelete(n);h.cleanUp();if(t&&e&&t.op&&e.op){this.link(t.op,t.getName(),e.op,e.getName())}delete this._opIdCache[s];break}}}if(!a)this.#log.warn("core patch deleteop: not found...",s)}getFrameNum(){if(this.renderloop)return this.renderloop.frameNum}updateAnims(e,i,t){if(!this.renderloop)return;this.timer.update(t);this.freeTimer.update(t);e=e||this.timer.getTime();for(let t=0;t<this.animFrameOps.length;++t)if(this.animFrameOps[t].onAnimFrame)this.animFrameOps[t].onAnimFrame(e,this.renderloop.frameNum,i)}link(t,e,i,s,r=false,n=false){if(!t)return this.#log.warn("link: op1 is null ");if(!i)return this.#log.warn("link: op2 is null");const a=t.getPort(e,r);const o=i.getPort(s,r);if(!a)return this.#log.warn("port1 not found! "+e+" ("+t.objName+")");if(!o)return this.#log.warn("port2 not found! "+s+" of "+i.name+"("+i.objName+")",i);if(!a.shouldLink(a,o)||!o.shouldLink(a,o))return false;if(M.canLink(a,o)){const h=new M(this);if(a&&o)h.link(a,o);this.emitEvent(L.EVENT_LINK,a,o,h,n);return h}}serialize(t){const e={};t=t||{};e.ops=[];e.settings=this.settings;for(let t=0;t<this.ops.length;t++){const i=this.ops[t];if(i&&i.getSerialized)e.ops.push(i.getSerialized())}g(e);if(t.asObject)return e;return JSON.stringify(e)}getOpsByRefId(e){const i=[];for(let t=0;t<this.ops.length;t++)if(this.ops[t].storage&&this.ops[t].storage.ref==e)i.push(this.ops[t]);return i}getOpById(t){return this._opIdCache[t]}getOpsByObjName(e){const i=[];for(let t=0;t<this.ops.length;t++)if(this.ops[t].objName==e)i.push(this.ops[t]);return i}getOpsByOpId(e){const i=[];for(let t=0;t<this.ops.length;t++)if(this.ops[t].opId==e)i.push(this.ops[t]);return i}getSubPatchOpsByName(e,i){const s=[];for(let t=0;t<this.ops.length;t++)if(this.ops[t].uiAttribs&&this.ops[t].uiAttribs.subPatch==e&&this.ops[t].objName==i)s.push(this.ops[t]);return s}getSubPatchOp(t,e){return this.getFirstSubPatchOpByName(t,e)}getFirstSubPatchOpByName(e,i){for(let t=0;t<this.ops.length;t++)if(this.ops[t].uiAttribs&&this.ops[t].uiAttribs.subPatch==e&&this.ops[t].objName==i)return this.ops[t];return null}_addLink(t,e,i,s){return this.link(this.getOpById(t),i,this.getOpById(e),s,false,true)}logStartup(t){if(window.logStartup)window.logStartup(t)}deSerialize(a,t={genIds:false,createRef:false}){if(this.aborted)return;const s=[];const e=this.loading.start("core","deserialize");if(typeof a==="string")a=JSON.parse(a);if(this.#initialDeserialize){this.namespace=a.namespace||"";this.name=a.name||"";this.settings=a.settings}this.emitEvent("patchLoadStart");a.ops=a.ops||[];this.logStartup("add "+a.ops.length+" ops... ");const r=[];for(let i=0;i<a.ops.length;i++){const n=CABLES.now();const o=a.ops[i];let e=null;try{if(o.opId)e=this.addOp(o.opId,o.uiAttribs,o.id,true,o.objName);else e=this.addOp(o.objName,o.uiAttribs,o.id,true)}catch(t){this.#log.error("[instancing error] op data:",o,t)}if(e){r.push(e);if(t.genIds)e.id=E();e.portsInData=o.portsIn;e._origData=structuredClone(o);e.storage=o.storage;if(o.portsIn)for(let t=0;t<o.portsIn.length;t++){const l=o.portsIn[t];if(l&&l.hasOwnProperty("name")){const u=e.getPort(l.name);if(u&&(u.uiAttribs.display=="bool"||u.uiAttribs.type=="bool")&&!isNaN(l.value))l.value=l.value==true?1:0;if(u&&l.value!==undefined&&u.type!=P.TYPE_TEXTURE)u.set(l.value);if(u){u.deSerializeSettings(l)}else{e.preservedPortValues=e.preservedPortValues||{};e.preservedPortValues[l.name]=l.value}}}if(o.portsOut)for(let t=0;t<o.portsOut.length;t++){const l=o.portsOut[t];if(l&&l.hasOwnProperty("name")){const c=e.getPort(l.name);if(c){c.deSerializeSettings(l);if(c.uiAttribs.hasOwnProperty("title")){e.preservedPortTitles=e.preservedPortTitles||{};e.preservedPortTitles[c.name]=c.uiAttribs.title}if(c.type!=P.TYPE_TEXTURE&&l.hasOwnProperty("value"))c.set(a.ops[i].portsOut[t].value);if(l.expose)c.setUiAttribs({expose:true})}}}s.push(e)}const h=Math.round(100*(CABLES.now()-n))/100;if(!this.silent&&h>5)console.log("long op init ",a.ops[i].objName,h)}this.logStartup("add ops done");for(let t=0;t<this.ops.length;t++){if(this.ops[t].onLoadedValueSet){this.ops[t].onLoadedValueSet(this.ops[t]._origData);this.ops[t].onLoadedValueSet=null;this.ops[t]._origData=null}this.ops[t].emitEvent(L.EVENT_VALUESSET)}this.logStartup("creating links");if(t.opsCreated)t.opsCreated(r);if(a.ops){for(let n=0;n<a.ops.length;n++){if(a.ops[n].portsIn){for(let e=0;e<a.ops[n].portsIn.length;e++){if(a.ops[n].portsIn[e]&&a.ops[n].portsIn[e].links){for(let t=0;t<a.ops[n].portsIn[e].links.length;t++){this._addLink(a.ops[n].portsIn[e].links[t].objIn,a.ops[n].portsIn[e].links[t].objOut,a.ops[n].portsIn[e].links[t].portIn,a.ops[n].portsIn[e].links[t].portOut)}}}}if(a.ops[n].portsOut)for(let r=0;r<a.ops[n].portsOut.length;r++)if(a.ops[n].portsOut[r]&&a.ops[n].portsOut[r].links){for(let s=0;s<a.ops[n].portsOut[r].links.length;s++){if(a.ops[n].portsOut[r].links[s]){if(a.ops[n].portsOut[r].links[s].subOpRef){const f=this.getOpById(a.ops[n].portsOut[r].links[s].objOut);let e=null;let i=0;for(let t=0;t<this.ops.length;t++){if(this.ops[t].storage&&this.ops[t].storage.ref==a.ops[n].portsOut[r].links[s].subOpRef&&f.uiAttribs.subPatch==this.ops[t].uiAttribs.subPatch){i=this.ops[t].patchId.get();break}}for(let t=0;t<this.ops.length;t++){if(this.ops[t].storage&&this.ops[t].storage.ref==a.ops[n].portsOut[r].links[s].refOp&&this.ops[t].uiAttribs.subPatch==i){e=this.ops[t];break}}if(!e)this.#log.warn("could not find op for lost link");else{this._addLink(e.id,a.ops[n].portsOut[r].links[s].objOut,a.ops[n].portsOut[r].links[s].portIn,a.ops[n].portsOut[r].links[s].portOut)}}else{const i=this._addLink(a.ops[n].portsOut[r].links[s].objIn,a.ops[n].portsOut[r].links[s].objOut,a.ops[n].portsOut[r].links[s].portIn,a.ops[n].portsOut[r].links[s].portOut);if(!i){const g=this.getOpById(a.ops[n].portsOut[r].links[s].objIn);const d=this.getOpById(a.ops[n].portsOut[r].links[s].objOut);if(!g)console.log("could not find link op1");if(!d)console.log("could not find link op2");const _=a.ops[n].portsOut[r].links[s].portIn;if(g&&!g.getPort(_)){g.preservedPortLinks[_]=g.preservedPortLinks[_]||[];g.preservedPortLinks[_].push(a.ops[n].portsOut[r].links[s])}const m=a.ops[n].portsOut[r].links[s].portOut;if(d&&!d.getPort(m)){d.preservedPortLinks[_]=d.preservedPortLinks[_]||[];d.preservedPortLinks[_].push(a.ops[n].portsOut[r].links[s])}}}}}}}}this.logStartup("calling ops onloaded");for(let t=0;t<this.ops.length;t++){if(this.ops[t].onLoaded){this.ops[t].onLoaded();this.ops[t].onLoaded=null}}this.logStartup("initializing ops...");for(let t=0;t<this.ops.length;t++){if(this.ops[t].init){try{this.ops[t].init();this.ops[t].init=null}catch(t){console.error("op.init crash",t)}}}this.logStartup("initializing vars...");if(this.config.variables)for(const p in this.config.variables)this.setVarValue(p,this.config.variables[p]);this.logStartup("initializing var ports");for(let t=0;t<this.ops.length;t++){this.ops[t].initVarPorts();delete this.ops[t].uiAttribs.pasted}setTimeout(()=>{this.loading.finished(e)},100);this.updateAnimMaxTime();if(this.config.onPatchLoaded)this.config.onPatchLoaded(this);this.emitEvent(L.EVENT_PATCHLOADEND,s,a,t.genIds);this.#initialDeserialize=false}setVariable(t,e){if(this._variables[t]!==undefined){this._variables[t].setValue(e)}else{this.#log.warn("variable "+t+" not found!")}}_sortVars(){if(!this.isEditorMode())return;const e={};Object.keys(this._variables).sort((t,e)=>{return t.localeCompare(e,"en",{sensitivity:"base"})}).forEach(t=>{e[t]=this._variables[t]});this._variables=e}hasVar(t){return this._variables[t]!==undefined}setVarValue(t,e,i){if(this.hasVar(t)){this._variables[t].setValue(e)}else{this._variables[t]=new it(t,e,i);this._sortVars();this.emitEvent(L.EVENT_VARIABLES_CHANGED)}return this._variables[t]}getVarValue(t,e){if(this._variables.hasOwnProperty(t))return this._variables[t].getValue()}getVar(t){if(this._variables.hasOwnProperty(t))return this._variables[t]}deleteVar(i){for(let e=0;e<this.ops.length;e++)for(let t=0;t<this.ops[e].portsIn.length;t++)if(this.ops[e].portsIn[t].getVariableName()==i)this.ops[e].portsIn[t].setVariable(null);delete this._variables[i];this.emitEvent("variableDeleted",i);this.emitEvent("variablesChanged")}getVars(e){if(e===undefined)return this._variables;if(e===1)return{};const i=[];let s="";if(e==P.TYPE_STRING)s="string";else if(e==P.TYPE_VALUE)s="number";else if(e==P.TYPE_ARRAY)s="array";else if(e==P.TYPE_OBJECT)s="object";else if(e==P.TYPE_DYNAMIC)s="dynamic";else{console.log("unknown port type",e);console.log((new Error).stack)}for(const t in this._variables){if(!this._variables[t].type||this._variables[t].type==s||this._variables[t].type==e)i.push(this._variables[t])}return i}preRenderOps(){this.#log.log("prerendering...");for(let t=0;t<this.ops.length;t++){if(this.ops[t].preRender){this.ops[t].preRender();this.#log.log("prerender "+this.ops[t].objName)}}}dispose(){this.pause();this.clear();this.emitEvent(L.EVENT_DISPOSE)}pushTriggerStack(t){this._triggerStack.push(t)}popTriggerStack(){this._triggerStack.pop()}printTriggerStack(){if(this._triggerStack.length==0){return}console.groupCollapsed("trigger port stack "+this._triggerStack[this._triggerStack.length-1].op.objName+"."+this._triggerStack[this._triggerStack.length-1].name);const e=[];for(let t=0;t<this._triggerStack.length;t++){e.push(t+". "+this._triggerStack[t].op.objName+" "+this._triggerStack[t].name)}console.table(e);console.groupEnd()}get containerElement(){if(this.config.containerElement)return this.config.containerElement;if(this.cg&&this.cg.canvas.parentElement)return this.cg.canvas.parentElement;if(this.cgl&&this.cgl.canvas.parentElement)return this.cgl.canvas.parentElement;return document.body}getDocument(){return this.containerElement.ownerDocument}static getOpClass(t){const e=t.split(".");let i=null;try{if(e.length==2)i=window[e[0]][e[1]];else if(e.length==3)i=window[e[0]][e[1]][e[2]];else if(e.length==4)i=window[e[0]][e[1]][e[2]][e[3]];else if(e.length==5)i=window[e[0]][e[1]][e[2]][e[3]][e[4]];else if(e.length==6)i=window[e[0]][e[1]][e[2]][e[3]][e[4]][e[5]];else if(e.length==7)i=window[e[0]][e[1]][e[2]][e[3]][e[4]][e[5]][e[6]];else if(e.length==8)i=window[e[0]][e[1]][e[2]][e[3]][e[4]][e[5]][e[6]][e[7]];else if(e.length==9)i=window[e[0]][e[1]][e[2]][e[3]][e[4]][e[5]][e[6]][e[7]][e[8]];else if(e.length==10)i=window[e[0]][e[1]][e[2]][e[3]][e[4]][e[5]][e[6]][e[7]][e[8]][e[9]];return i}catch(t){return null}}static replaceOpIds(s,r){const e={};for(const t in s.ops){e[s.ops[t].id]=s.ops[t]}for(const i in s.ops){for(const o in s.ops[i].portsOut){const h=s.ops[i].portsOut[o].links;if(h){let t=h.length;while(t--){if(h[t]&&(!e[h[t].objIn]||!e[h[t].objOut])){if(!r.doNotUnlinkLostLinks){h.splice(t,1)}else{if(r.fixLostLinks){const l=L.getGui().corePatch().getOpById(h[t].objIn);if(!l)console.log("op not found!");else{const u=L.getGui().patchView.getSubPatchOuterOp(l.uiAttribs.subPatch);if(u){l.storage=l.storage||{};l.storage.ref=l.storage.ref||E();h[t].refOp=l.storage.ref;h[t].subOpRef=u.storage.ref}}}}}}}}}for(const e in s.ops){const l=s.ops[e];const c=l.id;let t=E();if(r.prefixHash)t=m(r.prefixHash+c);else if(r.prefixId)t=r.prefixId+c;else if(r.refAsId){if(l.storage&&l.storage.ref){t=l.storage.ref;delete l.storage.ref}else{l.storage=l.storage||{};l.storage.ref=t=E()}}const f=l.id=t;if(r.oldIdAsRef){l.storage=l.storage||{};l.storage.ref=c}for(const i in s.ops){if(s.ops[i].portsIn)for(const o in s.ops[i].portsIn){if(s.ops[i].portsIn[o].links){let t=s.ops[i].portsIn[o].links.length;while(t--)if(s.ops[i].portsIn[o].links[t]===null)s.ops[i].portsIn[o].links.splice(t,1);for(t in s.ops[i].portsIn[o].links){if(s.ops[i].portsIn[o].links[t].objIn===c)s.ops[i].portsIn[o].links[t].objIn=f;if(s.ops[i].portsIn[o].links[t].objOut===c)s.ops[i].portsIn[o].links[t].objOut=f}}}if(s.ops[i].portsOut)for(const o in s.ops[i].portsOut){if(s.ops[i].portsOut[o].links){let t=s.ops[i].portsOut[o].links.length;while(t--)if(s.ops[i].portsOut[o].links[t]===null)s.ops[i].portsOut[o].links.splice(t,1);for(t in s.ops[i].portsOut[o].links){if(s.ops[i].portsOut[o].links[t].objIn===c)s.ops[i].portsOut[o].links[t].objIn=f;if(s.ops[i].portsOut[o].links[t].objOut===c)s.ops[i].portsOut[o].links[t].objOut=f}}}}}const n=[];const a=[];for(let i=0;i<s.ops.length;i++){if(s.ops[i].storage&&s.ops[i].storage.subPatchVer){for(let e=0;e<s.ops[i].portsIn.length;e++){if(s.ops[i].portsIn[e].name==="patchId"){let t=E();if(r.prefixHash)t=m(r.prefixHash+s.ops[i].portsIn[e].value);const g=s.ops[i].portsIn[e].value;const d=s.ops[i].portsIn[e].value=t;n.push(d);for(let t=0;t<s.ops.length;t++){if(s.ops[t].uiAttribs){if(s.ops[t].uiAttribs.subPatch===g){s.ops[t].uiAttribs.subPatch=d;a.push(s.ops[t].id)}}}}}}}for(const _ in s.ops){let e=false;for(let t=0;t<a.length;t++){if(s.ops[_].id===a[t]){e=true;break}}if(!e&&s.ops[_].uiAttribs&&r.parentSubPatchId!=null)s.ops[_].uiAttribs.subPatch=r.parentSubPatchId}return s}}class st extends P{constructor(t,e,i,s,r){super(t,e,i,s);this.get=()=>{let t=super.get();if(CABLES.UI){if(t===""||t===null||t===undefined||s.values&&s.values.indexOf(String(t))===-1){this.op.setUiError("invalidswitch","Invalid Value ["+this.name+']: "'+t+'"',1)}else this.op.setUiError("invalidswitch",null)}if(t===null||t===undefined)t="";return t};this.indexPort=r;this.indexPort.set=t=>{const e=s.values;if(!e){return}let i=Math.floor(t);i=Math.min(i,e.length-1);i=Math.max(i,0);this.indexPort.setValue(i);this.set(e[i]);if(this.op.patch.isEditorMode()&&performance.now()-(this.lastTime||0)>100&&L.getGui()&&L.getGui().patchView.isCurrentOp(this.op)){L.getGui().opParams.show(this.op);this.lastTime=performance.now()}}}setUiAttribs(t){const e=t.hidePort;t.hidePort=true;super.setUiAttribs(t);if(typeof e!=="undefined")this.indexPort.setUiAttribs({hidePort:e})}}const F=2;class rt extends P{constructor(t,i,s,r,e,n){super(t,i,P.TYPE_ARRAY,e);this._log=new l("multiport old");this.setUiAttribs({multiPort:true,group:this.name,order:-1});this.ports=[];this.direction=r;this._uiAttribsPorts=n;const a=()=>{const e=[];let i=1;if(this.uiAttribs.multiPortManual)i=0;for(let t=0;t<this.ports.length-i;t++)e[t]=this.ports[t];this.setRef(e)};const o=()=>{let n=!this.uiAttribs.multiPortManual||false;if(this.direction==c.PORT.PORT_DIR_OUT)n=false;for(let r=0;r<this.ports.length;r++){let t;let e=false;let i;let s={};if(this.op.preservedPortTitles&&this.op.preservedPortTitles[this.ports[r].name])i=this.op.preservedPortTitles[this.ports[r].name];if(r==0)t=this.ports.length;if(!this.uiAttribs.multiPortManual)if(r==this.ports.length-1){i="add port";e=true;n=true}for(const a in this._uiAttribsPorts){s[a]=this._uiAttribsPorts[a]}s.addPort=e;s.longPort=t;s.title=i;s.greyout=n;s.group=this.name;this.ports[r].setUiAttribs(s)}};this.removeInvalidPorts=()=>{for(let t=0;t<this.ports.length;t++){if(!this.ports[t])this.ports.splice(t,1)}if(!this.uiAttribs.multiPortManual){if(this.ports.length>F)for(let t=this.ports.length-1;t>1;t--){if(!this.ports[t].isLinked())this.uiAttribs.multiPortNum=t;else break}}a()};this.countPorts=()=>{const t=L.getGui();if(CABLES.UI&&!t.isRemoteClient&&t.patchView&&t.patchView.patchRenderer&&t.patchView.patchRenderer.isDraggingPort()){clearTimeout(this.retryTo);this.retryTo=setTimeout(this.countPorts.bind(this));return}this.retryTo=null;let i=false;this.removeListeners();this.removeInvalidPorts();for(let t=0;t<this.ports.length;t++){if(this.ports[t]&&this.ports[t].links.length>1){const s=this.ports[t+1];const r=this.ports[t].links[0].getOtherPort(this.ports[t]);if(!s||!r){this._log.warn("no port found?")}else{this.ports[t].links[0].remove();this.op.patch.link(this.op,s.name,r.op,r.name);i=true}break}}if(!this.uiAttribs.multiPortManual){let e=true;while(e){e=false;for(let t=this.ports.length-1;t>1;t--){if(this.ports[t]&&this.ports[t].links.length>0&&this.ports[t-1].links.length==0){const r=this.ports[t].links[0].getOtherPort(this.ports[t]);this.ports[t].links[0].remove();const s=this.ports[t-1];if(s&&this.ports[t]){this.op.patch.link(this.op,s.name,r.op,r.name);e=true;i=true;break}}}}}if(!this.uiAttribs.multiPortManual){while(this.ports.length>F&&!this.ports[this.ports.length-1].isLinked()&&!this.ports[this.ports.length-2].isLinked()){let t=this.ports.length-1;if(!this.ports[t].isLinked()&&this.ports[t-1]&&!this.ports[t-1].isLinked()){this.ports[t].setUiAttribs({removed:true});this.ports[t].remove();this.ports.splice(t,1)}}}this.removeInvalidPorts();if(!this.uiAttribs.multiPortManual&&this.ports.length>0&&this.ports[this.ports.length-1].isLinked())this.newPort();a();o();if(i)this.countPorts();else this.addListeners()};this.removeListeners=()=>{for(let t=0;t<this.ports.length;t++){const e=this.ports[t];if(e.multiPortChangeListener)e.multiPortChangeListener=e.off(e.multiPortChangeListener);if(e.multiLinkChangeListener)e.multiLinkChangeListener=e.off(e.multiLinkChangeListener)}};this.addListeners=()=>{for(let t=0;t<this.ports.length;t++){const e=this.ports[t];const i=t;if(e.multiPortChangeListener)e.multiPortChangeListener=e.off(e.multiPortChangeListener);e.multiPortChangeListener=e.on("change",a.bind(this));if(e.multiPortTriggerListener)e.multiPortTriggerListener=e.off(e.multiPortTriggerListener);e.multiPortTriggerListener=e.on("trigger",()=>{this._onTriggered()});if(e.multiLinkChangeListener)e.multiLinkChangeListener=e.off(e.multiLinkChangeListener);e.multiLinkChangeListener=e.on("onLinkChanged",()=>{this.countPorts();this.emitEvent("onLinkChanged")});if(e.multiLinkRemoveListener)e.multiLinkRemoveListener=e.off(e.multiLinkRemoveListener);e.multiLinkRemoveListener=e.on("onLinkRemoved",()=>{o();this.emitEvent("onLinkChanged")})}};this.newPort=()=>{const t={};t.type=s;const e=this.op.newPort(this.op,i+"_"+this.ports.length,s,t);e.direction=r;if(this.direction==c.PORT.PORT_DIR_OUT)this.op.addOutPort(e);else this.op.addInPort(e,this.ports[this.ports.length-1]);this.ports.push(e);if(s==P.TYPE_NUMBER)e.setInitialValue(0);else if(s==P.TYPE_STRING)e.setInitialValue("");this.addListeners();o();a();this.emitEvent("onLinkChanged");if(this.op.preservedPortTitles&&this.op.preservedPortTitles[e.name])e.setUiAttribs({title:this.op.preservedPortTitles[e.name]});return e};this.initPorts=()=>{for(let t=0;t<F;t++)this.newPort();a();o()};this.checkNum=()=>{this.uiAttribs.multiPortNum=Math.max(F,this.uiAttribs.multiPortNum);while(this.ports.length<this.uiAttribs.multiPortNum)this.newPort();while(this.ports.length>this.uiAttribs.multiPortNum)if(this.ports[this.ports.length-1])this.ports.pop().remove();this.removeInvalidPorts()};this.incDec=t=>{this.uiAttribs.multiPortNum=this.uiAttribs.multiPortNum||F;this.setUiAttribs({multiPortNum:this.uiAttribs.multiPortNum+t});this.checkNum();o()};this.toggleManual=()=>{this.setUiAttribs({multiPortManual:!this.uiAttribs.multiPortManual});this.op.refreshParams()};this.on("onUiAttrChange",t=>{if(t.hasOwnProperty("multiPortManual")){o();this.removeInvalidPorts();this.checkNum();this.countPorts();o()}});this.on("onUiAttrChange",this.checkNum.bind(this));this.checkNum();this.countPorts();this.removeInvalidPorts();o()}}class nt extends P{constructor(t,s,r,n,e,i,a=1){super(t,s,P.TYPE_ARRAY,e);this._log=new l("multiport2");this.setUiAttribs({multiPort2:true,multiPort:true,group:this.name,order:-1,multiPortManual:true});this.minNumPorts=a;this.ports=[];this.direction=n;this._uiAttribsPorts=i;const o=()=>{const e=[];let i=1;for(let t=0;t<this.ports.length-i;t++)e[t]=this.ports[t];this.setRef(e)};const h=()=>{for(let n=0;n<this.ports.length;n++){let t;let e=false;let i;let s=false;let r={};if(this.op.preservedPortTitles&&this.op.preservedPortTitles[this.ports[n].name])i=this.op.preservedPortTitles[this.ports[n].name];if(n==0)t=this.ports.length;if(n==this.ports.length-1){i="add port";e=true;s=true}for(const a in this._uiAttribsPorts)r[a]=this._uiAttribsPorts[a];r.addPort=e;r.longPort=t;r.title=i;r.greyout=s;r.group=this.name;this.ports[n].setUiAttribs(r)}};this.removeInvalidPorts=()=>{for(let t=0;t<this.ports.length;t++)if(!this.ports[t])this.ports.splice(t,1);o()};this.countPorts=()=>{const t=L.getGui();if(CABLES.UI&&!t.isRemoteClient&&t.patchView&&t.patchView.patchRenderer&&t.patchView.patchRenderer.isDraggingPort()){clearTimeout(this.retryTo);this.retryTo=setTimeout(this.countPorts.bind(this));return}this.retryTo=null;let e=false;this.removeListeners();this.removeInvalidPorts();for(let t=0;t<this.ports.length;t++){if(this.ports[t]&&this.ports[t].links.length>1){const s=this.ports[t+1];const r=this.ports[t].links[0].getOtherPort(this.ports[t]);if(!s||!r){this._log.warn("no port found?")}else{this.ports[t].links[0].remove();this.op.patch.link(this.op,s.name,r.op,r.name);e=true}break}}const i=this.ports.length-1;if(this.ports.length>=1&&this.ports[i].uiAttribs.addPort&&this.ports[i].isLinked()){this.newPort();this.setUiAttribs({multiPortNum:this.ports.length})}this.removeInvalidPorts();o();h();if(e)this.countPorts();else this.addListeners()};this.removeListeners=()=>{for(let t=0;t<this.ports.length;t++){const e=this.ports[t];if(e.multiPortChangeListener)e.multiPortChangeListener=e.off(e.multiPortChangeListener);if(e.multiLinkChangeListener)e.multiLinkChangeListener=e.off(e.multiLinkChangeListener)}};this.addListeners=()=>{for(let t=0;t<this.ports.length;t++){const e=this.ports[t];const i=t;if(e.multiPortChangeListener)e.multiPortChangeListener=e.off(e.multiPortChangeListener);e.multiPortChangeListener=e.on("change",o.bind(this));if(e.multiPortTriggerListener)e.multiPortTriggerListener=e.off(e.multiPortTriggerListener);e.multiPortTriggerListener=e.on("trigger",()=>{this._onTriggered(i)});if(e.multiLinkChangeListener)e.multiLinkChangeListener=e.off(e.multiLinkChangeListener);e.multiLinkChangeListener=e.on("onLinkChanged",()=>{this.countPorts();this.emitEvent("onLinkChanged")});if(e.multiLinkRemoveListener)e.multiLinkRemoveListener=e.off(e.multiLinkRemoveListener);e.multiLinkRemoveListener=e.on("onLinkRemoved",()=>{h();this.countPorts();this.emitEvent("onLinkChanged")})}};this.newPort=t=>{const e={};e.type=r;const i=this.op.newPort(this.op,s+"_"+this.ports.length,r,e);i.direction=n;if(this.direction==c.PORT.PORT_DIR_OUT)this.op.addOutPort(i);else this.op.addInPort(i,this.ports[this.ports.length-1]);this.ports.push(i);if(r==P.TYPE_NUMBER)i.setInitialValue(0);else if(r==P.TYPE_STRING)i.setInitialValue("");this.addListeners();h();o();this.emitEvent("onLinkChanged");if(this.op.preservedPortTitles&&this.op.preservedPortTitles[i.name])i.setUiAttribs({title:this.op.preservedPortTitles[i.name]});return i};this.initPorts=()=>{while(this.ports.length<this.minNumPorts)this.newPort("init"+this.minNumPorts);o();h()};this.checkNum=()=>{this.uiAttribs.multiPortNum||=this.minNumPorts;this.uiAttribs.multiPortNum=Math.max(this.minNumPorts,this.uiAttribs.multiPortNum);while(this.ports.length<this.uiAttribs.multiPortNum)this.newPort("checknum");while(this.ports.length>this.uiAttribs.multiPortNum)if(this.ports[this.ports.length-1])this.ports.pop().remove();this.removeInvalidPorts();if(this.ports.length>1&&this.ports[this.ports.length-1].uiAttribs.addPort&&this.ports[this.ports.length-1].isLinked()){this.ports[this.ports.length-1].removeLinks()}};this.incDec=t=>{this.uiAttribs.multiPortNum=this.uiAttribs.multiPortNum||this.minNumPorts;this.setUiAttribs({multiPortNum:this.uiAttribs.multiPortNum+t});this.checkNum();h()};this.on("onUiAttrChange",this.checkNum.bind(this));this.checkNum();this.countPorts();this.removeInvalidPorts();h()}}class y extends e{static OP_VERSION_PREFIX="_v";static EVENT_INIT="init";static EVENT_UIATTR_CHANGE="onUiAttribsChange";static UI_ERRORLEVEL_HINT=0;static UI_ERRORLEVEL_WARNING=1;static UI_ERRORLEVEL_ERROR=2;static UI_ERRORLEVEL_NOTWORKING=3;#objName="";#log=new l("core_op");#shortOpName="";opId="";portsOut=[];patch=null;data={};storage={};portsIn=[];portsInData=[];uiAttribs={};enabled=true;onAnimFrame=null;preservedPortTitles={};preservedPortValues={};preservedPortLinks={};linkTimeRules={needsLinkedToWork:[],needsStringToWork:[],needsParentOp:null};inValueSlider=this.inFloatSlider;shouldWork={};hasUiErrors=0;uiErrors={};hasAnimPort=false;patchId=null;constructor(t,e,i=null){super();this.opId=i;this.#objName=e;this.patch=t;this.#shortOpName=CABLES.getShortOpName(e);this.getTitle();this.id=i||E();this.onAddPort=null;this.onCreate=null;this.onResize=null;this.onLoaded=null;this.onDelete=null;this.onError=null;this._instances=null;this.preRender=null;this.init=null}isInBlueprint2(){return false}getSubPatch(){return 0}get name(){return this.getTitle()}set name(t){this.setTitle(t)}set _objName(t){this.#objName=t;this.#log=new l("op "+t)}get objName(){return this.#objName}get shortName(){return this.#shortOpName}require(t){if(CABLES.platform&&CABLES.StandaloneElectron&&!CABLES.platform.frontendOptions.isElectron)this.setUiError("notstandalone","This op will only work in cables standalone version",3);return null}checkMainloopExists(){if(!CABLES.UI)return;if(!this.patch.tempData.mainloopOp)this.setUiError("nomainloop","patch should have a mainloop to use this op");else this.setUiError("nomainloop",null)}getTitle(){if(!this.uiAttribs)return"nouiattribs"+this.shortName;return this.uiAttribs.title||this.#shortOpName}setTitle(t){if(t!=this.getTitle())this._setUiAttrib({title:t})}setStorage(t){if(!t)return;this.storage=this.storage||{};let e=false;for(const i in t){if(this.storage[i]!=t[i])e=true;this.storage[i]=t[i]}if(e)this.emitEvent("onStorageChange",t)}isSubPatchOp(){if(this.patchId&&this.storage)return this.storage.subPatchVer||this.storage.blueprintVer||0;return false}setUiAttrib(t){this._setUiAttrib(t)}setUiAttribs(t){this._setUiAttrib(t)}uiAttr(t){this._setUiAttrib(t)}inValueSelect(t,e,i,s){return this.inDropDown(t,e,i,s)}inValueInt(t,e){return this.inInt(t,e)}outFunction(t,e){return this.outTrigger(t,e)}outValue(t,e){return this.outNumber(t,e)}outValueBool(t,e){return this.outBool(t,e)}outBool(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_VALUE,{display:"bool"}));if(e!==undefined)i.set(e);else i.set(0);return i}outValueString(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_VALUE,{type:"string"}));if(e!==undefined)i.set(e);return i}inDynamic(t,e,i,s){const r=this.newPort(this,t,P.TYPE_DYNAMIC,i);r.shouldLink=()=>{if(e&&Array.isArray(e))return false;return true};this.addInPort(r);if(s!==undefined){r.set(s);r.defaultValue=s}return r}_setUiAttrib(t){if(!t)return;if(typeof t!="object")this.#log.error("op.uiAttrib attribs are not of type object");if(!this.uiAttribs)this.uiAttribs={};let e=false;let i=false;if(CABLES.UI&&t.hasOwnProperty("translate")&&(!this.uiAttribs.translate||this.uiAttribs.translate.x!=t.translate.x||this.uiAttribs.translate.y!=t.translate.y))i=true;if(t.hasOwnProperty("title")&&t.title!=this.uiAttribs.title){this.uiAttribs.title=t.title;e=true}if(t.hasOwnProperty("disabled")){e=true;this.setEnabled(!t.disabled)}for(const s in t){if(this.uiAttribs[s]!=t[s])e=true;this.uiAttribs[s]=t[s]}if(this.uiAttribs.hasOwnProperty("vizLayerMaxZoom")&&this.uiAttribs.vizLayerMaxZoom==false)delete this.uiAttribs.vizLayerMaxZoom;if(this.uiAttribs.hasOwnProperty("highlighted")&&this.uiAttribs.highlighted==false)delete this.uiAttribs.highlighted;if(this.uiAttribs.hasOwnProperty("highlightedMore")&&this.uiAttribs.highlightedMore==false)delete this.uiAttribs.highlightedMore;if(this.uiAttribs.hasOwnProperty("selected")&&this.uiAttribs.selected==false)delete this.uiAttribs.selected;if(this.uiAttribs.hasOwnProperty("selected"))e=true;if(e){this.emitEvent(y.EVENT_UIATTR_CHANGE,t);this.patch.emitEvent("onUiAttribsChange",this,t)}if(i)this.emitEvent("move")}getName(){return this.#shortOpName}addOutPort(t){t.direction=c.PORT.PORT_DIR_OUT;if(t.op!=this)this.#log.error("port op is not this...");this.portsOut.push(t);this.emitEvent("onPortAdd",t);return t}hasDynamicPort(){let t=0;for(t=0;t<this.portsIn.length;t++){if(this.portsIn[t].type==P.TYPE_DYNAMIC)return true;if(this.portsIn[t].getName()=="dyn")return true}for(t=0;t<this.portsOut.length;t++){if(this.portsOut[t].type==P.TYPE_DYNAMIC)return true;if(this.portsOut[t].getName()=="dyn")return true}return false}addInPort(t,e){t.direction=P.DIR_IN;t._op=this;if(!e){this.portsIn.push(t)}else{const i=this.portsIn.indexOf(e);this.portsIn.splice(i+1,0,t)}this.emitEvent("onPortAdd",t);return t}inFunction(t,e){return this.inTrigger(t,e)}inTrigger(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_FUNCTION));if(e!==undefined)i.set(e);return i}inTriggerButton(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_FUNCTION,{display:"button"}));if(e!==undefined)i.set(e);return i}inUiTriggerButtons(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_FUNCTION,{display:"buttons"}));if(e!==undefined)i.set(e);return i}inValueFloat(t,e){return this.inFloat(t,e)}inValue(t,e){return this.inFloat(t,e)}inValueBool(t,e){return this.inBool(t,e)}inFloat(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_VALUE));i.setInitialValue(e);return i}inBool(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_NUMBER,{display:"bool"}));if(e===true)e=1;if(e===false)e=0;i.setInitialValue(e);return i}inMultiPort(t,e,i){const s={addPort:true,hidePort:true};const r=new rt(this,t,e,P.DIR_IN,s,i);r.ignoreValueSerialize=true;this.addInPort(r);r.initPorts();return r}inMultiPort2(t,e,i,s=2){const r={addPort:true,hidePort:true};const n=new nt(this,t,e,P.DIR_IN,r,i,s);n.ignoreValueSerialize=true;this.addInPort(n);n.initPorts();return n}outMultiPort(t,e,i={}){const s=new rt(this,t,e,c.PORT.PORT_DIR_OUT,{display:"multiport",hidePort:true},i);s.ignoreValueSerialize=true;this.addOutPort(s);s.initPorts();return s}outMultiPort2(t,e,i={}){const s=new nt(this,t,e,c.PORT.PORT_DIR_OUT,{display:"multiport",hidePort:true},i);s.ignoreValueSerialize=true;this.addOutPort(s);s.initPorts();return s}inValueString(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_VALUE,{type:"string"}));i.value="";i.setInitialValue(e);return i}inString(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_STRING,{type:"string"}));e=e||"";i.setInitialValue(e);return i}inTextarea(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_STRING,{type:"string",display:"text"}));i.value="";if(e!==undefined){i.set(e);i.defaultValue=e}return i}inStringEditor(t,e,i,s=true){const r=this.addInPort(this.newPort(this,t,P.TYPE_STRING,{type:"string",display:"editor",editShortcut:true,editorSyntax:i,hideFormatButton:s}));r.value="";if(e!==undefined){r.set(e);r.defaultValue=e}return r}inValueEditor(t,e,i,s=true){const r=this.addInPort(this.newPort(this,t,P.TYPE_NUMBER,{type:"string",display:"editor",editorSyntax:i,hideFormatButton:s}));r.value="";if(e!==undefined){r.set(e);r.defaultValue=e}return r}inDropDown(t,e,i,s){let r=null;if(!s){const n=this.newPort(this,t+" index",P.TYPE_NUMBER,{increment:"integer",hideParam:true});const a=this.addInPort(n);if(e)for(let t=0;t<e.length;t++)e[t]=String(e[t]);const o=new st(this,t,P.TYPE_NUMBER,{display:"dropdown",hidePort:true,type:"string",values:e},a);o.indexPort=n;o.on("change",(t,e)=>{if(!e.indexPort.isLinked()&&e.uiAttribs.values){const i=e.uiAttribs.values.indexOf(t);if(i>-1)e.indexPort.set(i)}});n.on(P.EVENT_LINK_CHANGED,()=>{o.setUiAttribs({greyout:n.isLinked()});o.forceChange()});r=this.addInPort(o);if(i!==undefined){r.set(i);const h=e.findIndex(t=>{return t==i});a.setValue(h);r.defaultValue=i;a.defaultValue=h}}else{const o=this.newPort(this,t,P.TYPE_VALUE,{display:"dropdown",hidePort:true,type:"string",values:e});r=this.addInPort(o)}return r}inSwitch(t,e,i,s){let r=null;if(!s){if(!i)i=e[0];const n=this.newPort(this,t+" index",P.TYPE_VALUE,{increment:"integer",values:e,hideParam:true});const a=this.addInPort(n);if(e)for(let t=0;t<e.length;t++)e[t]=String(e[t]);const o=new st(this,t,P.TYPE_STRING,{display:"switch",hidePort:true,type:"string",values:e},a);o.indexPort=n;o.on("change",(t,e)=>{if(!e.indexPort.isLinked()&&e.uiAttribs.values){const i=e.uiAttribs.values.indexOf(t);if(i>-1)e.indexPort.set(i)}});r=this.addInPort(o);n.on(P.EVENT_LINK_CHANGED,()=>{o.setUiAttribs({greyout:n.isLinked()});o.forceChange()});if(i!==undefined){r.set(i);const h=e.findIndex(t=>{return t==i});a.setValue(h);r.defaultValue=i;a.defaultValue=h}}else{const o=this.newPort(this,t,P.TYPE_STRING,{display:"switch",hidePort:true,type:"string",values:e});r=this.addInPort(o)}return r}inInt(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_VALUE,{increment:"integer"}));if(e!==undefined){i.set(e);i.defaultValue=e}return i}inFile(t,e,i){const s=this.addInPort(this.newPort(this,t,P.TYPE_VALUE,{display:"file",type:"string",filter:e}));if(i!==undefined){s.set(i);s.defaultValue=i}return s}inUrl(t,e,i){const s=this.addInPort(this.newPort(this,t,P.TYPE_STRING,{display:"file",type:"string",filter:e}));if(i!==undefined){s.set(i);s.defaultValue=i}return s}inTexture(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_OBJECT,{display:"texture",objType:"texture",preview:true}));i.ignoreValueSerialize=true;if(e!==undefined)i.set(e);return i}inObject(t,e,i){const s=this.addInPort(this.newPort(this,t,P.TYPE_OBJECT,{objType:i}));s.ignoreValueSerialize=true;if(e!==undefined)s.set(e);return s}inGradient(t,e){const i=this.addInPort(this.newPort(this,t,P.TYPE_VALUE,{display:"gradient"}));if(e!==undefined)i.set(e);return i}getPortVisibleIndex(e){let i=this.portsIn;if(e.direction==c.PORT_DIR_OUT)i=this.portsOut;let s=0;for(let t=0;t<i.length;t++){if(i[t].uiAttribs.hidePort)continue;s++;if(i[t]==e)return s}}inArray(t,e=undefined,i=undefined){let s=i;if(!i&&CABLES.isNumeric(e))s=e;const r=this.addInPort(this.newPort(this,t,P.TYPE_ARRAY,{stride:s}));if(e!==undefined&&(Array.isArray(e)||e==null))r.set(e);return r}inFloatSlider(t,e,i,s){const r={display:"range"};if(i!=undefined&&s!=undefined){r.min=i;r.max=s}const n=this.addInPort(this.newPort(this,t,P.TYPE_VALUE,r));if(e!==undefined){n.set(e);n.defaultValue=e}return n}outTrigger(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_FUNCTION));if(e!==undefined)i.set(e);return i}outNumber(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_VALUE));if(e!==undefined)i.set(e);return i}outBoolNum(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_VALUE,{display:"boolnum"}));i.set=function(t){this.setValue(t?1:0)}.bind(i);if(e!==undefined)i.set(e);else i.set(0);return i}outString(t,e){const i=this.addOutPort(this.newPort(this,t,P.TYPE_STRING,{type:"string"}));if(e!==undefined)i.set(e);else i.set("");return i}outObject(t,e,i){const s=this.addOutPort(this.newPort(this,t,P.TYPE_OBJECT,{objType:i||null}));s.set(e||null);s.ignoreValueSerialize=true;return s}outArray(t,e,i){if(!i&&CABLES.isNumeric(e))i=e;const s=this.addOutPort(this.newPort(this,t,P.TYPE_ARRAY,{stride:i}));if(e!==undefined&&(Array.isArray(e)||e==null))s.set(e);s.ignoreValueSerialize=true;return s}outTexture(t,e){return null}removeLinks(){for(let t=0;t<this.portsIn.length;t++)this.portsIn[t].removeLinks();for(let t=0;t<this.portsOut.length;t++)this.portsOut[t].removeLinks()}getSerialized(){const e={};if(this.opId)e.opId=this.opId;if(this.patch.storeObjNames)e.objName=this.objName;e.id=this.id;e.uiAttribs=structuredClone(this.uiAttribs)||{};if(this.storage&&Object.keys(this.storage).length>0)e.storage=structuredClone(this.storage);if(this.uiAttribs.hasOwnProperty("working")&&this.uiAttribs.working==true)delete this.uiAttribs.working;if(e.uiAttribs.hasOwnProperty("uierrors"))delete e.uiAttribs.uierrors;if(e.uiAttribs.hasOwnProperty("highlighted"))delete e.uiAttribs.highlighted;if(e.uiAttribs.hasOwnProperty("highlightedMore"))delete e.uiAttribs.highlightedMore;if(e.uiAttribs.hasOwnProperty("heatmapIntensity"))delete e.uiAttribs.heatmapIntensity;if(e.uiAttribs.title==="")delete e.uiAttribs.title;if(e.uiAttribs.color===null)delete e.uiAttribs.color;if(e.uiAttribs.comment===null)delete e.uiAttribs.comment;if(e.uiAttribs.title==this.#shortOpName||(this.uiAttribs.title||"").toLowerCase()==this.#shortOpName.toLowerCase())delete e.uiAttribs.title;e.portsIn=[];e.portsOut=[];for(let t=0;t<this.portsIn.length;t++){const i=this.portsIn[t].getSerialized();if(i)e.portsIn.push(i)}for(let t=0;t<this.portsOut.length;t++){const i=this.portsOut[t].getSerialized();if(i)e.portsOut.push(i)}if(e.portsIn.length==0)delete e.portsIn;if(e.portsOut.length==0)delete e.portsOut;g(e);return e}getFirstOutPortByType(e){for(let t=0;t<this.portsOut.length;t++)if(this.portsOut[t].type==e)return this.portsOut[t]}getFirstInPortByType(e){for(let t=0;t<this.portsIn.length;t++)if(this.portsIn[t].type==e)return this.portsIn[t]}getPort(t,e=false){return this.getPortByName(t,e)}getPortByName(e,t=false){if(t){for(let t=0;t<this.portsIn.length;t++)if(this.portsIn[t].getName().toLowerCase()==e||this.portsIn[t].id.toLowerCase()==e)return this.portsIn[t];for(let t=0;t<this.portsOut.length;t++)if(this.portsOut[t].getName().toLowerCase()==e||this.portsOut[t].id.toLowerCase()==e)return this.portsOut[t]}else{for(let t=0;t<this.portsIn.length;t++)if(this.portsIn[t].getName()==e||this.portsIn[t].id==e)return this.portsIn[t];for(let t=0;t<this.portsOut.length;t++)if(this.portsOut[t].getName()==e||this.portsOut[t].id==e)return this.portsOut[t]}}getPortById(e){for(let t=0;t<this.portsIn.length;t++)if(this.portsIn[t].id==e)return this.portsIn[t];for(let t=0;t<this.portsOut.length;t++)if(this.portsOut[t].id==e)return this.portsOut[t]}updateAnims(){if(this.hasAnimPort)for(let t=0;t<this.portsIn.length;t++)this.portsIn[t].updateAnim()}log(){this.#log.log(...arguments)}logError(){this.#log.error(...arguments)}logWarn(){this.#log.warn(...arguments)}logVerbose(){this.#log.verbose(...arguments)}error(){this.#log.error(...arguments)}warn(){this.#log.warn(...arguments)}verbose(){this.#log.verbose(...arguments)}cleanUp(){if(this._instances){for(let t=0;t<this._instances.length;t++)if(this._instances[t].onDelete)this._instances[t].onDelete();this._instances.length=0}for(let t=0;t<this.portsIn.length;t++)this.portsIn[t].setAnimated(false);if(this.onAnimFrame)this.patch.removeOnAnimFrame(this)}instanced(t){return false}initInstancable(){}hasUiError(t){return this.uiErrors.hasOwnProperty(t)&&this.uiErrors[t]}setUiError(t,e,i=2,s={}){}setEnabled(t){this.enabled=t;this.emitEvent("onEnabledChange",t)}setPortGroup(e,i){for(let t=0;t<i.length;t++){if(i[t])if(i[t].setUiAttribs)i[t].setUiAttribs({group:e});else this.#log.error("setPortGroup: invalid port!")}}setUiAxisPorts(t,e,i){if(t)t.setUiAttribs({axis:"X"});if(e)e.setUiAttribs({axis:"Y"});if(i)i.setUiAttribs({axis:"Z"})}removePort(e){for(let t=0;t<this.portsIn.length;t++){if(this.portsIn[t]==e){this.portsIn.splice(t,1);this.emitEvent(y.EVENT_UIATTR_CHANGE,{});this.emitEvent("onPortRemoved",{});return}}for(let t=0;t<this.portsOut.length;t++){if(this.portsOut[t]==e){this.portsOut.splice(t,1);this.emitEvent(y.EVENT_UIATTR_CHANGE,{});this.emitEvent("onPortRemoved",{});return}}}toWorkNeedsParent(t){this.linkTimeRules.needsParentOp=t}toWorkShouldNotBeChild(t,e){if(!this.patch.isEditorMode())return;this.linkTimeRules.forbiddenParent=t;if(e!=undefined)this.linkTimeRules.forbiddenParentType=e}toWorkPortsNeedsString(){if(!this.patch.isEditorMode())return;for(let t=0;t<arguments.length;t++)if(this.linkTimeRules.needsStringToWork.indexOf(arguments[t])==-1)this.linkTimeRules.needsStringToWork.push(arguments[t])}toWorkPortsNeedToBeLinked(){if(!this.patch.isEditorMode())return;for(let t=0;t<arguments.length;t++)if(this.linkTimeRules.needsLinkedToWork.indexOf(arguments[t])==-1)this.linkTimeRules.needsLinkedToWork.push(arguments[t])}toWorkPortsNeedToBeLinkedReset(){if(!this.patch.isEditorMode())return;this.linkTimeRules.needsLinkedToWork.length=0;if(this.checkLinkTimeWarnings)this.checkLinkTimeWarnings()}initVarPorts(){for(let t=0;t<this.portsIn.length;t++)if(this.portsIn[t].getVariableName())this.portsIn[t].setVariable(this.portsIn[t].getVariableName())}checkLinkTimeWarnings(){}_checkLinksNeededToWork(){}refreshParams(){if(this.patch&&this.patch.isEditorMode()&&this.isCurrentUiOp())L.getGui().opParams.show(this)}isCurrentUiOp(){if(this.patch.isEditorMode())return L.getGui().patchView.isCurrentOp(this)}checkGraphicsApi(t=1){if(this.patch.isEditorMode())if(this.patch.cg&&this.patch.cg.gApi!=t)this.setUiError("wronggapi","Wrong graphics API",2)}newPort(t,e,i,s){return new CABLES.Port(t,e,i,s)}}const U={};U.addPatch=function(t,e){let i=t;let s=o();if(typeof t=="string"){s=t;i=document.getElementById(s);if(!i){console.error(s+" Container Element not found!");return}}const r=document.createElement("canvas");r.id="glcanvas_"+s;r.width=i.clientWidth;r.height=i.clientHeight;window.addEventListener("resize",function(){this.height=i.clientHeight;this.width=i.clientWidth}.bind(r));i.appendChild(r);e=e||{};e.glCanvasId=r.id;if(!e.onError){e.onError=function(t){console.error(t)}}CABLES.patch=new L(e);return r};class at{constructor(t){this.startFrame=t.getFrameNum();this.items={};this.currentId=null;this.currentStart=0;this._patch=t}getItems(){return this.items}clear(){this.currentStart=performance.now();if(this.paused)return;this.items={}}togglePause(){this.paused=!this.paused;if(!this.paused){this.items={};this.currentStart=performance.now()}}add(t,e){if(this.paused)return;if(this.currentId!==null){if(!e||e.id!=this.currentId){const i=this.items[this.currentId];if(i){i.timeUsed+=performance.now()-this.currentStart;i._timePsCount++;i._timePsMs+=performance.now()-this.currentStart;if(i._timePsStart==0||performance.now()>i._timePsStart+1e3){i.timePsMs=i._timePsMs;i.timePsMsAvg=i._timePsMs/i._timePsCount;i.timePsCount=i._timePsCount;i._timePsCount=0;i._timePsMs=0;i._timePsStart=performance.now()}if(!i.peakTime||N()-i.peakTime>5e3){i.peak=0;i.peakTime=N()}i.peak=Math.max(i.peak,performance.now()-this.currentStart)}}}if(e!==null){if(!this.items[e.id]){this.items[e.id]={numTriggers:0,timeUsed:0,timeUsedFrame:0,timePsMsAvg:0,timePsMs:0,_timePsCount:0,_timePsMs:0,_timePsStart:performance.now()}}if(this.items[e.id].lastFrame!=this._patch.getFrameNum())this.items[e.id].numTriggers=0;this.items[e.id].lastFrame=this._patch.getFrameNum();this.items[e.id].numTriggers++;this.items[e.id].opid=e.op.id;this.items[e.id].title=e.op.name+"."+e.name;this.items[e.id].subPatch=e.op.uiAttribs.subPatch;this.currentId=e.id;this.currentStart=performance.now()}else{this.currentId=null}}print(){for(const t in this.items){console.log(this.items[t].title+": "+this.items[t].numTriggers+" / "+this.items[t].timeUsed)}}}const ot=function(){let e=null;const i=[];this.onChanged=function(t){i.push(t)};this.getValue=function(){return e};this.setValue=function(t){e=t;this.emitChanged()};this.emitChanged=function(){for(let t=0;t<i.length;t++){i[t]()}}};class ht extends e{paused=false;frameNum=0;frameStartTime=0;exec(t){}pause(){}resume(){}}class lt{#arr=[];push(t){this.#arr.push(t)}pop(){return this.#arr.pop()}clear(){this.#arr.length=0;return this}current(){return this.#arr[this.#arr.length-1]}array(){return this.#arr}}CABLES=CABLES||{};CABLES={...CABLES,...c.PORT,...c.PACO,...c.ANIM,...c.OP};CABLES.EMBED=U;CABLES.Link=M;CABLES.Port=P;CABLES.Op=y;CABLES.Profiler=at;CABLES.Patch=L;CABLES.Timer=O;CABLES.LoadingStatus=R;CABLES.now=N;CABLES.internalNow=C;CABLES.Anim=u;CABLES.AnimKey=h;CABLES.RenderLoop=ht;CABLES.shortId=E;CABLES.uuid=a;CABLES.getShortOpName=i;CABLES.simpleId=_;CABLES.clamp=b;CABLES.map=T;CABLES.generateUUID=o;CABLES.prefixedHash=m;CABLES.smoothStep=p;CABLES.smootherStep=v;CABLES.copyArray=S;CABLES.basename=x;CABLES.logStack=X;CABLES.filename=q;CABLES.ajax=I;CABLES.cacheBust=A;CABLES.shuffleArray=s;CABLES.Variable=ot;CABLES.logErrorConsole=Q;CABLES.isNumeric=f;CABLES.uniqueArray=J;CABLES.Stack=lt;CABLES.OPS=[];CABLES.utils=t;CABLES.CONSTANTS=c;CABLES.SHARED={};CABLES.SHARED.Events=e;CABLES.SHARED.Logger=l;const ut=CABLES;if(!function(){return!this}())console.warn("not in strict mode: index core")})();var t=CABLES=typeof CABLES==="undefined"?{}:CABLES;for(var e in ft)t[e]=ft[e];if(ft.__esModule)Object.defineProperty(t,"__esModule",{value:true})})();var CABLES=CABLES||{};CABLES.build={timestamp:1771256201024,created:"2026-02-16T15:36:41.024Z",git:{branch:"develop",commit:"4e5ecef40bc499676d9098c6e50264c5cf57a22f",date:"1771256189",message:"skype ox"}};if(!CABLES.exportedPatches)CABLES.exportedPatches={};CABLES.exportedPatches["Zv2gpb"]={_id:"6993408b8ac151bf43c87a8f",ops:[{id:"2677de84-1b37-4a9f-a9f7-1f14e530f03c",portsIn:[{name:"String 3",value:""},{name:"String 4",value:""},{name:"String 5",value:""},{name:"String 6",value:""},{name:"String 7",value:""},{name:"String 8",value:""}],portsOut:[{name:"Result",links:[{portIn:"string1",portOut:"Result",objIn:"brmag00qi",objOut:"2677de84-1b37-4a9f-a9f7-1f14e530f03c"}]}],objName:"Ops.String.OrString"},{id:"aeb827c0-8930-4eb9-ac6a-8d5b8a161df3",portsIn:[{name:"value",value:"projectData is empty"}],portsOut:[{name:"String",links:[{portIn:"String 2",portOut:"String",objIn:"2677de84-1b37-4a9f-a9f7-1f14e530f03c",objOut:"aeb827c0-8930-4eb9-ac6a-8d5b8a161df3"}]}],objName:"Ops.String.String_v2"},{id:"liaw80brj",portsIn:[{name:"Variable",value:"projectsData"}],objName:"Ops.Vars.VarSetObject_v2"},{id:"7vzxdg6ev",portsIn:[{name:"JSON String",value:'[\n  {\n    "image": "assets/sprites/kanto/bulbasaur.png",\n    "name": "Bulbasaur",\n    "slug": "001-bulbasaur"\n  },\n  {\n    "image": "assets/sprites/kanto/charizard.png",\n    "name": "Charizard",\n    "slug": "006-charizard"\n  }\n]'}],portsOut:[{name:"Result",links:[{portIn:"Value",portOut:"Result",objIn:"liaw80brj",objOut:"7vzxdg6ev"}]},{name:"Valid",value:1}],objName:"Ops.Json.ParseObject_v2"},{id:"21ft3oxqy",portsIn:[{name:"Variable",value:"projectsData"}],portsOut:[{name:"Value",links:[{portIn:"Object",portOut:"Value",objIn:"qgfk0iwh0",objOut:"21ft3oxqy"}]}],objName:"Ops.Vars.VarGetObject_v2"},{id:"qgfk0iwh0",portsIn:[{name:"Beautify",value:1}],portsOut:[{name:"Result",links:[{portIn:"String 1",portOut:"Result",objIn:"2677de84-1b37-4a9f-a9f7-1f14e530f03c",objOut:"qgfk0iwh0"}]},{name:"Error",value:0}],objName:"Ops.Json.ObjectStringify_v2"},{id:"frupbdxsr",portsIn:[{name:"Draw Mesh",value:1},{name:"Size index",value:0},{name:"Size",value:"Auto"},{name:"Width",value:512},{name:"Height",value:512},{name:"Auto Height",value:1},{name:"Auto Line Breaks",value:1},{name:"font",value:"Arial"},{name:"weight",value:"normal"},{name:"fontSize",value:50},{name:"align index",value:0},{name:"align",value:"left"},{name:"Vertical align index",value:0},{name:"Vertical align",value:"Top"},{name:"Letter Spacing",value:0},{name:"Line Height Add",value:0},{name:"Padding Y Top",value:3},{name:"Padding Y Bottom",value:3},{name:"Padding X",value:0},{name:"filter index",value:1},{name:"filter",value:"linear"},{name:"Wrap index",value:2},{name:"Wrap",value:"clamp to edge"},{name:"Anisotropic index",value:0},{name:"Anisotropic",value:0},{name:"Reuse Texture",value:1},{name:"Show Debug",value:0},{name:"Redraw On Font Load",value:1},{name:"r",value:1},{name:"g",value:1},{name:"b",value:1},{name:"Opacity",value:1},{name:"background R",value:0},{name:"background G",value:0},{name:"background B",value:0},{name:"background A",value:1}],portsOut:[{name:"Ratio",value:.672566371681416},{name:"Aspect",value:1.486842105263158},{name:"Num Lines",value:13}],objName:"Ops.Gl.Textures.TextTexture_v6"},{id:"x669tytys",portsIn:[{name:"Max Pixel Density (DPR)",value:2},{name:"FPS Limit",value:5},{name:"Reduce FPS unfocussed",value:0},{name:"Transparent",value:0},{name:"Active",value:1},{name:"Focus canvas",value:1}],portsOut:[{name:"trigger",links:[{portIn:"render",portOut:"trigger",objIn:"j8u9lm0r1",objOut:"x669tytys"}]},{name:"width",value:973},{name:"height",value:446},{name:"Pixel Density",value:1.8181818181818181}],objName:"Ops.Gl.MainLoop_v2"},{id:"j8u9lm0r1",portsIn:[{name:"r",value:.1},{name:"g",value:.1},{name:"b",value:.1},{name:"a",value:1}],portsOut:[{name:"trigger",links:[{portIn:"Render",portOut:"trigger",objIn:"frupbdxsr",objOut:"j8u9lm0r1"}]}],objName:"Ops.Gl.ClearColor"},{id:"rb14vwdx6",portsIn:[{name:"Coordinates index",value:0},{name:"Coordinates",value:"-1 to 1"},{name:"Area index",value:0},{name:"Area",value:"Canvas Area"},{name:"flip y",value:1},{name:"right click prevent default",value:1},{name:"Events index",value:0},{name:"Events",value:"Pointer"},{name:"Passive Events",value:0},{name:"Active",value:1}],portsOut:[{name:"x",value:-.45921859741210935},{name:"y",value:-.7875},{name:"click",links:[{portIn:"exe",portOut:"click",objIn:"t5zh4b03f",objOut:"rb14vwdx6"},{portIn:"Trigger animation",portOut:"click",objIn:"id9sd5tid",objOut:"rb14vwdx6"}]},{name:"Button is down",value:0},{name:"Mouse is hovering",value:0},{name:"Movement X",value:-2.2},{name:"Movement Y",value:24.2}],objName:"Ops.Devices.Mouse.Mouse_v4"},{id:"fxmi8brso",portsIn:[{name:"Value 0",value:.5},{name:"Value 1",value:1}],portsOut:[{name:"Out Value",links:[{portIn:"Scale Mesh",portOut:"Out Value",objIn:"frupbdxsr",objOut:"fxmi8brso"}]}],objName:"Ops.Boolean.BoolToNumber_v2"},{id:"f9lvkycnz",portsIn:[{name:"Value",value:0},{name:"Variable",value:"zoomState"}],objName:"Ops.Vars.VarSetNumber_v2"},{id:"7alp8q7ec",portsIn:[{name:"Variable",value:"zoomState"}],portsOut:[{name:"Value",links:[{portIn:"Use Value 1",portOut:"Value",objIn:"fxmi8brso",objOut:"7alp8q7ec"},{portIn:"Boolean",portOut:"Value",objIn:"7rm10eume",objOut:"7alp8q7ec"}]}],objName:"Ops.Vars.VarGetNumber_v2"},{id:"t5zh4b03f",portsIn:[{name:"Parameter 2",value:""},{name:"Parameter 3",value:""}],objName:"Ops.Cables.CallBack_v2"},{id:"wj5dhhpem",portsIn:[{name:"value",value:"projectClickedSlug"}],portsOut:[{name:"String",links:[{portIn:"Callback Name",portOut:"String",objIn:"t5zh4b03f",objOut:"wj5dhhpem"},{portIn:"Strings_0",portOut:"String",objIn:"x0fd4c78y",objOut:"wj5dhhpem"}]}],objName:"Ops.String.String_v3"},{id:"9sw9xcdzz",portsIn:[{name:"value",value:"001-bulbasaur"}],portsOut:[{name:"String",links:[{portIn:"Parameter 1",portOut:"String",objIn:"t5zh4b03f",objOut:"9sw9xcdzz"},{portIn:"Strings_2",portOut:"String",objIn:"x0fd4c78y",objOut:"9sw9xcdzz"}]}],objName:"Ops.String.String_v3"},{id:"id9sd5tid",portsIn:[{name:"Class",value:""},{name:"Style",value:"visibility: hidden;\nbackground-color: #282828;\ncolor: #fff;\n\npadding: 16px;\nposition: absolute;\nz-index: 9999;\nfont-size: 17px;\nopacity:0;\n\ntext-align:center;\nleft: 50%;\ntransform: translate(-50%, 0);\n"},{name:"Active",value:1},{name:"Convert Line Breaks",value:0},{name:"Fade in",value:.1},{name:"Hold ",value:4},{name:"Fade out",value:.8},{name:"mode index",value:0},{name:"mode",value:"%"},{name:"Side index",value:0},{name:"Side",value:"bottom"},{name:"Starting position",value:4},{name:"Ending position",value:5}],portsOut:[{name:"Finished",value:true}],objName:"Ops.Html.Utils.Notification"},{id:"x0fd4c78y",portsIn:[{name:"Strings",multiPortNum:5,multiPortManual:true},{name:"Seperator index",value:0},{name:"Seperator",value:"None"},{name:"Strings_1",value:'("'},{name:"Strings_3",value:'")'},{name:"Strings_4",value:"",title:"add port"}],portsOut:[{name:"String",links:[{portIn:"Text",portOut:"String",objIn:"id9sd5tid",objOut:"x0fd4c78y"}]},{name:"Num Strings",value:4}],objName:"Ops.String.ConcatMultiPort_v2"},{id:"brmag00qi",portsIn:[{name:"New Line",value:1},{name:"Active",value:1}],portsOut:[{name:"result",links:[{portIn:"text",portOut:"result",objIn:"frupbdxsr",objOut:"brmag00qi"}]}],objName:"Ops.String.Concat_v2"},{id:"7rm10eume",portsIn:[{name:"False",value:"zoomState: 0"},{name:"True",value:"zoomState: 1"}],portsOut:[{name:"String",links:[{portIn:"string2",portOut:"String",objIn:"brmag00qi",objOut:"7rm10eume"}]}],objName:"Ops.Boolean.BoolToString"}],export:{time:"2026-02-16 17:13",service:"html",exportNumber:3}};if(!CABLES.exportedPatch){CABLES.exportedPatch=CABLES.exportedPatches["Zv2gpb"]}"use strict";var CABLES=CABLES||{};CABLES.OPS=CABLES.OPS||{};var Ops=Ops||{};Ops.Gl=Ops.Gl||{};Ops.Html=Ops.Html||{};Ops.Json=Ops.Json||{};Ops.Vars=Ops.Vars||{};Ops.Cables=Ops.Cables||{};Ops.String=Ops.String||{};Ops.Boolean=Ops.Boolean||{};Ops.Devices=Ops.Devices||{};Ops.Html.Utils=Ops.Html.Utils||{};Ops.Gl.Textures=Ops.Gl.Textures||{};Ops.Devices.Mouse=Ops.Devices.Mouse||{};Ops.String.OrString=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inString("String 1"),s=t.inString("String 2"),r=t.inString("String 3"),n=t.inString("String 4"),a=t.inString("String 5"),o=t.inString("String 6"),h=t.inString("String 7"),l=t.inString("String 8"),u=t.outString("Result");i.onChange=s.onChange=r.onChange=n.onChange=a.onChange=o.onChange=h.onChange=l.onChange=c;function c(){u.set(i.get()||s.get()||r.get()||n.get()||a.get()||o.get()||h.get()||l.get())}}};Ops.String.String_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inString("value",""),s=t.outString("String");i.setUiAttribs({display:"text"});i.onChange=function(){if(!i.isLinked())t.setUiAttrib({extendTitle:i.get()});s.set(i.get())}}};Ops.Vars.VarSetObject_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inObject("Value",null);t.varName=t.inDropDown("Variable",[],"",true);new CABLES.VarSetOpWrapper(t,"object",i,t.varName)}};Ops.Json.ParseObject_v2=class extends CABLES.Op{constructor(){super(...arguments);const o=this;const t=o.attachments={};const h=o.inStringEditor("JSON String","{}","json"),e=o.outObject("Result"),l=o.outBoolNum("Valid");h.onChange=i;i();function i(){if(!h.get()){e.set(null);l.set(false);return}try{const t=JSON.parse(h.get());e.setRef(t);l.set(true);o.setUiError("invalidjson",null)}catch(t){o.logWarn(t);l.set(false);let e="";const i=t.message.split(" ");for(let t=0;t<i.length-1;t++){const s=parseFloat(i[t+1]);if(s&&i[t]=="position"){const r=h.get().substring(s-15,s);const n=h.get().substring(s,s+1);const a=h.get().substring(s+1,s+15);e='<span style="font-family:monospace;background-color:black;">'+r+'<span style="font-weight:bold;background-color:red;">'+n+"</span>"+a+" </span>"}}o.setUiError("invalidjson","INVALID JSON<br/>can not parse string to object:<br/><b> "+t.message+"</b><br/>"+e)}}}};Ops.Vars.VarGetObject_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.outObject("Value");t.varName=t.inValueSelect("Variable",[],"",true);new CABLES.VarGetOpWrapper(t,"object",t.varName,i)}};Ops.Json.ObjectStringify_v2=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={};const i=e.inObject("Object"),s=e.inValueBool("Beautify",true),r=e.outString("Result"),n=e.outBoolNum("Error");s.onChange=i.onChange=a;function a(){const t=i.get();if(t&&t.constructor&&t.constructor.name=="String"||CABLES.isNumeric(t)||Array.isArray(t)){e.setUiError("notobj","The connected is not of type object! ",1)}else e.setUiError("notobj",null);try{if(!s.get())r.set(JSON.stringify(t));else r.set(JSON.stringify(t,false,4));n.set(0)}catch(t){e.error(t);r.set("error");n.set(1)}}}};Ops.Gl.Textures.TextTexture_v6=class extends CABLES.Op{constructor(){super(...arguments);const m=this;const n=m.attachments={text_frag:"{{MODULES_HEAD}}\n\nUNI sampler2D tex;\nUNI float a;\nUNI vec4 color;\nIN vec2 texCoord;\n\nvoid main()\n{\n\n    vec4 col=texture(tex,vec2(texCoord.x,(1.0-texCoord.y)));\n\n    {{MODULE_COLOR}}\n\n    outColor=col;\n}\n",text_vert:"{{MODULES_HEAD}}\n\nIN vec3 vPosition;\nUNI mat4 projMatrix;\nUNI mat4 modelMatrix;\nUNI mat4 viewMatrix;\nUNI float aspect;\nOUT vec2 texCoord;\nIN vec2 attrTexCoord;\n\nvoid main()\n{\n    vec4 pos=vec4(vPosition,  1.0);\n\n    pos.x*=aspect;\n\n    texCoord=vec2(attrTexCoord.x,1.0-attrTexCoord.y);;\n\n    mat4 mMatrix=modelMatrix;\n\n    {{MODULE_VERTEX_POSITION}}\n    mat4 modelViewMatrix=viewMatrix*mMatrix;\n\n    gl_Position = projMatrix * modelViewMatrix * pos;\n}\n"};const t=m.inTriggerButton("Render"),X=m.inString("text","cables"),e=m.inValueBool("Draw Mesh",true),i=m.inValueFloat("Scale Mesh",.5),p=m.inSwitch("Size",["Auto","Manual"],"Auto"),E=m.inInt("Width",512),v=m.inInt("Height",512),b=m.inBool("Auto Height",true),T=m.inBool("Auto Line Breaks",true),A=m.inString("font","Arial"),S=m.inString("weight","normal"),x=m.inValueFloat("fontSize",300),I=m.inSwitch("align",["left","center","right"],"center"),P=m.inSwitch("Vertical align",["Top","Middle","Bottom"],"Top"),M=m.inFloat("Letter Spacing",0),R=m.inFloat("Line Height Add",0),q=m.inInt("Padding Y Top",3),K=m.inInt("Padding Y Bottom",3),Q=m.inInt("Padding X",0),C=m.inSwitch("filter",["nearest","linear","mipmap"],"linear"),N=m.inValueSelect("Wrap",["repeat","mirrored repeat","clamp to edge"],"clamp to edge"),O=m.inSwitch("Anisotropic",[0,1,2,4,8,16],0),L=m.inValueBool("Reuse Texture",true),J=m.inBool("Show Debug",false),a=m.inBool("Redraw On Font Load",true),F=m.inValueSlider("r",1),y=m.inValueSlider("g",1),U=m.inValueSlider("b",1),w=m.inFloatSlider("Opacity",1),B=m.inValueSlider("background R",0),Z=m.inValueSlider("background G",0),$=m.inValueSlider("background B",0),tt=m.inValueSlider("background A",1),o=m.inTriggerButton("Force Redraw"),h=m.outTrigger("Next"),et=m.outNumber("Ratio"),V=m.outTexture("texture"),l=m.outObject("Canvas",null,"element"),u=m.outNumber("Aspect",1),it=m.outNumber("Num Lines");const D=" ";F.setUiAttribs({colorPick:true});B.setUiAttribs({colorPick:true});m.toWorkPortsNeedToBeLinked(t);m.setPortGroup("Text Color",[F,y,U,w]);m.setPortGroup("Background",[B,Z,$,tt]);m.setPortGroup("Font",[A,S,x,I,P,M,R]);m.setPortGroup("Texture",[N,C,O,L,J]);m.setPortGroup("Rendering",[e,i]);t.onLinkChanged=()=>{if(!t.isLinked())V.setRef(CGL.Texture.getEmptyTexture(k));else V.setRef(G)};o.onTriggered=F.onChange=y.onChange=U.onChange=w.onChange=P.onChange=T.onChange=b.onChange=R.onChange=p.onChange=E.onChange=v.onChange=I.onChange=M.onChange=q.onChange=K.onChange=Q.onChange=X.onChange=x.onChange=S.onChange=O.onChange=A.onChange=J.onChange=L.onChange=function(){W=true;lt()};V.ignoreValueSerialize=true;const k=m.patch.cgl;let G=new CGL.Texture(k);let H=2;let z=2;const j=document.createElement("canvas");j.id="texturetext_"+CABLES.generateUUID();j.style.display="none";document.body.appendChild(j);j.style.letterSpacing="0px";l.setRef(j);let Y=j.getContext("2d");let W=true;const c=CGL.MESHES.getSimpleRect(k,"texttexture rect");const s=vec3.create();const r=new CGL.Shader(k,"texttexture");r.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG"]);r.setSource(n.text_vert,n.text_frag);const f=new CGL.Uniform(r,"t","tex");const g=new CGL.Uniform(r,"f","aspect",0);const d=new CGL.Uniform(r,"f","a",w);const _=new CGL.Uniform(r,"4f","color",F,y,U,w);if(m.patch.isEditorMode())CABLES.UI.SIMPLEWIREFRAMERECT=CABLES.UI.SIMPLEWIREFRAMERECT||new CGL.WireframeRect(k);t.onTriggered=nt;e.onChange=lt;lt();m.on("delete",()=>{Y=null;j.remove()});O.onChange=C.onChange=N.onChange=()=>{if(G)G.delete();G=null;W=true};B.onChange=Z.onChange=$.onChange=tt.onChange=F.onChange=y.onChange=U.onChange=w.onChange=()=>{if(!e.get()||V.isLinked())W=true};V.onLinkChanged=()=>{if(V.isLinked())W=true};m.patch.on("fontLoaded",t=>{if(t==A.get())W=true});document.fonts.ready.then(()=>{if(a.get())W=true});document.fonts.onloadingdone=function(t){if(a.get())W=true};function st(){return z}function rt(){return H}function nt(){let t=0;while(W&&t<10){at();ht();t++}if(e.get()){s[0]=s[1]=s[2]=i.get();k.pushBlendMode(CGL.BLEND_NORMAL,false);k.pushModelMatrix();mat4.scale(k.mMatrix,k.mMatrix,s);r.popTextures();r.pushTexture(f,G.tex);g.set(u.get());if(k.shouldDrawHelpers(m))CABLES.UI.SIMPLEWIREFRAMERECT.render(u.get(),1,1);k.pushShader(r);c.render(m.patch.cg.getShader());k.popShader();k.popBlendMode();k.popModelMatrix()}h.trigger()}function at(){if(G)G.setSize(st(),rt());Y.canvas.width=j.width=st();Y.canvas.height=j.height=rt();u.set(j.width/j.height);W=true}function ot(i){let s="";for(let t=0;t<i.length;t++){if(!i[t]){s+="\n";continue}let e=0;const r=i[t].split(D);for(let t=0;t<r.length;t++){if(!r[t])continue;e+=Y.measureText(r[t]+D).width;if(e>E.get()){s+="\n"+r[t]+D;e=Y.measureText(r[t]+D).width}else{s+=r[t]+D}}s+="\n"}let t=s;i=t.split("\n");if(i[i.length-1]=="")i.pop();return i}function ht(){k.checkFrameStarted("texttrexture refresh");const t="rgba("+Math.floor(B.get()*255)+","+Math.floor(Z.get()*255)+","+Math.floor($.get()*255)+","+tt.get()+")";Y.fillStyle=t;Y.fillRect(0,0,Y.canvas.width,Y.canvas.height);const e="rgba("+Math.floor(F.get()*255)+","+Math.floor(y.get()*255)+","+Math.floor(U.get()*255)+","+w.get()+")";Y.fillStyle=e;let i=parseFloat(x.get());let s=A.get()||"arial";if(s.indexOf(D)>-1)s='"'+s+'"';Y.font=S.get()+D+i+"px "+s+"";Y.textBaseline="top";Y.textAlign=I.get();Y.letterSpacing=M.get()+"px";let r=(X.get()+"").replace(/<br\/>/g,"\n");r=r.trim();let n=r.split("\n");W=false;let a=Math.max(0,q.get());let o=Math.max(0,K.get());let h=Math.max(0,Q.get());z=0;H=0;if(T.get()&&p.get()=="Manual"){if(E.get()>128){n=ot(n)}}const l=[];for(let t=0;t<n.length;t++){const _=Y.measureText(n[t]);l[t]=Math.ceil(_.fontBoundingBoxAscent)+Math.ceil(_.fontBoundingBoxDescent)+R.get()}for(let t=0;t<n.length;t++){const _=Y.measureText(n[t]);z=Math.max(z,Math.ceil(_.width));H+=l[t]}z+=h*2;if(R.get()<0)H+=R.get()/2*-1;let u=H;if(p.get()=="Manual"){z=E.get()+h*2;if(!b.get()){H=v.get()}}H=Math.ceil(H);z=Math.ceil(z);if(z>k.maxTexSize||H>k.maxTexSize)m.setUiError("textoobig","Texture too big!");else m.setUiError("textoobig",null);H=Math.min(k.maxTexSize,H);z=Math.min(k.maxTexSize,z);let c=0;if(P.get()=="Middle")c=(H-u)/2;else if(P.get()=="Bottom")c=H-u;c+=a;H+=a+o;if(Y.canvas.width!=z||Y.canvas.height!=H)at();const f=J.get();for(let e=0;e<n.length;e++){let t=0+h;if(I.get()=="center")t=Y.canvas.width/2;if(I.get()=="right")t=Y.canvas.width-h;if(p.get()=="Manual")t+=M.get();Y.fillText(n[e],t,c);if(f){Y.lineWidth=3;Y.strokeStyle="#FF0000";Y.beginPath();Y.moveTo(0,c);Y.lineTo(Y.canvas.width,c);Y.stroke()}c+=l[e]}let g=CGL.Texture.WRAP_REPEAT;if(N.get()=="mirrored repeat")g=CGL.Texture.WRAP_MIRRORED_REPEAT;else if(N.get()=="clamp to edge")g=CGL.Texture.WRAP_CLAMP_TO_EDGE;let d=CGL.Texture.FILTER_LINEAR;if(C.get()=="nearest")d=CGL.Texture.FILTER_NEAREST;else if(C.get()=="mipmap")d=CGL.Texture.FILTER_MIPMAP;if(!L.get()||!G||!V.get()||G.width!=j.width||G.height!=j.height||G.anisotropic!=parseFloat(O.get())){if(G)G.delete();G=new CGL.Texture.createFromImage(k,j,{filter:d,anisotropic:parseFloat(O.get()),wrap:g})}G.unpackAlpha=false;G.flip=false;G.initTexture(j,d);et.set(Y.canvas.height/Y.canvas.width);it.set(n.length);V.setRef(G)}function lt(){E.setUiAttribs({greyout:p.get()!="Manual"});v.setUiAttribs({greyout:p.get()!="Manual"||b.get()});T.setUiAttribs({greyout:p.get()!="Manual"});P.setUiAttribs({greyout:p.get()!="Manual"});b.setUiAttribs({greyout:p.get()!="Manual"});i.setUiAttribs({greyout:!e.get()})}}};Ops.Gl.MainLoop_v2=class extends CABLES.Op{constructor(){super(...arguments);const r=this;const t=r.attachments={};const e=r.inFloat("Max Pixel Density (DPR)",2),i=r.inValue("FPS Limit",0),s=r.inValueBool("Reduce FPS unfocussed",false),n=r.inValueBool("Transparent",false),a=r.inValueBool("Active",1),o=r.inValueBool("Focus canvas",1),h=r.outTrigger("trigger"),l=r.outNumber("width"),u=r.outNumber("height"),c=r.outNumber("Pixel Density");r.onAnimFrame=R;e.onChange=I;const f=r.patch.cg=r.patch.cgl;let g=0;let d=0;let _=null;let m=false;if(!r.patch.cgl)r.uiAttr({error:"No webgl cgl context"});const p=vec3.create();vec3.set(p,0,0,0);const E=vec3.create();vec3.set(E,0,0,-2);let v=true;let b=null;let T=true;let A=true;let S=-1;let x=0;window.addEventListener("blur",()=>{T=false});window.addEventListener("focus",()=>{T=true});document.addEventListener("visibilitychange",()=>{A=!document.hidden});if(CABLES.UI)gui.canvasManager.addCgContext(r.patch.cgl);C();r.patch.tempData.mainloopOp=this;r.patch.cgl.canvas.classList.add("cablescontext");r.patch.cgl.canvas.dataset.contextname="cgl";r.patch.cgl.canvas.dataset.api="webgl";if(CABLES.UI)gui.setLayout();function I(){M();if(CABLES.UI){if(e.get()<1)r.patch.cgl.canvas.style.imageRendering="pixelated"}r.patch.cgl.updateSize();if(CABLES.UI)gui.setLayout()}a.onChange=function(){r.patch.removeOnAnimFrame(r);if(a.get()){r.setUiAttrib({extendTitle:""});r.onAnimFrame=R;r.patch.addOnAnimFrame(r);r.log("adding again!")}else{r.setUiAttrib({extendTitle:"Inactive"})}};function P(){if(s.get()){if(!A)return 10;if(!T)return 30}return i.get()}r.onDelete=function(){f.gl.clearColor(0,0,0,0);f.gl.clear(f.gl.COLOR_BUFFER_BIT|f.gl.DEPTH_BUFFER_BIT)};function M(){if(e.get()!=0)r.patch.cgl.pixelDensity=Math.min(e.get(),window.devicePixelRatio);else r.patch.cgl.pixelDensity=window.devicePixelRatio}function R(t,e,i){if(e===S){if(x<10)console.warn("duplicate frame?!");x++;return}S=e;if(!a.get())return;if(f.aborted||f.canvas.clientWidth===0||f.canvas.clientHeight===0)return;r.patch.cg=f;M();const s=performance.now();r.patch.config.fpsLimit=P();if(f.canvasWidth==-1){f.setCanvas(r.patch.config.glCanvasId);return}if(f.canvasWidth!=l.get()||f.canvasHeight!=u.get()){l.set(f.canvasWidth/1);u.set(f.canvasHeight/1)}if(CABLES.now()-d>1e3){CGL.fpsReport=CGL.fpsReport||[];if(r.patch.loading.getProgress()>=1&&d!==0)CGL.fpsReport.push(g);g=0;d=CABLES.now()}f.lastShader=null;f.lastMesh=null;f.renderStart(f,p,E);if(!n.get())f.gl.clearColor(0,0,0,1);else f.gl.clearColor(0,0,0,0);f.gl.clear(f.gl.COLOR_BUFFER_BIT|f.gl.DEPTH_BUFFER_BIT);h.trigger();if(f.lastMesh)f.lastMesh.unBind();if(CGL.Texture.previewTexture){if(!CGL.Texture.texturePreviewer)CGL.Texture.texturePreviewer=new CGL.Texture.texturePreview(f);CGL.Texture.texturePreviewer.render(CGL.Texture.previewTexture)}f.renderEnd(f);r.patch.cg=null;if(!n.get()){f.gl.clearColor(1,1,1,1);f.gl.colorMask(false,false,false,true);f.gl.clear(f.gl.COLOR_BUFFER_BIT);f.gl.colorMask(true,true,true,true)}if(!f.tempData.phong)f.tempData.phong={};g++;if(v){if(o.get())f.canvas.focus();v=false}c.set(r.patch.cgl.pixelDensity);r.patch.cgl.profileData.profileMainloopMs=performance.now()-s}function C(){clearTimeout(_);_=setTimeout(()=>{if(r.patch.getOpsByObjName(r.name).length>1){r.setUiError("multimainloop","there should only be one mainloop op!");if(!m)m=r.patch.addEventListener("onOpDelete",C)}else r.setUiError("multimainloop",null,1)},500)}}};Ops.Gl.ClearColor=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inTrigger("render"),s=t.outTrigger("trigger"),r=t.inFloatSlider("r",.1),n=t.inFloatSlider("g",.1),a=t.inFloatSlider("b",.1),o=t.inFloatSlider("a",1);r.setUiAttribs({colorPick:true});const h=t.patch.cgl;i.onTriggered=function(){h.gl.clearColor(r.get(),n.get(),a.get(),o.get());h.gl.clear(h.gl.COLOR_BUFFER_BIT|h.gl.DEPTH_BUFFER_BIT);s.trigger()}}};Ops.Devices.Mouse.Mouse_v4=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const U=e.attachments={};const t=e.inSwitch("Coordinates",["-1 to 1","Pixel Display","Pixel","0 to 1"],"-1 to 1"),r=e.inValueSelect("Area",["Canvas Area","Canvas","Document","Parent Element"],"Canvas Area"),n=e.inValueBool("flip y",true),i=e.inBool("right click prevent default",true),s=e.inSwitch("Events",["Pointer","Touch","Mouse"]),a=e.inValueBool("Passive Events",false),o=e.inObject("Element","element"),h=e.inValueBool("Active",true),l=e.outNumber("x",0),u=e.outNumber("y",0),c=e.outTrigger("click"),w=e.outTrigger("click right"),f=e.outBoolNum("Button is down"),g=e.outBoolNum("Mouse is hovering"),B=e.outNumber("Movement X",0),V=e.outNumber("Movement Y",0),d=e.outObject("Event");const _=e.patch.cgl;let m=1;let p=null;let E=null;a.onChange=r.onChange=y;t.onChange=k;e.onDelete=F;y();e.on("loadedValueSet",v);function v(){if(m==0){if(E.clientWidth===0)setTimeout(v,50);l.set(E.clientWidth/2);u.set(E.clientHeight/2)}else if(m==1){l.set(0);u.set(0)}else if(m==2){l.set(.5);u.set(.5)}else if(m==3){if(E.clientWidth===0){setTimeout(v,50)}l.set(E.clientWidth/2/_.pixelDensity);u.set(E.clientHeight/2/_.pixelDensity)}else console.error("unknown normalize mouse",m)}function D(r,n){r=r||0;n=n||0;if(m==0){l.set(r);u.set(n)}else if(m==3){l.set(r*_.pixelDensity);u.set(n*_.pixelDensity)}else{let i=E.clientWidth/_.pixelDensity;let s=E.clientHeight/_.pixelDensity;i=i||1;s=s||1;if(m==1){let t=r/i*2-1;let e=n/s*2-1;t=CABLES.clamp(t,-1,1);e=CABLES.clamp(e,-1,1);l.set(t);u.set(e)}else if(m==2){let t=r/i;let e=n/s;t=CABLES.clamp(t,0,1);e=CABLES.clamp(e,0,1);l.set(t);u.set(e)}}}function b(t){if(!E)return;const e=E.getBoundingClientRect();return t.clientX>e.left&&t.clientX<e.left+e.width&&t.clientY>e.top&&t.clientY<e.top+e.height}o.onChange=s.onChange=function(){r.setUiAttribs({greyout:o.isLinked()});F();y()};h.onChange=function(){if(p)F();if(h.get())y()};function k(){if(t.get()=="Pixel")m=0;else if(t.get()=="-1 to 1")m=1;else if(t.get()=="0 to 1")m=2;else if(t.get()=="Pixel Display")m=3}function T(t){d.setRef(t);f.set(false);g.set(b(t))}function A(t){if(!b(t))return;L(t);d.setRef(t);f.set(true)}function S(t){L(t);d.setRef(t);f.set(false)}function x(t){if(!b(t))return;d.setRef(t);w.trigger();if(i.get())t.preventDefault()}function I(t){if(!b(t))return;L(t);d.setRef(t);c.trigger()}function P(t){d.setRef(t);f.set(false);g.set(b(t))}function M(t){g.set(b(t));if(r.get()==="Canvas Area"){const e=E.getBoundingClientRect();const i=t.clientX-e.left;const s=t.clientY-e.top;if(i<0||i>e.width||s>e.height||s<0)return}d.setRef(t);L(t);B.set(t.movementX/_.pixelDensity);V.set(t.movementY/_.pixelDensity)}function R(t){if(event.touches&&event.touches.length>0)L(t.touches[0]);d.setRef(t)}function C(t){f.set(true);if(t.touches&&t.touches.length>0)A(t.touches[0]);d.setRef(t)}function N(t){f.set(false);S();d.setRef(t)}function O(t){console.log("mouse cancel");f.set(false);S();d.setRef(t)}function L(t){let e=t.clientX;let i=t.clientY;if(o.isLinked()){e=t.offsetX;i=t.offsetY}else{if(r.get()!="Document"){e=t.offsetX;i=t.offsetY}if(r.get()==="Canvas Area"){const s=E.getBoundingClientRect();e=t.clientX-s.left;i=t.clientY-s.top;if(e<0||e>s.width||i>s.height||i<0)return;e=CABLES.clamp(e,0,s.width);i=CABLES.clamp(i,0,s.height)}}if(n.get())i=E.clientHeight-i;D(e/_.pixelDensity,i/_.pixelDensity)}function F(){if(!p)return;p.removeEventListener("touchend",N);p.removeEventListener("touchstart",C);p.removeEventListener("touchmove",R);p.removeEventListener("touchcancel",O);p.removeEventListener("mousemove",M);p.removeEventListener("mouseleave",P);p.removeEventListener("mousedown",A);p.removeEventListener("mouseup",S);p.removeEventListener("mouseenter",T);p.removeEventListener("pointermove",M);p.removeEventListener("pointerleave",P);p.removeEventListener("pointerdown",A);p.removeEventListener("pointerup",S);p.removeEventListener("pointerenter",T);p.removeEventListener("pointercancel",O);p.removeEventListener("click",I);p.removeEventListener("contextmenu",x);p=null}function y(){if(p||!h.get())F();if(!h.get())return;p=E=_.canvas;if(o.isLinked()){p=E=o.get()}else{if(r.get()=="Canvas Area"&&_&&_.canvas){E=_.canvas.parentElement;p=document.body}if(r.get()=="Document")E=p=document.body;if(r.get()=="Parent Element")p=E=_.canvas.parentElement}if(!E){e.setUiError("noarea","could not find area element for mouse",2);return}e.setUiError("noarea",null);let t=false;if(a.get())t={passive:true};if(s.get()=="Touch"){p.addEventListener("touchend",N,t);p.addEventListener("touchstart",C,t);p.addEventListener("touchmove",R,t)}if(s.get()=="Mouse"){p.addEventListener("mousemove",M,t);p.addEventListener("mouseleave",P,t);p.addEventListener("mousedown",A,t);p.addEventListener("mouseup",S,t);p.addEventListener("mouseenter",T,t)}if(s.get()=="Pointer"){p.addEventListener("pointermove",M,t);p.addEventListener("pointerleave",P,t);p.addEventListener("pointerdown",A,t);p.addEventListener("pointerup",S,t);p.addEventListener("pointerenter",T,t)}p.addEventListener("contextmenu",x,t);p.addEventListener("click",I,t)}}};Ops.Boolean.BoolToNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inBool("Use Value 1",false),s=t.inFloat("Value 0",0),r=t.inFloat("Value 1",1),n=t.outNumber("Out Value",0);s.onChange=r.onChange=i.onChange=a;function a(){const t=i.get();if(t){n.set(r.get())}else{n.set(s.get())}}}};Ops.Vars.VarSetNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inValueFloat("Value",0);t.varName=t.inDropDown("Variable",[],"",true);new CABLES.VarSetOpWrapper(t,"number",i,t.varName)}};Ops.Vars.VarGetNumber_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.outNumber("Value");t.varName=t.inValueSelect("Variable",[],"",true);new CABLES.VarGetOpWrapper(t,"number",t.varName,i)}};Ops.Cables.CallBack_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inTriggerButton("exe");const s=t.inString("Callback Name","myFunction");const r=t.inString("Parameter 1","");const n=t.inString("Parameter 2","");const a=t.inString("Parameter 3","");let o=[0,0,0];r.onChange=function(){o[0]=r.get()};n.onChange=function(){o[1]=n.get()};a.onChange=function(){o[2]=a.get()};i.onTriggered=function(){if(t.patch.config.hasOwnProperty(s.get())){t.patch.config[s.get()](o)}else{t.log("callback ",s.get()," not found! Parameters: ",o)}}}};Ops.String.String_v3=class extends CABLES.Op{constructor(){super(...arguments);const s=this;const t=s.attachments={};const r=s.inString("value",""),e=s.outString("String");r.setUiAttribs({display:"text"});let n=false;let a=[];s.setUiAttrib({height:100,width:250,resizable:true,vizLayerMaxZoom:3500});r.onChange=function(){s.setUiAttrib({extendTitle:""});if(CABLES.UI){if(r.get())a=(r.get()||"").split("\n");else a=[]}e.set(r.get())};s.renderVizLayer=(t,e,i)=>{if(e.height<10){s.setUiAttrib({extendTitle:r.get()});n=true;return}if(n)s.setUiAttrib({extendTitle:null});n=false;i.clear(t,e);if(!r.get())return;t.save();t.scale(e.scale,e.scale);i.renderText(t,e,a,{zoomText:false,showLineNum:false,fontSize:12,scroll:0,syntax:"text",showWhitespace:false,wrap:true});t.restore()}}};Ops.Html.Utils.Notification=class extends CABLES.Op{constructor(){super(...arguments);const e=this;const t=e.attachments={defaultstyle_txt:"visibility: hidden;\nbackground-color: #282828;\ncolor: #fff;\n\npadding: 16px;\nposition: absolute;\nz-index: 9999;\nfont-size: 17px;\nopacity:0;\nborder-radius:10px;\ntext-align:center;\nleft: 50%;\ntransform: translate(-50%, 0);\n"};const i=e.inTriggerButton("Trigger animation"),s=e.inString("Text","Hello! <br> This is a pop up"),r=e.inString("Class"),n=e.inStringEditor("Style",t.defaultstyle_txt,"none"),a=e.inValueBool("Active",true),o=e.inValueBool("Convert Line Breaks",false),h=e.inFloat("Fade in",.5),l=e.inFloat("Hold ",2),u=e.inFloat("Fade out",.8),c=e.inSwitch("mode",["%","px"],"%"),f=e.inSwitch("Side",["bottom","top"],"bottom"),g=e.inFloat("Starting position",0),d=e.inFloat("Ending position",5),_=e.outTrigger("Finished trigger"),m=e.outBool("Finished",false),p=e.outObject("DOM Element");e.setPortGroup("Animation",[h,l,u]);e.setPortGroup("HTML CSS",[s,r,n,a,o]);e.setPortGroup("Positioning",[c,f,g,d]);const E="notification_"+CABLES.uuid();const U=null;let v=null;let b="block";const T=document.createElement("div");T.dataset.op=e.id;T.id=E;const A=e.patch.cgl.canvas.parentElement;A.appendChild(T);p.set(T);r.onChange=C;o.onChange=s.onChange=P;n.onChange=R;a.onChange=I;i.onTriggered=O;P();R();N();e.onDelete=M;p.onLinkChanged=R;let S=false;function x(t){if(!t){T.style.visibility="hidden";b=T.style.display||"block";T.style.display="none"}else{if(b=="none")b="block";T.style.visibility="visible";T.style.display="none"}}function I(){x(a.get())}function P(){let t=s.get();if(v===t)return;v=t;if(t&&o.get())t=t.replace(/(?:\r\n|\r|\n)/g,"<br>");if(T.innerHTML!=t)T.innerHTML=t;p.set(null);p.set(T)}function M(){if(T&&T.parentNode)T.parentNode.removeChild(T)}function R(){if(n.get()!=T.style){T.setAttribute("style",n.get());I();p.set(null);p.set(T)}N()}function C(){T.setAttribute("class",r.get());N()}e.addEventListener("onEnabledChange",function(t){e.log("css changed");x(T.style.visibility!="visible")});function N(){if(r.get()&&n.get())e.setUiError("error","DIV uses external and inline CSS",1);else e.setUiError("error",null)}function O(){if(!a.get())return;const t=c.get();const e=g.get()+t;const i=d.get()+t;const s=document.getElementById(E);T.style.display="block";const r={};L(t,e,i,r)}function L(t,e,i,s){if(S)return;m.set(false);S=true;s.easing=["cubic-bezier(0.0, 0.0, 0.2, 1.0)","linear"];s.opacity=[0,1];if(f.get()=="bottom")s.bottom=[e,i];else s.top=[e,i];document.getElementById(E).animate(s,h.get()*1e3).onfinish=function(){F(t,e,i,s)}}function F(t,e,i,s){s.easing=["linear","linear"];s.opacity=[1,1];if(f.get()=="bottom")s.bottom=[i,i];else s.top=[i,i];document.getElementById(E).animate(s,l.get()*1e3).onfinish=function(){y(t,e,i,s)}}function y(t,e,i,s){s.easing=["cubic-bezier(0.0, 0.0, 0.2, 1.0)","linear"];s.opacity=[1,0];if(f.get()=="bottom")s.bottom=[i,e];else s.top=[i,e];document.getElementById(E).animate(s,u.get()*1e3).onfinish=function(){T.style.display="none";S=false;_.trigger();m.set(true)}}}};Ops.String.ConcatMultiPort_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const r=t.inSwitch("Seperator",["None","LineBreak","Space",",","/"],"None"),n=t.inMultiPort2("Strings",CABLES.OP_PORT_TYPE_STRING),a=t.outString("String"),o=t.outNumber("Num Strings");r.onChange=n.onChange=()=>{const e=n.get();let i="";let s="";if(r.get()=="None")s="";else if(r.get()=="LineBreak")s="\n";else if(r.get()=="Space")s=" ";else s=r.get();for(let t=0;t<e.length;t++){i+=e[t].get()||"";if(t!=e.length-1)i+=s}a.set(i);o.set(e.length)}}};Ops.String.Concat_v2=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const s=t.inString("string1","ABC"),r=t.inString("string2","XYZ"),n=t.inValueBool("New Line",false),a=t.inBool("Active",true),o=t.outString("result");n.onChange=r.onChange=s.onChange=a.onChange=i;t.toWorkPortsNeedsString(s,r);i();function i(){if(!a.get()){return o.set(s.get())}let t=s.get();let e=r.get();if(!t&&!e){o.set("");return}if(!t)t="";if(!e)e="";let i="";if(t&&e&&n.get())i="\n";o.set(String(t)+i+String(e))}}};Ops.Boolean.BoolToString=class extends CABLES.Op{constructor(){super(...arguments);const t=this;const e=t.attachments={};const i=t.inBool("Boolean",false),s=t.inString("False","false"),r=t.inString("True","true"),n=t.outString("String","false");r.onChange=s.onChange=i.onChange=a;function a(){if(i.get())n.set(r.get());else n.set(s.get())}}};window.addEventListener("load",function(t){CABLES.jsLoaded=new Event("CABLES.jsLoaded");document.dispatchEvent(CABLES.jsLoaded)});(()=>{var s={};(()=>{s.d=(t,e)=>{for(var i in e){if(s.o(e,i)&&!s.o(t,i)){Object.defineProperty(t,i,{enumerable:true,get:e[i]})}}}})();(()=>{s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();(()=>{s.r=t=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(t,"__esModule",{value:true})}})();var i={};(()=>{"use strict";s.r(i);s.d(i,{VarGetOpWrapper:()=>e,VarSetOpWrapper:()=>t});const a=CABLES;class t{constructor(e,t,i,s,r,n){this._valuePort=i;this._varNamePort=s;this._op=e;this._type=t;this._typeId=-1;this._triggerPort=r;this._nextPort=n;this._var=null;this._btnCreate=e.inTriggerButton("Create new variable");this._btnCreate.setUiAttribs({hidePort:true});this._btnCreate.onTriggered=this._createVar.bind(this);this._helper=e.inUiTriggerButtons("",["Rename"]);this._helper.setUiAttribs({hidePort:true});this._helper.onTriggered=t=>{CABLES.CMD.PATCH.renameVariable(e.varName.get())};this._op.setPortGroup("Variable",[this._helper,this._varNamePort,this._btnCreate]);s.setUiAttribs({_variableSelect:true});this._op.on("uiParamPanel",this._updateVarNamesDropdown.bind(this));this._op.patch.addEventListener("variablesChanged",this._updateName.bind(this));this._op.patch.addEventListener("variableRename",this._renameVar.bind(this));this._varNamePort.onChange=this._updateName.bind(this);this._isTexture=this._valuePort.uiAttribs.objType==="texture";this._valuePort.changeAlways=true;if(this._triggerPort){this._triggerPort.onTriggered=()=>{this._setVarValue(true)}}else{this._valuePort.onChange=this._setVarValue.bind(this)}this._op.init=()=>{this._updateName();if(!this._triggerPort)this._setVarValue();this._updateErrorUi()};if(t=="array")this._typeId=a.Port.TYPE_ARRAY;else if(t=="object")this._typeId=a.Port.TYPE_OBJECT;else if(t=="string")this._typeId=a.Port.TYPE_STRING;else if(t=="texture")this._typeId=a.Port.TYPE_TEXTURE;else this._typeId=a.Port.TYPE_VALUE}_updateErrorUi(){if(CABLES.UI){if(!this._varNamePort.get())this._op.setUiError("novarname","no variable selected");else{if(this._op.hasUiErrors)this._op.setUiError("novarname",null)}}}_updateName(){this._var=null;const t=this._varNamePort.get();this._op.setTitle("var set");this._op.setUiAttrib({extendTitle:"#"+t});this._updateErrorUi();const e=this._op.patch.getVar(t);if(e&&!e.type)e.type=this._type;if(!this._op.patch.hasVar(t)&&t!=0&&!this._triggerPort){this._setVarValue()}if(!this._op.patch.hasVar(t)&&t!=0&&this._triggerPort){if(this._type=="string")this._op.patch.setVarValue(t,"");else if(this._type=="number")this._op.patch.setVarValue(t,"");else this._op.patch.setVarValue(t,null)}if(this._op.isCurrentUiOp()){this._updateVarNamesDropdown();this._op.refreshParams()}this._updateDisplay();this._op.patch.emitEvent("opVariableNameChanged",this._op,this._varNamePort.get())}_createVar(){CABLES.CMD.PATCH.createVariable(this._op,this._type,()=>{this._updateName()})}_updateDisplay(){this._valuePort.setUiAttribs({greyout:!this._varNamePort.get()})}_updateVarNamesDropdown(){if(CABLES.UI&&CABLES.UI.loaded&&CABLES.UI.loaded){const t=gui.uiProfiler.start("[vars] _updateVarNamesDropdown");const e=[];const i=this._op.patch.getVars();for(const t in i)if(i[t].type==this._type&&t!="0")e.push(t);this._varNamePort.uiAttribs.values=e;t.finish()}}_renameVar(t,e){if(t!=this._varNamePort.get())return;this._varNamePort.set(e);this._updateName()}_setVarValue(t){let e=this._valuePort.get();if(!this._var){const i=this._varNamePort.get();if(!i)return;if(this._typeId==a.Port.TYPE_VALUE&&typeof e=="string")e=parseFloat(e);this._op.patch.setVarValue(i,e,this._type);this._var=this._op.patch.getVar(i)}if(this._typeId==a.Port.TYPE_VALUE||this._typeId==a.Port.TYPE_STRING){this._var.setValue(e)}else if(this._typeId==a.Port.TYPE_ARRAY){this._arr=[];a.utils.copyArray(e,this._arr);this._var.setValue(this._arr)}else{if(this._typeId==a.Port.TYPE_OBJECT){if(this._isTexture)this._var.setValue(CGL.Texture.getEmptyTexture(this._op.patch.cgl));else this._var.setValue(null);if(e&&e.tex&&e._cgl&&!this._isTexture)this._op.setUiError("texobj","Dont use object variables for textures, use varSetTexture");else this._op.setUiError("texobj",null)}this._var.setValue(e)}if(t&&this._nextPort)this._nextPort.trigger()}}class e{constructor(t,e,i,s){this._op=t;this._type=e;this._varnamePort=i;this._variable=null;this._valueOutPort=s;this._listenerId=null;this._typeId=0;if(e=="array")this._typeId=a.Port.TYPE_ARRAY;else if(e=="object")this._typeId=a.Port.TYPE_OBJECT;else if(e=="texture")this._typeId=a.Port.TYPE_TEXTURE;else if(e=="string")this._typeId=a.Port.TYPE_STRING;else this._typeId=a.Port.TYPE_VALUE;if(s)this._isTexture=s.uiAttribs.objType==="texture";this._op.on("uiParamPanel",this._updateVarNamesDropdown.bind(this));this._op.on("uiErrorChange",this._updateTitle.bind(this));this._op.patch.on("variableRename",this._renameVar.bind(this));this._op.patch.on("variableDeleted",t=>{if(this._op.isCurrentUiOp())this._op.refreshParams()});i.setUiAttribs({_variableSelect:true});i.setUiAttribs({_variableSelectGet:true});this._varnamePort.onChange=this._changeVar.bind(this);this._op.patch.addEventListener("variablesChanged",this._init.bind(this));this._op.onDelete=()=>{if(this._variable&&this._listenerId)this._variable.off(this._listenerId)};this._op.init=()=>{this._init()}}get variable(){return this._variable}_changeVar(){if(this._variable&&this._listenerId){this._variable.off(this._listenerId)}this._init()}_renameVar(t,e){if(t!=this._varnamePort.get())return;this._varnamePort.set(e);if(!this._variable){console.log("rename has no var",t,e);this._init();if(!this._variable)return console.error("variable rename not found",t,e,this)}this._updateVarNamesDropdown();this._updateTitle();this._listenerId=this._variable.on("change",this._setValueOut.bind(this))}_updateVarNamesDropdown(){if(CABLES.UI&&CABLES.UI.loaded){const e=[];const i=this._op.patch.getVars();for(const t in i)if(i[t].type==this._type&&t!="0")e.push(t);this._op.varName.uiAttribs.values=e}}_setValueOut(t){if(this._valueOutPort)if(this._typeId==a.Port.TYPE_NUMBER||this._typeId==a.Port.TYPE_STRING)this._valueOutPort.set(t);else if(this._typeId==a.Port.TYPE_ARRAY||this._typeId==a.Port.TYPE_OBJECT||this._isTexture)this._valueOutPort.setRef(t);else console.log("unkown type?")}_updateTitle(){if(this._variable){this._op.setUiError("unknownvar",null);this._op.setTitle("var get");this._op.setUiAttrib({extendTitle:"#"+this._varnamePort.get()});if(this._valueOutPort)this._setValueOut(this._variable.getValue())}else{this._op.setUiError("unknownvar","unknown variable! - there is no setVariable with this name ("+this._varnamePort.get()+")");this._op.setUiAttrib({extendTitle:"#invalid"});if(this._valueOutPort)this._setValueOut(0)}}_init(){this._updateVarNamesDropdown();if(this._variable&&this._listenerId)this._variable.off(this._listenerId);this._variable=this._op.patch.getVar(this._op.varName.get());if(this._variable)this._listenerId=this._variable.on("change",this._setValueOut.bind(this));this._updateTitle();this._op.patch.emitEvent("opVariableNameChanged",this._op,this._varnamePort.get())}}})();var t=CABLES=typeof CABLES==="undefined"?{}:CABLES;for(var e in i)t[e]=i[e];if(i.__esModule)Object.defineProperty(t,"__esModule",{value:true})})();(()=>{var s={};(()=>{s.d=(t,e)=>{for(var i in e){if(s.o(e,i)&&!s.o(t,i)){Object.defineProperty(t,i,{enumerable:true,get:e[i]})}}}})();(()=>{s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();(()=>{s.r=t=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(t,"__esModule",{value:true})}})();var i={};(()=>{"use strict";s.r(i);s.d(i,{WireframeCube:()=>t,WireframeRect:()=>e});class t{constructor(t){this.cgl=t;this.geom=new CGL.Geometry("marker");this.geom.setPointVertices([-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,1,1,-1,1,-1,1,1,-1,-1,1,1,1,-1,1,1,1,-1,1,-1,-1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1]);this.mesh=new CGL.Mesh(this.cgl,this.geom,this.cgl.gl.LINES);this.mesh.setGeom(this.geom);this.colorShader=new CGL.UniColorShader(this.cgl);this.colorShader.setColor([0,1,1,1]);this._vScale=vec3.create()}render(t,e,i){this.cgl.pushModelMatrix();this.cgl.pushShader(this.colorShader.shader);this.cgl.pushDepthTest(false);if(t==undefined)t=1;if(e==undefined)e=t;if(i==undefined)i=t;vec3.set(this._vScale,t,e,i);mat4.scale(this.cgl.mvMatrix,this.cgl.mvMatrix,this._vScale);this.mesh.render(this.cgl.getShader());this.cgl.popDepthTest();this.cgl.popShader();this.cgl.popModelMatrix()}}class e{constructor(t){this.cgl=t;this.geom=new CGL.Geometry("marker");const e=-1;const i=1;this.geom.setPointVertices([e,e,0,i,e,0,i,e,0,i,i,0,i,i,0,e,i,0,e,i,0,e,e,0]);this.mesh=new CGL.Mesh(this.cgl,this.geom,this.cgl.gl.LINES);this.mesh.setGeom(this.geom);this.colorShader=new CGL.UniColorShader(this.cgl);this.colorShader.setColor([0,1,1,1]);this._vScale=vec3.create()}render(t,e,i){this.cgl.pushModelMatrix();this.cgl.pushShader(this.colorShader.shader);this.cgl.pushDepthTest(false);vec3.set(this._vScale,t||1,e||t||1,i||t||1);mat4.scale(this.cgl.mvMatrix,this.cgl.mvMatrix,this._vScale);this.mesh.render(this.cgl.getShader());this.cgl.popDepthTest();this.cgl.popShader();this.cgl.popModelMatrix()}}})();var t=CGL=typeof CGL==="undefined"?{}:CGL;for(var e in i)t[e]=i[e];if(i.__esModule)Object.defineProperty(t,"__esModule",{value:true})})();(()=>{var Ua={};(()=>{Ua.d=(t,e)=>{for(var i in e){if(Ua.o(e,i)&&!Ua.o(t,i)){Object.defineProperty(t,i,{enumerable:true,get:e[i]})}}}})();(()=>{Ua.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();(()=>{Ua.r=t=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(t,"__esModule",{value:true})}})();var wa={};(()=>{"use strict";Ua.r(wa);Ua.d(wa,{Framebuffer2:()=>ba,Geometry:()=>c,Mesh:()=>m,Shader:()=>b,Texture:()=>T,Uniform:()=>_,WhatTheDog:()=>Fa});var R={};Ua.r(R);Ua.d(R,{ARRAY_TYPE:()=>p,EPSILON:()=>y,RANDOM:()=>l,equals:()=>K,setMatrixArrayType:()=>W,toRadian:()=>q});var C={};Ua.r(C);Ua.d(C,{LDU:()=>gt,add:()=>dt,adjoint:()=>rt,clone:()=>J,copy:()=>Z,create:()=>Q,determinant:()=>nt,equals:()=>pt,exactEquals:()=>mt,frob:()=>ft,fromRotation:()=>lt,fromScaling:()=>ut,fromValues:()=>tt,identity:()=>$,invert:()=>st,mul:()=>bt,multiply:()=>at,multiplyScalar:()=>Et,multiplyScalarAndAdd:()=>vt,rotate:()=>ot,scale:()=>ht,set:()=>et,str:()=>ct,sub:()=>Tt,subtract:()=>_t,transpose:()=>it});var N={};Ua.r(N);Ua.d(N,{add:()=>Dt,clone:()=>St,copy:()=>xt,create:()=>At,determinant:()=>Ct,equals:()=>jt,exactEquals:()=>zt,frob:()=>Vt,fromRotation:()=>yt,fromScaling:()=>Ut,fromTranslation:()=>wt,fromValues:()=>Pt,identity:()=>It,invert:()=>Rt,mul:()=>Yt,multiply:()=>Nt,multiplyScalar:()=>Gt,multiplyScalarAndAdd:()=>Ht,rotate:()=>Ot,scale:()=>Lt,set:()=>Mt,str:()=>Bt,sub:()=>Wt,subtract:()=>kt,translate:()=>Ft});var O={};Ua.r(O);Ua.d(O,{add:()=>pe,adjoint:()=>ie,clone:()=>Kt,copy:()=>Qt,create:()=>Xt,determinant:()=>se,equals:()=>Ae,exactEquals:()=>Te,frob:()=>me,fromMat2d:()=>ce,fromMat4:()=>qt,fromQuat:()=>fe,fromRotation:()=>le,fromScaling:()=>ue,fromTranslation:()=>he,fromValues:()=>Jt,identity:()=>$t,invert:()=>ee,mul:()=>Se,multiply:()=>re,multiplyScalar:()=>ve,multiplyScalarAndAdd:()=>be,normalFromMat4:()=>ge,projection:()=>de,rotate:()=>ae,scale:()=>oe,set:()=>Zt,str:()=>_e,sub:()=>xe,subtract:()=>Ee,translate:()=>ne,transpose:()=>te});var L={};Ua.r(L);Ua.d(L,{add:()=>ai,adjoint:()=>Ne,clone:()=>Ie,copy:()=>Pe,create:()=>s,determinant:()=>Oe,equals:()=>ci,exactEquals:()=>ui,frob:()=>ni,fromQuat:()=>Je,fromQuat2:()=>Ye,fromRotation:()=>ke,fromRotationTranslation:()=>je,fromRotationTranslationScale:()=>Ke,fromRotationTranslationScaleOrigin:()=>Qe,fromScaling:()=>De,fromTranslation:()=>Ve,fromValues:()=>Me,fromXRotation:()=>Ge,fromYRotation:()=>He,fromZRotation:()=>ze,frustum:()=>Ze,getRotation:()=>qe,getScaling:()=>Xe,getTranslation:()=>We,identity:()=>S,invert:()=>e,lookAt:()=>ii,mul:()=>fi,multiply:()=>Le,multiplyScalar:()=>hi,multiplyScalarAndAdd:()=>li,ortho:()=>ei,perspective:()=>$e,perspectiveFromFieldOfView:()=>ti,rotate:()=>ye,rotateX:()=>Ue,rotateY:()=>we,rotateZ:()=>Be,scale:()=>Fe,set:()=>Re,str:()=>ri,sub:()=>gi,subtract:()=>oi,targetTo:()=>si,translate:()=>r,transpose:()=>Ce});var F={};Ua.r(F);Ua.d(F,{add:()=>pi,angle:()=>Hi,bezier:()=>yi,ceil:()=>bi,clone:()=>di,copy:()=>mi,create:()=>B,cross:()=>H,dist:()=>Qi,distance:()=>Mi,div:()=>Ki,divide:()=>vi,dot:()=>G,equals:()=>Wi,exactEquals:()=>Yi,floor:()=>Ti,forEach:()=>ts,fromValues:()=>o,hermite:()=>Fi,inverse:()=>Oi,len:()=>Zi,length:()=>_i,lerp:()=>Li,max:()=>Si,min:()=>Ai,mul:()=>qi,multiply:()=>Ei,negate:()=>Ni,normalize:()=>k,random:()=>Ui,rotateX:()=>Di,rotateY:()=>ki,rotateZ:()=>Gi,round:()=>xi,scale:()=>Ii,scaleAndAdd:()=>Pi,set:()=>V,sqrDist:()=>Ji,sqrLen:()=>$i,squaredDistance:()=>Ri,squaredLength:()=>Ci,str:()=>ji,sub:()=>Xi,subtract:()=>D,transformMat3:()=>Bi,transformMat4:()=>wi,transformQuat:()=>Vi,zero:()=>zi});var U={};Ua.r(U);Ua.d(U,{add:()=>as,ceil:()=>us,clone:()=>is,copy:()=>rs,create:()=>es,cross:()=>Is,dist:()=>Bs,distance:()=>ps,div:()=>ws,divide:()=>ls,dot:()=>xs,equals:()=>Fs,exactEquals:()=>Ls,floor:()=>cs,forEach:()=>Gs,fromValues:()=>ss,inverse:()=>As,len:()=>Ds,length:()=>vs,lerp:()=>Ps,max:()=>gs,min:()=>fs,mul:()=>Us,multiply:()=>hs,negate:()=>Ts,normalize:()=>Ss,random:()=>Ms,round:()=>ds,scale:()=>_s,scaleAndAdd:()=>ms,set:()=>ns,sqrDist:()=>Vs,sqrLen:()=>ks,squaredDistance:()=>Es,squaredLength:()=>bs,str:()=>Os,sub:()=>ys,subtract:()=>os,transformMat4:()=>Rs,transformQuat:()=>Cs,zero:()=>Ns});var w={};Ua.r(w);Ua.d(w,{add:()=>ur,calculateW:()=>Qs,clone:()=>ar,conjugate:()=>ir,copy:()=>hr,create:()=>n,dot:()=>gr,equals:()=>Tr,exactEquals:()=>br,exp:()=>Js,fromEuler:()=>rr,fromMat3:()=>sr,fromValues:()=>or,getAngle:()=>Ys,getAxisAngle:()=>js,identity:()=>Hs,invert:()=>er,len:()=>mr,length:()=>_r,lerp:()=>dr,ln:()=>Zs,mul:()=>cr,multiply:()=>Ws,normalize:()=>vr,pow:()=>$s,random:()=>tr,rotateX:()=>Xs,rotateY:()=>qs,rotateZ:()=>Ks,rotationTo:()=>Ar,scale:()=>fr,set:()=>lr,setAxes:()=>xr,setAxisAngle:()=>zs,slerp:()=>h,sqlerp:()=>Sr,sqrLen:()=>Er,squaredLength:()=>pr,str:()=>nr});var j={};Ua.r(j);Ua.d(j,{add:()=>qr,clone:()=>Pr,conjugate:()=>en,copy:()=>Fr,create:()=>Ir,dot:()=>Zr,equals:()=>ln,exactEquals:()=>hn,fromMat4:()=>Lr,fromRotation:()=>Or,fromRotationTranslation:()=>Cr,fromRotationTranslationValues:()=>Rr,fromTranslation:()=>Nr,fromValues:()=>Mr,getDual:()=>Br,getReal:()=>wr,getTranslation:()=>kr,identity:()=>yr,invert:()=>tn,len:()=>rn,length:()=>sn,lerp:()=>$r,mul:()=>Qr,multiply:()=>Kr,normalize:()=>an,rotateAroundAxis:()=>Xr,rotateByQuatAppend:()=>Yr,rotateByQuatPrepend:()=>Wr,rotateX:()=>Hr,rotateY:()=>zr,rotateZ:()=>jr,scale:()=>Jr,set:()=>Ur,setDual:()=>Dr,setReal:()=>Vr,sqrLen:()=>nn,squaredLength:()=>f,str:()=>on,translate:()=>Gr});var Y={};Ua.r(Y);Ua.d(Y,{add:()=>gn,angle:()=>kn,ceil:()=>pn,clone:()=>un,copy:()=>fn,create:()=>t,cross:()=>Ln,dist:()=>Kn,distance:()=>xn,div:()=>qn,divide:()=>mn,dot:()=>On,equals:()=>jn,exactEquals:()=>zn,floor:()=>En,forEach:()=>Zn,fromValues:()=>cn,inverse:()=>Cn,len:()=>Yn,length:()=>Pn,lerp:()=>Fn,max:()=>bn,min:()=>vn,mul:()=>Xn,multiply:()=>_n,negate:()=>Rn,normalize:()=>Nn,random:()=>yn,rotate:()=>Dn,round:()=>Tn,scale:()=>An,scaleAndAdd:()=>Sn,set:()=>z,sqrDist:()=>Qn,sqrLen:()=>Jn,squaredDistance:()=>In,squaredLength:()=>Mn,str:()=>Hn,sub:()=>Wn,subtract:()=>dn,transformMat2:()=>Un,transformMat2d:()=>wn,transformMat3:()=>Bn,transformMat4:()=>Vn,zero:()=>Gn});const A=CABLES;const u=CABLES.SHARED;var y=1e-6;var p=typeof Float32Array!=="undefined"?Float32Array:Array;var l=Math.random;function W(t){p=t}var X=Math.PI/180;function q(t){return t*X}function K(t,e){return Math.abs(t-e)<=y*Math.max(1,Math.abs(t),Math.abs(e))}if(!Math.hypot)Math.hypot=function(){var t=0,e=arguments.length;while(e--){t+=arguments[e]*arguments[e]}return Math.sqrt(t)};function Q(){var t=new p(4);if(p!=Float32Array){t[1]=0;t[2]=0}t[0]=1;t[3]=1;return t}function J(t){var e=new p(4);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];return e}function Z(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t}function $(t){t[0]=1;t[1]=0;t[2]=0;t[3]=1;return t}function tt(t,e,i,s){var r=new p(4);r[0]=t;r[1]=e;r[2]=i;r[3]=s;return r}function et(t,e,i,s,r){t[0]=e;t[1]=i;t[2]=s;t[3]=r;return t}function it(t,e){if(t===e){var i=e[1];t[1]=e[2];t[2]=i}else{t[0]=e[0];t[1]=e[2];t[2]=e[1];t[3]=e[3]}return t}function st(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=i*n-r*s;if(!a){return null}a=1/a;t[0]=n*a;t[1]=-s*a;t[2]=-r*a;t[3]=i*a;return t}function rt(t,e){var i=e[0];t[0]=e[3];t[1]=-e[1];t[2]=-e[2];t[3]=i;return t}function nt(t){return t[0]*t[3]-t[2]*t[1]}function at(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=i[0],h=i[1],l=i[2],u=i[3];t[0]=s*o+n*h;t[1]=r*o+a*h;t[2]=s*l+n*u;t[3]=r*l+a*u;return t}function ot(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=Math.sin(i);var h=Math.cos(i);t[0]=s*h+n*o;t[1]=r*h+a*o;t[2]=s*-o+n*h;t[3]=r*-o+a*h;return t}function ht(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=i[0],h=i[1];t[0]=s*o;t[1]=r*o;t[2]=n*h;t[3]=a*h;return t}function lt(t,e){var i=Math.sin(e);var s=Math.cos(e);t[0]=s;t[1]=i;t[2]=-i;t[3]=s;return t}function ut(t,e){t[0]=e[0];t[1]=0;t[2]=0;t[3]=e[1];return t}function ct(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function ft(t){return Math.hypot(t[0],t[1],t[2],t[3])}function gt(t,e,i,s){t[2]=s[2]/s[0];i[0]=s[0];i[1]=s[1];i[3]=s[3]-t[2]*i[1];return[t,e,i]}function dt(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];return t}function _t(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];t[3]=e[3]-i[3];return t}function mt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function pt(t,e){var i=t[0],s=t[1],r=t[2],n=t[3];var a=e[0],o=e[1],h=e[2],l=e[3];return Math.abs(i-a)<=y*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=y*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(r-h)<=y*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=y*Math.max(1,Math.abs(n),Math.abs(l))}function Et(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;return t}function vt(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;t[3]=e[3]+i[3]*s;return t}var bt=at;var Tt=_t;function At(){var t=new p(6);if(p!=Float32Array){t[1]=0;t[2]=0;t[4]=0;t[5]=0}t[0]=1;t[3]=1;return t}function St(t){var e=new p(6);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];return e}function xt(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];return t}function It(t){t[0]=1;t[1]=0;t[2]=0;t[3]=1;t[4]=0;t[5]=0;return t}function Pt(t,e,i,s,r,n){var a=new p(6);a[0]=t;a[1]=e;a[2]=i;a[3]=s;a[4]=r;a[5]=n;return a}function Mt(t,e,i,s,r,n,a){t[0]=e;t[1]=i;t[2]=s;t[3]=r;t[4]=n;t[5]=a;return t}function Rt(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=e[4],o=e[5];var h=i*n-s*r;if(!h){return null}h=1/h;t[0]=n*h;t[1]=-s*h;t[2]=-r*h;t[3]=i*h;t[4]=(r*o-n*a)*h;t[5]=(s*a-i*o)*h;return t}function Ct(t){return t[0]*t[3]-t[1]*t[2]}function Nt(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5];var l=i[0],u=i[1],c=i[2],f=i[3],g=i[4],d=i[5];t[0]=s*l+n*u;t[1]=r*l+a*u;t[2]=s*c+n*f;t[3]=r*c+a*f;t[4]=s*g+n*d+o;t[5]=r*g+a*d+h;return t}function Ot(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5];var l=Math.sin(i);var u=Math.cos(i);t[0]=s*u+n*l;t[1]=r*u+a*l;t[2]=s*-l+n*u;t[3]=r*-l+a*u;t[4]=o;t[5]=h;return t}function Lt(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5];var l=i[0],u=i[1];t[0]=s*l;t[1]=r*l;t[2]=n*u;t[3]=a*u;t[4]=o;t[5]=h;return t}function Ft(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5];var l=i[0],u=i[1];t[0]=s;t[1]=r;t[2]=n;t[3]=a;t[4]=s*l+n*u+o;t[5]=r*l+a*u+h;return t}function yt(t,e){var i=Math.sin(e),s=Math.cos(e);t[0]=s;t[1]=i;t[2]=-i;t[3]=s;t[4]=0;t[5]=0;return t}function Ut(t,e){t[0]=e[0];t[1]=0;t[2]=0;t[3]=e[1];t[4]=0;t[5]=0;return t}function wt(t,e){t[0]=1;t[1]=0;t[2]=0;t[3]=1;t[4]=e[0];t[5]=e[1];return t}function Bt(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function Vt(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)}function Dt(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];t[4]=e[4]+i[4];t[5]=e[5]+i[5];return t}function kt(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];t[3]=e[3]-i[3];t[4]=e[4]-i[4];t[5]=e[5]-i[5];return t}function Gt(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;t[4]=e[4]*i;t[5]=e[5]*i;return t}function Ht(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;t[3]=e[3]+i[3]*s;t[4]=e[4]+i[4]*s;t[5]=e[5]+i[5]*s;return t}function zt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function jt(t,e){var i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5];var h=e[0],l=e[1],u=e[2],c=e[3],f=e[4],g=e[5];return Math.abs(i-h)<=y*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(s-l)<=y*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(r-u)<=y*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(n-c)<=y*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-f)<=y*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(o-g)<=y*Math.max(1,Math.abs(o),Math.abs(g))}var Yt=Nt;var Wt=kt;function Xt(){var t=new p(9);if(p!=Float32Array){t[1]=0;t[2]=0;t[3]=0;t[5]=0;t[6]=0;t[7]=0}t[0]=1;t[4]=1;t[8]=1;return t}function qt(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[4];t[4]=e[5];t[5]=e[6];t[6]=e[8];t[7]=e[9];t[8]=e[10];return t}function Kt(t){var e=new p(9);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];e[8]=t[8];return e}function Qt(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];return t}function Jt(t,e,i,s,r,n,a,o,h){var l=new p(9);l[0]=t;l[1]=e;l[2]=i;l[3]=s;l[4]=r;l[5]=n;l[6]=a;l[7]=o;l[8]=h;return l}function Zt(t,e,i,s,r,n,a,o,h,l){t[0]=e;t[1]=i;t[2]=s;t[3]=r;t[4]=n;t[5]=a;t[6]=o;t[7]=h;t[8]=l;return t}function $t(t){t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=1;t[5]=0;t[6]=0;t[7]=0;t[8]=1;return t}function te(t,e){if(t===e){var i=e[1],s=e[2],r=e[5];t[1]=e[3];t[2]=e[6];t[3]=i;t[5]=e[7];t[6]=s;t[7]=r}else{t[0]=e[0];t[1]=e[3];t[2]=e[6];t[3]=e[1];t[4]=e[4];t[5]=e[7];t[6]=e[2];t[7]=e[5];t[8]=e[8]}return t}function ee(t,e){var i=e[0],s=e[1],r=e[2];var n=e[3],a=e[4],o=e[5];var h=e[6],l=e[7],u=e[8];var c=u*a-o*l;var f=-u*n+o*h;var g=l*n-a*h;var d=i*c+s*f+r*g;if(!d){return null}d=1/d;t[0]=c*d;t[1]=(-u*s+r*l)*d;t[2]=(o*s-r*a)*d;t[3]=f*d;t[4]=(u*i-r*h)*d;t[5]=(-o*i+r*n)*d;t[6]=g*d;t[7]=(-l*i+s*h)*d;t[8]=(a*i-s*n)*d;return t}function ie(t,e){var i=e[0],s=e[1],r=e[2];var n=e[3],a=e[4],o=e[5];var h=e[6],l=e[7],u=e[8];t[0]=a*u-o*l;t[1]=r*l-s*u;t[2]=s*o-r*a;t[3]=o*h-n*u;t[4]=i*u-r*h;t[5]=r*n-i*o;t[6]=n*l-a*h;t[7]=s*h-i*l;t[8]=i*a-s*n;return t}function se(t){var e=t[0],i=t[1],s=t[2];var r=t[3],n=t[4],a=t[5];var o=t[6],h=t[7],l=t[8];return e*(l*n-a*h)+i*(-l*r+a*o)+s*(h*r-n*o)}function re(t,e,i){var s=e[0],r=e[1],n=e[2];var a=e[3],o=e[4],h=e[5];var l=e[6],u=e[7],c=e[8];var f=i[0],g=i[1],d=i[2];var _=i[3],m=i[4],p=i[5];var E=i[6],v=i[7],b=i[8];t[0]=f*s+g*a+d*l;t[1]=f*r+g*o+d*u;t[2]=f*n+g*h+d*c;t[3]=_*s+m*a+p*l;t[4]=_*r+m*o+p*u;t[5]=_*n+m*h+p*c;t[6]=E*s+v*a+b*l;t[7]=E*r+v*o+b*u;t[8]=E*n+v*h+b*c;return t}function ne(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],f=i[0],g=i[1];t[0]=s;t[1]=r;t[2]=n;t[3]=a;t[4]=o;t[5]=h;t[6]=f*s+g*a+l;t[7]=f*r+g*o+u;t[8]=f*n+g*h+c;return t}function ae(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],f=Math.sin(i),g=Math.cos(i);t[0]=g*s+f*a;t[1]=g*r+f*o;t[2]=g*n+f*h;t[3]=g*a-f*s;t[4]=g*o-f*r;t[5]=g*h-f*n;t[6]=l;t[7]=u;t[8]=c;return t}function oe(t,e,i){var s=i[0],r=i[1];t[0]=s*e[0];t[1]=s*e[1];t[2]=s*e[2];t[3]=r*e[3];t[4]=r*e[4];t[5]=r*e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];return t}function he(t,e){t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=1;t[5]=0;t[6]=e[0];t[7]=e[1];t[8]=1;return t}function le(t,e){var i=Math.sin(e),s=Math.cos(e);t[0]=s;t[1]=i;t[2]=0;t[3]=-i;t[4]=s;t[5]=0;t[6]=0;t[7]=0;t[8]=1;return t}function ue(t,e){t[0]=e[0];t[1]=0;t[2]=0;t[3]=0;t[4]=e[1];t[5]=0;t[6]=0;t[7]=0;t[8]=1;return t}function ce(t,e){t[0]=e[0];t[1]=e[1];t[2]=0;t[3]=e[2];t[4]=e[3];t[5]=0;t[6]=e[4];t[7]=e[5];t[8]=1;return t}function fe(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=i+i;var o=s+s;var h=r+r;var l=i*a;var u=s*a;var c=s*o;var f=r*a;var g=r*o;var d=r*h;var _=n*a;var m=n*o;var p=n*h;t[0]=1-c-d;t[3]=u-p;t[6]=f+m;t[1]=u+p;t[4]=1-l-d;t[7]=g-_;t[2]=f-m;t[5]=g+_;t[8]=1-l-c;return t}function ge(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=e[4],o=e[5],h=e[6],l=e[7];var u=e[8],c=e[9],f=e[10],g=e[11];var d=e[12],_=e[13],m=e[14],p=e[15];var E=i*o-s*a;var v=i*h-r*a;var b=i*l-n*a;var T=s*h-r*o;var A=s*l-n*o;var S=r*l-n*h;var x=u*_-c*d;var I=u*m-f*d;var P=u*p-g*d;var M=c*m-f*_;var R=c*p-g*_;var C=f*p-g*m;var N=E*C-v*R+b*M+T*P-A*I+S*x;if(!N){return null}N=1/N;t[0]=(o*C-h*R+l*M)*N;t[1]=(h*P-a*C-l*I)*N;t[2]=(a*R-o*P+l*x)*N;t[3]=(r*R-s*C-n*M)*N;t[4]=(i*C-r*P+n*I)*N;t[5]=(s*P-i*R-n*x)*N;t[6]=(_*S-m*A+p*T)*N;t[7]=(m*b-d*S-p*v)*N;t[8]=(d*A-_*b+p*E)*N;return t}function de(t,e,i){t[0]=2/e;t[1]=0;t[2]=0;t[3]=0;t[4]=-2/i;t[5]=0;t[6]=-1;t[7]=1;t[8]=1;return t}function _e(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function me(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}function pe(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];t[4]=e[4]+i[4];t[5]=e[5]+i[5];t[6]=e[6]+i[6];t[7]=e[7]+i[7];t[8]=e[8]+i[8];return t}function Ee(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];t[3]=e[3]-i[3];t[4]=e[4]-i[4];t[5]=e[5]-i[5];t[6]=e[6]-i[6];t[7]=e[7]-i[7];t[8]=e[8]-i[8];return t}function ve(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;t[4]=e[4]*i;t[5]=e[5]*i;t[6]=e[6]*i;t[7]=e[7]*i;t[8]=e[8]*i;return t}function be(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;t[3]=e[3]+i[3]*s;t[4]=e[4]+i[4]*s;t[5]=e[5]+i[5]*s;t[6]=e[6]+i[6]*s;t[7]=e[7]+i[7]*s;t[8]=e[8]+i[8]*s;return t}function Te(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function Ae(t,e){var i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],u=t[8];var c=e[0],f=e[1],g=e[2],d=e[3],_=e[4],m=e[5],p=e[6],E=e[7],v=e[8];return Math.abs(i-c)<=y*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-f)<=y*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(r-g)<=y*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(n-d)<=y*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-_)<=y*Math.max(1,Math.abs(a),Math.abs(_))&&Math.abs(o-m)<=y*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(h-p)<=y*Math.max(1,Math.abs(h),Math.abs(p))&&Math.abs(l-E)<=y*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(u-v)<=y*Math.max(1,Math.abs(u),Math.abs(v))}var Se=re;var xe=Ee;function s(){var t=new p(16);if(p!=Float32Array){t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[11]=0;t[12]=0;t[13]=0;t[14]=0}t[0]=1;t[5]=1;t[10]=1;t[15]=1;return t}function Ie(t){var e=new p(16);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];e[8]=t[8];e[9]=t[9];e[10]=t[10];e[11]=t[11];e[12]=t[12];e[13]=t[13];e[14]=t[14];e[15]=t[15];return e}function Pe(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t}function Me(t,e,i,s,r,n,a,o,h,l,u,c,f,g,d,_){var m=new p(16);m[0]=t;m[1]=e;m[2]=i;m[3]=s;m[4]=r;m[5]=n;m[6]=a;m[7]=o;m[8]=h;m[9]=l;m[10]=u;m[11]=c;m[12]=f;m[13]=g;m[14]=d;m[15]=_;return m}function Re(t,e,i,s,r,n,a,o,h,l,u,c,f,g,d,_,m){t[0]=e;t[1]=i;t[2]=s;t[3]=r;t[4]=n;t[5]=a;t[6]=o;t[7]=h;t[8]=l;t[9]=u;t[10]=c;t[11]=f;t[12]=g;t[13]=d;t[14]=_;t[15]=m;return t}function S(t){t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=1;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function Ce(t,e){if(t===e){var i=e[1],s=e[2],r=e[3];var n=e[6],a=e[7];var o=e[11];t[1]=e[4];t[2]=e[8];t[3]=e[12];t[4]=i;t[6]=e[9];t[7]=e[13];t[8]=s;t[9]=n;t[11]=e[14];t[12]=r;t[13]=a;t[14]=o}else{t[0]=e[0];t[1]=e[4];t[2]=e[8];t[3]=e[12];t[4]=e[1];t[5]=e[5];t[6]=e[9];t[7]=e[13];t[8]=e[2];t[9]=e[6];t[10]=e[10];t[11]=e[14];t[12]=e[3];t[13]=e[7];t[14]=e[11];t[15]=e[15]}return t}function e(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=e[4],o=e[5],h=e[6],l=e[7];var u=e[8],c=e[9],f=e[10],g=e[11];var d=e[12],_=e[13],m=e[14],p=e[15];var E=i*o-s*a;var v=i*h-r*a;var b=i*l-n*a;var T=s*h-r*o;var A=s*l-n*o;var S=r*l-n*h;var x=u*_-c*d;var I=u*m-f*d;var P=u*p-g*d;var M=c*m-f*_;var R=c*p-g*_;var C=f*p-g*m;var N=E*C-v*R+b*M+T*P-A*I+S*x;if(!N){return null}N=1/N;t[0]=(o*C-h*R+l*M)*N;t[1]=(r*R-s*C-n*M)*N;t[2]=(_*S-m*A+p*T)*N;t[3]=(f*A-c*S-g*T)*N;t[4]=(h*P-a*C-l*I)*N;t[5]=(i*C-r*P+n*I)*N;t[6]=(m*b-d*S-p*v)*N;t[7]=(u*S-f*b+g*v)*N;t[8]=(a*R-o*P+l*x)*N;t[9]=(s*P-i*R-n*x)*N;t[10]=(d*A-_*b+p*E)*N;t[11]=(c*b-u*A-g*E)*N;t[12]=(o*I-a*M-h*x)*N;t[13]=(i*M-s*I+r*x)*N;t[14]=(_*v-d*T-m*E)*N;t[15]=(u*T-c*v+f*E)*N;return t}function Ne(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=e[4],o=e[5],h=e[6],l=e[7];var u=e[8],c=e[9],f=e[10],g=e[11];var d=e[12],_=e[13],m=e[14],p=e[15];t[0]=o*(f*p-g*m)-c*(h*p-l*m)+_*(h*g-l*f);t[1]=-(s*(f*p-g*m)-c*(r*p-n*m)+_*(r*g-n*f));t[2]=s*(h*p-l*m)-o*(r*p-n*m)+_*(r*l-n*h);t[3]=-(s*(h*g-l*f)-o*(r*g-n*f)+c*(r*l-n*h));t[4]=-(a*(f*p-g*m)-u*(h*p-l*m)+d*(h*g-l*f));t[5]=i*(f*p-g*m)-u*(r*p-n*m)+d*(r*g-n*f);t[6]=-(i*(h*p-l*m)-a*(r*p-n*m)+d*(r*l-n*h));t[7]=i*(h*g-l*f)-a*(r*g-n*f)+u*(r*l-n*h);t[8]=a*(c*p-g*_)-u*(o*p-l*_)+d*(o*g-l*c);t[9]=-(i*(c*p-g*_)-u*(s*p-n*_)+d*(s*g-n*c));t[10]=i*(o*p-l*_)-a*(s*p-n*_)+d*(s*l-n*o);t[11]=-(i*(o*g-l*c)-a*(s*g-n*c)+u*(s*l-n*o));t[12]=-(a*(c*m-f*_)-u*(o*m-h*_)+d*(o*f-h*c));t[13]=i*(c*m-f*_)-u*(s*m-r*_)+d*(s*f-r*c);t[14]=-(i*(o*m-h*_)-a*(s*m-r*_)+d*(s*h-r*o));t[15]=i*(o*f-h*c)-a*(s*f-r*c)+u*(s*h-r*o);return t}function Oe(t){var e=t[0],i=t[1],s=t[2],r=t[3];var n=t[4],a=t[5],o=t[6],h=t[7];var l=t[8],u=t[9],c=t[10],f=t[11];var g=t[12],d=t[13],_=t[14],m=t[15];var p=e*a-i*n;var E=e*o-s*n;var v=e*h-r*n;var b=i*o-s*a;var T=i*h-r*a;var A=s*h-r*o;var S=l*d-u*g;var x=l*_-c*g;var I=l*m-f*g;var P=u*_-c*d;var M=u*m-f*d;var R=c*m-f*_;return p*R-E*M+v*P+b*I-T*x+A*S}function Le(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=e[4],h=e[5],l=e[6],u=e[7];var c=e[8],f=e[9],g=e[10],d=e[11];var _=e[12],m=e[13],p=e[14],E=e[15];var v=i[0],b=i[1],T=i[2],A=i[3];t[0]=v*s+b*o+T*c+A*_;t[1]=v*r+b*h+T*f+A*m;t[2]=v*n+b*l+T*g+A*p;t[3]=v*a+b*u+T*d+A*E;v=i[4];b=i[5];T=i[6];A=i[7];t[4]=v*s+b*o+T*c+A*_;t[5]=v*r+b*h+T*f+A*m;t[6]=v*n+b*l+T*g+A*p;t[7]=v*a+b*u+T*d+A*E;v=i[8];b=i[9];T=i[10];A=i[11];t[8]=v*s+b*o+T*c+A*_;t[9]=v*r+b*h+T*f+A*m;t[10]=v*n+b*l+T*g+A*p;t[11]=v*a+b*u+T*d+A*E;v=i[12];b=i[13];T=i[14];A=i[15];t[12]=v*s+b*o+T*c+A*_;t[13]=v*r+b*h+T*f+A*m;t[14]=v*n+b*l+T*g+A*p;t[15]=v*a+b*u+T*d+A*E;return t}function r(t,e,i){var s=i[0],r=i[1],n=i[2];var a,o,h,l;var u,c,f,g;var d,_,m,p;if(e===t){t[12]=e[0]*s+e[4]*r+e[8]*n+e[12];t[13]=e[1]*s+e[5]*r+e[9]*n+e[13];t[14]=e[2]*s+e[6]*r+e[10]*n+e[14];t[15]=e[3]*s+e[7]*r+e[11]*n+e[15]}else{a=e[0];o=e[1];h=e[2];l=e[3];u=e[4];c=e[5];f=e[6];g=e[7];d=e[8];_=e[9];m=e[10];p=e[11];t[0]=a;t[1]=o;t[2]=h;t[3]=l;t[4]=u;t[5]=c;t[6]=f;t[7]=g;t[8]=d;t[9]=_;t[10]=m;t[11]=p;t[12]=a*s+u*r+d*n+e[12];t[13]=o*s+c*r+_*n+e[13];t[14]=h*s+f*r+m*n+e[14];t[15]=l*s+g*r+p*n+e[15]}return t}function Fe(t,e,i){var s=i[0],r=i[1],n=i[2];t[0]=e[0]*s;t[1]=e[1]*s;t[2]=e[2]*s;t[3]=e[3]*s;t[4]=e[4]*r;t[5]=e[5]*r;t[6]=e[6]*r;t[7]=e[7]*r;t[8]=e[8]*n;t[9]=e[9]*n;t[10]=e[10]*n;t[11]=e[11]*n;t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t}function ye(t,e,i,s){var r=s[0],n=s[1],a=s[2];var o=Math.hypot(r,n,a);var h,l,u;var c,f,g,d;var _,m,p,E;var v,b,T,A;var S,x,I;var P,M,R;var C,N,O;if(o<y){return null}o=1/o;r*=o;n*=o;a*=o;h=Math.sin(i);l=Math.cos(i);u=1-l;c=e[0];f=e[1];g=e[2];d=e[3];_=e[4];m=e[5];p=e[6];E=e[7];v=e[8];b=e[9];T=e[10];A=e[11];S=r*r*u+l;x=n*r*u+a*h;I=a*r*u-n*h;P=r*n*u-a*h;M=n*n*u+l;R=a*n*u+r*h;C=r*a*u+n*h;N=n*a*u-r*h;O=a*a*u+l;t[0]=c*S+_*x+v*I;t[1]=f*S+m*x+b*I;t[2]=g*S+p*x+T*I;t[3]=d*S+E*x+A*I;t[4]=c*P+_*M+v*R;t[5]=f*P+m*M+b*R;t[6]=g*P+p*M+T*R;t[7]=d*P+E*M+A*R;t[8]=c*C+_*N+v*O;t[9]=f*C+m*N+b*O;t[10]=g*C+p*N+T*O;t[11]=d*C+E*N+A*O;if(e!==t){t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}return t}function Ue(t,e,i){var s=Math.sin(i);var r=Math.cos(i);var n=e[4];var a=e[5];var o=e[6];var h=e[7];var l=e[8];var u=e[9];var c=e[10];var f=e[11];if(e!==t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}t[4]=n*r+l*s;t[5]=a*r+u*s;t[6]=o*r+c*s;t[7]=h*r+f*s;t[8]=l*r-n*s;t[9]=u*r-a*s;t[10]=c*r-o*s;t[11]=f*r-h*s;return t}function we(t,e,i){var s=Math.sin(i);var r=Math.cos(i);var n=e[0];var a=e[1];var o=e[2];var h=e[3];var l=e[8];var u=e[9];var c=e[10];var f=e[11];if(e!==t){t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}t[0]=n*r-l*s;t[1]=a*r-u*s;t[2]=o*r-c*s;t[3]=h*r-f*s;t[8]=n*s+l*r;t[9]=a*s+u*r;t[10]=o*s+c*r;t[11]=h*s+f*r;return t}function Be(t,e,i){var s=Math.sin(i);var r=Math.cos(i);var n=e[0];var a=e[1];var o=e[2];var h=e[3];var l=e[4];var u=e[5];var c=e[6];var f=e[7];if(e!==t){t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}t[0]=n*r+l*s;t[1]=a*r+u*s;t[2]=o*r+c*s;t[3]=h*r+f*s;t[4]=l*r-n*s;t[5]=u*r-a*s;t[6]=c*r-o*s;t[7]=f*r-h*s;return t}function Ve(t,e){t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=1;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=e[0];t[13]=e[1];t[14]=e[2];t[15]=1;return t}function De(t,e){t[0]=e[0];t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=e[1];t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=e[2];t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function ke(t,e,i){var s=i[0],r=i[1],n=i[2];var a=Math.hypot(s,r,n);var o,h,l;if(a<y){return null}a=1/a;s*=a;r*=a;n*=a;o=Math.sin(e);h=Math.cos(e);l=1-h;t[0]=s*s*l+h;t[1]=r*s*l+n*o;t[2]=n*s*l-r*o;t[3]=0;t[4]=s*r*l-n*o;t[5]=r*r*l+h;t[6]=n*r*l+s*o;t[7]=0;t[8]=s*n*l+r*o;t[9]=r*n*l-s*o;t[10]=n*n*l+h;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function Ge(t,e){var i=Math.sin(e);var s=Math.cos(e);t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=s;t[6]=i;t[7]=0;t[8]=0;t[9]=-i;t[10]=s;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function He(t,e){var i=Math.sin(e);var s=Math.cos(e);t[0]=s;t[1]=0;t[2]=-i;t[3]=0;t[4]=0;t[5]=1;t[6]=0;t[7]=0;t[8]=i;t[9]=0;t[10]=s;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function ze(t,e){var i=Math.sin(e);var s=Math.cos(e);t[0]=s;t[1]=i;t[2]=0;t[3]=0;t[4]=-i;t[5]=s;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function je(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=s+s;var h=r+r;var l=n+n;var u=s*o;var c=s*h;var f=s*l;var g=r*h;var d=r*l;var _=n*l;var m=a*o;var p=a*h;var E=a*l;t[0]=1-(g+_);t[1]=c+E;t[2]=f-p;t[3]=0;t[4]=c-E;t[5]=1-(u+_);t[6]=d+m;t[7]=0;t[8]=f+p;t[9]=d-m;t[10]=1-(u+g);t[11]=0;t[12]=i[0];t[13]=i[1];t[14]=i[2];t[15]=1;return t}function Ye(t,e){var i=new p(3);var s=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7];var c=s*s+r*r+n*n+a*a;if(c>0){i[0]=(o*a+u*s+h*n-l*r)*2/c;i[1]=(h*a+u*r+l*s-o*n)*2/c;i[2]=(l*a+u*n+o*r-h*s)*2/c}else{i[0]=(o*a+u*s+h*n-l*r)*2;i[1]=(h*a+u*r+l*s-o*n)*2;i[2]=(l*a+u*n+o*r-h*s)*2}je(t,e,i);return t}function We(t,e){t[0]=e[12];t[1]=e[13];t[2]=e[14];return t}function Xe(t,e){var i=e[0];var s=e[1];var r=e[2];var n=e[4];var a=e[5];var o=e[6];var h=e[8];var l=e[9];var u=e[10];t[0]=Math.hypot(i,s,r);t[1]=Math.hypot(n,a,o);t[2]=Math.hypot(h,l,u);return t}function qe(t,e){var i=new p(3);Xe(i,e);var s=1/i[0];var r=1/i[1];var n=1/i[2];var a=e[0]*s;var o=e[1]*r;var h=e[2]*n;var l=e[4]*s;var u=e[5]*r;var c=e[6]*n;var f=e[8]*s;var g=e[9]*r;var d=e[10]*n;var _=a+u+d;var m=0;if(_>0){m=Math.sqrt(_+1)*2;t[3]=.25*m;t[0]=(c-g)/m;t[1]=(f-h)/m;t[2]=(o-l)/m}else if(a>u&&a>d){m=Math.sqrt(1+a-u-d)*2;t[3]=(c-g)/m;t[0]=.25*m;t[1]=(o+l)/m;t[2]=(f+h)/m}else if(u>d){m=Math.sqrt(1+u-a-d)*2;t[3]=(f-h)/m;t[0]=(o+l)/m;t[1]=.25*m;t[2]=(c+g)/m}else{m=Math.sqrt(1+d-a-u)*2;t[3]=(o-l)/m;t[0]=(f+h)/m;t[1]=(c+g)/m;t[2]=.25*m}return t}function Ke(t,e,i,s){var r=e[0],n=e[1],a=e[2],o=e[3];var h=r+r;var l=n+n;var u=a+a;var c=r*h;var f=r*l;var g=r*u;var d=n*l;var _=n*u;var m=a*u;var p=o*h;var E=o*l;var v=o*u;var b=s[0];var T=s[1];var A=s[2];t[0]=(1-(d+m))*b;t[1]=(f+v)*b;t[2]=(g-E)*b;t[3]=0;t[4]=(f-v)*T;t[5]=(1-(c+m))*T;t[6]=(_+p)*T;t[7]=0;t[8]=(g+E)*A;t[9]=(_-p)*A;t[10]=(1-(c+d))*A;t[11]=0;t[12]=i[0];t[13]=i[1];t[14]=i[2];t[15]=1;return t}function Qe(t,e,i,s,r){var n=e[0],a=e[1],o=e[2],h=e[3];var l=n+n;var u=a+a;var c=o+o;var f=n*l;var g=n*u;var d=n*c;var _=a*u;var m=a*c;var p=o*c;var E=h*l;var v=h*u;var b=h*c;var T=s[0];var A=s[1];var S=s[2];var x=r[0];var I=r[1];var P=r[2];var M=(1-(_+p))*T;var R=(g+b)*T;var C=(d-v)*T;var N=(g-b)*A;var O=(1-(f+p))*A;var L=(m+E)*A;var F=(d+v)*S;var y=(m-E)*S;var U=(1-(f+_))*S;t[0]=M;t[1]=R;t[2]=C;t[3]=0;t[4]=N;t[5]=O;t[6]=L;t[7]=0;t[8]=F;t[9]=y;t[10]=U;t[11]=0;t[12]=i[0]+x-(M*x+N*I+F*P);t[13]=i[1]+I-(R*x+O*I+y*P);t[14]=i[2]+P-(C*x+L*I+U*P);t[15]=1;return t}function Je(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=i+i;var o=s+s;var h=r+r;var l=i*a;var u=s*a;var c=s*o;var f=r*a;var g=r*o;var d=r*h;var _=n*a;var m=n*o;var p=n*h;t[0]=1-c-d;t[1]=u+p;t[2]=f-m;t[3]=0;t[4]=u-p;t[5]=1-l-d;t[6]=g+_;t[7]=0;t[8]=f+m;t[9]=g-_;t[10]=1-l-c;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t}function Ze(t,e,i,s,r,n,a){var o=1/(i-e);var h=1/(r-s);var l=1/(n-a);t[0]=n*2*o;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=n*2*h;t[6]=0;t[7]=0;t[8]=(i+e)*o;t[9]=(r+s)*h;t[10]=(a+n)*l;t[11]=-1;t[12]=0;t[13]=0;t[14]=a*n*2*l;t[15]=0;return t}function $e(t,e,i,s,r){var n=1/Math.tan(e/2),a;t[0]=n/i;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=n;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[11]=-1;t[12]=0;t[13]=0;t[15]=0;if(r!=null&&r!==Infinity){a=1/(s-r);t[10]=(r+s)*a;t[14]=2*r*s*a}else{t[10]=-1;t[14]=-2*s}return t}function ti(t,e,i,s){var r=Math.tan(e.upDegrees*Math.PI/180);var n=Math.tan(e.downDegrees*Math.PI/180);var a=Math.tan(e.leftDegrees*Math.PI/180);var o=Math.tan(e.rightDegrees*Math.PI/180);var h=2/(a+o);var l=2/(r+n);t[0]=h;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=l;t[6]=0;t[7]=0;t[8]=-((a-o)*h*.5);t[9]=(r-n)*l*.5;t[10]=s/(i-s);t[11]=-1;t[12]=0;t[13]=0;t[14]=s*i/(i-s);t[15]=0;return t}function ei(t,e,i,s,r,n,a){var o=1/(e-i);var h=1/(s-r);var l=1/(n-a);t[0]=-2*o;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=-2*h;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=2*l;t[11]=0;t[12]=(e+i)*o;t[13]=(r+s)*h;t[14]=(a+n)*l;t[15]=1;return t}function ii(t,e,i,s){var r,n,a,o,h,l,u,c,f,g;var d=e[0];var _=e[1];var m=e[2];var p=s[0];var E=s[1];var v=s[2];var b=i[0];var T=i[1];var A=i[2];if(Math.abs(d-b)<y&&Math.abs(_-T)<y&&Math.abs(m-A)<y){return S(t)}u=d-b;c=_-T;f=m-A;g=1/Math.hypot(u,c,f);u*=g;c*=g;f*=g;r=E*f-v*c;n=v*u-p*f;a=p*c-E*u;g=Math.hypot(r,n,a);if(!g){r=0;n=0;a=0}else{g=1/g;r*=g;n*=g;a*=g}o=c*a-f*n;h=f*r-u*a;l=u*n-c*r;g=Math.hypot(o,h,l);if(!g){o=0;h=0;l=0}else{g=1/g;o*=g;h*=g;l*=g}t[0]=r;t[1]=o;t[2]=u;t[3]=0;t[4]=n;t[5]=h;t[6]=c;t[7]=0;t[8]=a;t[9]=l;t[10]=f;t[11]=0;t[12]=-(r*d+n*_+a*m);t[13]=-(o*d+h*_+l*m);t[14]=-(u*d+c*_+f*m);t[15]=1;return t}function si(t,e,i,s){var r=e[0],n=e[1],a=e[2],o=s[0],h=s[1],l=s[2];var u=r-i[0],c=n-i[1],f=a-i[2];var g=u*u+c*c+f*f;if(g>0){g=1/Math.sqrt(g);u*=g;c*=g;f*=g}var d=h*f-l*c,_=l*u-o*f,m=o*c-h*u;g=d*d+_*_+m*m;if(g>0){g=1/Math.sqrt(g);d*=g;_*=g;m*=g}t[0]=d;t[1]=_;t[2]=m;t[3]=0;t[4]=c*m-f*_;t[5]=f*d-u*m;t[6]=u*_-c*d;t[7]=0;t[8]=u;t[9]=c;t[10]=f;t[11]=0;t[12]=r;t[13]=n;t[14]=a;t[15]=1;return t}function ri(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function ni(t){return Math.hypot(t[0],t[1],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function ai(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];t[4]=e[4]+i[4];t[5]=e[5]+i[5];t[6]=e[6]+i[6];t[7]=e[7]+i[7];t[8]=e[8]+i[8];t[9]=e[9]+i[9];t[10]=e[10]+i[10];t[11]=e[11]+i[11];t[12]=e[12]+i[12];t[13]=e[13]+i[13];t[14]=e[14]+i[14];t[15]=e[15]+i[15];return t}function oi(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];t[3]=e[3]-i[3];t[4]=e[4]-i[4];t[5]=e[5]-i[5];t[6]=e[6]-i[6];t[7]=e[7]-i[7];t[8]=e[8]-i[8];t[9]=e[9]-i[9];t[10]=e[10]-i[10];t[11]=e[11]-i[11];t[12]=e[12]-i[12];t[13]=e[13]-i[13];t[14]=e[14]-i[14];t[15]=e[15]-i[15];return t}function hi(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;t[4]=e[4]*i;t[5]=e[5]*i;t[6]=e[6]*i;t[7]=e[7]*i;t[8]=e[8]*i;t[9]=e[9]*i;t[10]=e[10]*i;t[11]=e[11]*i;t[12]=e[12]*i;t[13]=e[13]*i;t[14]=e[14]*i;t[15]=e[15]*i;return t}function li(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;t[3]=e[3]+i[3]*s;t[4]=e[4]+i[4]*s;t[5]=e[5]+i[5]*s;t[6]=e[6]+i[6]*s;t[7]=e[7]+i[7]*s;t[8]=e[8]+i[8]*s;t[9]=e[9]+i[9]*s;t[10]=e[10]+i[10]*s;t[11]=e[11]+i[11]*s;t[12]=e[12]+i[12]*s;t[13]=e[13]+i[13]*s;t[14]=e[14]+i[14]*s;t[15]=e[15]+i[15]*s;return t}function ui(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function ci(t,e){var i=t[0],s=t[1],r=t[2],n=t[3];var a=t[4],o=t[5],h=t[6],l=t[7];var u=t[8],c=t[9],f=t[10],g=t[11];var d=t[12],_=t[13],m=t[14],p=t[15];var E=e[0],v=e[1],b=e[2],T=e[3];var A=e[4],S=e[5],x=e[6],I=e[7];var P=e[8],M=e[9],R=e[10],C=e[11];var N=e[12],O=e[13],L=e[14],F=e[15];return Math.abs(i-E)<=y*Math.max(1,Math.abs(i),Math.abs(E))&&Math.abs(s-v)<=y*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(r-b)<=y*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-T)<=y*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-A)<=y*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(o-S)<=y*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(h-x)<=y*Math.max(1,Math.abs(h),Math.abs(x))&&Math.abs(l-I)<=y*Math.max(1,Math.abs(l),Math.abs(I))&&Math.abs(u-P)<=y*Math.max(1,Math.abs(u),Math.abs(P))&&Math.abs(c-M)<=y*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(f-R)<=y*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(g-C)<=y*Math.max(1,Math.abs(g),Math.abs(C))&&Math.abs(d-N)<=y*Math.max(1,Math.abs(d),Math.abs(N))&&Math.abs(_-O)<=y*Math.max(1,Math.abs(_),Math.abs(O))&&Math.abs(m-L)<=y*Math.max(1,Math.abs(m),Math.abs(L))&&Math.abs(p-F)<=y*Math.max(1,Math.abs(p),Math.abs(F))}var fi=Le;var gi=oi;function B(){var t=new p(3);if(p!=Float32Array){t[0]=0;t[1]=0;t[2]=0}return t}function di(t){var e=new p(3);e[0]=t[0];e[1]=t[1];e[2]=t[2];return e}function _i(t){var e=t[0];var i=t[1];var s=t[2];return Math.hypot(e,i,s)}function o(t,e,i){var s=new p(3);s[0]=t;s[1]=e;s[2]=i;return s}function mi(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];return t}function V(t,e,i,s){t[0]=e;t[1]=i;t[2]=s;return t}function pi(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];return t}function D(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];return t}function Ei(t,e,i){t[0]=e[0]*i[0];t[1]=e[1]*i[1];t[2]=e[2]*i[2];return t}function vi(t,e,i){t[0]=e[0]/i[0];t[1]=e[1]/i[1];t[2]=e[2]/i[2];return t}function bi(t,e){t[0]=Math.ceil(e[0]);t[1]=Math.ceil(e[1]);t[2]=Math.ceil(e[2]);return t}function Ti(t,e){t[0]=Math.floor(e[0]);t[1]=Math.floor(e[1]);t[2]=Math.floor(e[2]);return t}function Ai(t,e,i){t[0]=Math.min(e[0],i[0]);t[1]=Math.min(e[1],i[1]);t[2]=Math.min(e[2],i[2]);return t}function Si(t,e,i){t[0]=Math.max(e[0],i[0]);t[1]=Math.max(e[1],i[1]);t[2]=Math.max(e[2],i[2]);return t}function xi(t,e){t[0]=Math.round(e[0]);t[1]=Math.round(e[1]);t[2]=Math.round(e[2]);return t}function Ii(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;return t}function Pi(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;return t}function Mi(t,e){var i=e[0]-t[0];var s=e[1]-t[1];var r=e[2]-t[2];return Math.hypot(i,s,r)}function Ri(t,e){var i=e[0]-t[0];var s=e[1]-t[1];var r=e[2]-t[2];return i*i+s*s+r*r}function Ci(t){var e=t[0];var i=t[1];var s=t[2];return e*e+i*i+s*s}function Ni(t,e){t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];return t}function Oi(t,e){t[0]=1/e[0];t[1]=1/e[1];t[2]=1/e[2];return t}function k(t,e){var i=e[0];var s=e[1];var r=e[2];var n=i*i+s*s+r*r;if(n>0){n=1/Math.sqrt(n)}t[0]=e[0]*n;t[1]=e[1]*n;t[2]=e[2]*n;return t}function G(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function H(t,e,i){var s=e[0],r=e[1],n=e[2];var a=i[0],o=i[1],h=i[2];t[0]=r*h-n*o;t[1]=n*a-s*h;t[2]=s*o-r*a;return t}function Li(t,e,i,s){var r=e[0];var n=e[1];var a=e[2];t[0]=r+s*(i[0]-r);t[1]=n+s*(i[1]-n);t[2]=a+s*(i[2]-a);return t}function Fi(t,e,i,s,r,n){var a=n*n;var o=a*(2*n-3)+1;var h=a*(n-2)+n;var l=a*(n-1);var u=a*(3-2*n);t[0]=e[0]*o+i[0]*h+s[0]*l+r[0]*u;t[1]=e[1]*o+i[1]*h+s[1]*l+r[1]*u;t[2]=e[2]*o+i[2]*h+s[2]*l+r[2]*u;return t}function yi(t,e,i,s,r,n){var a=1-n;var o=a*a;var h=n*n;var l=o*a;var u=3*n*o;var c=3*h*a;var f=h*n;t[0]=e[0]*l+i[0]*u+s[0]*c+r[0]*f;t[1]=e[1]*l+i[1]*u+s[1]*c+r[1]*f;t[2]=e[2]*l+i[2]*u+s[2]*c+r[2]*f;return t}function Ui(t,e){e=e||1;var i=l()*2*Math.PI;var s=l()*2-1;var r=Math.sqrt(1-s*s)*e;t[0]=Math.cos(i)*r;t[1]=Math.sin(i)*r;t[2]=s*e;return t}function wi(t,e,i){var s=e[0],r=e[1],n=e[2];var a=i[3]*s+i[7]*r+i[11]*n+i[15];a=a||1;t[0]=(i[0]*s+i[4]*r+i[8]*n+i[12])/a;t[1]=(i[1]*s+i[5]*r+i[9]*n+i[13])/a;t[2]=(i[2]*s+i[6]*r+i[10]*n+i[14])/a;return t}function Bi(t,e,i){var s=e[0],r=e[1],n=e[2];t[0]=s*i[0]+r*i[3]+n*i[6];t[1]=s*i[1]+r*i[4]+n*i[7];t[2]=s*i[2]+r*i[5]+n*i[8];return t}function Vi(t,e,i){var s=i[0],r=i[1],n=i[2],a=i[3];var o=e[0],h=e[1],l=e[2];var u=r*l-n*h,c=n*o-s*l,f=s*h-r*o;var g=r*f-n*c,d=n*u-s*f,_=s*c-r*u;var m=a*2;u*=m;c*=m;f*=m;g*=2;d*=2;_*=2;t[0]=o+u+g;t[1]=h+c+d;t[2]=l+f+_;return t}function Di(t,e,i,s){var r=[],n=[];r[0]=e[0]-i[0];r[1]=e[1]-i[1];r[2]=e[2]-i[2];n[0]=r[0];n[1]=r[1]*Math.cos(s)-r[2]*Math.sin(s);n[2]=r[1]*Math.sin(s)+r[2]*Math.cos(s);t[0]=n[0]+i[0];t[1]=n[1]+i[1];t[2]=n[2]+i[2];return t}function ki(t,e,i,s){var r=[],n=[];r[0]=e[0]-i[0];r[1]=e[1]-i[1];r[2]=e[2]-i[2];n[0]=r[2]*Math.sin(s)+r[0]*Math.cos(s);n[1]=r[1];n[2]=r[2]*Math.cos(s)-r[0]*Math.sin(s);t[0]=n[0]+i[0];t[1]=n[1]+i[1];t[2]=n[2]+i[2];return t}function Gi(t,e,i,s){var r=[],n=[];r[0]=e[0]-i[0];r[1]=e[1]-i[1];r[2]=e[2]-i[2];n[0]=r[0]*Math.cos(s)-r[1]*Math.sin(s);n[1]=r[0]*Math.sin(s)+r[1]*Math.cos(s);n[2]=r[2];t[0]=n[0]+i[0];t[1]=n[1]+i[1];t[2]=n[2]+i[2];return t}function Hi(t,e){var i=o(t[0],t[1],t[2]);var s=o(e[0],e[1],e[2]);k(i,i);k(s,s);var r=G(i,s);if(r>1){return 0}else if(r<-1){return Math.PI}else{return Math.acos(r)}}function zi(t){t[0]=0;t[1]=0;t[2]=0;return t}function ji(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Yi(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Wi(t,e){var i=t[0],s=t[1],r=t[2];var n=e[0],a=e[1],o=e[2];return Math.abs(i-n)<=y*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(s-a)<=y*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-o)<=y*Math.max(1,Math.abs(r),Math.abs(o))}var Xi=D;var qi=Ei;var Ki=vi;var Qi=Mi;var Ji=Ri;var Zi=_i;var $i=Ci;var ts=function(){var h=B();return function(t,e,i,s,r,n){var a,o;if(!e){e=3}if(!i){i=0}if(s){o=Math.min(s*e+i,t.length)}else{o=t.length}for(a=i;a<o;a+=e){h[0]=t[a];h[1]=t[a+1];h[2]=t[a+2];r(h,h,n);t[a]=h[0];t[a+1]=h[1];t[a+2]=h[2]}return t}}();function es(){var t=new p(4);if(p!=Float32Array){t[0]=0;t[1]=0;t[2]=0;t[3]=0}return t}function is(t){var e=new p(4);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];return e}function ss(t,e,i,s){var r=new p(4);r[0]=t;r[1]=e;r[2]=i;r[3]=s;return r}function rs(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t}function ns(t,e,i,s,r){t[0]=e;t[1]=i;t[2]=s;t[3]=r;return t}function as(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];return t}function os(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];t[2]=e[2]-i[2];t[3]=e[3]-i[3];return t}function hs(t,e,i){t[0]=e[0]*i[0];t[1]=e[1]*i[1];t[2]=e[2]*i[2];t[3]=e[3]*i[3];return t}function ls(t,e,i){t[0]=e[0]/i[0];t[1]=e[1]/i[1];t[2]=e[2]/i[2];t[3]=e[3]/i[3];return t}function us(t,e){t[0]=Math.ceil(e[0]);t[1]=Math.ceil(e[1]);t[2]=Math.ceil(e[2]);t[3]=Math.ceil(e[3]);return t}function cs(t,e){t[0]=Math.floor(e[0]);t[1]=Math.floor(e[1]);t[2]=Math.floor(e[2]);t[3]=Math.floor(e[3]);return t}function fs(t,e,i){t[0]=Math.min(e[0],i[0]);t[1]=Math.min(e[1],i[1]);t[2]=Math.min(e[2],i[2]);t[3]=Math.min(e[3],i[3]);return t}function gs(t,e,i){t[0]=Math.max(e[0],i[0]);t[1]=Math.max(e[1],i[1]);t[2]=Math.max(e[2],i[2]);t[3]=Math.max(e[3],i[3]);return t}function ds(t,e){t[0]=Math.round(e[0]);t[1]=Math.round(e[1]);t[2]=Math.round(e[2]);t[3]=Math.round(e[3]);return t}function _s(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;return t}function ms(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;t[2]=e[2]+i[2]*s;t[3]=e[3]+i[3]*s;return t}function ps(t,e){var i=e[0]-t[0];var s=e[1]-t[1];var r=e[2]-t[2];var n=e[3]-t[3];return Math.hypot(i,s,r,n)}function Es(t,e){var i=e[0]-t[0];var s=e[1]-t[1];var r=e[2]-t[2];var n=e[3]-t[3];return i*i+s*s+r*r+n*n}function vs(t){var e=t[0];var i=t[1];var s=t[2];var r=t[3];return Math.hypot(e,i,s,r)}function bs(t){var e=t[0];var i=t[1];var s=t[2];var r=t[3];return e*e+i*i+s*s+r*r}function Ts(t,e){t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=-e[3];return t}function As(t,e){t[0]=1/e[0];t[1]=1/e[1];t[2]=1/e[2];t[3]=1/e[3];return t}function Ss(t,e){var i=e[0];var s=e[1];var r=e[2];var n=e[3];var a=i*i+s*s+r*r+n*n;if(a>0){a=1/Math.sqrt(a)}t[0]=i*a;t[1]=s*a;t[2]=r*a;t[3]=n*a;return t}function xs(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Is(t,e,i,s){var r=i[0]*s[1]-i[1]*s[0],n=i[0]*s[2]-i[2]*s[0],a=i[0]*s[3]-i[3]*s[0],o=i[1]*s[2]-i[2]*s[1],h=i[1]*s[3]-i[3]*s[1],l=i[2]*s[3]-i[3]*s[2];var u=e[0];var c=e[1];var f=e[2];var g=e[3];t[0]=c*l-f*h+g*o;t[1]=-(u*l)+f*a-g*n;t[2]=u*h-c*a+g*r;t[3]=-(u*o)+c*n-f*r;return t}function Ps(t,e,i,s){var r=e[0];var n=e[1];var a=e[2];var o=e[3];t[0]=r+s*(i[0]-r);t[1]=n+s*(i[1]-n);t[2]=a+s*(i[2]-a);t[3]=o+s*(i[3]-o);return t}function Ms(t,e){e=e||1;var i,s,r,n;var a,o;do{i=l()*2-1;s=l()*2-1;a=i*i+s*s}while(a>=1);do{r=l()*2-1;n=l()*2-1;o=r*r+n*n}while(o>=1);var h=Math.sqrt((1-a)/o);t[0]=e*i;t[1]=e*s;t[2]=e*r*h;t[3]=e*n*h;return t}function Rs(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];t[0]=i[0]*s+i[4]*r+i[8]*n+i[12]*a;t[1]=i[1]*s+i[5]*r+i[9]*n+i[13]*a;t[2]=i[2]*s+i[6]*r+i[10]*n+i[14]*a;t[3]=i[3]*s+i[7]*r+i[11]*n+i[15]*a;return t}function Cs(t,e,i){var s=e[0],r=e[1],n=e[2];var a=i[0],o=i[1],h=i[2],l=i[3];var u=l*s+o*n-h*r;var c=l*r+h*s-a*n;var f=l*n+a*r-o*s;var g=-a*s-o*r-h*n;t[0]=u*l+g*-a+c*-h-f*-o;t[1]=c*l+g*-o+f*-a-u*-h;t[2]=f*l+g*-h+u*-o-c*-a;t[3]=e[3];return t}function Ns(t){t[0]=0;t[1]=0;t[2]=0;t[3]=0;return t}function Os(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Ls(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Fs(t,e){var i=t[0],s=t[1],r=t[2],n=t[3];var a=e[0],o=e[1],h=e[2],l=e[3];return Math.abs(i-a)<=y*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=y*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(r-h)<=y*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=y*Math.max(1,Math.abs(n),Math.abs(l))}var ys=os;var Us=hs;var ws=ls;var Bs=ps;var Vs=Es;var Ds=vs;var ks=bs;var Gs=function(){var h=es();return function(t,e,i,s,r,n){var a,o;if(!e){e=4}if(!i){i=0}if(s){o=Math.min(s*e+i,t.length)}else{o=t.length}for(a=i;a<o;a+=e){h[0]=t[a];h[1]=t[a+1];h[2]=t[a+2];h[3]=t[a+3];r(h,h,n);t[a]=h[0];t[a+1]=h[1];t[a+2]=h[2];t[a+3]=h[3]}return t}}();function n(){var t=new p(4);if(p!=Float32Array){t[0]=0;t[1]=0;t[2]=0}t[3]=1;return t}function Hs(t){t[0]=0;t[1]=0;t[2]=0;t[3]=1;return t}function zs(t,e,i){i=i*.5;var s=Math.sin(i);t[0]=s*e[0];t[1]=s*e[1];t[2]=s*e[2];t[3]=Math.cos(i);return t}function js(t,e){var i=Math.acos(e[3])*2;var s=Math.sin(i/2);if(s>y){t[0]=e[0]/s;t[1]=e[1]/s;t[2]=e[2]/s}else{t[0]=1;t[1]=0;t[2]=0}return i}function Ys(t,e){var i=gr(t,e);return Math.acos(2*i*i-1)}function Ws(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3];var o=i[0],h=i[1],l=i[2],u=i[3];t[0]=s*u+a*o+r*l-n*h;t[1]=r*u+a*h+n*o-s*l;t[2]=n*u+a*l+s*h-r*o;t[3]=a*u-s*o-r*h-n*l;return t}function Xs(t,e,i){i*=.5;var s=e[0],r=e[1],n=e[2],a=e[3];var o=Math.sin(i),h=Math.cos(i);t[0]=s*h+a*o;t[1]=r*h+n*o;t[2]=n*h-r*o;t[3]=a*h-s*o;return t}function qs(t,e,i){i*=.5;var s=e[0],r=e[1],n=e[2],a=e[3];var o=Math.sin(i),h=Math.cos(i);t[0]=s*h-n*o;t[1]=r*h+a*o;t[2]=n*h+s*o;t[3]=a*h-r*o;return t}function Ks(t,e,i){i*=.5;var s=e[0],r=e[1],n=e[2],a=e[3];var o=Math.sin(i),h=Math.cos(i);t[0]=s*h+r*o;t[1]=r*h-s*o;t[2]=n*h+a*o;t[3]=a*h-n*o;return t}function Qs(t,e){var i=e[0],s=e[1],r=e[2];t[0]=i;t[1]=s;t[2]=r;t[3]=Math.sqrt(Math.abs(1-i*i-s*s-r*r));return t}function Js(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=Math.sqrt(i*i+s*s+r*r);var o=Math.exp(n);var h=a>0?o*Math.sin(a)/a:0;t[0]=i*h;t[1]=s*h;t[2]=r*h;t[3]=o*Math.cos(a);return t}function Zs(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=Math.sqrt(i*i+s*s+r*r);var o=a>0?Math.atan2(a,n)/a:0;t[0]=i*o;t[1]=s*o;t[2]=r*o;t[3]=.5*Math.log(i*i+s*s+r*r+n*n);return t}function $s(t,e,i){Zs(t,e);fr(t,t,i);Js(t,t);return t}function h(t,e,i,s){var r=e[0],n=e[1],a=e[2],o=e[3];var h=i[0],l=i[1],u=i[2],c=i[3];var f,g,d,_,m;g=r*h+n*l+a*u+o*c;if(g<0){g=-g;h=-h;l=-l;u=-u;c=-c}if(1-g>y){f=Math.acos(g);d=Math.sin(f);_=Math.sin((1-s)*f)/d;m=Math.sin(s*f)/d}else{_=1-s;m=s}t[0]=_*r+m*h;t[1]=_*n+m*l;t[2]=_*a+m*u;t[3]=_*o+m*c;return t}function tr(t){var e=l();var i=l();var s=l();var r=Math.sqrt(1-e);var n=Math.sqrt(e);t[0]=r*Math.sin(2*Math.PI*i);t[1]=r*Math.cos(2*Math.PI*i);t[2]=n*Math.sin(2*Math.PI*s);t[3]=n*Math.cos(2*Math.PI*s);return t}function er(t,e){var i=e[0],s=e[1],r=e[2],n=e[3];var a=i*i+s*s+r*r+n*n;var o=a?1/a:0;t[0]=-i*o;t[1]=-s*o;t[2]=-r*o;t[3]=n*o;return t}function ir(t,e){t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=e[3];return t}function sr(t,e){var i=e[0]+e[4]+e[8];var s;if(i>0){s=Math.sqrt(i+1);t[3]=.5*s;s=.5/s;t[0]=(e[5]-e[7])*s;t[1]=(e[6]-e[2])*s;t[2]=(e[1]-e[3])*s}else{var r=0;if(e[4]>e[0])r=1;if(e[8]>e[r*3+r])r=2;var n=(r+1)%3;var a=(r+2)%3;s=Math.sqrt(e[r*3+r]-e[n*3+n]-e[a*3+a]+1);t[r]=.5*s;s=.5/s;t[3]=(e[n*3+a]-e[a*3+n])*s;t[n]=(e[n*3+r]+e[r*3+n])*s;t[a]=(e[a*3+r]+e[r*3+a])*s}return t}function rr(t,e,i,s){var r=.5*Math.PI/180;e*=r;i*=r;s*=r;var n=Math.sin(e);var a=Math.cos(e);var o=Math.sin(i);var h=Math.cos(i);var l=Math.sin(s);var u=Math.cos(s);t[0]=n*h*u-a*o*l;t[1]=a*o*u+n*h*l;t[2]=a*h*l-n*o*u;t[3]=a*h*u+n*o*l;return t}function nr(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}var ar=is;var or=ss;var hr=rs;var lr=ns;var ur=as;var cr=Ws;var fr=_s;var gr=xs;var dr=Ps;var _r=vs;var mr=_r;var pr=bs;var Er=pr;var vr=Ss;var br=Ls;var Tr=Fs;var Ar=function(){var r=B();var n=o(1,0,0);var a=o(0,1,0);return function(t,e,i){var s=G(e,i);if(s<-.999999){H(r,n,e);if(Zi(r)<1e-6)H(r,a,e);k(r,r);zs(t,r,Math.PI);return t}else if(s>.999999){t[0]=0;t[1]=0;t[2]=0;t[3]=1;return t}else{H(r,e,i);t[0]=r[0];t[1]=r[1];t[2]=r[2];t[3]=1+s;return vr(t,t)}}}();var Sr=function(){var a=n();var o=n();return function(t,e,i,s,r,n){h(a,e,r,n);h(o,i,s,n);h(t,a,o,2*n*(1-n));return t}}();var xr=function(){var r=Xt();return function(t,e,i,s){r[0]=i[0];r[3]=i[1];r[6]=i[2];r[1]=s[0];r[4]=s[1];r[7]=s[2];r[2]=-e[0];r[5]=-e[1];r[8]=-e[2];return vr(t,sr(t,r))}}();function Ir(){var t=new p(8);if(p!=Float32Array){t[0]=0;t[1]=0;t[2]=0;t[4]=0;t[5]=0;t[6]=0;t[7]=0}t[3]=1;return t}function Pr(t){var e=new p(8);e[0]=t[0];e[1]=t[1];e[2]=t[2];e[3]=t[3];e[4]=t[4];e[5]=t[5];e[6]=t[6];e[7]=t[7];return e}function Mr(t,e,i,s,r,n,a,o){var h=new p(8);h[0]=t;h[1]=e;h[2]=i;h[3]=s;h[4]=r;h[5]=n;h[6]=a;h[7]=o;return h}function Rr(t,e,i,s,r,n,a){var o=new p(8);o[0]=t;o[1]=e;o[2]=i;o[3]=s;var h=r*.5,l=n*.5,u=a*.5;o[4]=h*s+l*i-u*e;o[5]=l*s+u*t-h*i;o[6]=u*s+h*e-l*t;o[7]=-h*t-l*e-u*i;return o}function Cr(t,e,i){var s=i[0]*.5,r=i[1]*.5,n=i[2]*.5,a=e[0],o=e[1],h=e[2],l=e[3];t[0]=a;t[1]=o;t[2]=h;t[3]=l;t[4]=s*l+r*h-n*o;t[5]=r*l+n*a-s*h;t[6]=n*l+s*o-r*a;t[7]=-s*a-r*o-n*h;return t}function Nr(t,e){t[0]=0;t[1]=0;t[2]=0;t[3]=1;t[4]=e[0]*.5;t[5]=e[1]*.5;t[6]=e[2]*.5;t[7]=0;return t}function Or(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=0;t[5]=0;t[6]=0;t[7]=0;return t}function Lr(t,e){var i=n();qe(i,e);var s=new p(3);We(s,e);Cr(t,i,s);return t}function Fr(t,e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];return t}function yr(t){t[0]=0;t[1]=0;t[2]=0;t[3]=1;t[4]=0;t[5]=0;t[6]=0;t[7]=0;return t}function Ur(t,e,i,s,r,n,a,o,h){t[0]=e;t[1]=i;t[2]=s;t[3]=r;t[4]=n;t[5]=a;t[6]=o;t[7]=h;return t}var wr=hr;function Br(t,e){t[0]=e[4];t[1]=e[5];t[2]=e[6];t[3]=e[7];return t}var Vr=hr;function Dr(t,e){t[4]=e[0];t[5]=e[1];t[6]=e[2];t[7]=e[3];return t}function kr(t,e){var i=e[4],s=e[5],r=e[6],n=e[7],a=-e[0],o=-e[1],h=-e[2],l=e[3];t[0]=(i*l+n*a+s*h-r*o)*2;t[1]=(s*l+n*o+r*a-i*h)*2;t[2]=(r*l+n*h+i*o-s*a)*2;return t}function Gr(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=i[0]*.5,h=i[1]*.5,l=i[2]*.5,u=e[4],c=e[5],f=e[6],g=e[7];t[0]=s;t[1]=r;t[2]=n;t[3]=a;t[4]=a*o+r*l-n*h+u;t[5]=a*h+n*o-s*l+c;t[6]=a*l+s*h-r*o+f;t[7]=-s*o-r*h-n*l+g;return t}function Hr(t,e,i){var s=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=o*a+u*s+h*n-l*r,f=h*a+u*r+l*s-o*n,g=l*a+u*n+o*r-h*s,d=u*a-o*s-h*r-l*n;Xs(t,e,i);s=t[0];r=t[1];n=t[2];a=t[3];t[4]=c*a+d*s+f*n-g*r;t[5]=f*a+d*r+g*s-c*n;t[6]=g*a+d*n+c*r-f*s;t[7]=d*a-c*s-f*r-g*n;return t}function zr(t,e,i){var s=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=o*a+u*s+h*n-l*r,f=h*a+u*r+l*s-o*n,g=l*a+u*n+o*r-h*s,d=u*a-o*s-h*r-l*n;qs(t,e,i);s=t[0];r=t[1];n=t[2];a=t[3];t[4]=c*a+d*s+f*n-g*r;t[5]=f*a+d*r+g*s-c*n;t[6]=g*a+d*n+c*r-f*s;t[7]=d*a-c*s-f*r-g*n;return t}function jr(t,e,i){var s=-e[0],r=-e[1],n=-e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=o*a+u*s+h*n-l*r,f=h*a+u*r+l*s-o*n,g=l*a+u*n+o*r-h*s,d=u*a-o*s-h*r-l*n;Ks(t,e,i);s=t[0];r=t[1];n=t[2];a=t[3];t[4]=c*a+d*s+f*n-g*r;t[5]=f*a+d*r+g*s-c*n;t[6]=g*a+d*n+c*r-f*s;t[7]=d*a-c*s-f*r-g*n;return t}function Yr(t,e,i){var s=i[0],r=i[1],n=i[2],a=i[3],o=e[0],h=e[1],l=e[2],u=e[3];t[0]=o*a+u*s+h*n-l*r;t[1]=h*a+u*r+l*s-o*n;t[2]=l*a+u*n+o*r-h*s;t[3]=u*a-o*s-h*r-l*n;o=e[4];h=e[5];l=e[6];u=e[7];t[4]=o*a+u*s+h*n-l*r;t[5]=h*a+u*r+l*s-o*n;t[6]=l*a+u*n+o*r-h*s;t[7]=u*a-o*s-h*r-l*n;return t}function Wr(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=i[0],h=i[1],l=i[2],u=i[3];t[0]=s*u+a*o+r*l-n*h;t[1]=r*u+a*h+n*o-s*l;t[2]=n*u+a*l+s*h-r*o;t[3]=a*u-s*o-r*h-n*l;o=i[4];h=i[5];l=i[6];u=i[7];t[4]=s*u+a*o+r*l-n*h;t[5]=r*u+a*h+n*o-s*l;t[6]=n*u+a*l+s*h-r*o;t[7]=a*u-s*o-r*h-n*l;return t}function Xr(t,e,i,s){if(Math.abs(s)<y){return Fr(t,e)}var r=Math.hypot(i[0],i[1],i[2]);s=s*.5;var n=Math.sin(s);var a=n*i[0]/r;var o=n*i[1]/r;var h=n*i[2]/r;var l=Math.cos(s);var u=e[0],c=e[1],f=e[2],g=e[3];t[0]=u*l+g*a+c*h-f*o;t[1]=c*l+g*o+f*a-u*h;t[2]=f*l+g*h+u*o-c*a;t[3]=g*l-u*a-c*o-f*h;var d=e[4],_=e[5],m=e[6],p=e[7];t[4]=d*l+p*a+_*h-m*o;t[5]=_*l+p*o+m*a-d*h;t[6]=m*l+p*h+d*o-_*a;t[7]=p*l-d*a-_*o-m*h;return t}function qr(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];t[2]=e[2]+i[2];t[3]=e[3]+i[3];t[4]=e[4]+i[4];t[5]=e[5]+i[5];t[6]=e[6]+i[6];t[7]=e[7]+i[7];return t}function Kr(t,e,i){var s=e[0],r=e[1],n=e[2],a=e[3],o=i[4],h=i[5],l=i[6],u=i[7],c=e[4],f=e[5],g=e[6],d=e[7],_=i[0],m=i[1],p=i[2],E=i[3];t[0]=s*E+a*_+r*p-n*m;t[1]=r*E+a*m+n*_-s*p;t[2]=n*E+a*p+s*m-r*_;t[3]=a*E-s*_-r*m-n*p;t[4]=s*u+a*o+r*l-n*h+c*E+d*_+f*p-g*m;t[5]=r*u+a*h+n*o-s*l+f*E+d*m+g*_-c*p;t[6]=n*u+a*l+s*h-r*o+g*E+d*p+c*m-f*_;t[7]=a*u-s*o-r*h-n*l+d*E-c*_-f*m-g*p;return t}var Qr=Kr;function Jr(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=e[3]*i;t[4]=e[4]*i;t[5]=e[5]*i;t[6]=e[6]*i;t[7]=e[7]*i;return t}var Zr=gr;function $r(t,e,i,s){var r=1-s;if(Zr(e,i)<0)s=-s;t[0]=e[0]*r+i[0]*s;t[1]=e[1]*r+i[1]*s;t[2]=e[2]*r+i[2]*s;t[3]=e[3]*r+i[3]*s;t[4]=e[4]*r+i[4]*s;t[5]=e[5]*r+i[5]*s;t[6]=e[6]*r+i[6]*s;t[7]=e[7]*r+i[7]*s;return t}function tn(t,e){var i=f(e);t[0]=-e[0]/i;t[1]=-e[1]/i;t[2]=-e[2]/i;t[3]=e[3]/i;t[4]=-e[4]/i;t[5]=-e[5]/i;t[6]=-e[6]/i;t[7]=e[7]/i;return t}function en(t,e){t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=e[3];t[4]=-e[4];t[5]=-e[5];t[6]=-e[6];t[7]=e[7];return t}var sn=_r;var rn=sn;var f=pr;var nn=f;function an(t,e){var i=f(e);if(i>0){i=Math.sqrt(i);var s=e[0]/i;var r=e[1]/i;var n=e[2]/i;var a=e[3]/i;var o=e[4];var h=e[5];var l=e[6];var u=e[7];var c=s*o+r*h+n*l+a*u;t[0]=s;t[1]=r;t[2]=n;t[3]=a;t[4]=(o-s*c)/i;t[5]=(h-r*c)/i;t[6]=(l-n*c)/i;t[7]=(u-a*c)/i}return t}function on(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"}function hn(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]}function ln(t,e){var i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7];var u=e[0],c=e[1],f=e[2],g=e[3],d=e[4],_=e[5],m=e[6],p=e[7];return Math.abs(i-u)<=y*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-c)<=y*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(r-f)<=y*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(n-g)<=y*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-d)<=y*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-_)<=y*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(h-m)<=y*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(l-p)<=y*Math.max(1,Math.abs(l),Math.abs(p))}function t(){var t=new p(2);if(p!=Float32Array){t[0]=0;t[1]=0}return t}function un(t){var e=new p(2);e[0]=t[0];e[1]=t[1];return e}function cn(t,e){var i=new p(2);i[0]=t;i[1]=e;return i}function fn(t,e){t[0]=e[0];t[1]=e[1];return t}function z(t,e,i){t[0]=e;t[1]=i;return t}function gn(t,e,i){t[0]=e[0]+i[0];t[1]=e[1]+i[1];return t}function dn(t,e,i){t[0]=e[0]-i[0];t[1]=e[1]-i[1];return t}function _n(t,e,i){t[0]=e[0]*i[0];t[1]=e[1]*i[1];return t}function mn(t,e,i){t[0]=e[0]/i[0];t[1]=e[1]/i[1];return t}function pn(t,e){t[0]=Math.ceil(e[0]);t[1]=Math.ceil(e[1]);return t}function En(t,e){t[0]=Math.floor(e[0]);t[1]=Math.floor(e[1]);return t}function vn(t,e,i){t[0]=Math.min(e[0],i[0]);t[1]=Math.min(e[1],i[1]);return t}function bn(t,e,i){t[0]=Math.max(e[0],i[0]);t[1]=Math.max(e[1],i[1]);return t}function Tn(t,e){t[0]=Math.round(e[0]);t[1]=Math.round(e[1]);return t}function An(t,e,i){t[0]=e[0]*i;t[1]=e[1]*i;return t}function Sn(t,e,i,s){t[0]=e[0]+i[0]*s;t[1]=e[1]+i[1]*s;return t}function xn(t,e){var i=e[0]-t[0],s=e[1]-t[1];return Math.hypot(i,s)}function In(t,e){var i=e[0]-t[0],s=e[1]-t[1];return i*i+s*s}function Pn(t){var e=t[0],i=t[1];return Math.hypot(e,i)}function Mn(t){var e=t[0],i=t[1];return e*e+i*i}function Rn(t,e){t[0]=-e[0];t[1]=-e[1];return t}function Cn(t,e){t[0]=1/e[0];t[1]=1/e[1];return t}function Nn(t,e){var i=e[0],s=e[1];var r=i*i+s*s;if(r>0){r=1/Math.sqrt(r)}t[0]=e[0]*r;t[1]=e[1]*r;return t}function On(t,e){return t[0]*e[0]+t[1]*e[1]}function Ln(t,e,i){var s=e[0]*i[1]-e[1]*i[0];t[0]=t[1]=0;t[2]=s;return t}function Fn(t,e,i,s){var r=e[0],n=e[1];t[0]=r+s*(i[0]-r);t[1]=n+s*(i[1]-n);return t}function yn(t,e){e=e||1;var i=l()*2*Math.PI;t[0]=Math.cos(i)*e;t[1]=Math.sin(i)*e;return t}function Un(t,e,i){var s=e[0],r=e[1];t[0]=i[0]*s+i[2]*r;t[1]=i[1]*s+i[3]*r;return t}function wn(t,e,i){var s=e[0],r=e[1];t[0]=i[0]*s+i[2]*r+i[4];t[1]=i[1]*s+i[3]*r+i[5];return t}function Bn(t,e,i){var s=e[0],r=e[1];t[0]=i[0]*s+i[3]*r+i[6];t[1]=i[1]*s+i[4]*r+i[7];return t}function Vn(t,e,i){var s=e[0];var r=e[1];t[0]=i[0]*s+i[4]*r+i[12];t[1]=i[1]*s+i[5]*r+i[13];return t}function Dn(t,e,i,s){var r=e[0]-i[0],n=e[1]-i[1],a=Math.sin(s),o=Math.cos(s);t[0]=r*o-n*a+i[0];t[1]=r*a+n*o+i[1];return t}function kn(t,e){var i=t[0],s=t[1],r=e[0],n=e[1];var a=i*i+s*s;if(a>0){a=1/Math.sqrt(a)}var o=r*r+n*n;if(o>0){o=1/Math.sqrt(o)}var h=(i*r+s*n)*a*o;if(h>1){return 0}else if(h<-1){return Math.PI}else{return Math.acos(h)}}function Gn(t){t[0]=0;t[1]=0;return t}function Hn(t){return"vec2("+t[0]+", "+t[1]+")"}function zn(t,e){return t[0]===e[0]&&t[1]===e[1]}function jn(t,e){var i=t[0],s=t[1];var r=e[0],n=e[1];return Math.abs(i-r)<=y*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(s-n)<=y*Math.max(1,Math.abs(s),Math.abs(n))}var Yn=Pn;var Wn=dn;var Xn=_n;var qn=mn;var Kn=xn;var Qn=In;var Jn=Mn;var Zn=function(){var h=t();return function(t,e,i,s,r,n){var a,o;if(!e){e=2}if(!i){i=0}if(s){o=Math.min(s*e+i,t.length)}else{o=t.length}for(a=i;a<o;a+=e){h[0]=t[a];h[1]=t[a+1];r(h,h,n);t[a]=h[0];t[a+1]=h[1]}return t}}();class c{isGeometry=true;constructor(t){this.name=t||"unknown";this._log=new u.Logger("cgl_geometry");this.faceVertCount=3;this.glPrimitive=null;this._attributes={};this._vertices=[];this.verticesIndices=[];this.morphTargets=[]}get vertices(){return this._vertices}set vertices(t){this.setVertices(t)}get texCoords(){const t=this.getAttribute("texCoords");if(!t)return[];return t.data}set texCoords(t){this.setAttribute("texCoords",t,2)}get vertexNormals(){const t=this.getAttribute("vertexNormals");if(!t)return[];return t.data}set vertexNormals(t){this.setAttribute("vertexNormals",t,3)}get tangents(){const t=this.getAttribute("tangents");if(!t)return[];return t.data}set tangents(t){this.setAttribute("tangents",t,3)}get biTangents(){const t=this.getAttribute("biTangents");if(!t)return[];return t.data}set biTangents(t){this.setAttribute("biTangents",t,3)}get vertexColors(){const t=this.getAttribute("vertexColors");if(!t)return[];return t.data}set vertexColors(t){this.setAttribute("vertexColors",t,4)}clear(){this._vertices=new Float32Array([]);this.verticesIndices=[];this.texCoords=new Float32Array([]);this.vertexNormals=new Float32Array([]);this.tangents=[];this.biTangents=[];this._attributes={}}getAttributes(){return this._attributes}getAttribute(e){for(const t in this._attributes){if(this._attributes[t].name==e)return this._attributes[t]}return null}setAttribute(t,e,i){let s="";if(!i||i>4){this._log.warn("itemsize wrong?",i,t);this._log.stack("itemsize");i=3}if(i==1)s="float";else if(i==2)s="vec2";else if(i==3)s="vec3";else if(i==4)s="vec4";const r={name:t,data:e,itemSize:i,type:s};this._attributes[t]=r}copyAttribute(t,e){const i=this.getAttribute(t);e.setAttribute(t,new Float32Array(i.data),i.itemSize)}setVertices(t){if(t instanceof Float32Array)this._vertices=t;else this._vertices=new Float32Array(t)}setTexCoords(t){if(t instanceof Float32Array)this.texCoords=t;else this.texCoords=new Float32Array(t)}calcNormals(t){const e={smooth:t};this.calculateNormals(e)}flipNormals(e,i,s){let r=B();if(e==undefined)e=1;if(i==undefined)i=1;if(s==undefined)s=1;for(let t=0;t<this.vertexNormals.length;t+=3){V(r,this.vertexNormals[t+0],this.vertexNormals[t+1],this.vertexNormals[t+2]);r[0]*=-e;r[1]*=-i;r[2]*=-s;k(r,r);this.vertexNormals[t+0]=r[0];this.vertexNormals[t+1]=r[1];this.vertexNormals[t+2]=r[2]}}getNumTriangles(){if(this.verticesIndices&&this.verticesIndices.length)return this.verticesIndices.length/3;return this.vertices.length/3}flipVertDir(){const e=[];e.length=this.verticesIndices.length;for(let t=0;t<this.verticesIndices.length;t+=3){e[t]=this.verticesIndices[t+2];e[t+1]=this.verticesIndices[t+1];e[t+2]=this.verticesIndices[t]}this.verticesIndices=e}setPointVertices(e){if(e.length%3!==0){this._log.error("SetPointVertices: Array must be multiple of three.");return}if(!(e instanceof Float32Array))this.vertices=new Float32Array(e);else this.vertices=e;if(!(this.texCoords instanceof Float32Array))this.texCoords=new Float32Array(e.length/3*2);this.verticesIndices.length=e.length/3;for(let t=0;t<e.length/3;t++){this.verticesIndices[t]=t;this.texCoords[t*2]=0;this.texCoords[t*2+1]=0}}merge(e){if(!e)return;if(this.isIndexed()!=e.isIndexed()){if(this.isIndexed()){this.unIndex(false,true)}if(e.isIndexed()){const t=e.copy();t.unIndex(false,true);e=t}}const i=this.verticesIndices.length;const s=this._vertices.length/3;this.verticesIndices.length+=e.verticesIndices.length;for(let t=0;t<e.verticesIndices.length;t++)this.verticesIndices[i+t]=e.verticesIndices[t]+s;this.vertices=A.utils.float32Concat(this._vertices,e.vertices);this.texCoords=A.utils.float32Concat(this.texCoords,e.texCoords);this.vertexNormals=A.utils.float32Concat(this.vertexNormals,e.vertexNormals);this.tangents=A.utils.float32Concat(this.tangents,e.tangents);this.biTangents=A.utils.float32Concat(this.biTangents,e.biTangents)}copy(){const e=new c(this.name+" copy");e.faceVertCount=this.faceVertCount;e.glPrimitive=this.glPrimitive;e.setVertices(this._vertices.slice(0));if(this.verticesIndices){e.verticesIndices.length=this.verticesIndices.length;for(let t=0;t<this.verticesIndices.length;t++)e.verticesIndices[t]=this.verticesIndices[t]}for(let t in this._attributes)this.copyAttribute(t,e);e.morphTargets.length=this.morphTargets.length;for(let t=0;t<this.morphTargets.length;t++)e.morphTargets[t]=this.morphTargets[t];return e}calculateNormals(e=null){e=e||{};if(e.smooth===false)this.unIndex();const i=B();const s=B();const r=B();function n(t){D(i,t[0],t[1]);D(s,t[0],t[2]);H(r,i,s);k(r,r);if(e&&e.forceZUp){if(r[2]<0){r[0]*=-1;r[1]*=-1;r[2]*=-1}}return r}this.getVertexVec=function(t){const e=[0,0,0];e[0]=this.vertices[t*3+0];e[1]=this.vertices[t*3+1];e[2]=this.vertices[t*3+2];return e};if(!(this.vertexNormals instanceof Float32Array)||this.vertexNormals.length!=this.vertices.length)this.vertexNormals=new Float32Array(this.vertices.length);for(let t=0;t<this.vertices.length;t++){this.vertexNormals[t]=0}if(!this.isIndexed()){const a=[];for(let t=0;t<this.vertices.length;t+=9){const o=[[this.vertices[t+0],this.vertices[t+1],this.vertices[t+2]],[this.vertices[t+3],this.vertices[t+4],this.vertices[t+5]],[this.vertices[t+6],this.vertices[t+7],this.vertices[t+8]]];const h=n(o);a.push(h[0],h[1],h[2],h[0],h[1],h[2],h[0],h[1],h[2])}this.vertexNormals=a}else{const l=[];l.length=Math.floor(this.verticesIndices.length/3);for(let t=0;t<this.verticesIndices.length;t+=3){const o=[this.getVertexVec(this.verticesIndices[t+0]),this.getVertexVec(this.verticesIndices[t+1]),this.getVertexVec(this.verticesIndices[t+2])];l[t/3]=n(o);this.vertexNormals[this.verticesIndices[t+0]*3+0]+=l[t/3][0];this.vertexNormals[this.verticesIndices[t+0]*3+1]+=l[t/3][1];this.vertexNormals[this.verticesIndices[t+0]*3+2]+=l[t/3][2];this.vertexNormals[this.verticesIndices[t+1]*3+0]+=l[t/3][0];this.vertexNormals[this.verticesIndices[t+1]*3+1]+=l[t/3][1];this.vertexNormals[this.verticesIndices[t+1]*3+2]+=l[t/3][2];this.vertexNormals[this.verticesIndices[t+2]*3+0]+=l[t/3][0];this.vertexNormals[this.verticesIndices[t+2]*3+1]+=l[t/3][1];this.vertexNormals[this.verticesIndices[t+2]*3+2]+=l[t/3][2]}for(let e=0;e<this.verticesIndices.length;e+=3){for(let t=0;t<3;t++){const u=[this.vertexNormals[this.verticesIndices[e+t]*3+0],this.vertexNormals[this.verticesIndices[e+t]*3+1],this.vertexNormals[this.verticesIndices[e+t]*3+2]];k(u,u);this.vertexNormals[this.verticesIndices[e+t]*3+0]=u[0];this.vertexNormals[this.verticesIndices[e+t]*3+1]=u[1];this.vertexNormals[this.verticesIndices[e+t]*3+2]=u[2]}}}}calcTangentsBitangents(){if(!this.vertices.length){return}if(!this.vertexNormals.length){return}if(!this.texCoords.length){const b=this.vertices.length/3*2;this.texCoords=new Float32Array(b);for(let t=0;t<b;t+=1)this.texCoords[t]=0}if(!this.verticesIndices||!this.verticesIndices.length){return}if(this.verticesIndices.length%3!==0){this._log.error("Vertex indices mismatch!");return}const e=this.verticesIndices.length/3;const i=this.vertices.length/3;this.tangents=new Float32Array(this.vertexNormals.length);this.biTangents=new Float32Array(this.vertexNormals.length);const s=[];s.length=i*2;const r=B();const n=B();const a=B();const o=t();const h=t();const l=t();const u=B();const c=B();for(let t=0;t<e;t+=1){const T=this.verticesIndices[t*3];const A=this.verticesIndices[t*3+1];const S=this.verticesIndices[t*3+2];V(r,this.vertices[T*3],this.vertices[T*3+1],this.vertices[T*3+2]);V(n,this.vertices[A*3],this.vertices[A*3+1],this.vertices[A*3+2]);V(a,this.vertices[S*3],this.vertices[S*3+1],this.vertices[S*3+2]);z(o,this.texCoords[T*2],this.texCoords[T*2+1]);z(h,this.texCoords[A*2],this.texCoords[A*2+1]);z(l,this.texCoords[S*2],this.texCoords[S*2+1]);const x=n[0]-r[0];const I=a[0]-r[0];const P=n[1]-r[1];const M=a[1]-r[1];const R=n[2]-r[2];const C=a[2]-r[2];const N=h[0]-o[0];const O=l[0]-o[0];const L=h[1]-o[1];const F=l[1]-o[1];const y=1/(N*F-O*L);V(u,(F*x-L*I)*y,(F*P-L*M)*y,(F*R-L*C)*y);V(c,(N*I-O*x)*y,(N*M-O*P)*y,(N*C-O*R)*y);s[T]=u;s[A]=u;s[S]=u;s[T+i]=c;s[A+i]=c;s[S+i]=c}const f=B();const g=B();const d=B();const _=B();const m=B();const p=B();const E=B();const v=B();for(let t=0;t<i;t+=1){if(!s[t])continue;V(f,this.vertexNormals[t*3],this.vertexNormals[t*3+1],this.vertexNormals[t*3+2]);V(g,s[t][0],s[t][1],s[t][2]);const U=G(f,g);Ii(m,f,U);D(p,g,m);k(v,p);H(E,f,g);const w=1;Ii(d,v,1/w);H(_,f,d);this.tangents[t*3+0]=d[0];this.tangents[t*3+1]=d[1];this.tangents[t*3+2]=d[2];this.biTangents[t*3+0]=_[0];this.biTangents[t*3+1]=_[1];this.biTangents[t*3+2]=_[2]}}isIndexed(){if(this._vertices.length==0)return true;return this.verticesIndices.length!=0}unIndex(t=false,e=false){const i=[];const s=[];let r=0;for(let t in this._attributes){const n=this._attributes[t];let i=[];for(let e=0;e<this.verticesIndices.length;e+=3){for(let t=0;t<3;t++){if(n.itemSize==3)i.push(n.data[this.verticesIndices[e+t]*3+0],n.data[this.verticesIndices[e+t]*3+1],n.data[this.verticesIndices[e+t]*3+2]);else if(n.itemSize==4)i.push(n.data[this.verticesIndices[e+t]*4+0],n.data[this.verticesIndices[e+t]*4+1],n.data[this.verticesIndices[e+t]*4+2],n.data[this.verticesIndices[e+t]*4+3]);else if(n.itemSize==2)i.push(n.data[this.verticesIndices[e+t]*2+0],n.data[this.verticesIndices[e+t]*2+1]);else if(n.itemSize==1)i.push(n.data[this.verticesIndices[e+t]]);else this._log.warn("unknown attr",n)}}this.setAttribute(n.name,i,n.itemSize)}for(let t=0;t<this.verticesIndices.length;t+=3){i.push(this.vertices[this.verticesIndices[t+0]*3+0],this.vertices[this.verticesIndices[t+0]*3+1],this.vertices[this.verticesIndices[t+0]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[t+1]*3+0],this.vertices[this.verticesIndices[t+1]*3+1],this.vertices[this.verticesIndices[t+1]*3+2]);s.push(r);r++;i.push(this.vertices[this.verticesIndices[t+2]*3+0],this.vertices[this.verticesIndices[t+2]*3+1],this.vertices[this.verticesIndices[t+2]*3+2]);s.push(r);r++}this.vertices=i;this.verticesIndices=[];if(t)this.verticesIndices=s;if(!e)this.calculateNormals()}calcBarycentric(){let e=[];e.length=this.vertices.length;for(let t=0;t<this.vertices.length;t++)e[t]=0;let i=0;for(let t=0;t<this.vertices.length;t+=3){e[t+i]=1;i++;if(i==3)i=0}this.setAttribute("attrBarycentric",e,3)}getBounds(){return new i(this)}center(t,e,i){if(t===undefined){t=true;e=true;i=true}let s=0;const r=this.getBounds();const n=[r.minX+(r.maxX-r.minX)/2,r.minY+(r.maxY-r.minY)/2,r.minZ+(r.maxZ-r.minZ)/2];for(s=0;s<this.vertices.length;s+=3){if(this.vertices[s+0]==this.vertices[s+0]){if(t)this.vertices[s+0]-=n[0];if(e)this.vertices[s+1]-=n[1];if(i)this.vertices[s+2]-=n[2]}}return n}mapTexCoords2d(){const e=this.getBounds();const i=this.vertices.length/3;this.texCoords=new Float32Array(i*2);for(let t=0;t<i;t++){const s=this.vertices[t*3+0];const r=this.vertices[t*3+1];this.texCoords[t*2+0]=s/(e.maxX-e.minX)+.5;this.texCoords[t*2+1]=1-r/(e.maxY-e.minY)+.5}}getInfoOneLine(){let t="";if(this.faceVertCount==3&&this.verticesIndices)t+=this.verticesIndices.length/3;else t+=0;t+=" tris ";if(this.vertices)t+=this.vertices.length/3;else t+=0;t+=" verts";return t}getInfo(){const t={};t.name=this.name;t.class=this.constructor.name;if(this.faceVertCount==3&&this.verticesIndices)t.numFaces=this.verticesIndices.length/3;else t.numFaces=0;if(this.verticesIndices&&this.verticesIndices.length)t.indices=this.verticesIndices.length;if(this.vertices)t.numVerts=this.vertices.length/3;else t.numVerts=0;if(this.vertexNormals)t.numNormals=this.vertexNormals.length/3;else t.numNormals=0;if(this.texCoords)t.numTexCoords=this.texCoords.length/2;else t.numTexCoords=0;if(this.tangents)t.numTangents=this.tangents.length/3;else t.numTangents=0;if(this.biTangents)t.numBiTangents=this.biTangents.length/3;else t.numBiTangents=0;if(this.biTangents)t.numBiTangents=this.biTangents.length/3;else t.numBiTangents=0;if(this.vertexColors)t.numVertexColors=this.vertexColors.length/4;else t.numVertexColors=0;if(this.getAttributes())t.numAttribs=Object.keys(this.getAttributes()).length;else t.numAttribs=0;t.isIndexed=this.isIndexed();return t}}c.buildFromFaces=function(e,t,i){const s=[];const r=[];for(let t=0;t<e.length;t+=3){const a=e[t+0];const o=e[t+1];const h=e[t+2];const l=[-1,-1,-1];if(i)for(let t=0;t<s.length;t+=3){if(s[t+0]==a[0]&&s[t+1]==a[1]&&s[t+2]==a[2])l[0]=t/3;if(s[t+0]==o[0]&&s[t+1]==o[1]&&s[t+2]==o[2])l[1]=t/3;if(s[t+0]==h[0]&&s[t+1]==h[1]&&s[t+2]==h[2])l[2]=t/3}if(l[0]==-1){s.push(a[0],a[1],a[2]);l[0]=s.length/3-1}if(l[1]==-1){s.push(o[0],o[1],o[2]);l[1]=s.length/3-1}if(l[2]==-1){s.push(h[0],h[1],h[2]);l[2]=s.length/3-1}r.push(l[0]);r.push(l[1]);r.push(l[2])}const n=new c(t);n.name=t;n.vertices=s;n.verticesIndices=r;return n};class i{_first=true;_wireMesh=null;constructor(t){this._init();if(t)if(t.isGeometry)this.applyGeom(t);else this.applyBoundingBox(t)}_init(){this._max=[-0,-0,-0];this._min=[0,0,0];this._center=[0,0,0];this._size=[0,0,0];this._maxAxis=0;this._first=true}get isBoundingBox(){return true}get maxAxis(){return this._maxAxis||1}get size(){return this._size}get center(){return this._center}get x(){return this._center[0]}get y(){return this._center[1]}get z(){return this._center[2]}get minX(){return this._min[0]}get minY(){return this._min[1]}get minZ(){return this._min[2]}get maxX(){return this._max[0]}get maxY(){return this._max[1]}get maxZ(){return this._max[2]}apply(t){console.warn("boundingbox apply is deprecated, use applyGeom or applyBoundingBox or applyPos");return this.applyGeom(t)}applyBoundingBox(t){this.applyPos(t.maxX,t.maxY,t.maxZ);this.applyPos(t.minX,t.minY,t.minZ);this.calcCenterSize()}applyGeom(e){if(!e)return;if(e.isGeometry)for(let t=0;t<e.vertices.length;t+=3)this.applyPos(e.vertices[t],e.vertices[t+1],e.vertices[t+2]);else{console.error("not geom! ");CABLES.logStack();if(e.isGeometry)this.applyBoundingBox(e)}this.calcCenterSize()}copy(){return new i(this)}get changed(){return!(this._max[0]==-Number.MAX_VALUE&&this._max[1]==-Number.MAX_VALUE&&this._max[2]==-Number.MAX_VALUE)}applyPos(t,e,i){if(t==Number.MAX_VALUE||t==-Number.MAX_VALUE||e==Number.MAX_VALUE||e==-Number.MAX_VALUE||i==Number.MAX_VALUE||i==-Number.MAX_VALUE)return;if(!A.utils.isNumeric(t)||!A.utils.isNumeric(e)||!A.utils.isNumeric(i))return;if(this._first){this._max[0]=t;this._max[1]=e;this._max[2]=i;this._min[0]=t;this._min[1]=e;this._min[2]=i;this._first=false;return}this._max[0]=Math.max(this._max[0],t);this._max[1]=Math.max(this._max[1],e);this._max[2]=Math.max(this._max[2],i);this._min[0]=Math.min(this._min[0],t);this._min[1]=Math.min(this._min[1],e);this._min[2]=Math.min(this._min[2],i)}calcCenterSize(){if(this._first)return;this._size[0]=this._max[0]-this._min[0];this._size[1]=this._max[1]-this._min[1];this._size[2]=this._max[2]-this._min[2];this._center[0]=(this._min[0]+this._max[0])/2;this._center[1]=(this._min[1]+this._max[1])/2;this._center[2]=(this._min[2]+this._max[2])/2;this._maxAxis=Math.max(this._size[2],Math.max(this._size[0],this._size[1]))}mulMat4(t){if(this._first){this._max[0]=0;this._max[1]=0;this._max[2]=0;this._min[0]=0;this._min[1]=0;this._min[2]=0;this._first=false}wi(this._max,this._max,t);wi(this._min,this._min,t);this.calcCenterSize()}render(t,e,i){if(!this._wireMesh)this._wireMesh=new CGL.WireCube(t);t.pushModelMatrix();r(t.mMatrix,t.mMatrix,this._center);if(CABLES.UI&&i){CABLES.UI.OverlayMeshes.drawCube(i,this._size[0]/2,this._size[1]/2,this._size[2]/2)}t.popModelMatrix()}}class $n{hasFocus=false;forceAspect=0;pixelDensity=1;_oldWidthRp=-1;_oldHeightRp=-1;constructor(t){this._log=new u.Logger("CgCanvas");if(!t){this._log.error("CgCanvas no options")}else{this._canvasEle=t.canvasEle}if(!t.cg)this._log.error("CgCanvas options has no cg");this._cg=t.cg;if(this.canvasEle){this.canvasWidth=this.canvasEle.clientWidth;this.canvasHeight=this.canvasEle.clientHeight;this.setSize(this.canvasWidth,this.canvasHeight);this.canvasEle.addEventListener("focus",()=>{this.hasFocus=true});this.canvasEle.addEventListener("blur",()=>{this.hasFocus=false})}}get canvasEle(){return this._canvasEle}setSize(t,e,i=false){if(this._oldWidthRp!=t*this.pixelDensity||this._oldHeightRp!=e*this.pixelDensity){this._oldWidthRp=this.canvasEle.width=t*this.pixelDensity;this._oldHeightRp=this.canvasEle.height=e*this.pixelDensity;if(!i){this.canvasEle.style.width=t+"px";this.canvasEle.style.height=e+"px"}this.updateSize();this._cg.emitEvent("resize")}}updateSize(){this.canvasEle.width=this.canvasWidth=Math.ceil(this.canvasEle.clientWidth*this.pixelDensity);this.canvasEle.height=this.canvasHeight=Math.ceil(this.canvasEle.clientHeight*this.pixelDensity)}dispose(){if(this._canvasEle)this._canvasEle.remove();this._canvasEle=null}}class ta extends u.Events{#timeStartFrame=0;#timeStartSecond=0;#fpsCounter=0;#msCounter=0;#frameCount=0;logFps=false;constructor(){super();this.stats={ms:0,fps:0}}get frameCount(){return this.#frameCount}startFrame(){this.#timeStartFrame=(0,A.now)()}endFrame(){this.#frameCount++;this.#fpsCounter++;const t=(0,A.now)()-this.#timeStartFrame;this.#msCounter+=t;if((0,A.now)()-this.#timeStartSecond>1e3)this.endSecond()}endSecond(){this.stats.fps=this.#fpsCounter;this.stats.ms=Math.round(this.#msCounter/this.#fpsCounter*100)/100;this.emitEvent("performance",this.stats);if(this.logFps)console.log(this.stats);this.#fpsCounter=0;this.#msCounter=0;this.#timeStartSecond=(0,A.now)()}}class a{constructor(){this._arr=[s()];this._index=0;this.stateCounter=0}push(t){this._index++;this.stateCounter++;if(this._index==this._arr.length){const t=s();this._arr.push(t)}Pe(this._arr[this._index],t||this._arr[this._index-1]);return this._arr[this._index]}pop(){this.stateCounter++;this._index--;if(this._index<0)this._index=0;return this._arr[this._index]}length(){return this._index}}class ea{constructor(t){this._cgl=t;this._lastTime=0;this.pause=false;this.profileUniformCount=0;this.profileShaderBinds=0;this.profileUniformCount=0;this.profileShaderCompiles=0;this.profileVideosPlaying=0;this.profileMVPMatrixCount=0;this.profileEffectBuffercreate=0;this.profileShaderGetUniform=0;this.profileFrameBuffercreate=0;this.profileMeshSetGeom=0;this.profileTextureNew=0;this.profileGenMipMap=0;this.profileOnAnimFrameOps=0;this.profileFencedPixelRead=0;this.profileMainloopMs=0;this.profileMeshDraw=0;this.profileTextureEffect=0;this.profileTexPreviews=0;this.shaderCompileTime=0;this.profileMeshNumElements=0;this.profileMeshAttributes=0;this.profileSingleMeshAttribute={};this.heavyEvents=[];this.doProfileGlQuery=false;this.glQueryData={};this.counts={}}clear(){for(const t in this.counts)this.counts[t]=0}clearGlQuery(){for(let t in this.glQueryData){if(!this.glQueryData[t].lastClear||performance.now()-this.glQueryData[t].lastClear>1e3){this.glQueryData[t].time=this.glQueryData[t]._times/this.glQueryData[t]._numcount;this.glQueryData[t].num=this.glQueryData[t]._numcount;this.glQueryData[t]._times=0;this.glQueryData[t]._numcount=0;this.glQueryData[t].lastClear=performance.now()}}}count(t,e=1){this.counts[t]=this.counts[t]||0;this.counts[t]+=e}getCount(t){return this.counts[t]}addHeavyEvent(t,e,i){const s={event:t,name:e,info:i,date:performance.now()};this.heavyEvents.push(s);this._cgl.emitEvent("heavyEvent",s)}}class ia extends u.Events{static API_UNKNOWN=0;static API_WEBGL=1;static API_WEBGPU=2;static EVENT_RESIZE="resize";#patch=null;gApi=0;_textureslots=[];_pMatrixStack=new a;_mMatrixStack=new a;_vMatrixStack=new a;canvasScale=1;constructor(t){super();this._log=new u.Logger("cg_context",{onError:t.config.onError});this.tempData=this.frameStore=this.frameStore||{};this.fpsCounter=new ta;this._identView=B();this._ident=B();V(this._identView,0,0,-2);V(this._ident,0,0,0);this._onetimeCallbacks=[];this.maxTexSize=2048;this._viewPort=[0,0,1,1];this._viewPortStack=[];this.patch=t;this.autoReSize=true;this.DEPTH_COMPARE_FUNC_NEVER=0;this.DEPTH_COMPARE_FUNC_LESS=1;this.DEPTH_COMPARE_FUNC_EQUAL=2;this.DEPTH_COMPARE_FUNC_LESSEQUAL=3;this.DEPTH_COMPARE_FUNC_GREATER=4;this.DEPTH_COMPARE_FUNC_NOTEQUAL=5;this.DEPTH_COMPARE_FUNC_GREATEREQUAL=6;this.DEPTH_COMPARE_FUNC_ALWAYS=7;this.profileData=new ea(this);this.pMatrix=s();this.mMatrix=s();this.vMatrix=s();S(this.mMatrix);S(this.vMatrix);window.matchMedia("screen and (min-resolution: 2dppx)").addEventListener("change",()=>{this.emitEvent("resize")})}get canvasWidth(){return this.width}get canvasHeight(){return this.height}get width(){return this.cgCanvas.canvasWidth}get height(){return this.cgCanvas.canvasHeight}get widthCss(){return this.cgCanvas.canvasWidth/this.pixelDensity}get heightCss(){return this.cgCanvas.canvasHeight/this.pixelDensity}set pixelDensity(t){if(this.cgCanvas.pixelDensity!=t){this.cgCanvas.pixelDensity=t;this.cgCanvas.updateSize();this.emitEvent("resize")}}get pixelDensity(){return this.cgCanvas.pixelDensity}getGApiName(){return["unknown","WebGL","WebGPU"][this.gApi]}get canvas(){return this.cgCanvas.canvasEle}get viewPort(){return[0,0,this.canvasWidth,this.canvasHeight]}setCanvas(t){if(this.cgCanvas&&t==this.cgCanvas.canvasEle)return;if(typeof t==="string")t=document.getElementById(t);this.cgCanvas=new $n({canvasEle:t,cg:this});if(!t)return;t.parentElement.classList.add("cablesContainer");if(this._setCanvas)this._setCanvas(t);this.updateSize()}_setCanvas(t){}updateSize(){this.cgCanvas.updateSize()}setSize(t,e,i=false){this.cgCanvas.setSize(t,e,i)}_resizeToWindowSize(){if(this.autoReSize){this.setSize(window.innerWidth,window.innerHeight);this.updateSize()}}_resizeToParentSize(){if(this.autoReSize){const t=this.canvas.parentElement;if(!t){this._log.error("cables: can not resize to container element");return}this.setSize(t.clientWidth,t.clientHeight);this.updateSize()}}setAutoResize(t){window.removeEventListener("resize",this._resizeToWindowSize.bind(this));window.removeEventListener("resize",this._resizeToParentSize.bind(this));if(t=="window"){window.addEventListener("resize",this._resizeToWindowSize.bind(this));window.addEventListener("orientationchange",this._resizeToWindowSize.bind(this));this._resizeToWindowSize()}if(t=="parent"){window.addEventListener("resize",this._resizeToParentSize.bind(this));this._resizeToParentSize()}}pushPMatrix(){this.pMatrix=this._pMatrixStack.push(this.pMatrix)}popPMatrix(){this.pMatrix=this._pMatrixStack.pop();return this.pMatrix}getProjectionMatrixStateCount(){return this._pMatrixStack.stateCounter}pushModelMatrix(){this.mMatrix=this._mMatrixStack.push(this.mMatrix)}popModelMatrix(){this.mMatrix=this._mMatrixStack.pop();return this.mMatrix}modelMatrix(){return this.mMatrix}pushViewMatrix(){this.vMatrix=this._vMatrixStack.push(this.vMatrix)}popViewMatrix(){this.vMatrix=this._vMatrixStack.pop()}getViewMatrixStateCount(){return this._vMatrixStack.stateCounter}_startMatrixStacks(t,e){t=t||this._ident;e=e||this._identView;$e(this.pMatrix,45,this.canvasWidth/this.canvasHeight,.1,1e3);S(this.mMatrix);S(this.vMatrix);r(this.mMatrix,this.mMatrix,t);r(this.vMatrix,this.vMatrix,e);this.pushPMatrix();this.pushModelMatrix();this.pushViewMatrix()}_endMatrixStacks(){this.popViewMatrix();this.popModelMatrix();this.popPMatrix()}dispose(){this.aborted=true;if(this.cgCanvas)this.cgCanvas.dispose();if(this._dispose)this._dispose()}_dispose(){}shouldDrawHelpers(t){return false}addNextFrameOnceCallback(t){if(t&&this._onetimeCallbacks.indexOf(t)==-1)this._onetimeCallbacks.push(t)}_execOneTimeCallbacks(){if(this._onetimeCallbacks.length>0){for(let t=0;t<this._onetimeCallbacks.length;t++)this._onetimeCallbacks[t]();this._onetimeCallbacks.length=0}}checkTextureSize(t){t=t||1;t=Math.floor(t);t=Math.min(t,this.maxTexSize);t=Math.max(t,1);return t}screenShot(t,e,i,s){console.log("no screenshot function implemented")}saveScreenshot(i,s,t,e,r){this.patch.renderOneFrame();let n=this.canvas.clientWidth*this.pixelDensity;let a=this.canvas.clientHeight*this.pixelDensity;if(t){this.canvas.width=t;n=t}if(e){this.canvas.height=e;a=e}function o(t,e,i){return Array(e-String(t).length+1).join(i||"0")+t}const h=new Date;const l="".concat(String(h.getFullYear())+String(h.getMonth()+1)+String(h.getDate()),"_").concat(o(h.getHours(),2)).concat(o(h.getMinutes(),2)).concat(o(h.getSeconds(),2));if(!i)i="cables_"+l+".png";else i+=".png";this.screenShot(t=>{this.canvas.width=n;this.canvas.height=a;if(t){const e=document.createElement("a");e.download=i;e.href=URL.createObjectURL(t);console.log("scrrenshot");setTimeout(function(){e.click();if(s)s(t)},100)}else{this._log.log("screenshot: no blob")}})}hasFocus(){return this.cgCanvas.hasFocus}}class sa extends u.Events{id=A.utils.simpleId();_isValid=true;_defines=[];_moduleNames=[];_moduleNumId=0;_needsRecompile=true;_compileReason="initial";_modules=[];_compileCount=0;logError=true;num=-1;lastCompile=0;constructor(){super()}setWhyCompile(t){this._compileReason=t;this._needsRecompile=true}getWhyCompile(){return this._compileReason}needsRecompile(){return this._needsRecompile}removeUniform(e){for(let t=0;t<this._uniforms.length;t++){if(this._uniforms[t].getName()==e){this._uniforms.splice(t,1)}}this.setWhyCompile("remove uniform "+e)}hasUniformInStage(e,t){let i=this.defaultUniBindingFrag;if(t==GPUShaderStage.VERTEX)i=this.defaultUniBindingVert;if(t==GPUShaderStage.COMPUTE)i=this.defaultUniBindingCompute;for(let t=0;t<this._uniforms.length;t++){console.log("hasuniiiiiiiiiiiiiii",this._uniforms[t].getName(),e);if(this._uniforms[t].getName()==e)return true}return false}hasUniform(t){}toggleDefine(e,t){if(t&&typeof t=="object"&&t.addEventListener){if(t.changeListener)t.off(t.changeListener);t.onToggleDefine=t=>{this.toggleDefine(e,t)};t.changeListener=t.on("change",t.onToggleDefine);t=t.get()}if(t)this.define(e);else this.removeDefine(e)}define(e,i=""){if(i===null||i===undefined)i="";if(typeof i=="object"){i.removeEventListener("change",i.onDefineChange);i.onDefineChange=t=>{this.define(e,t)};i.on("change",i.onDefineChange);i=i.get()}for(let t=0;t<this._defines.length;t++){if(this._defines[t][0]==e&&this._defines[t][1]==i)return;if(this._defines[t][0]==e){this._defines[t][1]=i;this.setWhyCompile("define "+e+" "+i);return}}this.setWhyCompile("define "+e+" "+i);this._defines.push([e,i])}getDefines(){return this._defines}getDefine(e){for(let t=0;t<this._defines.length;t++)if(this._defines[t][0]==e)return this._defines[t][1];return null}hasDefine(e){for(let t=0;t<this._defines.length;t++)if(this._defines[t][0]==e)return true}removeDefine(e){for(let t=0;t<this._defines.length;t++){if(this._defines[t][0]==e){this._defines.splice(t,1);this.setWhyCompile("define removed:"+e);return}}}hasModule(e){for(let t=0;t<this._modules.length;t++)if(this._modules[t].id==e)return true;return false}setModules(t){this._moduleNames=t}removeModule(i){for(let t=0;t<this._modules.length;t++){if(i&&i.id){if(this._modules[t].id==i.id||!this._modules[t]){let e=true;while(e){e=false;for(let t=0;t<this._uniforms.length;t++){if(this._uniforms[t].getName().startsWith(i.prefix)){this._uniforms.splice(t,1);e=true;continue}}}this.setWhyCompile("remove module "+i.title);this._modules.splice(t,1);break}}}}getNumModules(){return this._modules.length}getCurrentModules(){return this._modules}addModule(t,e){if(this.hasModule(t.id))return;if(!t.id)t.id=A.utils.simpleId();if(!t.numId)t.numId=this._moduleNumId;if(!t.num)t.num=this._modules.length;if(e&&!e.group)e.group=A.utils.simpleId();if(!t.group)if(e)t.group=e.group;else t.group=A.utils.simpleId();t.prefix="mod"+t.group+"_";this._modules.push(t);this.setWhyCompile("add module "+t.title);this._moduleNumId++;return t}isValid(){return this._isValid}}class ra{constructor(t,e,i,s,r,n,a,o,h,l){this._log=new u.Logger("cg_uniform");this._type=e;this._name=i;this._shader=t;this._value=1e-5;this._oldValue=null;this._port=null;this._structName=h;this._structUniformName=o;this._propertyName=l;if(this._shader._addUniform)this._shader._addUniform(this);this.needsUpdate=true;this.shaderType=null;this.comment=null;if(e=="f"){this.set=this.setValue=this.setValueF.bind(this);this.updateValue=this.updateValueF.bind(this)}else if(e=="f[]"){this.set=this.setValue=this.setValueArrayF.bind(this);this.updateValue=this.updateValueArrayF.bind(this)}else if(e=="2f[]"){this.set=this.setValue=this.setValueArray2F.bind(this);this.updateValue=this.updateValueArray2F.bind(this)}else if(e=="3f[]"){this.set=this.setValue=this.setValueArray3F.bind(this);this.updateValue=this.updateValueArray3F.bind(this)}else if(e=="4f[]"){this.set=this.setValue=this.setValueArray4F.bind(this);this.updateValue=this.updateValueArray4F.bind(this)}else if(e=="i"){this.set=this.setValue=this.setValueI.bind(this);this.updateValue=this.updateValueI.bind(this)}else if(e=="2i"){this.set=this.setValue=this.setValue2I.bind(this);this.updateValue=this.updateValue2I.bind(this)}else if(e=="3i"){this.set=this.setValue=this.setValue3I.bind(this);this.updateValue=this.updateValue3I.bind(this)}else if(e=="4i"){this.set=this.setValue=this.setValue4I.bind(this);this.updateValue=this.updateValue4I.bind(this)}else if(e=="b"){this.set=this.setValue=this.setValueBool.bind(this);this.updateValue=this.updateValueBool.bind(this)}else if(e=="4f"){this.set=this.setValue=this.setValue4F.bind(this);this.updateValue=this.updateValue4F.bind(this)}else if(e=="3f"){this.set=this.setValue=this.setValue3F.bind(this);this.updateValue=this.updateValue3F.bind(this)}else if(e=="2f"){this.set=this.setValue=this.setValue2F.bind(this);this.updateValue=this.updateValue2F.bind(this)}else if(e=="t"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(e=="sampler"){if(this.setValueAny){this.set=this.setValue=this.setValueAny.bind(this);this.updateValue=this.updateValueAny.bind(this)}}else if(e=="tc"){this.set=this.setValue=this.setValueT.bind(this);this.updateValue=this.updateValueT.bind(this)}else if(e=="t[]"){this.set=this.setValue=this.setValueArrayT.bind(this);this.updateValue=this.updateValueArrayT.bind(this)}else if(e=="m4"||e=="m4[]"){this.set=this.setValue=this.setValueM4.bind(this);this.updateValue=this.updateValueM4.bind(this)}else{this._log.error("Unknown uniform type "+e,i,typeof this._shader)}if(typeof s=="object"&&s instanceof A.Port){this._port=s;this._value=this._port.get();if(r&&n&&a){if(!(r instanceof A.Port)||!(n instanceof A.Port)||!(a instanceof A.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0,0];this._port2=r;this._port3=n;this._port4=a;this._port.on("change",this.updateFromPort4f.bind(this));this._port2.on("change",this.updateFromPort4f.bind(this));this._port3.on("change",this.updateFromPort4f.bind(this));this._port4.on("change",this.updateFromPort4f.bind(this));this.updateFromPort4f()}else if(r&&n){if(!(r instanceof A.Port)||!(n instanceof A.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0,0];this._port2=r;this._port3=n;this._port.on("change",this.updateFromPort3f.bind(this));this._port2.on("change",this.updateFromPort3f.bind(this));this._port3.on("change",this.updateFromPort3f.bind(this));this.updateFromPort3f()}else if(r){if(!(r instanceof A.Port)){this._log.error("[cgl_uniform] mixed port/value parameter for vec4 ",this._name)}this._value=[0,0];this._port2=r;this._port.on("change",this.updateFromPort2f.bind(this));this._port2.on("change",this.updateFromPort2f.bind(this));this.updateFromPort2f()}else{this._port.on("change",this.updateFromPort.bind(this))}}else this._value=s;if(this._value==undefined){this._value=0}this.setValue(this._value);this.needsUpdate=true}getType(){return this._type}get type(){return this._type}get name(){return this._name}getName(){return this._name}getValue(){return this._value}getShaderType(){return this.shaderType}isStructMember(){return!!this._structName}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}get port(){return this._port}}class na{_name="unknown";constructor(){}}const aa=8;class g{constructor(t={}){this.id=A.utils.uuid();this.width=0;this.height=0;this.name="unknown";t=t||{};this.pixelFormat=t.pixelFormat||g.PFORMATSTR_RGBA8UB;this.name=t.name||"unknown";if(!t.width)t.width=aa;if(!t.height)t.height=aa}}g.getDefaultTextureData=(t,n,a={})=>{if(t=="empty"){return new Uint8Array(n*n*4).fill(0)}else if(t=="color"){const r=new Uint8Array(n*n*4);let e=a.r||1;let i=a.g||1;let s=a.b||1;for(let t=0;t<n*n;t++){r[t*4+0]=e;r[t*4+1]=i;r[t*4+2]=s;r[t*4+3]=255}return r}else if(t=="randomUInt"){const r=new Uint8Array(n*n*4);for(let t=0;t<n*n;t++){r[t*4+0]=Math.random()*255;r[t*4+1]=Math.random()*255;r[t*4+2]=Math.random()*255;r[t*4+3]=255}return r}else if(t=="random"||t=="randomFloat"){const r=new Float32Array(n*n*4);for(let t=0;t<n*n;t++){r[t*4+0]=(Math.random()-.5)*2;r[t*4+1]=(Math.random()-.5)*2;r[t*4+2]=(Math.random()-.5)*2;r[t*4+3]=1}return r}else if(t=="stripes"){const o=[];let i=a.r;let s=a.g;let r=a.b;if(i===undefined)i=1;if(s===undefined)s=1;if(r===undefined)r=1;for(let e=0;e<n;e++){for(let t=0;t<n;t++){if((t+e)%64<32){o.push((200+e/n*25+t/n*25)*i);o.push((200+e/n*25+t/n*25)*s);o.push((200+e/n*25+t/n*25)*r)}else{o.push((40+e/n*25+t/n*25)*i);o.push((40+e/n*25+t/n*25)*s);o.push((40+e/n*25+t/n*25)*r)}o.push(255)}}return new Uint8Array(o)}else{console.warn("unknown default texture",t);return g.getDefaultTextureData("stripes",n,{r:1,g:0,b:0})}};g.FILTER_NEAREST=0;g.FILTER_LINEAR=1;g.FILTER_MIPMAP=2;g.WRAP_REPEAT=0;g.WRAP_MIRRORED_REPEAT=1;g.WRAP_CLAMP_TO_EDGE=2;g.TYPE_DEFAULT=0;g.TYPE_DEPTH=1;g.TYPE_FLOAT=2;g.PFORMATSTR_RGB565="RGB 5/6/5bit ubyte";g.PFORMATSTR_R8UB="R 8bit ubyte";g.PFORMATSTR_RG8UB="RG 8bit ubyte";g.PFORMATSTR_RGB8UB="RGB 8bit ubyte";g.PFORMATSTR_RGBA8UB="RGBA 8bit ubyte";g.PFORMATSTR_SRGBA8="SRGBA 8bit ubyte";g.PFORMATSTR_R11FG11FB10F="RGB 11/11/10bit float";g.PFORMATSTR_R16F="R 16bit float";g.PFORMATSTR_RG16F="RG 16bit float";g.PFORMATSTR_RGB16F="RGB 16bit float";g.PFORMATSTR_RGBA16F="RGBA 16bit float";g.PFORMATSTR_R32F="R 32bit float";g.PFORMATSTR_RG32F="RG 32bit float";g.PFORMATSTR_RGB32F="RGB 32bit float";g.PFORMATSTR_RGBA32F="RGBA 32bit float";g.PFORMATSTR_DEPTH="DEPTH";g.PIXELFORMATS=[g.PFORMATSTR_RGB565,g.PFORMATSTR_R8UB,g.PFORMATSTR_RG8UB,g.PFORMATSTR_RGB8UB,g.PFORMATSTR_RGBA8UB,g.PFORMATSTR_SRGBA8,g.PFORMATSTR_R11FG11FB10F,g.PFORMATSTR_R16F,g.PFORMATSTR_RG16F,g.PFORMATSTR_RGBA16F,g.PFORMATSTR_R32F,g.PFORMATSTR_RGBA32F];const oa={SHADERVAR_VERTEX_POSITION:"vPosition",SHADERVAR_VERTEX_NUMBER:"attrVertIndex",SHADERVAR_VERTEX_NORMAL:"attrVertNormal",SHADERVAR_VERTEX_TEXCOORD:"attrTexCoord",SHADERVAR_INSTANCE_MMATRIX:"instMat",SHADERVAR_VERTEX_COLOR:"attrVertColor",SHADERVAR_INSTANCE_INDEX:"instanceIndex",SHADERVAR_UNI_PROJMAT:"projMatrix",SHADERVAR_UNI_VIEWMAT:"viewMatrix",SHADERVAR_UNI_MODELMAT:"modelMatrix",SHADERVAR_UNI_NORMALMAT:"normalMatrix",SHADERVAR_UNI_INVVIEWMAT:"inverseViewMatrix",SHADERVAR_UNI_INVPROJMAT:"invProjMatrix",SHADERVAR_UNI_MATERIALID:"materialId",SHADERVAR_UNI_OBJECTID:"objectId",SHADERVAR_UNI_VIEWPOS:"camPos"};const ha={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};const la=180/Math.PI;const ua=Math.PI/180;const d={MATH:{DEG2RAD:ua,RAD2DEG:la},SHADER:oa,BLEND_MODES:ha};const x="\n";const ca={DEPTH_COMPARE_NEVER:0,DEPTH_COMPARE_LESS:1,DEPTH_COMPARE_EQUAL:2,DEPTH_COMPARE_LESSEQUAL:3,DEPTH_COMPARE_GREATER:4,DEPTH_COMPARE_NOTEQUAL:5,DEPTH_COMPARE_GREATEREQUAL:6,DEPTH_COMPARE_ALWAYS:7,CULL_NONE:0,CULL_BACK:1,CULL_FRONT:2,CULL_BOTH:3,Geometry:c,BoundingBox:i,FpsCounter:ta,CgCanvas:$n};window.CABLES=window.CABLES||{};window.CABLES.CG={...ca,...window.CABLES.CG};window.CG={...ca,...window.CABLES.CG,...window.CG};window.glMatrix=R;window.mat2=C;window.mat2d=N;window.mat3=O;window.mat4=L;window.quat=w;window.quat2=j;window.vec2=Y;window.vec3=F;window.vec4=U;class _ extends ra{constructor(t,e,i,s,r,n,a,o,h,l){super(t,e,i,s,r,n,a,o,h,l);this._loc=-1;this._cgl=t._cgl}get name(){return this._name}copy(t){const e=new _(t,this._type,this._name,this._value,this._port2,this._port3,this._port4,this._structUniformName,this._structName,this._propertyName);e.shaderType=this.shaderType;return e}getGlslTypeString(){return _.glslTypeString(this._type)}_isValidLoc(){return this._loc!=-1}resetLoc(){this._loc=-1;this.needsUpdate=true}bindTextures(){}getLoc(){return this._loc}updateFromPort4f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this._value[3]=this._port4.get();this.setValue(this._value)}updateFromPort3f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this._value[2]=this._port3.get();this.setValue(this._value)}updateFromPort2f(){this._value[0]=this._port.get();this._value[1]=this._port2.get();this.setValue(this._value)}updateFromPort(){this.setValue(this._port.get())}updateValueF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1f(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}setValueF(t){if(t!=this._value){this.needsUpdate=true;this._value=t}}updateValueI(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}updateValue2I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2i(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.count("uniformUpdate")}updateValue3I(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3i(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.count("uniformUpdate")}updateValue4I(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform4i(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.count("uniformUpdate")}setValueI(t){if(t!=this._value){this.needsUpdate=true;this._value=t}}setValue2I(t){if(!t)return;if(!this._oldValue){this._oldValue=[t[0]-1,1];this.needsUpdate=true}else if(t[0]!=this._oldValue[0]||t[1]!=this._oldValue[1]){this._oldValue[0]=t[0];this._oldValue[1]=t[1];this.needsUpdate=true}this._value=t}setValue3I(t){if(!t)return;if(!this._oldValue){this._oldValue=[t[0]-1,1,2];this.needsUpdate=true}else if(t[0]!=this._oldValue[0]||t[1]!=this._oldValue[1]||t[2]!=this._oldValue[2]){this._oldValue[0]=t[0];this._oldValue[1]=t[1];this._oldValue[2]=t[2];this.needsUpdate=true}this._value=t}setValue4I(t){this.needsUpdate=true;this._value=t||vec4.create()}updateValueBool(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;this._shader.getCgl().gl.uniform1i(this._loc,this._value?1:0);this._cgl.profileData.count("uniformUpdate")}setValueBool(t){if(t!=this._value){this.needsUpdate=true;this._value=t}}setValueArray4F(t){this.needsUpdate=true;this._value=t}updateValueArray4F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform4fv(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}setValueArray3F(t){this.needsUpdate=true;this._value=t}updateValueArray3F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform3fv(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}setValueArray2F(t){this.needsUpdate=true;this._value=t}updateValueArray2F(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform2fv(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}setValueArrayF(t){this.needsUpdate=true;this._value=t}updateValueArrayF(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1fv(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}setValueArrayT(t){this.needsUpdate=true;this._value=t}updateValue3F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform3f(this._loc,this._value[0],this._value[1],this._value[2]);this.needsUpdate=false;this._cgl.profileData.count("uniformUpdate")}setValue3F(t){if(!t)return;if(!this._oldValue){this._oldValue=[t[0]-1,1,2];this.needsUpdate=true}else if(t[0]!=this._oldValue[0]||t[1]!=this._oldValue[1]||t[2]!=this._oldValue[2]){this._oldValue[0]=t[0];this._oldValue[1]=t[1];this._oldValue[2]=t[2];this.needsUpdate=true}this._value=t}updateValue2F(){if(!this._value)return;if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._shader.getCgl().gl.uniform2f(this._loc,this._value[0],this._value[1]);this.needsUpdate=false;this._cgl.profileData.count("uniformUpdate")}setValue2F(t){if(!t)return;if(!this._oldValue){this._oldValue=[t[0]-1,1];this.needsUpdate=true}else if(t[0]!=this._oldValue[0]||t[1]!=this._oldValue[1]){this._oldValue[0]=t[0];this._oldValue[1]=t[1];this.needsUpdate=true}this._value=t}updateValue4F(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value){this._log.warn("no value for uniform",this._name,this);this._value=[0,0,0,0]}this.needsUpdate=false;this._shader.getCgl().gl.uniform4f(this._loc,this._value[0],this._value[1],this._value[2],this._value[3]);this._cgl.profileData.count("uniformUpdate")}setValue4F(t){if(typeof this.value=="number")this.value=vec4.create();if(!t)return;if(!this._oldValue){this._oldValue=[t[0]-1,1,2,3];this.needsUpdate=true}else if(t[0]!=this._oldValue[0]||t[1]!=this._oldValue[1]||t[2]!=this._oldValue[2]||t[3]!=this._oldValue[3]){this._oldValue[0]=t[0];this._oldValue[1]=t[1];this._oldValue[2]=t[2];this.needsUpdate=true}this._value=t}updateValueM4(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}if(!this._value||this._value.length%16!=0)return console.log("this.name",this._name,this._value);this._shader.getCgl().gl.uniformMatrix4fv(this._loc,false,this._value);this._cgl.profileData.count("uniformUpdate")}setValueM4(t){this.needsUpdate=true;this._value=t||mat4.create()}updateValueArrayT(){if(!this._isValidLoc())this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);else this.needsUpdate=false;if(!this._value)return;this._shader.getCgl().gl.uniform1iv(this._loc,this._value);this._cgl.profileData.count("uniformUpdate")}updateValueT(){if(!this._isValidLoc()){this._loc=this._shader.getCgl().gl.getUniformLocation(this._shader.getProgram(),this._name);this._cgl.profileData.count("uniformGet");this._cgl.profileData.profileShaderGetUniformName=this._name}this._cgl.profileData.count("uniformUpdate");this._shader.getCgl().gl.uniform1i(this._loc,this._value);this.needsUpdate=false}setValueT(t){this.needsUpdate=true;this._value=t}}_.glslTypeString=t=>{if(t=="f")return"float";if(t=="b")return"bool";if(t=="i")return"int";if(t=="2i")return"ivec2";if(t=="2f")return"vec2";if(t=="3f")return"vec3";if(t=="4f")return"vec4";if(t=="m4")return"mat4";if(t=="t")return"sampler2D";if(t=="tc")return"samplerCube";if(t=="3f[]")return null;if(t=="m4[]")return null;if(t=="f[]")return null;console.warn("[CGL UNIFORM] unknown glsl type string ",t)};const I={};I.lastMesh=null;class m extends na{#log=new u.Logger("cgl_mesh");#cgl=null;#geom=null;#bufVerticesIndizes=null;#indexType;_attributes=[];_attribLocs={};_lastShader=null;_numInstances=0;_preWireframeGeom=null;addVertexNumbers=false;feedBackAttributes=[];_feedBacks=[];_feedBacksChanged=false;_transformFeedBackLoc=-1;_lastAttrUpdate=0;memFreed=false;_queryExt=null;constructor(t,e,i={}){super();this.#cgl=t;let s=i||{};if(A.utils.isNumeric(s))s={glPrimitive:i};this._bufVertexAttrib=null;this.#bufVerticesIndizes=this.#cgl.gl.createBuffer();this.#indexType=this.#cgl.gl.UNSIGNED_SHORT;this._glPrimitive=s.glPrimitive||null;this.opId=s.opId||"";this.setGeom(e);this.#cgl.profileData.addHeavyEvent("mesh constructed",this._name)}get geom(){return this.#geom}get numInstances(){return this._numInstances}set numInstances(t){this.setNumInstances(t)}freeMem(){this.memFreed=true;for(let t=0;t<this._attributes.length;t++)this._attributes[t].floatArray=null}updateVertices(t){this.setAttribute(d.SHADER.SHADERVAR_VERTEX_POSITION,t.vertices,3);this._numVerts=t.vertices.length/3}setAttributePointer(e,i,s,r){for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].name==e){if(!this._attributes[t].pointer)this._attributes[t].pointer=[];this._attributes[t].pointer.push({loc:-1,name:i,stride:s,offset:r,instanced:e==d.SHADER.SHADERVAR_INSTANCE_MMATRIX})}}}getAttribute(e){for(let t=0;t<this._attributes.length;t++)if(this._attributes[t].name==e)return this._attributes[t]}setAttributeRange(t,e,i,s){if(!t)return;if(!i&&!s)return;if(!t.name)this.#log.stack("no attrname?!");const r=this.#cgl.gl;r.bindBuffer(r.ARRAY_BUFFER,t.buffer);this.#cgl.profileData.profileMeshAttributes+=s-i||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]=this.#cgl.profileData.profileSingleMeshAttribute[this._name]||0;this.#cgl.profileData.profileSingleMeshAttribute[this._name]+=s-i||0;if(t.numItems<e.length/t.itemSize){this._resizeAttr(e,t)}if(s>e.length&&!this.warned){this.warned=true;this.#log.warn(this.#cgl.canvas.id+"'"+t.name+"' buffersubdata out of bounds ?",e.length,s,i,t);return}r.bufferSubData(r.ARRAY_BUFFER,i*4,e,i,s-i)}_resizeAttr(t,e){const i=this.#cgl.gl;if(e.buffer)i.deleteBuffer(e.buffer);e.buffer=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,e.buffer);this._bufferArray(t,e);e.numItems=t.length/e.itemSize}_bufferArray(t,e){let i=e.floatArray||null;if(!t)return;if(this.#cgl.debugOneFrame)console.log("_bufferArray",t.length,e.name);if(!(t instanceof Float32Array)){if(e&&i&&i.length==t.length){i.set(t)}else{i=new Float32Array(t);if(this.#cgl.debugOneFrame){console.log("_bufferArray create new float32array",t.length,e.name)}if(t.length>1e4){this.#cgl.profileData.profileNonTypedAttrib++;this.#cgl.profileData.profileNonTypedAttribNames="("+this._name+":"+e.name+")"}}}else i=t;e.arrayLength=i.length;e.floatArray=null;this.#cgl.gl.bufferData(this.#cgl.gl.ARRAY_BUFFER,i,this.#cgl.gl.DYNAMIC_DRAW)}addAttribute(t,e,i,s){this.setAttribute(t,e,i,s)}setAttribute(t,e,i,s={}){if(!e){this.#log.error("mesh addAttribute - no array given! "+t);throw new Error}let r=null;let n=false;let a=0;const o=e.length/i;this.#cgl.profileData.profileMeshAttributes+=o||0;if(typeof s=="function"){r=s}if(typeof s=="object"){if(s.cb)r=s.cb;if(s.instanced)n=s.instanced}if(t==d.SHADER.SHADERVAR_INSTANCE_MMATRIX)n=true;for(a=0;a<this._attributes.length;a++){const u=this._attributes[a];if(u.name==t){if(u.numItems===o){}else{this._resizeAttr(e,u)}this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,u.buffer);this._bufferArray(e,u);return u}}const h=this.#cgl.gl.createBuffer();this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,h);let l=this.#cgl.gl.FLOAT;if(s&&s.type)l=s.type;const u={buffer:h,name:t,cb:r,itemSize:i,numItems:o,startItem:0,instanced:n,type:l};this._bufferArray(e,u);if(t==d.SHADER.SHADERVAR_VERTEX_POSITION)this._bufVertexAttrib=u;this._attributes.push(u);this._attribLocs={};return u}getAttributes(){return this._attributes}updateTexCoords(t){if(t.texCoords&&t.texCoords.length>0){this.setAttribute(d.SHADER.SHADERVAR_VERTEX_TEXCOORD,t.texCoords,2)}else{const e=new Float32Array(Math.round(t.vertices.length/3*2));this.setAttribute(d.SHADER.SHADERVAR_VERTEX_TEXCOORD,e,2)}}updateNormals(t){if(t.vertexNormals&&t.vertexNormals.length>0){this.setAttribute(d.SHADER.SHADERVAR_VERTEX_NORMAL,t.vertexNormals,3)}else{const e=new Float32Array(Math.round(t.vertices.length));this.setAttribute(d.SHADER.SHADERVAR_VERTEX_NORMAL,e,3)}}_setVertexNumbers(t=null){if(!this._verticesNumbers||this._verticesNumbers.length!=this._numVerts||t){if(t)this._verticesNumbers=t;else{this._verticesNumbers=new Float32Array(this._numVerts);for(let t=0;t<this._numVerts;t++)this._verticesNumbers[t]=t}this.setAttribute(d.SHADER.SHADERVAR_VERTEX_NUMBER,this._verticesNumbers,1,(t,e,i)=>{if(!i.uniformNumVertices)i.uniformNumVertices=new _(i,"f","numVertices",this._numVerts);i.uniformNumVertices.setValue(this._numVerts)})}}setVertexIndices(e){if(!this.#bufVerticesIndizes){this.#log.warn("no bufVerticesIndizes: "+this._name);return}if(e.length>0){if(e instanceof Float32Array)this.#log.warn("vertIndices float32Array: "+this._name);for(let t=0;t<e.length;t++){if(e[t]>=this._numVerts){this.#log.warn("invalid index in "+this._name,t,e[t]);return}}this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes);if(e.length>65535){this.vertIndicesTyped=new Uint32Array(e);this.#indexType=this.#cgl.gl.UNSIGNED_INT}else if(e instanceof Uint32Array){this.vertIndicesTyped=e;this.#indexType=this.#cgl.gl.UNSIGNED_INT}else if(!(e instanceof Uint16Array)){this.vertIndicesTyped=new Uint16Array(e);this.#indexType=this.#cgl.gl.UNSIGNED_SHORT}else this.vertIndicesTyped=e;this.#cgl.gl.bufferData(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.vertIndicesTyped,this.#cgl.gl.DYNAMIC_DRAW);this.#bufVerticesIndizes.itemSize=1;this.#bufVerticesIndizes.numItems=e.length}else this.#bufVerticesIndizes.numItems=0}setGeom(t,e=false){this.#geom=t;if(t.glPrimitive!=null)this._glPrimitive=t.glPrimitive;if(this.#geom&&this.#geom.name)this._name="mesh "+this.#geom.name;I.lastMesh=null;this.#cgl.profileData.count("meshSetGeom");this._disposeAttributes();this.updateVertices(this.#geom);this.setVertexIndices(this.#geom.verticesIndices);if(this.addVertexNumbers)this._setVertexNumbers();const i=this.#geom.getAttributes();const s={texCoords:d.SHADER.SHADERVAR_VERTEX_TEXCOORD,vertexNormals:d.SHADER.SHADERVAR_VERTEX_NORMAL,vertexColors:d.SHADER.SHADERVAR_VERTEX_COLOR,tangents:"attrTangent",biTangents:"attrBiTangent"};for(const r in i)if(i[r].data&&i[r].data.length)this.setAttribute(s[r]||r,i[r].data,i[r].itemSize);if(e){this.#geom=null}}_preBind(e){for(let t=0;t<this._attributes.length;t++)if(this._attributes[t].cb)this._attributes[t].cb(this._attributes[t],this.#geom,e)}_checkAttrLengths(){if(this.memFreed)return;for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].arrayLength/this._attributes[t].itemSize<this._attributes[0].arrayLength/this._attributes[0].itemSize){let t="unknown";if(this.#geom)t=this.#geom.name}}}_bind(e){if(!e)return;if(!e.isValid())return;let i=[];if(this._attribLocs[e.id])i=this._attribLocs[e.id];else this._attribLocs[e.id]=i;this._lastShader=e;if(e.lastCompile>this._lastAttrUpdate||i.length!=this._attributes.length){this._lastAttrUpdate=e.lastCompile;for(let t=0;t<this._attributes.length;t++)i[t]=-1}for(let t=0;t<this._attributes.length;t++){const s=this._attributes[t];if(i[t]==-1){if(s._attrLocationLastShaderTime!=e.lastCompile){s._attrLocationLastShaderTime=e.lastCompile;i[t]=this.#cgl.glGetAttribLocation(e.getProgram(),s.name);this.#cgl.profileData.profileAttrLoc++}}if(i[t]!=-1){this.#cgl.gl.enableVertexAttribArray(i[t]);this.#cgl.gl.bindBuffer(this.#cgl.gl.ARRAY_BUFFER,s.buffer);if(s.instanced){if(s.itemSize<=4){if(!s.itemSize||s.itemSize==0)this.#log.warn("instanced attrib itemsize error",this.#geom.name,s);this.#cgl.gl.vertexAttribPointer(i[t],s.itemSize,s.type,false,s.itemSize*4,0);this.#cgl.gl.vertexAttribDivisor(i[t],1)}else if(s.itemSize==16){const r=16*4;this.#cgl.gl.vertexAttribPointer(i[t],4,s.type,false,r,0);this.#cgl.gl.enableVertexAttribArray(i[t]+1);this.#cgl.gl.vertexAttribPointer(i[t]+1,4,s.type,false,r,4*4*1);this.#cgl.gl.enableVertexAttribArray(i[t]+2);this.#cgl.gl.vertexAttribPointer(i[t]+2,4,s.type,false,r,4*4*2);this.#cgl.gl.enableVertexAttribArray(i[t]+3);this.#cgl.gl.vertexAttribPointer(i[t]+3,4,s.type,false,r,4*4*3);this.#cgl.gl.vertexAttribDivisor(i[t],1);this.#cgl.gl.vertexAttribDivisor(i[t]+1,1);this.#cgl.gl.vertexAttribDivisor(i[t]+2,1);this.#cgl.gl.vertexAttribDivisor(i[t]+3,1)}else{this.#log.warn("unknown instance attrib size",s.name)}}else{if(!s.itemSize||s.itemSize==0)this.#log.warn("attrib itemsize error",this._name,s);this.#cgl.gl.vertexAttribPointer(i[t],s.itemSize,s.type,false,s.itemSize*4,0);if(s.pointer){for(let t=0;t<s.pointer.length;t++){const n=s.pointer[t];if(n.loc==-1){n.loc=this.#cgl.glGetAttribLocation(e.getProgram(),n.name)}if(n.loc>-1){this.#cgl.profileData.profileAttrLoc++;this.#cgl.gl.enableVertexAttribArray(n.loc);this.#cgl.gl.vertexAttribPointer(n.loc,s.itemSize,s.type,false,n.stride,n.offset)}}}if(this.bindFeedback)this.bindFeedback(s)}}}if(this.#bufVerticesIndizes&&this.#bufVerticesIndizes.numItems!==0)this.#cgl.gl.bindBuffer(this.#cgl.gl.ELEMENT_ARRAY_BUFFER,this.#bufVerticesIndizes)}unBind(){const t=this._lastShader;this._lastShader=null;if(!t)return;let e=[];if(this._attribLocs[t.id])e=this._attribLocs[t.id];else this._attribLocs[t.id]=e;I.lastMesh=null;for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].instanced){if(this._attributes[t].itemSize<=4){if(e[t]!=-1)this.#cgl.gl.vertexAttribDivisor(e[t],0);if(e[t]>=0)this.#cgl.gl.disableVertexAttribArray(e[t])}else{this.#cgl.gl.vertexAttribDivisor(e[t],0);this.#cgl.gl.vertexAttribDivisor(e[t]+1,0);this.#cgl.gl.vertexAttribDivisor(e[t]+2,0);this.#cgl.gl.vertexAttribDivisor(e[t]+3,0);this.#cgl.gl.disableVertexAttribArray(e[t]+1);this.#cgl.gl.disableVertexAttribArray(e[t]+2);this.#cgl.gl.disableVertexAttribArray(e[t]+3)}}if(e[t]!=-1)this.#cgl.gl.disableVertexAttribArray(e[t])}}meshChanged(){return this.#cgl.lastMesh&&this.#cgl.lastMesh!=this}printDebug(){console.log("--attributes");for(let t=0;t<this._attributes.length;t++){console.log("attribute "+t+" "+this._attributes[t].name)}}setNumVertices(t){this._bufVertexAttrib.numItems=t}getNumVertices(){return this._bufVertexAttrib.numItems}setNumIndices(t){this.#bufVerticesIndizes.numItems=t}getNumIndices(){return this.#bufVerticesIndizes.numItems}render(i){if(this.#cgl.aborted)return;i=i||this.#cgl.getShader();if(!i){for(let t=0;t<this.#cgl._shaderStack.length;t++){console.log(t+" "+this.#cgl._shaderStack[t].getName())}return console.log("shader not valid")}if(!i.isValid()){i=this.#cgl.getErrorShader()}this._checkAttrLengths();if(this.#geom){if(this._preWireframeGeom&&!i.wireframe&&!this.#geom.isIndexed()){this.setGeom(this._preWireframeGeom);this._preWireframeGeom=null}if(i.wireframe){let t=false;if(this.#geom.isIndexed()){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}this.#geom.unIndex();t=true}if(!this.#geom.getAttribute("attrBarycentric")){if(!this._preWireframeGeom){this._preWireframeGeom=this.#geom;this.#geom=this.#geom.copy()}t=true;this.#geom.calcBarycentric()}if(t)this.setGeom(this.#geom)}}let t=false;if(I.lastMesh!=this){if(I.lastMesh)I.lastMesh.unBind();t=true}if(t)this._preBind(i);if(!i.bind())return;this._bind(i);if(this.addVertexNumbers)this._setVertexNumbers();I.lastMesh=this;let e=this.#cgl.gl.TRIANGLES;if(this._glPrimitive!==null)e=this._glPrimitive;if(i.glPrimitive!==null)e=i.glPrimitive;let s=1;let r=this.#cgl.profileData.doProfileGlQuery;let n=false;if(r){let t=this._name+" - "+i.getName()+" #"+i.id;if(this._numInstances)t+=" instanced "+this._numInstances+"x";let e=this.#cgl.profileData.glQueryData[t];if(!e)e={id:t,num:0};if(i.opId)e.shaderOp=i.opId;if(this.opId)e.meshOp=this.opId;this.#cgl.profileData.glQueryData[t]=e;if(!this._queryExt&&this._queryExt!==false)this._queryExt=this.#cgl.enableExtension("EXT_disjoint_timer_query_webgl2")||false;if(this._queryExt){if(e._drawQuery){const a=this.#cgl.gl.getQueryParameter(e._drawQuery,this.#cgl.gl.QUERY_RESULT_AVAILABLE);if(a){const o=this.#cgl.gl.getQueryParameter(e._drawQuery,this.#cgl.gl.QUERY_RESULT);const h=o/1e6;e._times=e._times||0;e._times+=h;e._numcount++;e.when=performance.now();e._drawQuery=null;e.queryStarted=false}}if(!e.queryStarted){e._drawQuery=this.#cgl.gl.createQuery();this.#cgl.gl.beginQuery(this._queryExt.TIME_ELAPSED_EXT,e._drawQuery);n=e.queryStarted=true}}}if(this.hasFeedbacks&&this.hasFeedbacks())this.drawFeedbacks(i,e);else if(!this.#bufVerticesIndizes||this.#bufVerticesIndizes.numItems===0){if(e==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0)this.#cgl.gl.drawArrays(e,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems-this._bufVertexAttrib.startItem);else this.#cgl.gl.drawArraysInstanced(e,this._bufVertexAttrib.startItem,this._bufVertexAttrib.numItems,this._numInstances)}else{if(e==this.#cgl.gl.TRIANGLES)s=3;if(this._numInstances===0){this.#cgl.gl.drawElements(e,this.#bufVerticesIndizes.numItems,this.#indexType,0)}else{this.#cgl.gl.drawElementsInstanced(e,this.#bufVerticesIndizes.numItems,this.#indexType,0,this._numInstances)}}if(this.#cgl.debugOneFrame){if(this.#cgl.gl.getError()!=this.#cgl.gl.NO_ERROR){this.#log.error("mesh draw gl error");this.#log.error("mesh",this);this.#log.error("shader",i);const l=[];for(let t=0;t<this.#cgl.gl.getProgramParameter(i.getProgram(),this.#cgl.gl.ACTIVE_ATTRIBUTES);t++){const u=this.#cgl.gl.getActiveAttrib(i.getProgram(),t).name;this.#log.error("attrib ",u)}}}this.#cgl.profileData.count("glprimitives",this._bufVertexAttrib.numItems/s*(this._numInstances||1));this.#cgl.profileData.count("meshDrawCalls");if(r&&n){this.#cgl.gl.endQuery(this._queryExt.TIME_ELAPSED_EXT)}this.#cgl.printError("mesh render "+this._name);this.unBind()}setNumInstances(e){e=Math.max(0,e);if(this._numInstances!=e){this._numInstances=e;const i=new Float32Array(e);for(let t=0;t<e;t++)i[t]=t;this.setAttribute(d.SHADER.SHADERVAR_INSTANCE_INDEX,i,1,{instanced:true})}}_disposeAttributes(){if(!this._attributes)return;for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].buffer){this.#cgl.gl.deleteBuffer(this._attributes[t].buffer);this._attributes[t].buffer=null}}this._attributes.length=0}dispose(){if(this.#cgl.aborted)return;if(this._bufVertexAttrib&&this._bufVertexAttrib.buffer)this.#cgl.gl.deleteBuffer(this._bufVertexAttrib.buffer);if(this.#bufVerticesIndizes)this.#cgl.gl.deleteBuffer(this.#bufVerticesIndizes);this.#bufVerticesIndizes=null;this._disposeAttributes();return null}}const E={};E.getSimpleRect=function(t,e,i=1){const s=new c(e);s.vertices=[1*i,1*i,0,-1*i,1*i,0,1*i,-1*i,0,-1*i,-1*i,0];s.texCoords=[1,1,0,1,1,0,0,0];s.verticesIndices=[0,1,2,2,1,3];s.vertexNormals=[0,0,0,0,0,0,0,0,0,0,0,0];return t.createMesh(s)};E.getSimpleCube=function(t,e){const i=new c(e);i.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];i.setTexCoords([0,1,1,1,1,0,0,0,1,1,1,0,0,0,0,1,0,0,0,1,1,1,1,0,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,0,0,0]);i.verticesIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];i.vertexNormals=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]);i.tangents=new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1]);i.biTangents=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1]);return new m(t,i)};class v{constructor(t,e){this._cgl=t;this._log=new u.Logger("cgl_TextureEffect");if(!t.TextureEffectMesh)this.createMesh();this._textureSource=null;this._options=e;this.name=e.name||"unknown";this.imgCompVer=0;this.aspectRatio=1;this._textureTarget=null;this._frameBuf=this._cgl.gl.createFramebuffer();this._frameBuf2=this._cgl.gl.createFramebuffer();this._renderbuffer=this._cgl.gl.createRenderbuffer();this._renderbuffer2=this._cgl.gl.createRenderbuffer();this.switched=false;this.depth=false}dispose(){if(this._renderbuffer)this._cgl.gl.deleteRenderbuffer(this._renderbuffer);if(this._frameBuf)this._cgl.gl.deleteFramebuffer(this._frameBuf);if(this._renderbuffer2)this._cgl.gl.deleteRenderbuffer(this._renderbuffer2);if(this._frameBuf2)this._cgl.gl.deleteFramebuffer(this._frameBuf2)}getWidth(){return this._textureSource.width}getHeight(){return this._textureSource.height}setSourceTexture(t){if(t===null){this._textureSource=new T(this._cgl);this._textureSource.setSize(16,16)}else{this._textureSource=t}if(!this._textureSource.compareSettings(this._textureTarget)){if(this._textureTarget)this._textureTarget.delete();this._textureTarget=this._textureSource.clone();this._cgl.profileData.profileEffectBuffercreate++;this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureTarget.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._renderbuffer2);if(this.depth)this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,this._cgl.gl.DEPTH_COMPONENT16,this._textureSource.width,this._textureSource.height);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._textureSource.tex,0);if(this.depth)this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._renderbuffer2);this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}this.aspectRatio=this._textureSource.width/this._textureSource.height}continueEffect(){this._cgl.pushDepthTest(false);this._cgl.pushModelMatrix();this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this.getCurrentTargetTexture().width,this.getCurrentTargetTexture().height);mat4.perspective(this._cgl.pMatrix,45,this.getCurrentTargetTexture().width/this.getCurrentTargetTexture().height,.1,1100);this._cgl.pushPMatrix();mat4.identity(this._cgl.pMatrix);this._cgl.pushViewMatrix();mat4.identity(this._cgl.vMatrix);this._cgl.pushModelMatrix();mat4.identity(this._cgl.mMatrix)}startEffect(t){if(!this._textureTarget){this._log.warn("effect has no target");return}this.switched=false;this.continueEffect();if(t){this._bgTex=t}this._countEffects=0}endEffect(){this._cgl.popDepthTest();this._cgl.popModelMatrix();this._cgl.popPMatrix();this._cgl.popModelMatrix();this._cgl.popViewMatrix();this._cgl.popPMatrix();this._cgl.popViewPort()}bind(){if(this._textureSource===null){this._log.warn("no base texture set!");return}if(!this.switched){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf);this._cgl.pushGlFrameBuffer(this._frameBuf)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuf2);this._cgl.pushGlFrameBuffer(this._frameBuf2)}}finish(){if(this._textureSource===null){this._log.warn("no base texture set!");return}this._cgl.TextureEffectMesh.render(this._cgl.getShader());this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.profileData.count("textureEffect");if(this._textureTarget.filter==T.FILTER_MIPMAP){if(!this.switched){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureTarget.tex);this._textureTarget.updateMipMap()}else{this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._textureSource.tex);this._textureSource.updateMipMap()}this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}this.switched=!this.switched;this._countEffects++}getCurrentTargetTexture(){if(this.switched)return this._textureSource;return this._textureTarget}getCurrentSourceTexture(){if(this._countEffects==0&&this._bgTex)return this._bgTex;if(this.switched)return this._textureTarget;return this._textureSource}delete(){if(this._textureTarget)this._textureTarget.delete();if(this._textureSource)this._textureSource.delete();this._cgl.gl.deleteRenderbuffer(this._renderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuf)}createMesh(){this._cgl.TextureEffectMesh=E.getSimpleRect(this._cgl,"texEffectRect")}}v.checkOpNotInTextureEffect=function(t){if(!t.patch.cgl)return true;if(t.uiAttribs.error&&!t.patch.cgl.currentTextureEffect){t.setUiError("textureeffect",null);return true}if(!t.patch.cgl.currentTextureEffect)return true;if(t.patch.cgl.currentTextureEffect&&!t.uiAttribs.error){t.setUiError("textureeffect","This op can not be a child of a ImageCompose/texture effect! imagecompose should only have textureeffect childs.",0);return false}if(t.patch.cgl.currentTextureEffect)return false;return true};v.checkOpInEffect=function(t,e){e=e||0;if(t.patch.cgl.currentTextureEffect){if(t.uiAttribs.uierrors&&t.patch.cgl.currentTextureEffect.imgCompVer>=e){t.setUiError("texeffect",null);return true}if(e&&t.patch.cgl.currentTextureEffect.imgCompVer<e){t.setUiError("texeffect","This op must be a child of an ImageCompose op with version >="+e+' <span class="button-small" onclick="gui.patchView.downGradeOp(\''+t.id+"','"+t.name+"')\">Downgrade</span> to previous version",1)}}if(t.patch.cgl.currentTextureEffect)return true;if(!t.patch.cgl.currentTextureEffect&&(!t.uiAttribs.uierrors||t.uiAttribs.uierrors.length==0)){t.setUiError("texeffect",'This op must be a child of an ImageCompose op! More infos <a href="https://cables.gl/docs/image_composition/image_composition.html" target="_blank">here</a>. ',1);return false}if(!t.patch.cgl.currentTextureEffect)return false;return true};v.getBlendCode=function(t){let e="".endl()+"vec3 _blend(vec3 base,vec3 blend)".endl()+"{".endl()+"   vec3 colNew=blend;".endl()+"   #ifdef BM_MULTIPLY".endl()+"       colNew=base*blend;".endl()+"   #endif".endl()+"   #ifdef BM_MULTIPLY_INV".endl()+"       colNew=base* vec3(1.0)-blend;".endl()+"   #endif".endl()+"   #ifdef BM_AVERAGE".endl()+"       colNew=((base + blend) / 2.0);".endl()+"   #endif".endl()+"   #ifdef BM_ADD".endl()+"       colNew=min(base + blend, vec3(1.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT_ONE".endl()+"       colNew=max(base + blend - vec3(1.0), vec3(0.0));".endl()+"   #endif".endl()+"   #ifdef BM_SUBTRACT".endl()+"       colNew=base - blend;".endl()+"   #endif".endl()+"   #ifdef BM_DIFFERENCE".endl()+"       colNew=abs(base - blend);".endl()+"   #endif".endl()+"   #ifdef BM_NEGATION".endl()+"       colNew=(vec3(1.0) - abs(vec3(1.0) - base - blend));".endl()+"   #endif".endl()+"   #ifdef BM_EXCLUSION".endl()+"       colNew=(base + blend - 2.0 * base * blend);".endl()+"   #endif".endl()+"   #ifdef BM_LIGHTEN".endl()+"       colNew=max(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_DARKEN".endl()+"       colNew=min(blend, base);".endl()+"   #endif".endl()+"   #ifdef BM_OVERLAY".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SCREEN".endl()+"      #define BlendScreenf(base, blend)       (1.0 - ((1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendScreenf(base.r, blend.r),BlendScreenf(base.g, blend.g),BlendScreenf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_SOFTLIGHT".endl()+"      #define BlendSoftLightf(base, blend)    ((blend < 0.5) ? (2.0 * base * blend + base * base * (1.0 - 2.0 * blend)) : (sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend)))".endl()+"      colNew=vec3(BlendSoftLightf(base.r, blend.r),BlendSoftLightf(base.g, blend.g),BlendSoftLightf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_HARDLIGHT".endl()+"      #define BlendOverlayf(base, blend)  (base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))".endl()+"      colNew=vec3(BlendOverlayf(base.r, blend.r),BlendOverlayf(base.g, blend.g),BlendOverlayf(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORDODGE".endl()+"      #define BlendColorDodgef(base, blend)   ((blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0))".endl()+"      colNew=vec3(BlendColorDodgef(base.r, blend.r),BlendColorDodgef(base.g, blend.g),BlendColorDodgef(base.b, blend.b));".endl()+"   #endif".endl()+"   #ifdef BM_COLORBURN".endl()+"      #define BlendColorBurnf(base, blend)    ((blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0))".endl()+"      colNew=vec3(BlendColorBurnf(base.r, blend.r),BlendColorBurnf(base.g, blend.g),BlendColorBurnf(base.b, blend.b));".endl()+"   #endif".endl()+"   return colNew;".endl()+"}".endl();if(!t)e+="vec4 cgl_blend(vec4 oldColor,vec4 newColor,float amount)".endl()+"{".endl()+"vec4 col=vec4( _blend(oldColor.rgb,newColor.rgb) ,1.0);".endl()+"col=vec4( mix( col.rgb, oldColor.rgb ,1.0-oldColor.a*amount),1.0);".endl()+"return col;".endl()+"}".endl();if(t>=3)e+="vec4 cgl_blendPixel(vec4 base,vec4 col,float amount)".endl()+"{".endl()+"#ifdef BM_MATH_ADD".endl()+"   return vec4(base.rgb+col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_SUB".endl()+"   return vec4(base.rgb-col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_MUL".endl()+"   return vec4(base.rgb*col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifdef BM_MATH_DIV".endl()+"   return vec4(base.rgb/col.rgb*amount,1.0);".endl()+"#endif".endl()+"#ifndef BM_MATH".endl()+"vec3 colNew=_blend(base.rgb,col.rgb);".endl()+"float newA=clamp(base.a+(col.a*amount),0.,1.);".endl()+"#ifdef BM_ALPHAMASKED".endl()+"newA=base.a;".endl()+"#endif".endl()+"return vec4(".endl()+"mix(colNew,base.rgb,1.0-(amount*col.a)),".endl()+"newA);".endl()+"#endif".endl()+"}".endl();return e};v.onChangeBlendSelect=function(t,e,i=false){e=String(e);t.toggleDefine("BM_NORMAL",e=="normal");t.toggleDefine("BM_MULTIPLY",e=="multiply");t.toggleDefine("BM_MULTIPLY_INV",e=="multiply invert");t.toggleDefine("BM_AVERAGE",e=="average");t.toggleDefine("BM_ADD",e=="add");t.toggleDefine("BM_SUBTRACT_ONE",e=="subtract one");t.toggleDefine("BM_SUBTRACT",e=="subtract");t.toggleDefine("BM_DIFFERENCE",e=="difference");t.toggleDefine("BM_NEGATION",e=="negation");t.toggleDefine("BM_EXCLUSION",e=="exclusion");t.toggleDefine("BM_LIGHTEN",e=="lighten");t.toggleDefine("BM_DARKEN",e=="darken");t.toggleDefine("BM_OVERLAY",e=="overlay");t.toggleDefine("BM_SCREEN",e=="screen");t.toggleDefine("BM_SOFTLIGHT",e=="softlight");t.toggleDefine("BM_HARDLIGHT",e=="hardlight");t.toggleDefine("BM_COLORDODGE",e=="color dodge");t.toggleDefine("BM_COLORBURN",e=="color burn");t.toggleDefine("BM_MATH_ADD",e=="Math Add");t.toggleDefine("BM_MATH_SUB",e=="Math Subtract");t.toggleDefine("BM_MATH_MUL",e=="Math Multiply");t.toggleDefine("BM_MATH_DIV",e=="Math Divide");t.toggleDefine("BM_MATH",e.indexOf("Math ")==0);t.toggleDefine("BM_ALPHAMASKED",i)};v.AddBlendSelect=function(t,e,i){const s=t.inValueSelect(e||"Blend Mode",["normal","lighten","darken","multiply","multiply invert","average","add","subtract","difference","negation","exclusion","overlay","screen","color dodge","color burn","softlight","hardlight","subtract one","Math Add","Math Subtract","Math Multiply","Math Divide"],i||"normal");return s};v.AddBlendAlphaMask=function(t,e,i){const s=t.inSwitch(e||"Alpha Mask",["Off","On"],i||"Off");return s};v.setupBlending=function(i,s,r,t,n){const e=()=>{let t=false;if(n)t=n.get()=="On";v.onChangeBlendSelect(s,r.get(),t);let e=r.get();if(e=="normal")e=null;else if(e=="multiply")e="mul";else if(e=="multiply invert")e="mulinv";else if(e=="lighten")e="light";else if(e=="darken")e="darken";else if(e=="average")e="avg";else if(e=="subtract one")e="sub one";else if(e=="subtract")e="sub";else if(e=="difference")e="diff";else if(e=="negation")e="neg";else if(e=="exclusion")e="exc";else if(e=="overlay")e="ovl";else if(e=="color dodge")e="dodge";else if(e=="color burn")e="burn";else if(e=="softlight")e="soft";else if(e=="hardlight")e="hard";else if(e=="Math Add")e="+";else if(e=="Math Subtract")e="-";else if(e=="Math Multiply")e="*";else if(e=="Math Divide")e="/";i.setUiAttrib({extendTitle:e})};i.setPortGroup("Blending",[r,t,n]);let a=false;r.onChange=e;if(n){n.onChange=e;a=n.get()=="On"}v.onChangeBlendSelect(s,r.get(),a)};const fa={"CGL.BLENDMODES":function(){this.name="blendmodes";this.srcHeadFrag=v.getBlendCode()},"CGL.BLENDMODES3":function(){this.name="blendmodes3";this.srcHeadFrag=v.getBlendCode(3)},"CGL.LUMINANCE":function(){this.name="luminance";this.srcHeadFrag="".endl()+"float cgl_luminance(vec3 c)".endl()+"{".endl()+"    return dot(vec3(0.2126,0.7152,0.0722),c);".endl()+"}".endl()},"CGL.RANDOM_OLD":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 432758.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_LOW":function(){this.name="randomNumber";this.srcHeadFrag="".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return fract(sin(dot(co.xy ,vec2(12.9898,4.1414))) * 358.5453);".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return vec3( cgl_random(co),cgl_random(co+0.5711),cgl_random(co+1.5711));".endl()+"}"},"CGL.RANDOM_TEX":function(){this.name="randomNumbertex";this.srcHeadFrag="".endl()+"UNI sampler2D CGLRNDTEX;".endl()+"float cgl_random(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).r;".endl()+"}".endl()+"vec3 cgl_random3(vec2 co)".endl()+"{".endl()+"    return texture(CGLRNDTEX,co*5711.0).rgb;".endl()+"}";this.initUniforms=function(t){return[new _(t,"t","CGLRNDTEX",7)]};this.onBind=function(t,e){T.getRandomTexture(t);t.setTexture(7,T.getRandomTexture(t).tex)}}};const ga="{{MODULES_HEAD}}\nIN vec3 vPosition; //!@\nIN vec2 attrTexCoord;\nIN vec3 attrVertNormal;\nIN vec3 attrTangent,attrBiTangent;\n\nIN float attrVertIndex;\n\nOUT vec2 texCoord;\nOUT vec3 norm;\nUNI mat4 projMatrix;\nUNI mat4 viewMatrix;\nUNI mat4 modelMatrix;\n\nvoid main()\n{\n    texCoord=attrTexCoord;\n    norm=attrVertNormal;\n    vec4 pos=vec4(vPosition,  1.0);\n    vec3 tangent=attrTangent;\n    vec3 bitangent=attrBiTangent;\n    mat4 mMatrix=modelMatrix;\n    gl_PointSize=10.0;\n\n    {{MODULE_VERTEX_POSITION}}\n\n    mat4 modelViewMatrix=viewMatrix*mMatrix;\n    {{MODULE_VERTEX_MODELVIEW}}\n\n    gl_Position = projMatrix * modelViewMatrix * pos;\n}\n";let da=0;function P(){return ga}function M(t,e,i){if(t==undefined){t=.5;e=.5;i=.5}return""+x+"IN vec2 texCoord;"+x+"{{MODULES_HEAD}}"+x+"void main()"+x+"{"+x+"    vec4 col=vec4("+t+","+e+","+i+",1.0);"+x+"    {{MODULE_COLOR}}"+x+"    outColor = col;"+x+"}"}class b extends sa{_uniforms=[];materialPropUniforms={};constructor(t,e,i){super();if(!t)throw new Error("shader constructed without cgl "+e);this._log=new u.Logger("cgl_shader");this._cgl=t;if(!e)this._log.stack("no shader name given");this._name=e||"unknown";if(i)this.opId=i.id;this.glslVersion=0;if(t.glVersion>1)this.glslVersion=300;this._materialId=++da;this._program=null;this._drawBuffers=[true];this.error=null;this.ignoreMissingUniforms=false;this._projMatrixUniform=null;this._mvMatrixUniform=null;this._mMatrixUniform=null;this._vMatrixUniform=null;this._camPosUniform=null;this._normalMatrixUniform=null;this._inverseViewMatrixUniform=null;this._fromUserInteraction=false;this._attrVertexPos=-1;this.precision=t.patch.config.glslPrecision||"highp";this._pMatrixState=-1;this._vMatrixState=-1;this._countMissingUniforms=0;this._modGroupCount=0;this._feedBackNames=[];this._attributes=[];this.glPrimitive=null;this.offScreenPass=false;this._extensions=[];this.srcVert=P();this.srcFrag=M();this.lastCompile=0;this._libs=[];this._structNames=[];this._structUniformNames=[];this._textureStackUni=[];this._textureStackTex=[];this._textureStackType=[];this._textureStackTexCgl=[];this._tempNormalMatrix=s();this._tempCamPosMatrix=s();this._tempInverseViewMatrix=s();this._tempInverseProjMatrix=s();this.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_NORMAL","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"])}isValid(){return this._isValid}getCgl(){return this._cgl}getName(){return this._name}enableExtension(t){this.setWhyCompile("enable extension "+t);this._extensions.push(t)}getAttrVertexPos(){return this._attrVertexPos}hasTextureUniforms(){for(let t=0;t<this._uniforms.length;t++)if(this._uniforms[t].getType()=="t")return true;return false}copyUniformValues(e){for(let t=0;t<e._uniforms.length;t++){if(!this._uniforms[t]){this._log.log("unknown uniform?!");continue}this.getUniform(e._uniforms[t].getName()).set(e._uniforms[t].getValue())}this.popTextures();for(let t=0;t<e._textureStackUni.length;t++){this._textureStackUni[t]=e._textureStackUni[t];this._textureStackTex[t]=e._textureStackTex[t];this._textureStackType[t]=e._textureStackType[t];this._textureStackTexCgl[t]=e._textureStackTexCgl[t]}}copy(){const e=new b(this._cgl,this._name+" copy");e.setSource(this.srcVert,this.srcFrag);e._modules=JSON.parse(JSON.stringify(this._modules));e._defines=JSON.parse(JSON.stringify(this._defines));e._modGroupCount=this._modGroupCount;e._moduleNames=this._moduleNames;e.glPrimitive=this.glPrimitive;e.offScreenPass=this.offScreenPass;e._extensions=this._extensions;e.wireframe=this.wireframe;e._attributes=this._attributes;for(let t=0;t<this._uniforms.length;t++){const i=this._uniforms[t].copy(e);i.resetLoc()}if(this.materialPropUniforms)for(const t in this.materialPropUniforms){if(!this.materialPropUniforms[t]||!this.materialPropUniforms[t].copy)console.log("no matprop",this.materialPropUniforms[t]);else e.materialPropUniforms[t]=this.materialPropUniforms[t].copy(e)}e.setWhyCompile("copy");return e}setSource(t,e,i=false){this._fromUserInteraction=i;this.srcVert=t;this.srcFrag=e;this.setWhyCompile("Source changed");this._isValid=true}_addLibs(t){for(const e in fa){if(t.includes(e)){const i=new fa[e];t=t.replace("{{"+e+"}}",i.srcHeadFrag);this._libs.push(i);if(i.initUniforms)i.initUniforms(this)}}return t}createStructUniforms(){let s="";let r="";this._structNames=[];this._injectedStringsFrag={};this._injectedStringsVert={};this._structUniformNamesIndicesFrag=[];this._structUniformNamesIndicesVert=[];for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].isStructMember()){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[i]._structName+"}}";if(!this._structNames.includes(this._uniforms[i]._structName)){const a="struct "+this._uniforms[i]._structName+" {"+x+n+"};"+x+x;if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="frag")s=s.concat(a);if(this._uniforms[i].getShaderType()==="both"||this._uniforms[i].getShaderType()==="vert")r=r.concat(a);this._structNames.push(this._uniforms[i]._structName);this._injectedStringsFrag[this._uniforms[i]._structName]=[];this._injectedStringsVert[this._uniforms[i]._structName]=[]}let t="";if(this._uniforms[i].comment)t=" // "+this._uniforms[i].comment;let e="";if(this._uniforms[i].getGlslTypeString()==undefined)e+="//";e+="  "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i]._propertyName+";"+t;if(this._uniforms[i].getShaderType()==="both"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(e)&&!this._injectedStringsVert[this._uniforms[i]._structName].includes(e)){const o=s.lastIndexOf(n);const h=r.lastIndexOf(n);s=s.slice(0,o)+e+s.slice(o-1);r=r.slice(0,h)+e+r.slice(h-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(e);this._injectedStringsVert[this._uniforms[i]._structName].push(e)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i);if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}else if(this._uniforms[i].getShaderType()==="frag"){if(!this._injectedStringsFrag[this._uniforms[i]._structName].includes(e)){const o=s.lastIndexOf(n);s=s.slice(0,o)+e+s.slice(o-1);this._injectedStringsFrag[this._uniforms[i]._structName].push(e)}if(!this._structUniformNamesIndicesFrag.includes(i))this._structUniformNamesIndicesFrag.push(i)}else if(this._uniforms[i].getShaderType()==="vert"){if(!this._injectedStringsVert[this._uniforms[i]._structName].includes(e)){const h=r.lastIndexOf(n);r=r.slice(0,h)+e+r.slice(h-1);this._injectedStringsVert[this._uniforms[i]._structName].push(e)}if(!this._structUniformNamesIndicesVert.includes(i))this._structUniformNamesIndicesVert.push(i)}}}this._uniDeclarationsFrag=[];this._uniDeclarationsVert=[];for(let t=0;t<this._structUniformNamesIndicesFrag.length;t+=1){const e=this._structUniformNamesIndicesFrag[t];const i="UNI "+this._uniforms[e]._structName+" "+this._uniforms[e]._structUniformName+";"+x;if(!this._uniDeclarationsFrag.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[e]._structName+"}}";s=s.replace(n,"");s+=i;this._uniDeclarationsFrag.push(i)}}for(let t=0;t<this._structUniformNamesIndicesVert.length;t+=1){const e=this._structUniformNamesIndicesVert[t];const i="UNI "+this._uniforms[e]._structName+" "+this._uniforms[e]._structUniformName+";"+x;if(!this._uniDeclarationsVert.includes(i)){const n="{{INJECTION_POINT_STRUCT_"+this._uniforms[e]._structName+"}}";r=r.replace(n,"");r+=i;this._uniDeclarationsVert.push(i)}}return[r,s]}_getAttrSrc(t,e){const i={};if(t.name&&t.type){i.srcHeadVert="";if(!e)i.srcHeadVert+="#ifndef ATTRIB_"+t.name+x;i.srcHeadVert+="#define ATTRIB_"+t.name+x;i.srcHeadVert+="IN "+t.type+" "+t.name+";"+x;if(!e)i.srcHeadVert+="#endif"+x;if(t.nameFrag){i.srcHeadVert+="";if(!e)i.srcHeadVert+="#ifndef ATTRIB_"+t.nameFrag+x;i.srcHeadVert+="#define ATTRIB_"+t.nameFrag+x;i.srcHeadVert+="OUT "+t.type+" "+t.nameFrag+";"+x;if(!e)i.srcHeadVert+="#endif"+x;i.srcVert=""+x+t.nameFrag+"="+t.name+";";i.srcHeadFrag="";if(!e)i.srcHeadFrag+="#ifndef ATTRIB_"+t.nameFrag+x;i.srcHeadFrag+="#define ATTRIB_"+t.nameFrag+x;i.srcHeadFrag+="IN "+t.type+" "+t.nameFrag+";"+x;if(!e)i.srcHeadFrag+="#endif"+x}}return i}compile(){if(this._cgl.aborted)return;const t=performance.now();this._cgl.profileData.count("shaderCompile");this._cgl.profileData.profileShaderCompileName=this._name+" ["+this._compileReason+"]";let e="";if(this._extensions)for(let t=0;t<this._extensions.length;t++)e+="#extension "+this._extensions[t]+" : enable"+x;let i="";if(this._defines.length)i="\n// cgl generated"+x;for(let t=0;t<this._defines.length;t++)i+="#define "+this._defines[t][0]+" "+this._defines[t][1]+""+x;const s=this.createStructUniforms();this._cgl.profileData.addHeavyEvent("shader compile",this._name+" ["+this._compileReason+"]");this._compileReason="";if(this._uniforms){const m=this._uniforms.map(t=>{return t._name});const p=[];for(let t=0;t<this._uniforms.length;t++){const E=this._uniforms[t];const v=m.indexOf(E._name,t+1);if(v>-1)p.push(t)}for(let t=this._uniforms.length-1;t>=0;t-=1){if(p.includes(t))this._uniforms.splice(t,1);else this._uniforms[t].resetLoc()}}this._cgl.printError("uniform resets");this._compileCount++;if(this.hasTextureUniforms())i+="#define HAS_TEXTURES"+x;let r="";let n="";if(!this.srcFrag){this._log.warn("[cgl shader] has no fragment source!",this._name,this);this.srcVert=P();this.srcFrag=M()}r="#version 300 es"+x+"// "+x+"// vertex shader "+this._name+x+"// "+x+"precision "+this.precision+" float;"+x+"precision "+this.precision+" sampler2D;"+x+""+x+"#define WEBGL2"+x+"#define texture2D texture"+x+"#define UNI uniform"+x+"#define IN in"+x+"#define OUT out"+x;n="#version 300 es"+x+"// "+x+"// fragment shader "+this._name+x+"// "+x+"precision "+this.precision+" float;"+x+"precision "+this.precision+" sampler2D;"+x+""+x+"#define WEBGL2"+x+"#define texture2D texture"+x+"#define IN in"+x+"#define OUT out"+x+"#define UNI uniform"+x+"{{DRAWBUFFER}}"+x;let a="\n// cgl generated"+x;let o="\n// cgl generated"+x;n+="\n// active mods: --------------- ";r+="\n// active mods: --------------- ";let h=false;let l=false;for(let e=0;e<this._moduleNames.length;e++){for(let t=0;t<this._modules.length;t++){if(this._modules[t].name==this._moduleNames[e]){if(this._modules[t].srcBodyFrag||this._modules[t].srcHeadFrag){h=true;n+="\n// "+e+"."+t+". "+this._modules[t].title+" ("+this._modules[t].name+")"}if(this._modules[t].srcBodyVert||this._modules[t].srcHeadVert){r+="\n// "+e+"."+t+". "+this._modules[t].title+" ("+this._modules[t].name+")";l=true}}}}if(!l)n+="\n// no mods used...";if(!h)n+="\n// no mods used...";n+="\n";r+="\n";for(let i=0;i<this._uniforms.length;i++){if(this._uniforms[i].shaderType&&!this._uniforms[i].isStructMember()){let t="";if(!this._uniforms[i].getGlslTypeString())t+="// ";t+="UNI "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName();let e="";if(this._uniforms[i].comment)e=" // "+this._uniforms[i].comment;if(this._uniforms[i].shaderType=="vert"||this._uniforms[i].shaderType=="both")if(!this.srcVert.includes(t)&&!this.srcVert.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))a+=t+";"+e+x;if(this._uniforms[i].shaderType=="frag"||this._uniforms[i].shaderType=="both")if(!this.srcFrag.includes(t)&&!this.srcFrag.includes("uniform "+this._uniforms[i].getGlslTypeString()+" "+this._uniforms[i].getName()))o+=t+";"+e+x}}let u=0;let c=0;for(let t=0;t<this._uniforms.length;t++){if(this._uniforms[t].shaderType&&!this._uniforms[t].isStructMember()){if(this._uniforms[t].shaderType=="vert"||this._uniforms[t].shaderType=="both")c++;if(this._uniforms[t].shaderType=="frag"||this._uniforms[t].shaderType=="both")u++}}if(u>=this._cgl.maxUniformsFrag)this._log.warn("[cgl_shader] num uniforms frag: "+u+" / "+this._cgl.maxUniformsFrag);if(c>=this._cgl.maxUniformsVert)this._log.warn("[cgl_shader] num uniforms vert: "+c+" / "+this._cgl.maxUniformsVert);if(!n.includes("precision"))n="precision "+this.precision+" float;"+x+n;if(!r.includes("precision"))r="precision "+this.precision+" float;"+x+r;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){n+="#define MOBILE"+x;r+="#define MOBILE"+x}r=e+r+i+s[0]+a+"\n// -- \n"+this.srcVert;n=e+n+i+s[1]+o+"\n// -- \n"+this.srcFrag;let f="";let g="";this._modules.sort(function(t,e){return t.priority||0-e.priority||0});let d=false;for(let s=0;s<this._moduleNames.length;s++){let e="";let i="";if(!d){d=true;for(let t=0;t<this._attributes.length;t++){const b=this._getAttrSrc(this._attributes[t],true);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)e+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}}for(let t=0;t<this._modules.length;t++){const T=this._modules[t];if(T.name==this._moduleNames[s]){f+="\n//---- MOD: group:"+T.group+": idx:"+t+" - prfx:"+T.prefix+" - "+T.title+" ------\n";g+="\n//---- MOD: group:"+T.group+": idx:"+t+" - prfx:"+T.prefix+" - "+T.title+" ------\n";e+="\n\n//---- MOD: "+T.title+" / "+T.priority+" ------\n";i+="\n\n//---- MOD: "+T.title+" / "+T.priority+" ------\n";if(T.attributes)for(let t=0;t<T.attributes.length;t++){const b=this._getAttrSrc(T.attributes[t],false);if(b.srcHeadVert)f+=b.srcHeadVert;if(b.srcVert)e+=b.srcVert;if(b.srcHeadFrag)g+=b.srcHeadFrag}f+=T.srcHeadVert||"";g+=T.srcHeadFrag||"";e+=T.srcBodyVert||"";i+=T.srcBodyFrag||"";f+="\n//---- end mod ------\n";g+="\n//---- end mod ------\n";e+="\n//---- end mod ------\n";i+="\n//---- end mod ------\n";e=e.replace(/{{mod}}/g,T.prefix);i=i.replace(/{{mod}}/g,T.prefix);f=f.replace(/{{mod}}/g,T.prefix);g=g.replace(/{{mod}}/g,T.prefix);e=e.replace(/MOD_/g,T.prefix);i=i.replace(/MOD_/g,T.prefix);f=f.replace(/MOD_/g,T.prefix);g=g.replace(/MOD_/g,T.prefix)}}r=r.replace("{{"+this._moduleNames[s]+"}}",e);n=n.replace("{{"+this._moduleNames[s]+"}}",i)}r=r.replace("{{MODULES_HEAD}}",f);n=n.replace("{{MODULES_HEAD}}",g);r=this._addLibs(r);n=this._addLibs(n);let _="";for(let t=0;t<16;t++)if(n.includes("outColor"+t))this._drawBuffers[t]=true;if(this._drawBuffers.length==1){_="out vec4 outColor;"+x;_+="#define gl_FragColor outColor"+x}else{_+="#define MULTI_COLORTARGETS"+x;_+="vec4 outColor;"+x;let e=0;for(let t=0;t<this._drawBuffers.length;t++){if(e==0)_+="#define gl_FragColor outColor"+t+""+x;_+="layout(location = "+t+") out vec4 outColor"+t+";"+x;e++}}n=n.replace("{{DRAWBUFFER}}",_);if(!this._program){this._program=this._createProgram(r,n)}else{this._program=this._createProgram(r,n);this._projMatrixUniform=null;for(let t=0;t<this._uniforms.length;t++)this._uniforms[t].resetLoc()}this.finalShaderFrag=n;this.finalShaderVert=r;I.lastMesh=null;I.lastShader=null;this._countMissingUniforms=0;this._needsRecompile=false;this.lastCompile=(0,A.now)();this._cgl.profileData.shaderCompileTime+=performance.now()-t}bind(){if(!this._isValid||this._cgl.aborted)return;I.lastShader=this;if(!this._program||this.needsRecompile())this.compile();if(!this._isValid)return;if(!this._projMatrixUniform&&!this.ignoreMissingUniforms){this._countMissingUniforms++;if(this._countMissingUniforms<10){this._projMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_PROJMAT);this._attrVertexPos=this._cgl.glGetAttribLocation(this._program,d.SHADER.SHADERVAR_VERTEX_POSITION);this._mvMatrixUniform=this._cgl.gl.getUniformLocation(this._program,"mvMatrix");this._vMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_VIEWMAT);this._mMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_MODELMAT);this._camPosUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_VIEWPOS);this._normalMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_NORMALMAT);this._inverseViewMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_INVVIEWMAT);this._inverseProjMatrixUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_INVPROJMAT);this._materialIdUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_MATERIALID);this._objectIdUniform=this._cgl.gl.getUniformLocation(this._program,d.SHADER.SHADERVAR_UNI_OBJECTID);for(let t=0;t<this._uniforms.length;t++)this._uniforms[t].needsUpdate=true}}if(this._cgl.currentProgram!=this._program){this._cgl.profileData.count("shaderBinds");this._cgl.gl.useProgram(this._program);this._cgl.currentProgram=this._program}for(let t=0;t<this._uniforms.length;t++)if(this._uniforms[t].needsUpdate)this._uniforms[t].updateValue();if(this._pMatrixState!=this._cgl.getProjectionMatrixStateCount()){this._pMatrixState=this._cgl.getProjectionMatrixStateCount();this._cgl.gl.uniformMatrix4fv(this._projMatrixUniform,false,this._cgl.pMatrix);this._cgl.profileData.count("mvpMatrixCount")}if(this._objectIdUniform)this._cgl.gl.uniform1f(this._objectIdUniform,++this._cgl.tempData.objectIdCounter);if(this._materialIdUniform)this._cgl.gl.uniform1f(this._materialIdUniform,this._materialId);if(this._vMatrixUniform){if(this._vMatrixState!=this._cgl.getViewMatrixStateCount()){this._cgl.gl.uniformMatrix4fv(this._vMatrixUniform,false,this._cgl.vMatrix);this._cgl.profileData.count("mvpMatrixCount");this._vMatrixState=this._cgl.getViewMatrixStateCount();if(this._inverseViewMatrixUniform){e(this._tempInverseViewMatrix,this._cgl.vMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseViewMatrixUniform,false,this._tempInverseViewMatrix);this._cgl.profileData.count("mvpMatrixCount")}if(this._inverseProjMatrixUniform){e(this._tempInverseProjMatrix,this._cgl.pMatrix);this._cgl.gl.uniformMatrix4fv(this._inverseProjMatrixUniform,false,this._tempInverseProjMatrix);this._cgl.profileData.count("mvpMatrixCount")}}this._cgl.gl.uniformMatrix4fv(this._mMatrixUniform,false,this._cgl.mMatrix);this._cgl.profileData.count("mvpMatrixCount");if(this._camPosUniform){e(this._tempCamPosMatrix,this._cgl.vMatrix);this._cgl.gl.uniform3f(this._camPosUniform,this._tempCamPosMatrix[12],this._tempCamPosMatrix[13],this._tempCamPosMatrix[14]);this._cgl.profileData.count("mvpMatrixCount")}}else{const t=s();fi(t,this._cgl.vMatrix,this._cgl.mMatrix);this._cgl.gl.uniformMatrix4fv(this._mvMatrixUniform,false,t);this._cgl.profileData.count("mvpMatrixCount")}if(this._normalMatrixUniform){e(this._tempNormalMatrix,this._cgl.mMatrix);Ce(this._tempNormalMatrix,this._tempNormalMatrix);this._cgl.gl.uniformMatrix4fv(this._normalMatrixUniform,false,this._tempNormalMatrix);this._cgl.profileData.count("mvpMatrixCount")}for(let t=0;t<this._libs.length;t++){if(this._libs[t].onBind)this._libs[t].onBind.bind(this._libs[t])(this._cgl,this)}this._bindTextures();return this._isValid}unBind(){}dispose(){if(this._program&&this._cgl&&this._cgl.gl)this._cgl.gl.deleteProgram(this._program);this._program=null}setDrawBuffers(t){this._log.warn("useless drawbuffers...?!")}getUniforms(){return this._uniforms}getUniform(e){for(let t=0;t<this._uniforms.length;t++)if(this._uniforms[t].getName()==e)return this._uniforms[t];return null}removeAllUniforms(){this._uniforms=[]}_addUniform(t){this._uniforms.push(t);this.setWhyCompile("add uniform "+name)}addUniformFrag(t,e,i,s,r,n){const a=new _(this,t,e,i,s,r,n);a.shaderType="frag";return a}addUniformVert(t,e,i,s,r,n){const a=new _(this,t,e,i,s,r,n);a.shaderType="vert";return a}addUniformBoth(t,e,i,s,r,n){const a=new _(this,t,e,i,s,r,n);a.shaderType="both";return a}addUniformStructFrag(e,i,s){const r={};if(!s)return r;for(let t=0;t<s.length;t+=1){const n=s[t];if(!this.hasUniform(i+"."+n.name)){const a=new _(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,e,n.name);a.shaderType="frag";r[i+"."+n.name]=a}}return r}addUniformStructVert(e,i,s){const r={};if(!s)return r;for(let t=0;t<s.length;t+=1){const n=s[t];if(!this.hasUniform(i+"."+n.name)){const a=new _(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,e,n.name);a.shaderType="vert";r[i+"."+n.name]=a}}return r}addUniformStructBoth(e,i,s){const r={};if(!s)return r;for(let t=0;t<s.length;t+=1){const n=s[t];if(n.type==="2i"||n.type==="i"||n.type==="3i")this._log.error("Adding an integer struct member to both shaders can potentially error. Please use different structs for each shader. Error occured in struct:",e," with member:",n.name," of type:",n.type,".");if(!this.hasUniform(i+"."+n.name)){const a=new _(this,n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,e,n.name);a.shaderType="both";r[i+"."+n.name]=a}}return r}_createProgram(t,e){this._cgl.printError("before _createprogram");const i=this._cgl.gl.createProgram();this.vshader=b.createShader(this._cgl,t,this._cgl.gl.VERTEX_SHADER,this);this.fshader=b.createShader(this._cgl,e,this._cgl.gl.FRAGMENT_SHADER,this);if(this.vshader&&this.fshader){this._cgl.gl.attachShader(i,this.vshader);this._cgl.gl.attachShader(i,this.fshader);this._linkProgram(i,t,e)}else{this._isValid=false;this._cgl.printError("shader _createProgram");this._log.error("could not link shaderprogram");return null}this._cgl.printError("shader _createProgram");return i}hasErrors(){return this._hasErrors}_linkProgram(t,e,i){this._cgl.printError("before _linkprogram");if(this._feedBackNames.length>0){this._cgl.gl.transformFeedbackVaryings(t,this._feedBackNames,this._cgl.gl.SEPARATE_ATTRIBS)}this._cgl.gl.linkProgram(t);this._cgl.printError("gl.linkprogram");this._isValid=true;this._hasErrors=false;if(this._cgl.patch.config.glValidateShader!==false){this._cgl.gl.validateProgram(t);if(!this._cgl.gl.getProgramParameter(t,this._cgl.gl.VALIDATE_STATUS)){this._log.log("shaderprogram validation failed...");this._cgl.gl.getProgramInfoLog(t)}if(!this._cgl.gl.getProgramParameter(t,this._cgl.gl.LINK_STATUS)){this._hasErrors=true;const s=this._cgl.gl.getShaderInfoLog(this.fshader);const r=this._cgl.gl.getShaderInfoLog(this.vshader);if(this.logError)this._log.error(this._name+" shader linking fail...");else this._log.warn(this._name+" shader linking fail...");if(s)this._log.warn(this._cgl.gl.getShaderInfoLog(this.fshader));if(r)this._log.warn(this._cgl.gl.getShaderInfoLog(this.vshader));this._cgl.gl.getProgramInfoLog(t);if(!CABLES.UI)this._log.log(this);this._isValid=false;this._cgl.printError("shader link err")}}}getProgram(){return this._program}setFeedbackNames(t){this.setWhyCompile("setFeedbackNames");this._feedBackNames=t}addAttribute(e){for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].name==e.name&&this._attributes[t].nameFrag==e.nameFrag)return}this._attributes.push(e);this.setWhyCompile("addAttribute")}bindTextures(){this._bindTextures()}_bindTextures(){if(this._textureStackTex.length>this._cgl.maxTextureUnits){this._log.warn("[shader._bindTextures] too many textures bound",this._textureStackTex.length+"/"+this._cgl.maxTextureUnits)}for(let i=0;i<this._textureStackTex.length;i++){if(!this._textureStackTex[i]&&!this._textureStackTexCgl[i]){this._log.warn("no texture for pushtexture",this._name)}else{let t=this._textureStackTex[i];if(this._textureStackTexCgl[i]){t=this._textureStackTexCgl[i].tex||CGL.Texture.getEmptyTexture(this._cgl).tex}let e=true;if(!this._textureStackUni[i]){this._log.warn("no uniform for pushtexture",this._name);e=this._cgl.setTexture(i,t,this._textureStackType[i])}else{this._textureStackUni[i].setValue(i);e=this._cgl.setTexture(i,t,this._textureStackType[i])}if(!e)this._log.warn("tex bind failed",this.getName(),this._textureStackUni[i])}}}setUniformTexture(e,i){i=i||T.getTempTexture(this._cgl);for(let t=0;t<this._textureStackUni.length;t++)if(this._textureStackUni[t]==e){const s=this._textureStackTex[t]||this._textureStackTexCgl[t];if(i.hasOwnProperty("tex")){this._textureStackTexCgl[t]=i;this._textureStackTex[t]=null}else{this._textureStackTexCgl[t]=null;this._textureStackTex[t]=i}return s}return null}pushTexture(t,e,i){if(!t){return}if(!e){return}if(!e.hasOwnProperty("tex")&&!(e instanceof WebGLTexture)){this._log.warn(new Error("invalid texture").stack);this._log.warn("[cgl_shader] invalid texture...",e);return}this._textureStackUni.push(t);if(e.hasOwnProperty("tex")){this._textureStackTexCgl.push(e);this._textureStackTex.push(null)}else{this._textureStackTexCgl.push(null);this._textureStackTex.push(e)}this._textureStackType.push(i)}popTexture(){this._textureStackUni.pop();this._textureStackTex.pop();this._textureStackTexCgl.pop();this._textureStackType.pop()}popTextures(){this._textureStackTex.length=this._textureStackTexCgl.length=this._textureStackType.length=this._textureStackUni.length=0}getMaterialId(){return this._materialId}getInfo(){const t={};t.name=this._name;t.defines=this.getDefines();t.hasErrors=this.hasErrors();return t}getDefaultFragmentShader(t,e,i,s){return M(t,e,i,s)}getDefaultVertexShader(){return P()}}b.getDefaultVertexShader=P;b.getDefaultFragmentShader=M;b.getErrorFragmentShader=function(){return""+x+"void main()"+x+"{"+x+"   float g=mod((gl_FragCoord.y+gl_FragCoord.x),50.0)/50.0;"+x+"   g= step(0.1,g);"+x+"   outColor = vec4( g+0.5, 0.0, 0.0, 1.0);"+x+"}"};b.createShader=function(t,e,i,s){if(t.aborted)return;const r=t.gl.createShader(i);t.gl.shaderSource(r,e);t.gl.compileShader(r);if(!t.gl.getShaderParameter(r,t.gl.COMPILE_STATUS)){s.error={str:e,infoLog:t.gl.getShaderInfoLog(r)};if(CABLES.UI)gui.emitEvent("ShaderError",s);if(!s.error.infoLog){s._log.warn("empty shader info log",this._name);return}s.setSource(b.getDefaultVertexShader(),b.getErrorFragmentShader())}return r};class _a extends A.RenderLoop{#patch;#cgl;#renderOneFrame;#animReq;frameNum=0;onOneFrameRendered=null;_frameNext=0;_frameInterval=0;_lastFrameTime=0;reqAnimTimeStamp=0;_frameWasdelayed=true;aborted=false;constructor(t,e){super();this.#cgl=t;this.#patch=e;this.#patch.renderloop=this;this.exec(0)}exec(t){this.#patch.config.fpsLimit=this.#patch.config.fpsLimit||0;if(this.#patch.config.fpsLimit){this._frameInterval=1e3/this.#patch.config.fpsLimit}const e=CABLES.now();const i=e-this._frameNext;if(this.#patch.isEditorMode()){if(!this.#renderOneFrame){if(e-this._lastFrameTime>=500&&this._lastFrameTime!==0&&!this._frameWasdelayed){this._lastFrameTime=0;setTimeout(this.exec.bind(this),500);this.emitEvent("renderDelayStart");this._frameWasdelayed=true;return}}}if(this.#renderOneFrame||this.#patch.config.fpsLimit===0||i>this._frameInterval||this._frameWasdelayed){this.renderFrame(t);if(this._frameInterval)this._frameNext=e-i%this._frameInterval}if(this._frameWasdelayed){this.emitEvent("renderDelayEnd");this._frameWasdelayed=false}if(this.#renderOneFrame){if(this.onOneFrameRendered)this.onOneFrameRendered();this.emitEvent(A.Patch.EVENT_RENDERED_ONE_FRAME);this._renderOneFrame=false}if(this.#patch.config.doRequestAnimation){this.#animReq=this.#patch.getDocument().defaultView.requestAnimationFrame(this.exec.bind(this))}}renderFrame(t){const e=this.#patch.timer.getTime();const i=performance.now();this.#cgl.frameStartTime=this.#patch.timer.getTime();const s=t-this.reqAnimTimeStamp||t;this.#patch.updateAnims(null,s,t);this.#cgl.profileData.profileFrameDelta=s;this.reqAnimTimeStamp=t;this.#cgl.profileData.profileOnAnimFrameOps=performance.now()-i;this.#patch.emitEvent(A.Patch.EVENT_RENDER_FRAME,e);this.frameNum++;if(this.frameNum==1){if(this.#patch.config.onFirstFrameRendered)this.#patch.config.onFirstFrameRendered()}}pause(){cancelAnimationFrame(this.#animReq);this.#animReq=null;this.paused=true}resume(){cancelAnimationFrame(this.#animReq);this.paused=false;this.exec(0)}}const ma={BLEND_NONE:0,BLEND_NORMAL:1,BLEND_ADD:2,BLEND_SUB:3,BLEND_MUL:4};class pa extends ia{#cursor="auto";frameStartTime=0;constructor(t){super(t);this.gApi=ia.API_WEBGL;this.aborted=false;t.cgl=this;this.pushMvMatrix=this.pushModelMatrix;this.popMvMatrix=this.popmMatrix=this.popModelMatrix;this._log=new u.Logger("cgl_context",{onError:t.config.onError});this.lastMesh=null;this.glVersion=0;this.glUseHalfFloatTex=false;this.clearCanvasTransparent=true;this.clearCanvasDepth=true;this.debugOneFrame=false;this.checkGlErrors=false;this.maxTextureUnits=0;this.maxVaryingVectors=0;this.currentProgram=null;this._hadStackError=false;this.glSlowRendere=false;this._isSafariCrap=false;this.temporaryTexture=null;this.gl=null;this.#cursor="auto";this._currentCursor="";this._viewPortStack=[];this._glFrameBufferStack=[];this._frameBufferStack=[];this._shaderStack=[];this._stackDepthTest=[];this.mainloopOp=null;this._stackBlendMode=[];this._stackBlendModePremul=[];this._stackBlend=[];this._stackDepthFunc=[];this._stackCullFaceFacing=[];this._stackCullFace=[];this._stackDepthWrite=[];this._stackDepthTest=[];this._stackStencil=[];this._simpleShader=new b(this,"simpleshader");this._simpleShader.setModules(["MODULE_VERTEX_POSITION","MODULE_COLOR","MODULE_BEGIN_FRAG","MODULE_VERTEX_MODELVIEW"]);this._simpleShader.setSource(b.getDefaultVertexShader(),b.getDefaultFragmentShader());this._currentShader=this._simpleShader;this._oldCanvasWidth=-1;this._oldCanvasHeight=-1;this._enabledExtensions={};this.errorShader=null;this.setCanvas(t.config.glCanvasId||t.config.glCanvas||"glcanvas");if(t.config.glCanvasResizeToWindow===true)this.setAutoResize("window");if(t.config.glCanvasResizeToParent===true)this.setAutoResize("parent");if(this.aborted)t.aborted=true;t.on(A.Patch.EVENT_DISPOSE,()=>{this.dispose()});t.on("patchClearStart",()=>{this.TextureEffectMesh=null});this.renderLoop=new _a(this,t)}get viewPort(){if(this._viewPortStack.length>3){const t=this._viewPortStack.length;return[this._viewPortStack[t-4],this._viewPortStack[t-3],this._viewPortStack[t-2],this._viewPortStack[t-1]]}else{return this._viewPort}}get mvMatrix(){return this.mMatrix}set mvMatrix(t){this.mMatrix=t}_setCanvas(t){if(!t)this._log.stack("_setCanvas undef");if(!this.patch.config.canvas)this.patch.config.canvas={};if(!this.patch.config.canvas.hasOwnProperty("preserveDrawingBuffer"))this.patch.config.canvas.preserveDrawingBuffer=true;if(!this.patch.config.canvas.hasOwnProperty("premultipliedAlpha"))this.patch.config.canvas.premultipliedAlpha=false;if(!this.patch.config.canvas.hasOwnProperty("alpha"))this.patch.config.canvas.alpha=false;this.patch.config.canvas.stencil=true;if(this.patch.config.hasOwnProperty("clearCanvasColor"))this.clearCanvasTransparent=this.patch.config.clearCanvasColor;if(this.patch.config.hasOwnProperty("clearCanvasDepth"))this.clearCanvasDepth=this.patch.config.clearCanvasDepth;if(/^((?!chrome|android).)*safari/i.test(navigator.userAgent)){this._isSafariCrap=true;this.glUseHalfFloatTex=true}if(!this.patch.config.canvas.forceWebGl1)this.gl=t.getContext("webgl2",this.patch.config.canvas);if(!this.gl||this.gl.isContextLost()){this.aborted=true;this._log.warn("NO_WEBGL","sorry, could not initialize WebGL. Please check if your Browser supports WebGL or try to restart your browser.");return}if(this.gl.getParameter(this.gl.VERSION)!="WebGL 1.0"){this.glVersion=2}else{this.gl=t.getContext("webgl",this.patch.config.canvas)||t.getContext("experimental-webgl",this.patch.config.canvas);this.glVersion=1;if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){if(!this.patch.config.canvas.hasOwnProperty("powerPreference"))this.patch.config.canvas.powerPreference="high-performance"}this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}const e=this.enableExtension("WEBGL_debug_renderer_info");if(e){this.glRenderer=this.gl.getParameter(e.UNMASKED_RENDERER_WEBGL);if(this.glRenderer==="Google SwiftShader")this.glSlowRenderer=true}this.canvas.addEventListener("webglcontextlost",t=>{if(this.aborted)return this._log.warn("[cgl_state] aborted context lost... can be ignored...");this._log.error("canvas lost...",t);this.emitEvent("webglcontextlost");this.aborted=true});this.maxAnisotropic=0;if(this.enableExtension("EXT_texture_filter_anisotropic"))this.maxAnisotropic=this.gl.getParameter(this.enableExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.maxVaryingVectors=this.gl.getParameter(this.gl.MAX_VARYING_VECTORS);this.maxTextureUnits=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS);this.maxTexSize=this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE);this.maxUniformsFrag=this.gl.getParameter(this.gl.MAX_FRAGMENT_UNIFORM_VECTORS);this.maxUniformsVert=this.gl.getParameter(this.gl.MAX_VERTEX_UNIFORM_VECTORS);this.maxSamples=0;if(this.gl.MAX_SAMPLES)this.maxSamples=this.gl.getParameter(this.gl.MAX_SAMPLES);if(this.glVersion==1){this.enableExtension("OES_standard_derivatives");const i=this.enableExtension("ANGLE_instanced_arrays")||this.gl;if(i.vertexAttribDivisorANGLE){this.gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i);this.gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i)}}this.DEPTH_FUNCS=[this.gl.NEVER,this.gl.ALWAYS,this.gl.LESS,this.gl.LEQUAL,this.gl.GREATER,this.gl.GEQUAL,this.gl.EQUAL,this.gl.NOTEQUAL];this.CULL_MODES=[null,this.gl.BACK,this.gl.FRONT,this.gl.FRONT_AND_BACK]}getInfo(){return{glVersion:this.glVersion,glRenderer:this.glRenderer,glUseHalfFloatTex:this.glUseHalfFloatTex,maxVaryingVectors:this.maxVaryingVectors,maxTextureUnits:this.maxTextureUnits,maxTexSize:this.maxTexSize,maxUniformsFrag:this.maxUniformsFrag,maxUniformsVert:this.maxUniformsVert,maxSamples:this.maxSamples}}popViewPort(){this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();this._viewPortStack.pop();if(this._viewPortStack.length==0)this.setViewPort(0,0,this.canvasWidth,this.canvasHeight);else this.setViewPort(this._viewPortStack[this._viewPort.length-4],this._viewPortStack[this._viewPort.length-3],this._viewPortStack[this._viewPort.length-2],this._viewPortStack[this._viewPort.length-1])}pushViewPort(t,e,i,s){this._viewPortStack.push(t,e,i,s);this.setViewPort(t,e,i,s)}getViewPort(){return this._viewPort}resetViewPort(){this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}setViewPort(t,e,i,s){this._viewPort[0]=Math.round(t);this._viewPort[1]=Math.round(e);this._viewPort[2]=Math.round(i);this._viewPort[3]=Math.round(s);this.gl.viewport(this._viewPort[0],this._viewPort[1],this._viewPort[2],this._viewPort[3])}screenShot(e,t,i,s){if(t){this.gl.clearColor(1,1,1,1);this.gl.colorMask(false,false,false,true);this.gl.clear(this.gl.COLOR_BUFFER_BIT);this.gl.colorMask(true,true,true,true)}if(this.canvas&&this.canvas.toBlob){this.canvas.toBlob(t=>{if(e)e(t);else this._log.log("no screenshot callback...")},i,s)}}endFrame(){if(this.patch.isEditorMode())CABLES.GL_MARKER.drawMarkerLayer(this);this.setPreviousShader();if(this._vMatrixStack.length()>0)this.logStackError("view matrix stack length !=0 at end of rendering...");if(this._mMatrixStack.length()>0)this.logStackError("mvmatrix stack length !=0 at end of rendering...");if(this._pMatrixStack.length()>0)this.logStackError("pmatrix stack length !=0 at end of rendering...");if(this._glFrameBufferStack.length>0)this.logStackError("glFrameBuffer stack length !=0 at end of rendering...");if(this._stackDepthTest.length>0)this.logStackError("depthtest stack length !=0 at end of rendering...");if(this._stackDepthWrite.length>0)this.logStackError("depthwrite stack length !=0 at end of rendering...");if(this._stackDepthFunc.length>0)this.logStackError("depthfunc stack length !=0 at end of rendering...");if(this._stackBlend.length>0)this.logStackError("blend stack length !=0 at end of rendering...");if(this._stackBlendMode.length>0)this.logStackError("blendMode stack length !=0 at end of rendering...");if(this._shaderStack.length>0)this.logStackError("this._shaderStack length !=0 at end of rendering...");if(this._stackCullFace.length>0)this.logStackError("this._stackCullFace length !=0 at end of rendering...");if(this._stackCullFaceFacing.length>0)this.logStackError("this._stackCullFaceFacing length !=0 at end of rendering...");if(this._viewPortStack.length>0)this.logStackError("viewport stack length !=0 at end of rendering...");this._frameStarted=false;if(this._oldCanvasWidth!=this.canvasWidth||this._oldCanvasHeight!=this.canvasHeight){this._oldCanvasWidth=this.canvasWidth;this._oldCanvasHeight=this.canvasHeight;this.emitEvent(ia.EVENT_RESIZE)}if(this.#cursor!=this._currentCursor){this._currentCursor=this.canvas.style.cursor=this.#cursor}this.emitEvent("endframe");this.fpsCounter.endFrame()}logStackError(t){if(!this._hadStackError){this._hadStackError=true;this._log.warn("["+this.canvas.id+"]: ",t)}}getShader(){if(this._currentShader)if(!this.tempData||this.tempData.renderOffscreen===true==this._currentShader.offScreenPass===true)return this._currentShader;for(let t=this._shaderStack.length-1;t>=0;t--)if(this._shaderStack[t])if(this.tempData.renderOffscreen==this._shaderStack[t].offScreenPass)return this._shaderStack[t]}getDefaultShader(){return this._simpleShader}setShader(t){this.pushShader(t)}pushShader(e){if(this.tempData.forceShaderMods&&!this.tempData.shadowPass){for(let t=0;t<this.tempData.forceShaderMods.length;t++){e=this.tempData.forceShaderMods[t].bind(e,false)}}this._shaderStack.push(e);this._currentShader=e}popShader(){this.setPreviousShader()}setPreviousShader(){if(this.tempData.forceShaderMods&&!this.tempData.shadowPass){for(let t=0;t<this.tempData.forceShaderMods.length;t++){this.tempData.forceShaderMods[t].unbind(false)}}if(this._shaderStack.length===0)throw new Error("Invalid shader stack pop!");this._shaderStack.pop();this._currentShader=this._shaderStack[this._shaderStack.length-1]}pushGlFrameBuffer(t){this._glFrameBufferStack.push(t)}popGlFrameBuffer(){if(this._glFrameBufferStack.length==0)return null;this._glFrameBufferStack.pop();return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}getCurrentGlFrameBuffer(){if(this._glFrameBufferStack.length===0)return null;return this._glFrameBufferStack[this._glFrameBufferStack.length-1]}pushFrameBuffer(t){this._frameBufferStack.push(t)}popFrameBuffer(){if(this._frameBufferStack.length==0)return null;this._frameBufferStack.pop();return this._frameBufferStack[this._frameBufferStack.length-1]}getCurrentFrameBuffer(){if(this._frameBufferStack.length===0)return null;return this._frameBufferStack[this._frameBufferStack.length-1]}renderStart(t,e,i){this.fpsCounter.startFrame();this.pushDepthTest(true);this.pushDepthWrite(true);this.pushDepthFunc(t.gl.LEQUAL);this.pushCullFaceFacing(t.gl.BACK);this.pushCullFace(false);t.setViewPort(0,0,t.canvasWidth,t.canvasHeight);this._startMatrixStacks(e,i);t.pushBlendMode(d.BLEND_MODES.BLEND_NORMAL,false);for(let t=0;t<this._textureslots.length;t++)this._textureslots[t]=null;this.pushShader(this._simpleShader);this._frameStarted=true;this._execOneTimeCallbacks();for(let t=0;t<this._textureslots.length;t++){this.gl.activeTexture(this.gl.TEXTURE0+t);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this._textureslots[t]=null}this.emitEvent("beginFrame")}renderEnd(t,e=true){this._endMatrixStacks();this.popDepthTest();this.popDepthWrite();this.popDepthFunc();this.popCullFaceFacing();this.popCullFace();this.popBlend();this.popBlendMode();if(e)t.endFrame();this.emitEvent("endFrame")}getTexture(t){return this._textureslots[t]}hasFrameStarted(){return this._frameStarted}checkFrameStarted(t){if(CABLES.UI&&CABLES.UI.showDevInfo&&!this._frameStarted){this._log.warn("frame not started "+t);Error.stackTraceLimit=25;A.utils.logStack();this.patch.printTriggerStack()}}setTexture(t,e,i){this.checkFrameStarted("cgl setTexture");if(e===null)e=T.getEmptyTexture(this).tex;if(this._textureslots[t]!=e){this.gl.activeTexture(this.gl.TEXTURE0+t);this.gl.bindTexture(i||this.gl.TEXTURE_2D,e);this._textureslots[t]=e}return true}fullScreen(){if(this.canvas.requestFullscreen)this.canvas.requestFullscreen();else if(this.canvas.mozRequestFullScreen)this.canvas.mozRequestFullScreen();else if(this.canvas.webkitRequestFullscreen)this.canvas.webkitRequestFullscreen();else if(this.canvas.msRequestFullscreen)this.canvas.msRequestFullscreen()}printError(e){if(!this.checkGlErrors)return;let i=false;let s=this.gl.getError();if(s!=this.gl.NO_ERROR){let t="";if(s==this.gl.OUT_OF_MEMORY)t="OUT_OF_MEMORY";if(s==this.gl.INVALID_ENUM)t="INVALID_ENUM";if(s==this.gl.INVALID_OPERATION)t="INVALID_OPERATION";if(s==this.gl.INVALID_FRAMEBUFFER_OPERATION)t="INVALID_FRAMEBUFFER_OPERATION";if(s==this.gl.INVALID_VALUE)t="INVALID_VALUE";if(s==this.gl.CONTEXT_LOST_WEBGL){this.aborted=true;t="CONTEXT_LOST_WEBGL"}if(s==this.gl.NO_ERROR)t="NO_ERROR";i=true;this._log.warn("gl error ["+this.canvas.id+"]: ",e,s,t);if(this.canvas.id.includes("glGuiCanvas"))if(!this._loggedGlError){this.patch.printTriggerStack();this._log.stack("glerror");this._loggedGlError=true}}s=this.gl.getError();return i}_dispose(){this._simpleShader.dispose();this.gl=null}pushDepthTest(t){this._stackDepthTest.push(t);if(!t)this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}stateDepthTest(){return this._stackDepthTest[this._stackDepthTest.length-1]}popDepthTest(){this._stackDepthTest.pop();if(!this._stackDepthTest[this._stackDepthTest.length-1])this.gl.disable(this.gl.DEPTH_TEST);else this.gl.enable(this.gl.DEPTH_TEST)}pushDepthWrite(t){t=t||false;this._stackDepthWrite.push(t);this.gl.depthMask(t)}stateDepthWrite(){return this._stackDepthWrite[this._stackDepthWrite.length-1]}popDepthWrite(){this._stackDepthWrite.pop();this.gl.depthMask(this._stackDepthWrite[this._stackDepthWrite.length-1]||false)}pushCullFace(t){this._stackCullFace.push(t);if(t)this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}stateCullFace(){return this._stackCullFace[this._stackCullFace.length-1]}popCullFace(){this._stackCullFace.pop();if(this._stackCullFace[this._stackCullFace.length-1])this.gl.enable(this.gl.CULL_FACE);else this.gl.disable(this.gl.CULL_FACE)}pushCullFaceFacing(t){this._stackCullFaceFacing.push(t);this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}stateCullFaceFacing(){return this._stackCullFaceFacing[this._stackCullFaceFacing.length-1]}popCullFaceFacing(){this._stackCullFaceFacing.pop();if(this._stackCullFaceFacing.length>0)this.gl.cullFace(this._stackCullFaceFacing[this._stackCullFaceFacing.length-1])}pushDepthFunc(t){this._stackDepthFunc.push(t);this.gl.depthFunc(t)}stateDepthFunc(){if(this._stackDepthFunc.length>0)return this._stackDepthFunc[this._stackDepthFunc.length-1];return false}popDepthFunc(){this._stackDepthFunc.pop();if(this._stackDepthFunc.length>0)this.gl.depthFunc(this._stackDepthFunc[this._stackDepthFunc.length-1])}pushBlend(t){this._stackBlend.push(t);if(!t)this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}popBlend(){this._stackBlend.pop();if(!this._stackBlend[this._stackBlend.length-1])this.gl.disable(this.gl.BLEND);else this.gl.enable(this.gl.BLEND)}stateBlend(){return this._stackBlend[this._stackBlend.length-1]}pushBlendMode(t,e){this._stackBlendMode.push(t);this._stackBlendModePremul.push(e);const i=this._stackBlendMode.length-1;this.pushBlend(this._stackBlendMode[i]!==d.BLEND_MODES.BLEND_NONE);this._setBlendMode(this._stackBlendMode[i],this._stackBlendModePremul[i])}popBlendMode(){this._stackBlendMode.pop();this._stackBlendModePremul.pop();const t=this._stackBlendMode.length-1;this.popBlend();if(t>=0)this._setBlendMode(this._stackBlendMode[t],this._stackBlendModePremul[t])}pushStencil(t){this._stackStencil.push(t);if(!t)this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}popStencil(){this._stackStencil.pop();if(!this._stackStencil[this._stackStencil.length-1])this.gl.disable(this.gl.STENCIL_TEST);else this.gl.enable(this.gl.STENCIL_TEST)}glGetAttribLocation(t,e){const i=this.gl.getAttribLocation(t,e);if(i==-1)this.profileData.count("invalidAttribLoc");return i}shouldDrawHelpers(t){if(this.tempData.shadowPass)return false;if(!t.patch.isEditorMode())return false;return gui.shouldDrawOverlay}_setBlendMode(t,e){const i=this.gl;if(t==d.BLEND_MODES.BLEND_NONE){}else if(t==d.BLEND_MODES.BLEND_ADD){if(e){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE,i.ONE,i.ONE)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.SRC_ALPHA,i.ONE)}}else if(t==d.BLEND_MODES.BLEND_SUB){if(e){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.ZERO,i.ONE_MINUS_SRC_COLOR,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.ONE_MINUS_SRC_COLOR)}}else if(t==d.BLEND_MODES.BLEND_MUL){if(e){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ZERO,i.SRC_COLOR,i.ZERO,i.SRC_ALPHA)}else{i.blendEquation(i.FUNC_ADD);i.blendFunc(i.ZERO,i.SRC_COLOR)}}else if(t==d.BLEND_MODES.BLEND_NORMAL){if(e){i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.ONE,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}else{i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD);i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA)}}else{this._log.log("setblendmode: unknown blendmode")}}createMesh(t,e){if(A.utils.isNumeric(e))e={glPrimitive:e};return new m(this,t,e)}setCursor(t){this.#cursor=t}enableExtension(t){if(!this.gl)return null;if(this._enabledExtensions.hasOwnProperty(t))return this._enabledExtensions[t];const e=this.gl.getExtension(t);this._enabledExtensions[t]=e;if(!e)this._log.warn("[cgl_state] extension not available "+t);return e}getErrorShader(){if(this.errorShader)return this.errorShader;this.errorShader=new b(this,"errormaterial");this.errorShader.setSource(b.getDefaultVertexShader(),b.getErrorFragmentShader());return this.errorShader}}const Ea=8;const va=new u.Logger("cgl_texture");class T extends g{constructor(t,e={}){super(e);if(!t)throw new Error("no cgl");this._cgl=t;this._log=new u.Logger("tex");this.tex=this._cgl.gl.createTexture();this.loading=false;this.flip=true;this.flipped=false;this.shadowMap=false;this.deleted=false;this.image=null;this.anisotropic=0;this.filter=T.FILTER_NEAREST;this.wrap=T.WRAP_CLAMP_TO_EDGE;this.texTarget=this._cgl.gl.TEXTURE_2D;if(e&&e.type)this.texTarget=e.type;this.textureType=T.TYPE_DEFAULT;this.unpackAlpha=true;this._fromData=true;this._glDataType=-1;this._glInternalFormat=-1;this._glDataFormat=-1;if(e){if(e.isDepthTexture)this.textureType=T.TYPE_DEPTH;if(e.isFloatingPointTexture===true)this.textureType=T.TYPE_FLOAT;if("textureType"in e)this.textureType=e.textureType;if("filter"in e)this.filter=e.filter;if("wrap"in e)this.wrap=e.wrap;if("unpackAlpha"in e)this.unpackAlpha=e.unpackAlpha;if("flip"in e)this.flip=e.flip;if("shadowMap"in e)this.shadowMap=e.shadowMap;if("anisotropic"in e)this.anisotropic=e.anisotropic}else{e={}}if(!e.pixelFormat&&e.isFloatingPointTexture)this.pixelFormat=T.PFORMATSTR_RGBA32F;if(this.textureType==T.TYPE_DEPTH)this.pixelFormat=T.PFORMATSTR_DEPTH;this._cgl.profileData.count("texturecreated");this.setFormat(T.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.profileData.addHeavyEvent("texture created",this.name,e.width+"x"+e.height);this.setSize(e.width,e.height);this.getInfoOneLine()}isFloatingPoint(){return T.isPixelFormatFloat(this.pixelFormat)}compareSettings(t){if(!t)return false;return t.width==this.width&&t.height==this.height&&t.filter==this.filter&&t.wrap==this.wrap&&t.textureType==this.textureType&&t.unpackAlpha==this.unpackAlpha&&t.anisotropic==this.anisotropic&&t.shadowMap==this.shadowMap&&t.texTarget==this.texTarget&&t.flip==this.flip}clone(){const t=new T(this._cgl,{name:this.name,filter:this.filter,anisotropic:this.anisotropic,wrap:this.wrap,textureType:this.textureType,pixelFormat:this.pixelFormat,unpackAlpha:this.unpackAlpha,flip:this.flip,width:this.width,height:this.height});this._cgl.profileData.addHeavyEvent("texture created",this.name,this.width+"x"+this.height);if(!this.compareSettings(t)){this._log.error("Cloned texture settings do not compare!");this._log.error(this);this._log.error(t)}return t}setFormat(t){this.pixelFormat=t.pixelFormat;this._glDataFormat=t.glDataFormat;this._glInternalFormat=t.glInternalFormat;this._glDataType=t.glDataType}setSize(t,e){if(this._cgl.aborted)return;if(t!=t||t<=0||!t)t=Ea;if(e!=e||e<=0||!e)e=Ea;if(t>this._cgl.maxTexSize||e>this._cgl.maxTexSize)this._log.error("texture size too big! "+t+"x"+e+" / max: "+this._cgl.maxTexSize);t=Math.min(t,this._cgl.maxTexSize);e=Math.min(e,this._cgl.maxTexSize);t=Math.floor(t);e=Math.floor(e);if(this.width==t&&this.height==e)return;t=this._cgl.checkTextureSize(t);e=this._cgl.checkTextureSize(e);this.width=t;this.height=e;this.deleted=false;this.setFormat(T.setUpGlPixelFormat(this._cgl,this.pixelFormat));this.shortInfoString=this.getInfoOneLine();this._cgl.gl.bindTexture(this.texTarget,this.tex);this._cgl.profileData.count("textureResize");const i=null;this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,t,e,0,this._glDataFormat,this._glDataType,i);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null)}initFromData(t,e,i,s,r){this.filter=s;this.wrap=r;if(s==undefined)this.filter=T.FILTER_LINEAR;if(r==undefined)this.wrap=T.WRAP_CLAMP_TO_EDGE;this.width=e;this.height=i;this._fromData=true;this.deleted=false;if(this.height>this._cgl.maxTexSize||this.width>this._cgl.maxTexSize){const n=CGL.Texture.getTempTexture(this._cgl);this.width=n.width;this.height=n.height;this.tex=n.tex;this._log.warn("[cgl_texture] texture size too big!",this.width,this.height,this._cgl.maxTexSize);return}if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flip);this._cgl.gl.bindTexture(this.texTarget,this.tex);this.setFormat(T.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,e,i,0,this._glDataFormat,this._glDataType,t);this._setFilter();this.updateMipMap();if(this.flip)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this._cgl.gl.bindTexture(this.texTarget,null)}updateMipMap(){if((this._cgl.glVersion==2||this.isPowerOfTwo())&&this.filter==T.FILTER_MIPMAP){this._cgl.gl.generateMipmap(this.texTarget);this._cgl.profileData.count("textureGenMipMap")}}initTexture(t,e=null){this._cgl.printError("before initTexture");this._cgl.checkFrameStarted("texture inittexture");this._fromData=false;this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha);if(t.width||t.videoWidth)this.width=t.videoWidth||t.width;if(t.height||t.videoHeight)this.height=t.videoHeight||t.height;if(e!==null)this.filter=e;if(t.height>this._cgl.maxTexSize||t.width>this._cgl.maxTexSize){const i=CGL.Texture.getTempTexture(this._cgl);this.width=i.width;this.height=i.height;this.tex=i.tex;this._log.warn("[cgl_texture] texture size too big!",t.width,t.height,this._cgl.maxTexSize);return}this._cgl.gl.bindTexture(this.texTarget,this.tex);this.deleted=false;this.flipped=!this.flip;if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,this.flipped);this.setFormat(T.setUpGlPixelFormat(this._cgl,this.pixelFormat));this._cgl.gl.texImage2D(this.texTarget,0,this._glInternalFormat,this._glDataFormat,this._glDataType,t);this._setFilter();this.updateMipMap();this._cgl.gl.bindTexture(this.texTarget,null);this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(this.flipped)this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_FLIP_Y_WEBGL,false);this.getInfoOneLine();this._cgl.printError("initTexture")}dispose(){this.delete()}delete(){if(this.loading){return}this.deleted=true;this.width=0;this.height=0;this._cgl.profileData.count("textureDelete");this._cgl.gl.deleteTexture(this.tex);this.image=null;this.tex=null}isPowerOfTwo(){return T.isPowerOfTwo(this.width)&&T.isPowerOfTwo(this.height)}printInfo(){va.log(this.getInfo())}getInfoReadable(){const e=this.getInfo();let i="";e.name=e.name.substr(0,e.name.indexOf("?rnd="));for(const t in e){i+="* "+t+":  **"+e[t]+"**\n"}return i}getInfoOneLine(){let t=""+this.width+"x"+this.height;t+=" ";t+=this.pixelFormat;if(this.filter===T.FILTER_NEAREST)t+=" nearest";if(this.filter===T.FILTER_LINEAR)t+=" linear";if(this.filter===T.FILTER_MIPMAP)t+=" mipmap";if(this.wrap===T.WRAP_CLAMP_TO_EDGE)t+=" clamp";if(this.wrap===T.WRAP_REPEAT)t+=" repeat";if(this.wrap===T.WRAP_MIRRORED_REPEAT)t+=" repeatmir";this.shortInfoString=t;return t}getInfoOneLineShort(){let t=""+this.width+"x"+this.height;t+=" ";t+=this.pixelFormat;this.shortInfoString=t;return t}getInfo(){return T.getTexInfo(this)}_setFilter(){this._cgl.printError("before _setFilter");if(!this._fromData){this._cgl.gl.pixelStorei(this._cgl.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.unpackAlpha)}if(this.shadowMap){this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_MODE,this._cgl.gl.COMPARE_REF_TO_TEXTURE);this._cgl.gl.texParameteri(this._cgl.gl.TEXTURE_2D,this._cgl.gl.TEXTURE_COMPARE_FUNC,this._cgl.gl.LEQUAL)}if(this.textureType==T.TYPE_FLOAT&&this.filter==T.FILTER_MIPMAP){this.filter=T.FILTER_LINEAR;this._log.stack("texture: HDR and mipmap filtering at the same time is not possible")}if(this._cgl.glVersion==1&&!this.isPowerOfTwo()){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE);this.filter=T.FILTER_NEAREST;this.wrap=T.WRAP_CLAMP_TO_EDGE}else{if(this.wrap==T.WRAP_CLAMP_TO_EDGE){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.CLAMP_TO_EDGE);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.CLAMP_TO_EDGE)}else if(this.wrap==T.WRAP_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.REPEAT)}else if(this.wrap==T.WRAP_MIRRORED_REPEAT){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_S,this._cgl.gl.MIRRORED_REPEAT);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_WRAP_T,this._cgl.gl.MIRRORED_REPEAT)}if(this.filter==T.FILTER_NEAREST){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.NEAREST);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.NEAREST)}else if(this.filter==T.FILTER_LINEAR){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR)}else if(this.filter==T.FILTER_MIPMAP){this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MAG_FILTER,this._cgl.gl.LINEAR);this._cgl.gl.texParameteri(this.texTarget,this._cgl.gl.TEXTURE_MIN_FILTER,this._cgl.gl.LINEAR_MIPMAP_LINEAR)}else{this._log.log("unknown texture filter!",this.filter);throw new Error("unknown texture filter!"+this.filter)}if(this.anisotropic){const t=this._cgl.enableExtension("EXT_texture_filter_anisotropic");if(this._cgl.maxAnisotropic){const e=Math.min(this._cgl.maxAnisotropic,this.anisotropic);this._cgl.gl.texParameterf(this._cgl.gl.TEXTURE_2D,t.TEXTURE_MAX_ANISOTROPY_EXT,e)}}}this.getInfoOneLine();this._cgl.printError("_setFilter")}}T.load=function(i,s,r,t){if(!s)return r({error:true});let n=null;if(!i.patch.loading.existByName(s))n=i.patch.loading.start("cgl.texture",s);const a=new T(i);a.name=s;a.image=new Image;a.image.crossOrigin="anonymous";a.loading=true;if(t&&t.hasOwnProperty("filter"))a.filter=t.filter;if(t&&t.hasOwnProperty("flip"))a.flip=t.flip;if(t&&t.hasOwnProperty("wrap"))a.wrap=t.wrap;if(t&&t.hasOwnProperty("anisotropic"))a.anisotropic=t.anisotropic;if(t&&t.hasOwnProperty("unpackAlpha"))a.unpackAlpha=t.unpackAlpha;if(t&&t.hasOwnProperty("pixelFormat"))a.pixelFormat=t.pixelFormat;a.image.onabort=a.image.onerror=t=>{console.warn("[cgl.texture.load] error loading texture",s,t);a.loading=false;if(n)i.patch.loading.finished(n);const e={error:true};if(r)r(e,a)};a.image.onload=function(t){i.addNextFrameOnceCallback(()=>{a.initTexture(a.image);if(n)i.patch.loading.finished(n);a.loading=false;if(r)r(null,a)})};a.image.src=s;return a};T.getTempTexture=function(t){if(!t)console.error("[getTempTexture] no cgl!");if(!t.tempTexture)t.tempTexture=T.getTemporaryTexture(t,256,T.FILTER_LINEAR,T.REPEAT);return t.tempTexture};T.getErrorTexture=function(t){if(!t)console.error("[getTempTexture] no cgl!");if(!t.errorTexture)t.errorTexture=T.getTemporaryTexture(t,256,T.FILTER_LINEAR,T.REPEAT,1,.2,.2);return t.errorTexture};T.getEmptyTexture=function(t,e){if(e)return T.getEmptyTextureFloat(t);if(!t)console.error("[getEmptyTexture] no cgl!");if(t.tempTextureEmpty)return t.tempTextureEmpty;let i=8;t.tempTextureEmpty=new T(t,{name:"emptyTexture"});const s=T.getDefaultTextureData("empty",i);t.tempTextureEmpty.initFromData(s,i,i,T.FILTER_NEAREST,T.WRAP_REPEAT);return t.tempTextureEmpty};T.getEmptyTextureFloat=function(t){if(!t)console.error("[getEmptyTextureFloat] no cgl!");if(t.tempTextureEmptyFloat)return t.tempTextureEmptyFloat;t.tempTextureEmptyFloat=new T(t,{name:"emptyTexture",isFloatingPointTexture:true});const e=new Float32Array(8*8*4).fill(1);for(let t=0;t<8*8*4;t+=4)e[t+3]=0;t.tempTextureEmptyFloat.initFromData(e,8,8,T.FILTER_NEAREST,T.WRAP_REPEAT);return t.tempTextureEmptyFloat};T.getRandomTexture=function(t){if(!t)console.error("[getRandomTexture] no cgl!");if(t.randomTexture)return t.randomTexture;const e=256;const i=T.getDefaultTextureData("randomUInt",e);t.randomTexture=new T(t);t.randomTexture.initFromData(i,e,e,T.FILTER_NEAREST,T.WRAP_REPEAT);return t.randomTexture};T.getRandomFloatTexture=function(t){if(!t)console.error("[getRandomTexture] no cgl!");if(t.getRandomFloatTexture)return t.getRandomFloatTexture;const e=256;const i=T.getDefaultTextureData("randomFloat",e);t.getRandomFloatTexture=new T(t,{isFloatingPointTexture:true});t.getRandomFloatTexture.initFromData(i,e,e,T.FILTER_NEAREST,T.WRAP_REPEAT);return t.getRandomFloatTexture};T.getBlackTexture=function(t){if(t.blackTexture)return t.blackTexture;const e=8;const i=T.getDefaultTextureData("color",e,{r:0,g:0,b:0});t.blackTexture=new T(t);t.blackTexture.initFromData(i,e,e,T.FILTER_NEAREST,T.WRAP_REPEAT);return t.blackTexture};T.getEmptyCubemapTexture=function(e){const i=[e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z];const t=e.gl.createTexture();const s=e.gl.TEXTURE_CUBE_MAP;const r=T.FILTER_NEAREST;const n=T.WRAP_CLAMP_TO_EDGE;const a=8;const o=8;e.profileData.count("texturecreated");e.gl.bindTexture(s,t);e.profileData.count("textureResize");for(let t=0;t<6;t+=1){const h=new Uint8Array(8*8*4);e.gl.texImage2D(i[t],0,e.gl.RGBA,8,8,0,e.gl.RGBA,e.gl.UNSIGNED_BYTE,h);e.gl.texParameteri(s,e.gl.TEXTURE_MAG_FILTER,e.gl.NEAREST);e.gl.texParameteri(s,e.gl.TEXTURE_MIN_FILTER,e.gl.NEAREST);e.gl.texParameteri(s,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE);e.gl.texParameteri(s,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE)}e.gl.bindTexture(s,null);return{id:A.utils.uuid(),tex:t,cubemap:t,width:a,height:o,filter:r,wrap:n,unpackAlpha:true,flip:true,_fromData:true,name:"emptyCubemapTexture",anisotropic:0}};T.getTempGradientTexture=function(t){if(!t)console.error("[getTempGradientTexture] no cgl!");return T.getTempTexture(t)};T.getTemporaryTexture=function(t,e,i,s,r,n,a){const o=T.getDefaultTextureData("stripes",256,{r:r,g:n,b:a});const h=new T(t);h.initFromData(o,e,e,i,s);return h};T.createFromImage=function(t,e,i){i=i||{};const s=new T(t,i);s.flip=false;s.image=e;s.width=e.videoWidth||e.width||8;s.height=e.videoHeight||e.height||8;if(i.hasOwnProperty("wrap"))s.wrap=i.wrap;s.initTexture(e,i.filter);return s};T.fromImage=function(t,e,i,s){console.error("deprecated texture from image...");const r=new T(t);r.flip=false;if(i)r.filter=i;if(s)r.wrap=s;r.image=e;r.initTexture(e);return r};T.isPowerOfTwo=function(t){return t==1||t==2||t==4||t==8||t==16||t==32||t==64||t==128||t==256||t==512||t==1024||t==2048||t==4096||t==8192||t==16384};T.getTexInfo=function(t){const e={};e.name=t.name;e["power of two"]=t.isPowerOfTwo();e.size=t.width+" x "+t.height;let i=t.texTarget;if(t.texTarget==t._cgl.gl.TEXTURE_2D)i="TEXTURE_2D";e.target=i;e.unpackAlpha=t.unpackAlpha;if(t.cubemap)e.cubemap=true;if(t.textureType==T.TYPE_FLOAT)e.textureType="TYPE_FLOAT";if(t.textureType==T.TYPE_HALF_FLOAT)e.textureType="TYPE_HALF_FLOAT";else if(t.textureType==T.TYPE_DEPTH)e.textureType="TYPE_DEPTH";else if(t.textureType==T.TYPE_DEFAULT)e.textureType="TYPE_DEFAULT";else e.textureType="UNKNOWN "+this.textureType;if(t.wrap==T.WRAP_CLAMP_TO_EDGE)e.wrap="CLAMP_TO_EDGE";else if(t.wrap==T.WRAP_REPEAT)e.wrap="WRAP_REPEAT";else if(t.wrap==T.WRAP_MIRRORED_REPEAT)e.wrap="WRAP_MIRRORED_REPEAT";else e.wrap="UNKNOWN";if(t.filter==T.FILTER_NEAREST)e.filter="FILTER_NEAREST";else if(t.filter==T.FILTER_LINEAR)e.filter="FILTER_LINEAR";else if(t.filter==T.FILTER_MIPMAP)e.filter="FILTER_MIPMAP";else e.filter="UNKNOWN";e.pixelFormat=t.pixelFormat||"unknown";return e};T.setUpGlPixelFormat=function(t,e){const i={};if(!e){t._log.error("no pixelformatstr!");t._log.log(new Error);e=T.PFORMATSTR_RGBA8UB}i.pixelFormatBase=e;i.pixelFormat=e;i.glDataType=t.gl.UNSIGNED_BYTE;i.glInternalFormat=t.gl.RGBA8;i.glDataFormat=t.gl.RGBA;let s=t.gl.FLOAT;if(t.glUseHalfFloatTex){if(e==T.PFORMATSTR_RGBA32F)e=T.PFORMATSTR_RGBA16F;if(e==T.PFORMATSTR_RG32F)e=T.PFORMATSTR_RG16F;if(e==T.PFORMATSTR_R32F)e=T.PFORMATSTR_R16F}if(e.includes("16bit")){if(t.glVersion==2){const r=t.enableExtension("EXT_color_buffer_half_float");if(!r){console.warn("no 16bit extension, fallback to 32bit",e);if(e==T.PFORMATSTR_RGBA16F)e=T.PFORMATSTR_RGBA32F;if(e==T.PFORMATSTR_RGB16F)e=T.PFORMATSTR_RGB32F;if(e==T.PFORMATSTR_RG16F)e=T.PFORMATSTR_RG32F;if(e==T.PFORMATSTR_R16F)e=T.PFORMATSTR_R32F}else{s=t.gl.HALF_FLOAT}}}if(t.glVersion==1){i.glInternalFormat=t.gl.RGBA;if(e==T.PFORMATSTR_RGBA16F||e==T.PFORMATSTR_RG16F||e==T.PFORMATSTR_R16F){const n=t.enableExtension("OES_texture_half_float");if(!n)throw new Error("no half float texture extension");s=n.HALF_FLOAT_OES}}if(e==T.PFORMATSTR_RGBA8UB){}else if(e==T.PFORMATSTR_RGB565){i.glInternalFormat=t.gl.RGB565;i.glDataFormat=t.gl.RGB}else if(e==T.PFORMATSTR_R8UB){i.glInternalFormat=t.gl.R8;i.glDataFormat=t.gl.RED}else if(e==T.PFORMATSTR_RG8UB){i.glInternalFormat=t.gl.RG8;i.glDataFormat=t.gl.RG}else if(e==T.PFORMATSTR_RGB8UB){i.glInternalFormat=t.gl.RGB8;i.glDataFormat=t.gl.RGB}else if(e==T.PFORMATSTR_SRGBA8){i.glInternalFormat=t.gl.SRGB8_ALPHA8}else if(e==T.PFORMATSTR_R32F){i.glInternalFormat=t.gl.R32F;i.glDataFormat=t.gl.RED;i.glDataType=s}else if(e==T.PFORMATSTR_R16F){i.glInternalFormat=t.gl.R16F;i.glDataType=s;i.glDataFormat=t.gl.RED}else if(e==T.PFORMATSTR_RG16F){i.glInternalFormat=t.gl.RG16F;i.glDataType=s;i.glDataFormat=t.gl.RG}else if(e==T.PFORMATSTR_RGBA16F){if(t.glVersion==1)i.glInternalFormat=t.gl.RGBA;else i.glInternalFormat=t.gl.RGBA16F;i.glDataType=s}else if(e==T.PFORMATSTR_R11FG11FB10F){i.glInternalFormat=t.gl.R11F_G11F_B10F;i.glDataType=s;i.glDataFormat=t.gl.RGB}else if(e==T.PFORMATSTR_RGBA32F){if(t.glVersion==1)i.glInternalFormat=t.gl.RGBA;else i.glInternalFormat=t.gl.RGBA32F;i.glDataType=s}else if(e==T.PFORMATSTR_DEPTH){if(t.glVersion==1){i.glInternalFormat=t.gl.DEPTH_COMPONENT;i.glDataType=t.gl.UNSIGNED_SHORT;i.glDataFormat=t.gl.DEPTH_COMPONENT}else{i.glInternalFormat=t.gl.DEPTH_COMPONENT32F;i.glDataType=t.gl.FLOAT;i.glDataFormat=t.gl.DEPTH_COMPONENT}}else{va.log("unknown pixelformat ",e)}if(e.includes("32bit")||e==T.PFORMATSTR_R11FG11FB10F){if(t.glVersion==2)t.enableExtension("EXT_color_buffer_float");if(t.glVersion==2)t.enableExtension("EXT_float_blend");t.enableExtension("OES_texture_float_linear")}i.numColorChannels=T.getPixelFormatNumChannels(e);if(!i.glDataType||!i.glInternalFormat||!i.glDataFormat)va.log("pixelformat wrong ?!",e,i.glDataType,i.glInternalFormat,i.glDataFormat,this);return i};T.getPixelFormatNumChannels=t=>{if(t.startsWith("RGBA"))return 4;if(t.startsWith("RGB"))return 3;if(t.startsWith("RG"))return 2;return 1};T.isPixelFormatFloat=t=>{return(t||"").includes("float")};T.isPixelFormatHalfFloat=t=>{return(t||"").includes("float")&&(t||"").includes("16bit")};A.Op.prototype.outTexture=function(t,e){const i=this.addOutPort(this.newPort(this,t,A.Port.TYPE_OBJECT,{preview:true,objType:"texture",display:"texture"}));if(e!==undefined)i.setRef(e||T.getEmptyTexture(this.patch.cgl));i.ignoreValueSerialize=true;return i};class ba{constructor(e,t,i,s){this._log=new u.Logger("cgl_framebuffer2");if(e.glVersion==1)this._log.error("framebuffer2 used on webgl1");this.Framebuffer2DrawTargetsDefault=null;this.Framebuffer2BlittingFramebuffer=null;this.Framebuffer2FinalFramebuffer=null;this._cgl=e;this._cgl.printError("before framebuffer2 constructor");this._width=0;this._height=0;this.valid=true;this._depthRenderbuffer=null;this._frameBuffer=null;this._textureFrameBuffer=null;this._colorRenderbuffers=[];this._drawTargetArray=[];this._disposed=false;if(!this.Framebuffer2BlittingFramebuffer)this.Framebuffer2BlittingFramebuffer=e.gl.createFramebuffer();if(!this.Framebuffer2FinalFramebuffer)this.Framebuffer2FinalFramebuffer=e.gl.createFramebuffer();if(!this.Framebuffer2DrawTargetsDefault)this.Framebuffer2DrawTargetsDefault=[e.gl.COLOR_ATTACHMENT0];this._options=s||{isFloatingPointTexture:false};this.name=this._options.name||"unknown";this._cgl.profileData.addHeavyEvent("framebuffer create",this.name);if(!this._options.hasOwnProperty("numRenderBuffers"))this._options.numRenderBuffers=1;if(!this._options.hasOwnProperty("depth"))this._options.depth=true;if(!this._options.hasOwnProperty("clear"))this._options.clear=true;if(!this._options.hasOwnProperty("multisampling")){this._options.multisampling=false;this._options.multisamplingSamples=0}if(this._options.multisamplingSamples){if(this._cgl.glSlowRenderer)this._options.multisamplingSamples=0;if(!this._cgl.gl.MAX_SAMPLES)this._options.multisamplingSamples=0;else this._options.multisamplingSamples=Math.min(this._cgl.maxSamples,this._options.multisamplingSamples)}if(!this._options.hasOwnProperty("filter"))this._options.filter=T.FILTER_LINEAR;if(!this._options.hasOwnProperty("wrap"))this._options.wrap=T.WRAP_REPEAT;this._numRenderBuffers=this._options.numRenderBuffers;this._colorTextures=[];this.clearColors=[];for(let t=0;t<this._numRenderBuffers;t++)this.clearColors.push([0,0,0,1]);if(!s.pixelFormat){if(s.isFloatingPointTexture)this._options.pixelFormat=T.PFORMATSTR_RGBA32F;else this._options.pixelFormat=T.PFORMATSTR_RGBA8UB}for(let t=0;t<this._numRenderBuffers;t++){this._colorTextures[t]=new T(e,{name:"fb2 "+this.name+" "+t,isFloatingPointTexture:this._options.isFloatingPointTexture,anisotropic:this._options.anisotropic||0,pixelFormat:this._options.pixelFormat,filter:this._options.filter,wrap:this._options.wrap})}let r=T.FILTER_NEAREST;if(this._options.shadowMap)r=T.FILTER_LINEAR;const n=512;if(this._options.depth){this._textureDepth=new T(e,{name:"fb2 depth "+this.name,isDepthTexture:true,filter:r,shadowMap:this._options.shadowMap||false,width:t||n,height:i||n})}if(e.aborted)return;this.setSize(t||n,i||n);this._cgl.printError("framebuffer2 constructor")}getWidth(){return this._width}getHeight(){return this._height}getGlFrameBuffer(){return this._frameBuffer}getDepthRenderBuffer(){return this._depthRenderbuffer}getTextureColor(){return this._colorTextures[0]}getTextureColorNum(t){return this._colorTextures[t]}getTextureDepth(){return this._textureDepth}setFilter(e){for(let t=0;t<this._numRenderBuffers;t++){this._colorTextures[t].filter=e;this._colorTextures[t].setSize(this._width,this._height)}}delete(){this.dispose()}dispose(){this._disposed=true;let t=0;for(t=0;t<this._numRenderBuffers;t++)this._colorTextures[t].delete();if(this._textureDepth)this._textureDepth.delete();for(t=0;t<this._numRenderBuffers;t++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[t]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}setSize(t,e){if(this._disposed)return this._log.warn("disposed framebuffer setsize...");this._cgl.profileData.addHeavyEvent("framebuffer resize",this.name);let i=0;this._width=this._cgl.checkTextureSize(t);this._height=this._cgl.checkTextureSize(e);this._cgl.profileData.profileFrameBuffercreate++;if(this._frameBuffer){for(i=0;i<this._numRenderBuffers;i++)this._cgl.gl.deleteRenderbuffer(this._colorRenderbuffers[i]);this._cgl.gl.deleteRenderbuffer(this._depthRenderbuffer);this._cgl.gl.deleteFramebuffer(this._frameBuffer);this._cgl.gl.deleteFramebuffer(this._textureFrameBuffer)}this._frameBuffer=this._cgl.gl.createFramebuffer();this._textureFrameBuffer=this._cgl.gl.createFramebuffer();const s=this._options.depth;for(i=0;i<this._numRenderBuffers;i++){this._colorTextures[i].setSize(this._width,this._height)}for(i=0;i<this._numRenderBuffers;i++){const a=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,a);const o=T.setUpGlPixelFormat(this._cgl,this._options.pixelFormat);let t=o.glInternalFormat;if(CGL.Texture.isPixelFormatHalfFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._options.filter=T.FILTER_NEAREST;this.setFilter(this._options.filter)}}else if(CGL.Texture.isPixelFormatFloat(o.pixelFormat)){if(!this._cgl.enableExtension("OES_texture_float_linear")){this._log.warn("no linear pixelformat,using nearest");this._options.filter=T.FILTER_NEAREST;this.setFilter(this._options.filter)}}if(this._options.multisampling&&this._options.multisamplingSamples){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,t,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,t,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.RENDERBUFFER,a);this._colorRenderbuffers[i]=a}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._textureFrameBuffer);for(i=0;i<this._numRenderBuffers;i++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+i,this._cgl.gl.TEXTURE_2D,this._colorTextures[i].tex,0)}if(this._options.depth){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0)}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);let r=this._cgl.gl.DEPTH_COMPONENT32F;if(this._cgl.glSlowRenderer)r=this._cgl.gl.DEPTH_COMPONENT16;if(s){this._textureDepth.setSize(this._width,this._height);this._depthRenderbuffer=this._cgl.gl.createRenderbuffer();this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);if(this._options.isFloatingPointTexture){if(this._options.multisampling)this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height);else this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}else if(this._options.multisampling){this._cgl.gl.renderbufferStorageMultisample(this._cgl.gl.RENDERBUFFER,this._options.multisamplingSamples,r,this._width,this._height)}else{this._cgl.gl.renderbufferStorage(this._cgl.gl.RENDERBUFFER,r,this._width,this._height)}this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer)}this._drawTargetArray.length=0;for(i=0;i<this._numRenderBuffers;i++)this._drawTargetArray.push(this._cgl.gl.COLOR_ATTACHMENT0+i);if(!this._cgl.gl.isFramebuffer(this._textureFrameBuffer))this._log.warn("invalid framebuffer");const n=this._cgl.gl.checkFramebufferStatus(this._cgl.gl.FRAMEBUFFER);if(n!=this._cgl.gl.FRAMEBUFFER_COMPLETE){this._log.error("framebuffer incomplete: "+this.name,this);this._log.log("options",this._options);this._log.log("options pixelformat",this._options.pixelFormat);switch(n){case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_ATTACHMENT...",this);throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:this._log.warn("FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this._cgl.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:this._log.warn("FRAMEBUFFER_INCOMPLETE_DIMENSIONS");throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this._cgl.gl.FRAMEBUFFER_UNSUPPORTED:this._log.warn("FRAMEBUFFER_UNSUPPORTED");throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:this.valid=false;this._log.error("incomplete framebuffer",n,this._frameBuffer);this._cgl.printError();this._frameBuffer=null;throw new Error("Incomplete framebuffer: "+n)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindRenderbuffer(this._cgl.gl.RENDERBUFFER,null)}renderStart(){if(this._disposed)return this._log.warn("disposed framebuffer renderStart...");this._cgl.checkFrameStarted("fb2 renderstart");this._cgl.pushModelMatrix();this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.pushGlFrameBuffer(this._frameBuffer);this._cgl.pushFrameBuffer(this);this._cgl.pushPMatrix();this._cgl.pushViewPort(0,0,this._width,this._height);this._cgl.gl.drawBuffers(this._drawTargetArray);if(this._options.clear){this._cgl.gl.clearColor(0,0,0,0);this._cgl.gl.clear(this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT)}}clear(){if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer)}else this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._frameBuffer);this._cgl.gl.drawBuffers(this._drawTargetArray);for(let t=0;t<this._numRenderBuffers;t++){this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0+t,this._cgl.gl.TEXTURE_2D,this._colorTextures[t].tex,0);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,t,this.clearColors[t])}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null)}renderEnd(){if(this._disposed)return this._log.warn("disposed framebuffer renderEnd...");this._cgl.popPMatrix();this._cgl.profileData.count("framebufferBlit");if(this._numRenderBuffers<=1){this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this._frameBuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this._textureFrameBuffer);this._cgl.gl.clearBufferfv(this._cgl.gl.COLOR,0,[0,0,0,1]);this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,this._cgl.gl.COLOR_BUFFER_BIT|this._cgl.gl.DEPTH_BUFFER_BIT,this._cgl.gl.NEAREST)}else{this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.RENDERBUFFER,this._depthRenderbuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.DEPTH_ATTACHMENT,this._cgl.gl.TEXTURE_2D,this._textureDepth.tex,0);for(let e=0;e<this._numRenderBuffers;e++){this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.framebufferRenderbuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.RENDERBUFFER,this._colorRenderbuffers[e]);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);this._cgl.gl.framebufferTexture2D(this._cgl.gl.FRAMEBUFFER,this._cgl.gl.COLOR_ATTACHMENT0,this._cgl.gl.TEXTURE_2D,this._colorTextures[e].tex,0);this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,null);this._cgl.gl.bindFramebuffer(this._cgl.gl.READ_FRAMEBUFFER,this.Framebuffer2BlittingFramebuffer);this._cgl.gl.bindFramebuffer(this._cgl.gl.DRAW_FRAMEBUFFER,this.Framebuffer2FinalFramebuffer);let t=this._cgl.gl.COLOR_BUFFER_BIT;if(e==0)t|=this._cgl.gl.DEPTH_BUFFER_BIT;this._cgl.gl.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,t,this._cgl.gl.NEAREST)}}this._cgl.gl.bindFramebuffer(this._cgl.gl.FRAMEBUFFER,this._cgl.popGlFrameBuffer());this._cgl.popFrameBuffer();this._cgl.popModelMatrix();this._cgl.popViewPort();if(this._colorTextures[0].filter==T.FILTER_MIPMAP){for(let t=0;t<this._numRenderBuffers;t++){this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,this._colorTextures[t].tex);this._colorTextures[t].updateMipMap();this._cgl.gl.bindTexture(this._cgl.gl.TEXTURE_2D,null)}}}}const Ta=function(t){this.draw=function(t,e,i){}};const Aa=function(t){this.render=function(t,e){}};const Sa=function(t){this.render=function(t,e,i,s){}};class xa{constructor(t){this.shader=new CGL.Shader(t,"markermaterial");const e="".endl()+"void main()".endl()+"{".endl()+"    outColor = vec4(color.rgb,1.0);".endl()+"}";const i="".endl()+"IN vec3 vPosition;".endl()+"UNI mat4 projMatrix;".endl()+"UNI mat4 mvMatrix;".endl()+"void main()".endl()+"{".endl()+"   gl_Position = projMatrix * mvMatrix * vec4(vPosition,1.0);".endl()+"}";this.shader.setSource(i,e);this.coloruni=this.shader.addUniformFrag("4f","color",[1,.777,1,1])}setColor(t,e,i,s){this.coloruni.set(t,e,i,s)}}const Ia=Math.PI/180;const Pa=180/Math.PI;const Ma=null;const Ra=window.navigator.userAgent.includes("Windows");const Ca=function(e){let i;if(e.wheelDelta){i=e.wheelDelta%120-0==-0?e.wheelDelta/120:e.wheelDelta/30;i*=-1.5;if(Ra)i*=2}else{let t=e.deltaY;if(e.shiftKey)t=e.deltaX;const s=t||e.detail;i=-(s%3?s*10:s/3);i*=-3}if(i>20)i=20;if(i<-20)i=-20;return i};const Na=Ca;const Oa=Ca;class La{_origShaders={};_uniforms=[];_structUniforms=[];_definesToggled={};_defines={};_mods=[];_textures=[];_boundShader=null;_changedDefines=true;_changedUniforms=true;_modulesChanged=false;needsTexturePush=false;_lastShader=null;_attributes=[];constructor(t,e,i){this._cgl=t;this._name=e;if(i&&i.opId)this.opId=i.opId;if(this._cgl.glVersion==1){this._cgl.enableExtension("OES_texture_float");this._cgl.enableExtension("OES_texture_float_linear");this._cgl.enableExtension("OES_texture_half_float");this._cgl.enableExtension("OES_texture_half_float_linear")}}bind(t,e){const i=t||this._cgl.getShader();if(!i)return;this._boundShader=this._origShaders[i.id];let s=false;if(this._boundShader&&this._lastShader!=this._boundShader.shader){if(!this._boundShader.shader.hasModule(this._mods[0].id))s=true}if(s||!this._boundShader||i.lastCompile!=this._boundShader.lastCompile||this._modulesChanged||i.needsRecompile()){if(this._boundShader)this._boundShader.shader.dispose();if(i.needsRecompile())i.compile();this.needsTexturePush=true;this._boundShader=this._origShaders[i.id]={lastCompile:i.lastCompile,orig:i,shader:i.copy()};this._addModulesToShader(this._boundShader.shader);this._updateDefinesShader(this._boundShader.shader);this._updateUniformsShader(this._boundShader.shader)}this._boundShader.wireframe=i.wireframe;if(this._changedDefines)this._updateDefines();if(this._changedUniforms)this._updateUniforms();if(e!==false)this._cgl.pushShader(this._boundShader.shader);this._boundShader.shader.copyUniformValues(this._boundShader.orig);if(this.needsTexturePush){for(let t=0;t<this._textures.length;t++){const r=this._textures[t][0];const n=this._textures[t][1];const a=this._textures[t][2];if(this._getUniform(r)){const o=this.getPrefixedName(r);const h=this._boundShader.shader.getUniform(o);if(h)this._boundShader.shader.pushTexture(h,n,a)}}this.needsTexturePush=false;this._textures.length=0}this._modulesChanged=false;this._boundShader.shader.fromMod=this;if(this.onBind)this.onBind(this._boundShader.shader);return this._boundShader.shader}unbind(t){if(this._boundShader){if(t!==false)this._cgl.popShader()}this._boundShader=null}_addModulesToShader(e){let i;if(this._mods.length>1)i=this._mods[0];for(let t=0;t<this._mods.length;t++)e.addModule(this._mods[t],i)}_removeModulesFromShader(t){for(const e in this._origShaders)this._origShaders[e].shader.removeModule(t)}addModule(t){this._mods.push(t);this._modulesChanged=true}removeModule(e){const i=[];let s=false;for(let t=0;t<this._mods.length;t++){if(this._mods[t].title==e){s=true;this._removeModulesFromShader(this._mods[t]);i.push(t)}}for(let t=i.length-1;t>=0;t-=1)this._mods.splice(i[t],1);this._modulesChanged=true}_updateUniformsShader(s){for(let t=0;t<this._uniforms.length;t++){const e=this._uniforms[t];const i=this.getPrefixedName(e.name);if(!s.hasUniform(i)&&!e.structName){let t=null;if(e.shaderType==="both"){t=s.addUniformBoth(e.type,i,e.v1,e.v2,e.v3,e.v4);t.comment="mod: "+this._name}else if(e.shaderType==="frag"){t=s.addUniformFrag(e.type,i,e.v1,e.v2,e.v3,e.v4);t.comment="mod: "+this._name}else if(e.shaderType==="vert"){t=s.addUniformVert(e.type,i,e.v1,e.v2,e.v3,e.v4);t.comment="mod: "+this._name}}}for(let i=0;i<this._structUniforms.length;i+=1){const r=this._structUniforms[i];let t=r.uniformName;let e=r.structName;const n=r.members;t=this.getPrefixedName(r.uniformName);e=this.getPrefixedName(r.structName);if(r.shaderType==="frag"){s.addUniformStructFrag(e,t,n)}if(r.shaderType==="vert"){s.addUniformStructVert(e,t,n)}if(r.shaderType==="both"){s.addUniformStructBoth(e,t,n)}}}_updateUniforms(){for(const t in this._origShaders)this._updateUniformsShader(this._origShaders[t].shader);this._changedUniforms=false}_setUniformValue(t,e,i){const s=t.getUniform(e);if(s)s.setValue(i)}setUniformValue(t,e){const i=this._getUniform(t);if(!i)return;const s=this.getPrefixedName(t);for(const r in this._origShaders){this._setUniformValue(this._origShaders[r].shader,s,e)}}hasUniform(t){return this._getUniform(t)}_getUniform(e){for(let t=0;t<this._uniforms.length;t++){if(this._uniforms[t].name==e)return this._uniforms[t];if(this._uniforms[t].structName){if(this._uniforms[t].propertyName==e)return this._uniforms[t]}}return false}_getStructUniform(e){for(let t=0;t<this._structUniforms.length;t+=1)if(this._structUniforms[t].uniformName===e)return this._structUniforms[t];return null}_isStructUniform(e){for(let t=0;t<this._uniforms.length;t++){if(this._uniforms[t].name==e)return false;if(this._uniforms[t].structName){if(this._uniforms[t].propertyName==e)return true}}return false}addUniform(e,i,s,r,n,a,o,h,l,u){if(!this._getUniform(i)){let t="both";if(u)t=u;this._uniforms.push({type:e,name:i,v1:s,v2:r,v3:n,v4:a,structUniformName:o,structName:h,propertyName:l,shaderType:t});this._changedUniforms=true}}addUniformFrag(t,e,i,s,r,n){this.addUniform(t,e,i,s,r,n,null,null,null,"frag");this._changedUniforms=true}addUniformVert(t,e,i,s,r,n){this.addUniform(t,e,i,s,r,n,null,null,null,"vert");this._changedUniforms=true}addUniformBoth(t,e,i,s,r,n){this.addUniform(t,e,i,s,r,n,null,null,null,"both");this._changedUniforms=true}addUniformStruct(e,i,s,r){for(let t=0;t<s.length;t+=1){const n=s[t];if((n.type==="2i"||n.type==="i"||n.type==="3i")&&r==="both")console.error("Adding an integer struct member to both shaders can potentially error. Please use different structs for each shader. Error occured in struct:",e," with member:",n.name," of type:",n.type,".");if(!this._getUniform(i+"."+n.name)){this.addUniform(n.type,i+"."+n.name,n.v1,n.v2,n.v3,n.v4,i,e,n.name,r)}}if(!this._getStructUniform(i)){this._structUniforms.push({structName:e,uniformName:i,members:s,shaderType:r})}}addUniformStructVert(t,e,i){this.addUniformStruct(t,e,i,"vert")}addUniformStructFrag(t,e,i){this.addUniformStruct(t,e,i,"frag")}addUniformStructBoth(t,e,i){this.addUniformStruct(t,e,i,"both")}addAttribute(e){for(let t=0;t<this._attributes.length;t++){if(this._attributes[t].name==e.name&&this._attributes[t].nameFrag==e.nameFrag)return}this._attributes.push(e)}pushTexture(t,e,i){if(!e)throw new Error("no texture given to texturestack");this._textures.push([t,e,i]);this.needsTexturePush=true}_removeUniformFromShader(t,e){if(e.hasUniform(t))e.removeUniform(t)}removeUniform(e){if(this._getUniform(e)){for(let t=this._uniforms.length-1;t>=0;t-=1){const i=e;if(this._uniforms[t].name==e&&!this._uniforms[t].structName){for(const s in this._origShaders){this._removeUniformFromShader(this.getPrefixedName(i),this._origShaders[s].shader)}this._uniforms.splice(t,1)}}this._changedUniforms=true}}removeUniformStruct(e){if(this._getStructUniform(e)){for(let t=this._structUniforms.length-1;t>=0;t-=1){const i=this._structUniforms[t];if(i.uniformName===e){for(const s in this._origShaders){for(let t=0;t<i.members.length;t+=1){const r=i.members[t];this._removeUniformFromShader(this.getPrefixedName(r.name),this._origShaders[s].shader)}}this._structUniforms.splice(t,1)}}this._changedUniforms=true}}getPrefixedName(t){const e=this._mods[0].group;if(e===undefined){return}if(t.startsWith("MOD_")){t=t.substr("MOD_".length);t="mod"+e+"_"+t}return t}_updateDefinesShader(e){for(const t in this._defines){const i=this.getPrefixedName(t);if(this._defines[t]!==null&&this._defines[t]!==undefined)e.define(i,this._defines[t]);else e.removeDefine(i)}for(const t in this._definesToggled){const i=this.getPrefixedName(t);e.toggleDefine(i,this._definesToggled[t])}}_updateDefines(){for(const t in this._origShaders)this._updateDefinesShader(this._origShaders[t].shader);this._changedDefines=false}define(t,e){if(e===undefined)e=true;this._defines[t]=e;this._changedDefines=true}removeDefine(t){this._defines[t]=null;this._changedDefines=true}hasDefine(t){if(this._defines[t]!==null&&this._defines[t]!==undefined)return true;return false}toggleDefine(t,e){this._changedDefines=true;this._definesToggled[t]=e}currentShader(){if(!this._boundShader)return null;return this._boundShader.shader}dispose(){}}class Fa{}const ya={Framebuffer2:ba,Geometry:c,BoundingBox:i,Marker:Ta,WirePoint:Aa,WireCube:Sa,MatrixStack:a,Mesh:m,MESH:I,ShaderLibMods:fa,ShaderModifier:La,Shader:b,Uniform:_,MESHES:E,getWheelSpeed:Na,getWheelDelta:Oa,Context:pa,Texture:T,TextureEffect:v,onLoadingAssetsFinished:Ma,ProfileData:ea,UniColorShader:xa,...d.BLEND_MODES,...d.SHADER,...d.MATH,...d.BLEND_MODES};window.CABLES=window.CABLES||{};window.CABLES.CGL={...ya,...window.CABLES.CGL};window.CGL={...ya,...window.CABLES.CGL,...window.CGL};console.log("cglindexxxxxxxxxxx");window.addEventListener(A.Patch.EVENT_INIT_CGL,t=>{const e=t?.detail;if(!e||e.tempData.cglInitialized&&!CABLES.UI)return;e.tempData.cglInitialized=true;console.log("lalalalala");const i=new pa(e)});A.Anim.slerpQuaternion=function(t,e,i,s,r,n){if(!A.Anim.slerpQuaternion.q1){A.Anim.slerpQuaternion.q1=quat.create();A.Anim.slerpQuaternion.q2=quat.create()}const a=i.getKeyIndex(t);let o=a+1;if(o>=i.keys.length)o=i.keys.length-1;if(a==o){quat.set(e,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value)}else{const h=i.keys[a].time;const l=i.keys[o].time;const u=(t-h)/(l-h);quat.set(A.Anim.slerpQuaternion.q1,i.keys[a].value,s.keys[a].value,r.keys[a].value,n.keys[a].value);quat.set(A.Anim.slerpQuaternion.q2,i.keys[o].value,s.keys[o].value,r.keys[o].value,n.keys[o].value);quat.slerp(e,A.Anim.slerpQuaternion.q1,A.Anim.slerpQuaternion.q2,u)}return e}})();var t=CABLES=typeof CABLES==="undefined"?{}:CABLES;for(var e in wa)t[e]=wa[e];if(wa.__esModule)Object.defineProperty(t,"__esModule",{value:true})})();